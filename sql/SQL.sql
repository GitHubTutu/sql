SELECT LOOKUP_CODE,MEANING,DESCRIPTION,TAG,START_DATE_ACTIVE,END_DATE_ACTIVE,ENABLED_FLAG,LOOKUP_TYPE,ATTRIBUTE_CATEGORY,ATTRIBUTE1,ATTRIBUTE2,ATTRIBUTE3,ATTRIBUTE4,ATTRIBUTE5,ATTRIBUTE6,ATTRIBUTE7,ATTRIBUTE8,ATTRIBUTE9,ATTRIBUTE10,ATTRIBUTE11,ATTRIBUTE12,ATTRIBUTE13,ATTRIBUTE14,ATTRIBUTE15,VIEW_APPLICATION_ID,SECURITY_GROUP_ID,TERRITORY_CODE,CREATED_BY,CREATION_DATE,LAST_UPDATE_DATE,LAST_UPDATED_BY,LAST_UPDATE_LOGIN,ROW_ID FROM FND_LOOKUP_VALUES_VL WHERE (nvl('', territory_code) = territory_code or territory_code is null) AND lookup_type = 'CUX_CST_3326_COMPLETE_INV' and (LOOKUP_TYPE LIKE 'CUX_CST_3326_COMPLETE_INV') and (VIEW_APPLICATION_ID=20003) and (SECURITY_GROUP_ID=0) order by LOOKUP_CODE

/*关联交易开票*/
SELECT REQ_LINE_NUM,REQ_HEADER_ID,SUPPLIER_ITEM_NUM,SUPPLIER_ITEM_DESC,PRIMARY_UOM_CODE,LOGIST_QUANTITY,RETURN_QUANTITY,REQUEST_QUANTITY,REQ_LOGIST_HEADER_ID,PARAENT_LOGIST_ID,ORDER_HEADER_ID,REQUEST_DATE,RECEIVE_DATE,CURRENCY_CODE,UNIT_PRICE,AMOUNT,BASE_AMOUNT,TAX_PLANNING_FLAG,RETRUN_FLAG,ROLLBACK_FLAG,INVOICE_PRICE_METHOD_DESC,INVOICE_PRICE_SOURCE,AGREEMENT_PRICE,AGREEMENT_AMOUNT,REQUIRE_ITEM_NUM,REQUIRE_ITEM_DESC,PO_NUMBER,PO_LINE_NUM,RECEIPT_NUM,RECEIPT_LINE_NUM,ORDER_NUMBER,OE_LINE_NUMBER,OM_ORDER_TYPE,REQ_LOGIST_ID,AR_TAX_CODE,AP_TAX_CODE,GROUP_NAME,REQUIREMENT_ORG,SUPPLIER_ORG,ORDER_SOURCE_NUM,LOGIST_R_ORDER_NUM,LOGIST_S_ORDER_NUM,SUPPLIER_SHIP_SUBINV,ESB_DATA_SOURCE,INVOICE_GROUP_NAME,ROW_ID,INVOICE_PRICE_METHOD,SUPPLIER_INV_ORG_ID,SUPPLIER_INV_ORG,SUPPLIER_SHIP_LOCATION_ID,ISS_LOT_NUMBER,RECEIVE_INV_ORG_ID,RECEIVE_INV_ORG,RECEIVE_SUBINV,RECEIVE_LOCATION_ID,RECEIVE_LOT_NUMBER,ORDER_STATUS,PRICE_LIST,REQUIREMENT_SYSTEM,REQUIREMENT_ORG_ID,SUPPLIER_SYSTEM,SUPPLIER_ORG_ID,REQ_LINE_ID,PROC_GROUP_ID,GROUP_CODE,REQUIRE_ITEM_ID,SUPPLIER_ITEM_ID,PO_LINE_ID,OE_LINE_ID,RCV_TRANSACTION_ID,STATUS,STATUS_NAME,PROCESS_PHASE,SOURCE_HEADER_ID,ERROR_MESSAGE,CREATED_BY,CREATION_DATE,LAST_UPDATED_BY,LAST_UPDATE_DATE,LAST_UPDATE_LOGIN,PROGRAM_APPLICATION_ID,PROGRAM_ID,PROGRAM_UPDATE_DATE,REQUEST_ID,ATTRIBUTE_CATEGORY,ATTRIBUTE1,ATTRIBUTE2,ATTRIBUTE3,ATTRIBUTE4,ATTRIBUTE5,ATTRIBUTE6,ATTRIBUTE7,ATTRIBUTE8,ATTRIBUTE9,ATTRIBUTE10,ATTRIBUTE11,ATTRIBUTE12,ATTRIBUTE13,ATTRIBUTE14,ATTRIBUTE15,CHOICE_FLAG 
FROM CUX_ICP_INVOICE_REQ_LINES_V 
WHERE 1 = -1 
UNION ALL 
SELECT REQ_LINE_NUM ,REQ_HEADER_ID ,SUPPLIER_ITEM_NUM ,SUPPLIER_ITEM_DESC ,PRIMARY_UOM_CODE ,LOGIST_QUANTITY ,RETURN_QUANTITY ,REQUEST_QUANTITY ,REQ_LOGIST_HEADER_ID ,PARAENT_LOGIST_ID ,ORDER_HEADER_ID ,REQUEST_DATE ,RECEIVE_DATE ,CURRENCY_CODE ,UNIT_PRICE ,AMOUNT ,BASE_AMOUNT ,TAX_PLANNING_FLAG ,RETRUN_FLAG ,ROLLBACK_FLAG ,INVOICE_PRICE_METHOD_DESC ,INVOICE_PRICE_SOURCE ,AGREEMENT_PRICE ,AGREEMENT_AMOUNT ,REQUIRE_ITEM_NUM ,REQUIRE_ITEM_DESC ,PO_NUMBER ,PO_LINE_NUM ,RECEIPT_NUM ,RECEIPT_LINE_NUM ,ORDER_NUMBER ,OE_LINE_NUMBER ,OM_ORDER_TYPE ,REQ_LOGIST_ID ,AR_TAX_CODE ,AP_TAX_CODE ,GROUP_NAME ,REQUIREMENT_ORG ,SUPPLIER_ORG ,ORDER_SOURCE_NUM ,LOGIST_R_ORDER_NUM ,LOGIST_S_ORDER_NUM ,SUPPLIER_SHIP_SUBINV ,ESB_DATA_SOURCE ,INVOICE_GROUP_NAME ,ROW_ID ,INVOICE_PRICE_METHOD ,SUPPLIER_INV_ORG_ID ,SUPPLIER_INV_ORG ,SUPPLIER_SHIP_LOCATION_ID ,ISS_LOT_NUMBER ,RECEIVE_INV_ORG_ID ,RECEIVE_INV_ORG ,RECEIVE_SUBINV ,RECEIVE_LOCATION_ID ,RECEIVE_LOT_NUMBER ,ORDER_STATUS ,PRICE_LIST ,REQUIREMENT_SYSTEM ,REQUIREMENT_ORG_ID ,SUPPLIER_SYSTEM ,SUPPLIER_ORG_ID ,REQ_LINE_ID ,PROC_GROUP_ID ,GROUP_CODE ,REQUIRE_ITEM_ID ,SUPPLIER_ITEM_ID ,PO_LINE_ID ,OE_LINE_ID ,RCV_TRANSACTION_ID ,STATUS ,STATUS_NAME ,PROCESS_PHASE ,SOURCE_HEADER_ID ,ERROR_MESSAGE ,CREATED_BY ,CREATION_DATE ,LAST_UPDATED_BY ,LAST_UPDATE_DATE ,LAST_UPDATE_LOGIN ,PROGRAM_APPLICATION_ID ,PROGRAM_ID ,PROGRAM_UPDATE_DATE ,REQUEST_ID ,ATTRIBUTE_CATEGORY ,ATTRIBUTE1 ,ATTRIBUTE2 ,ATTRIBUTE3 ,ATTRIBUTE4 ,ATTRIBUTE5 ,ATTRIBUTE6 ,ATTRIBUTE7 ,ATTRIBUTE8 ,ATTRIBUTE9 ,ATTRIBUTE10 ,ATTRIBUTE11 ,ATTRIBUTE12 ,ATTRIBUTE13 ,ATTRIBUTE14 ,ATTRIBUTE15 ,CHOICE_FLAG FROM ( 
	SELECT T.REQ_LINE_NUM ,T.REQ_HEADER_ID ,T.SUPPLIER_ITEM_NUM ,T.SUPPLIER_ITEM_DESC ,T.PRIMARY_UOM_CODE ,T.LOGIST_QUANTITY ,T.RETURN_QUANTITY ,T.REQUEST_QUANTITY ,T.REQ_LOGIST_HEADER_ID ,T.PARAENT_LOGIST_ID ,T.ORDER_HEADER_ID ,T.REQUEST_DATE ,T.RECEIVE_DATE ,T.CURRENCY_CODE ,T.UNIT_PRICE ,T.AMOUNT ,T.BASE_AMOUNT ,T.TAX_PLANNING_FLAG ,T.RETRUN_FLAG ,T.ROLLBACK_FLAG ,T.INVOICE_PRICE_METHOD_DESC ,T.INVOICE_PRICE_SOURCE ,T.AGREEMENT_PRICE ,T.AGREEMENT_AMOUNT ,T.REQUIRE_ITEM_NUM ,T.REQUIRE_ITEM_DESC ,T.PO_NUMBER ,T.PO_LINE_NUM ,T.RECEIPT_NUM ,T.RECEIPT_LINE_NUM ,T.ORDER_NUMBER ,T.OE_LINE_NUMBER ,T.OM_ORDER_TYPE ,T.REQ_LOGIST_ID ,T.AR_TAX_CODE ,T.AP_TAX_CODE ,T.GROUP_NAME ,T.REQUIREMENT_ORG ,T.SUPPLIER_ORG ,T.ORDER_SOURCE_NUM ,T.LOGIST_R_ORDER_NUM ,T.LOGIST_S_ORDER_NUM ,T.SUPPLIER_SHIP_SUBINV ,T.ESB_DATA_SOURCE ,T.INVOICE_GROUP_NAME ,T.ROW_ID ,T.INVOICE_PRICE_METHOD ,T.SUPPLIER_INV_ORG_ID ,T.SUPPLIER_INV_ORG ,T.SUPPLIER_SHIP_LOCATION_ID ,T.ISS_LOT_NUMBER ,T.RECEIVE_INV_ORG_ID ,T.RECEIVE_INV_ORG ,T.RECEIVE_SUBINV ,T.RECEIVE_LOCATION_ID ,T.RECEIVE_LOT_NUMBER ,T.ORDER_STATUS ,T.PRICE_LIST ,T.REQUIREMENT_SYSTEM ,T.REQUIREMENT_ORG_ID ,T.SUPPLIER_SYSTEM ,T.SUPPLIER_ORG_ID ,T.REQ_LINE_ID ,T.PROC_GROUP_ID ,T.GROUP_CODE ,T.REQUIRE_ITEM_ID ,T.SUPPLIER_ITEM_ID ,T.PO_LINE_ID ,T.OE_LINE_ID ,T.RCV_TRANSACTION_ID ,T.STATUS ,T.STATUS_NAME ,T.PROCESS_PHASE ,T.SOURCE_HEADER_ID ,T.ERROR_MESSAGE ,T.CREATED_BY ,T.CREATION_DATE ,T.LAST_UPDATED_BY ,T.LAST_UPDATE_DATE ,T.LAST_UPDATE_LOGIN ,T.PROGRAM_APPLICATION_ID ,T.PROGRAM_ID ,T.PROGRAM_UPDATE_DATE ,T.REQUEST_ID ,T.ATTRIBUTE_CATEGORY ,T.ATTRIBUTE1 ,T.ATTRIBUTE2 ,T.ATTRIBUTE3 ,T.ATTRIBUTE4 ,T.ATTRIBUTE5 ,T.ATTRIBUTE6 ,T.ATTRIBUTE7 ,T.ATTRIBUTE8 ,T.ATTRIBUTE9 ,T.ATTRIBUTE10 ,T.ATTRIBUTE11 ,T.ATTRIBUTE12 ,T.ATTRIBUTE13 ,T.ATTRIBUTE14 ,T.ATTRIBUTE15 ,DECODE(T.AGREEMENT_PRICE,0,'N','Y') CHOICE_FLAG 
	FROM CUX_ICP_INVOICE_REQ_LINES_V T 
	WHERE T.REQ_HEADER_ID IS NULL AND ((T.RETRUN_FLAG = 'Y' AND CUX_ICP_STANDARD_PKG.CHECK_LOGIST_INVOICE_FLAG_F(T.REQ_LOGIST_ID) = 'Y') OR (T.RETRUN_FLAG = 'Y' AND CUX_ICP_STANDARD_PKG.CHECK_LOGIST_INVOICE_FLAG_F(T.REQ_LOGIST_ID) = 'N' AND T.RECEIVE_DATE IS NOT NULL) OR (T.ROLLBACK_FLAG = 'Y' AND T.RECEIVE_DATE IS NOT NULL)) AND (T.LOGIST_STATUS IN (1,3,5) OR (T.LOGIST_ORDER_STATUS = 'RETURNING' AND CUX_ICP_STANDARD_PKG.CHECK_LOGIST_INVOICE_FLAG_F(T.REQ_LOGIST_ID) = 'Y')) AND T.REQUIREMENT_ORG = 'OU_107509_美的环境电器' AND T.SUPPLIER_ORG = '宁波物资业务实体' AND (T.ESB_DATA_SOURCE = '' OR '' IS NULL) AND (T.OM_ORDER_TYPE = '' OR '' IS NULL) AND (T.SUPPLIER_INV_ORG_ID = '' OR '' IS NULL) AND (T.CURRENCY_CODE = 'CNY' OR 'CNY' IS NULL) 
	UNION ALL
	SELECT T.REQ_LINE_NUM ,T.REQ_HEADER_ID ,T.SUPPLIER_ITEM_NUM ,T.SUPPLIER_ITEM_DESC ,T.PRIMARY_UOM_CODE ,T.LOGIST_QUANTITY ,T.RETURN_QUANTITY ,T.REQUEST_QUANTITY ,T.REQ_LOGIST_HEADER_ID ,T.PARAENT_LOGIST_ID ,T.ORDER_HEADER_ID ,T.REQUEST_DATE ,T.RECEIVE_DATE ,T.CURRENCY_CODE ,T.UNIT_PRICE ,T.AMOUNT ,T.BASE_AMOUNT ,T.TAX_PLANNING_FLAG ,T.RETRUN_FLAG ,T.ROLLBACK_FLAG ,T.INVOICE_PRICE_METHOD_DESC ,T.INVOICE_PRICE_SOURCE ,T.AGREEMENT_PRICE ,T.AGREEMENT_AMOUNT ,T.REQUIRE_ITEM_NUM ,T.REQUIRE_ITEM_DESC ,T.PO_NUMBER ,T.PO_LINE_NUM ,T.RECEIPT_NUM ,T.RECEIPT_LINE_NUM ,T.ORDER_NUMBER ,T.OE_LINE_NUMBER ,T.OM_ORDER_TYPE ,T.REQ_LOGIST_ID ,T.AR_TAX_CODE ,T.AP_TAX_CODE ,T.GROUP_NAME ,T.REQUIREMENT_ORG ,T.SUPPLIER_ORG ,T.ORDER_SOURCE_NUM ,T.LOGIST_R_ORDER_NUM ,T.LOGIST_S_ORDER_NUM ,T.SUPPLIER_SHIP_SUBINV ,T.ESB_DATA_SOURCE ,T.INVOICE_GROUP_NAME ,T.ROW_ID ,T.INVOICE_PRICE_METHOD ,T.SUPPLIER_INV_ORG_ID ,T.SUPPLIER_INV_ORG ,T.SUPPLIER_SHIP_LOCATION_ID ,T.ISS_LOT_NUMBER ,T.RECEIVE_INV_ORG_ID ,T.RECEIVE_INV_ORG ,T.RECEIVE_SUBINV ,T.RECEIVE_LOCATION_ID ,T.RECEIVE_LOT_NUMBER ,T.ORDER_STATUS ,T.PRICE_LIST ,T.REQUIREMENT_SYSTEM ,T.REQUIREMENT_ORG_ID ,T.SUPPLIER_SYSTEM ,T.SUPPLIER_ORG_ID ,T.REQ_LINE_ID ,T.PROC_GROUP_ID ,T.GROUP_CODE ,T.REQUIRE_ITEM_ID ,T.SUPPLIER_ITEM_ID ,T.PO_LINE_ID ,T.OE_LINE_ID ,T.RCV_TRANSACTION_ID ,T.STATUS ,T.STATUS_NAME ,T.PROCESS_PHASE ,T.SOURCE_HEADER_ID ,T.ERROR_MESSAGE ,T.CREATED_BY ,T.CREATION_DATE ,T.LAST_UPDATED_BY ,T.LAST_UPDATE_DATE ,T.LAST_UPDATE_LOGIN ,T.PROGRAM_APPLICATION_ID ,T.PROGRAM_ID ,T.PROGRAM_UPDATE_DATE ,T.REQUEST_ID ,T.ATTRIBUTE_CATEGORY ,T.ATTRIBUTE1 ,T.ATTRIBUTE2 ,T.ATTRIBUTE3 ,T.ATTRIBUTE4 ,T.ATTRIBUTE5 ,T.ATTRIBUTE6 ,T.ATTRIBUTE7 ,T.ATTRIBUTE8 ,T.ATTRIBUTE9 ,T.ATTRIBUTE10 ,T.ATTRIBUTE11 ,T.ATTRIBUTE12 ,T.ATTRIBUTE13 ,T.ATTRIBUTE14 ,T.ATTRIBUTE15 ,NVL( 
		(SELECT 'Y' 
		FROM CUX_ICP_LOGIST_REQ_LINES CIL ,CUX_ICP_INVOICE_REQ_LINES_V CIV ,CUX_ICP_LOGIST_REQ_HEADERS CIH 
		WHERE CIL.PARAENT_REQ_LINE_ID = T.REQ_LOGIST_ID AND CIV.REQ_LOGIST_ID = CIL.REQ_LINE_ID AND CIL.REQ_HEADER_ID = CIH.REQ_HEADER_ID AND CIV.RETRUN_FLAG = 'Y' AND CIV.AGREEMENT_PRICE <> 0 AND CIH.ORDER_STATUS <> 'CREATING' AND CIV.REQUIREMENT_ORG = T.REQUIREMENT_ORG AND CIV.SUPPLIER_ORG = T.SUPPLIER_ORG AND CIV.CURRENCY_CODE = T.CURRENCY_CODE AND ROWNUM = 1
	) ,'N') CHOICE_FLAG 
	FROM CUX_ICP_INVOICE_REQ_LINES_V T 
	WHERE T.REQ_HEADER_ID IS NULL AND T.TAX_PLANNING_FLAG = 'Y' AND (T.LOGIST_STATUS = 5 OR T.LOGIST_ORDER_STATUS = 'PART_CONFIRM') AND T.RECEIVE_DATE <= TO_DATE('2017-1-9 23:59:59','YYYY-MM-DD HH24:MI:SS') AND T.REQUIREMENT_ORG = 'OU_107509_美的环境电器' AND T.SUPPLIER_ORG = '宁波物资业务实体' AND (T.ESB_DATA_SOURCE = '' OR '' IS NULL) AND (T.OM_ORDER_TYPE = '' OR '' IS NULL) AND (T.SUPPLIER_INV_ORG_ID = '' OR '' IS NULL) AND (T.CURRENCY_CODE = 'CNY' OR 'CNY' IS NULL) 
	UNION ALL 
	SELECT T.REQ_LINE_NUM ,T.REQ_HEADER_ID ,T.SUPPLIER_ITEM_NUM ,T.SUPPLIER_ITEM_DESC ,T.PRIMARY_UOM_CODE ,T.LOGIST_QUANTITY ,T.RETURN_QUANTITY ,T.REQUEST_QUANTITY ,T.REQ_LOGIST_HEADER_ID ,T.PARAENT_LOGIST_ID ,T.ORDER_HEADER_ID ,T.REQUEST_DATE ,T.RECEIVE_DATE ,T.CURRENCY_CODE ,T.UNIT_PRICE ,T.AMOUNT ,T.BASE_AMOUNT ,T.TAX_PLANNING_FLAG ,T.RETRUN_FLAG ,T.ROLLBACK_FLAG ,T.INVOICE_PRICE_METHOD_DESC ,T.INVOICE_PRICE_SOURCE ,T.AGREEMENT_PRICE ,T.AGREEMENT_AMOUNT ,T.REQUIRE_ITEM_NUM ,T.REQUIRE_ITEM_DESC ,T.PO_NUMBER ,T.PO_LINE_NUM ,T.RECEIPT_NUM ,T.RECEIPT_LINE_NUM ,T.ORDER_NUMBER ,T.OE_LINE_NUMBER ,T.OM_ORDER_TYPE ,T.REQ_LOGIST_ID ,T.AR_TAX_CODE ,T.AP_TAX_CODE ,T.GROUP_NAME ,T.REQUIREMENT_ORG ,T.SUPPLIER_ORG ,T.ORDER_SOURCE_NUM ,T.LOGIST_R_ORDER_NUM ,T.LOGIST_S_ORDER_NUM ,T.SUPPLIER_SHIP_SUBINV ,T.ESB_DATA_SOURCE ,T.INVOICE_GROUP_NAME ,T.ROW_ID ,T.INVOICE_PRICE_METHOD ,T.SUPPLIER_INV_ORG_ID ,T.SUPPLIER_INV_ORG ,T.SUPPLIER_SHIP_LOCATION_ID ,T.ISS_LOT_NUMBER ,T.RECEIVE_INV_ORG_ID ,T.RECEIVE_INV_ORG ,T.RECEIVE_SUBINV ,T.RECEIVE_LOCATION_ID ,T.RECEIVE_LOT_NUMBER ,T.ORDER_STATUS ,T.PRICE_LIST ,T.REQUIREMENT_SYSTEM ,T.REQUIREMENT_ORG_ID ,T.SUPPLIER_SYSTEM ,T.SUPPLIER_ORG_ID ,T.REQ_LINE_ID ,T.PROC_GROUP_ID ,T.GROUP_CODE ,T.REQUIRE_ITEM_ID ,T.SUPPLIER_ITEM_ID ,T.PO_LINE_ID ,T.OE_LINE_ID ,T.RCV_TRANSACTION_ID ,T.STATUS ,T.STATUS_NAME ,T.PROCESS_PHASE ,T.SOURCE_HEADER_ID ,T.ERROR_MESSAGE ,T.CREATED_BY ,T.CREATION_DATE ,T.LAST_UPDATED_BY ,T.LAST_UPDATE_DATE ,T.LAST_UPDATE_LOGIN ,T.PROGRAM_APPLICATION_ID ,T.PROGRAM_ID ,T.PROGRAM_UPDATE_DATE ,T.REQUEST_ID ,T.ATTRIBUTE_CATEGORY ,T.ATTRIBUTE1 ,T.ATTRIBUTE2 ,T.ATTRIBUTE3 ,T.ATTRIBUTE4 ,T.ATTRIBUTE5 ,T.ATTRIBUTE6 ,T.ATTRIBUTE7 ,T.ATTRIBUTE8 ,T.ATTRIBUTE9 ,T.ATTRIBUTE10 ,T.ATTRIBUTE11 ,T.ATTRIBUTE12 ,T.ATTRIBUTE13 ,T.ATTRIBUTE14 ,T.ATTRIBUTE15 ,DECODE(T.AGREEMENT_PRICE,0,'N','Y') CHOICE_FLAG 
	FROM CUX_ICP_INVOICE_REQ_LINES_V T 
	WHERE T.REQ_HEADER_ID IS NULL AND (T.LOGIST_STATUS = 5 OR T.LOGIST_ORDER_STATUS = 'PART_CONFIRM') AND T.TAX_PLANNING_FLAG = 'Y' AND T.RECEIVE_DATE > TO_DATE('2017-1-9 23:59:59','YYYY-MM-DD HH24:MI:SS') AND T.REQUIREMENT_ORG = 'OU_107509_美的环境电器' AND T.SUPPLIER_ORG = '宁波物资业务实体' AND (T.ESB_DATA_SOURCE = '' OR '' IS NULL) AND (T.OM_ORDER_TYPE = '' OR '' IS NULL) AND (T.SUPPLIER_INV_ORG_ID = '' OR '' IS NULL) AND (T.CURRENCY_CODE = 'CNY' OR 'CNY' IS NULL) AND EXISTS (
		SELECT 1 FROM CUX_ICP_LOGIST_REQ_LINES CIL ,CUX_ICP_INVOICE_REQ_LINES_V CIV WHERE CIL.PARAENT_REQ_LINE_ID = T.REQ_LOGIST_ID AND CIV.REQ_LOGIST_ID = CIL.REQ_LINE_ID AND (CIV.LOGIST_STATUS IN (3,5) OR (T.LOGIST_ORDER_STATUS = 'RETURNING' AND CUX_ICP_STANDARD_PKG.CHECK_LOGIST_INVOICE_FLAG_F(T.REQ_LOGIST_ID) = 'Y')) AND CIV.RETRUN_FLAG = 'Y' AND CIV.AGREEMENT_PRICE <> 0 AND CIV.REQUIREMENT_ORG = T.REQUIREMENT_ORG AND CIV.SUPPLIER_ORG = T.SUPPLIER_ORG AND CIV.ESB_DATA_SOURCE = T.ESB_DATA_SOURCE AND CIV.CURRENCY_CODE = T.CURRENCY_CODE
	)
) ;
SELECT REQ_LINE_NUM,REQ_HEADER_ID,SUPPLIER_ITEM_NUM,SUPPLIER_ITEM_DESC,PRIMARY_UOM_CODE,LOGIST_QUANTITY,RETURN_QUANTITY,REQUEST_QUANTITY,REQ_LOGIST_HEADER_ID,PARAENT_LOGIST_ID,ORDER_HEADER_ID,REQUEST_DATE,RECEIVE_DATE,CURRENCY_CODE,UNIT_PRICE,AMOUNT,BASE_AMOUNT,TAX_PLANNING_FLAG,RETRUN_FLAG,ROLLBACK_FLAG,INVOICE_PRICE_METHOD_DESC,INVOICE_PRICE_SOURCE,AGREEMENT_PRICE,AGREEMENT_AMOUNT,REQUIRE_ITEM_NUM,REQUIRE_ITEM_DESC,PO_NUMBER,PO_LINE_NUM,RECEIPT_NUM,RECEIPT_LINE_NUM,ORDER_NUMBER,OE_LINE_NUMBER,OM_ORDER_TYPE,REQ_LOGIST_ID,AR_TAX_CODE,AP_TAX_CODE,GROUP_NAME,REQUIREMENT_ORG,SUPPLIER_ORG,ORDER_SOURCE_NUM,LOGIST_R_ORDER_NUM,LOGIST_S_ORDER_NUM,SUPPLIER_SHIP_SUBINV,ESB_DATA_SOURCE,INVOICE_GROUP_NAME,ROW_ID,INVOICE_PRICE_METHOD,SUPPLIER_INV_ORG_ID,SUPPLIER_INV_ORG,SUPPLIER_SHIP_LOCATION_ID,ISS_LOT_NUMBER,RECEIVE_INV_ORG_ID,RECEIVE_INV_ORG,RECEIVE_SUBINV,RECEIVE_LOCATION_ID,RECEIVE_LOT_NUMBER,ORDER_STATUS,PRICE_LIST,REQUIREMENT_SYSTEM,REQUIREMENT_ORG_ID,SUPPLIER_SYSTEM,SUPPLIER_ORG_ID,REQ_LINE_ID,PROC_GROUP_ID,GROUP_CODE,REQUIRE_ITEM_ID,SUPPLIER_ITEM_ID,PO_LINE_ID,OE_LINE_ID,RCV_TRANSACTION_ID,STATUS,STATUS_NAME,PROCESS_PHASE,SOURCE_HEADER_ID,ERROR_MESSAGE,CREATED_BY,CREATION_DATE,LAST_UPDATED_BY,LAST_UPDATE_DATE,LAST_UPDATE_LOGIN,PROGRAM_APPLICATION_ID,PROGRAM_ID,PROGRAM_UPDATE_DATE,REQUEST_ID,ATTRIBUTE_CATEGORY,ATTRIBUTE1,ATTRIBUTE2,ATTRIBUTE3,ATTRIBUTE4,ATTRIBUTE5,ATTRIBUTE6,ATTRIBUTE7,ATTRIBUTE8,ATTRIBUTE9,ATTRIBUTE10,ATTRIBUTE11,ATTRIBUTE12,ATTRIBUTE13,ATTRIBUTE14,ATTRIBUTE15,CHOICE_FLAG FROM apps.CUX_ICP_INVOICE_REQ_LINES_V WHERE 1 = -1 UNION ALL SELECT REQ_LINE_NUM ,REQ_HEADER_ID ,SUPPLIER_ITEM_NUM ,SUPPLIER_ITEM_DESC ,PRIMARY_UOM_CODE ,LOGIST_QUANTITY ,RETURN_QUANTITY ,REQUEST_QUANTITY ,REQ_LOGIST_HEADER_ID ,PARAENT_LOGIST_ID ,ORDER_HEADER_ID ,REQUEST_DATE ,RECEIVE_DATE ,CURRENCY_CODE ,UNIT_PRICE ,AMOUNT ,BASE_AMOUNT ,TAX_PLANNING_FLAG ,RETRUN_FLAG ,ROLLBACK_FLAG ,INVOICE_PRICE_METHOD_DESC ,INVOICE_PRICE_SOURCE ,AGREEMENT_PRICE ,AGREEMENT_AMOUNT ,REQUIRE_ITEM_NUM ,REQUIRE_ITEM_DESC ,PO_NUMBER ,PO_LINE_NUM ,RECEIPT_NUM ,RECEIPT_LINE_NUM ,ORDER_NUMBER ,OE_LINE_NUMBER ,OM_ORDER_TYPE ,REQ_LOGIST_ID ,AR_TAX_CODE ,AP_TAX_CODE ,GROUP_NAME ,REQUIREMENT_ORG ,SUPPLIER_ORG ,ORDER_SOURCE_NUM ,LOGIST_R_ORDER_NUM ,LOGIST_S_ORDER_NUM ,SUPPLIER_SHIP_SUBINV ,ESB_DATA_SOURCE ,INVOICE_GROUP_NAME ,ROW_ID ,INVOICE_PRICE_METHOD ,SUPPLIER_INV_ORG_ID ,SUPPLIER_INV_ORG ,SUPPLIER_SHIP_LOCATION_ID ,ISS_LOT_NUMBER ,RECEIVE_INV_ORG_ID ,RECEIVE_INV_ORG ,RECEIVE_SUBINV ,RECEIVE_LOCATION_ID ,RECEIVE_LOT_NUMBER ,ORDER_STATUS ,PRICE_LIST ,REQUIREMENT_SYSTEM ,REQUIREMENT_ORG_ID ,SUPPLIER_SYSTEM ,SUPPLIER_ORG_ID ,REQ_LINE_ID ,PROC_GROUP_ID ,GROUP_CODE ,REQUIRE_ITEM_ID ,SUPPLIER_ITEM_ID ,PO_LINE_ID ,OE_LINE_ID ,RCV_TRANSACTION_ID ,STATUS ,STATUS_NAME ,PROCESS_PHASE ,SOURCE_HEADER_ID ,ERROR_MESSAGE ,CREATED_BY ,CREATION_DATE ,LAST_UPDATED_BY ,LAST_UPDATE_DATE ,LAST_UPDATE_LOGIN ,PROGRAM_APPLICATION_ID ,PROGRAM_ID ,PROGRAM_UPDATE_DATE ,REQUEST_ID ,ATTRIBUTE_CATEGORY ,ATTRIBUTE1 ,ATTRIBUTE2 ,ATTRIBUTE3 ,ATTRIBUTE4 ,ATTRIBUTE5 ,ATTRIBUTE6 ,ATTRIBUTE7 ,ATTRIBUTE8 ,ATTRIBUTE9 ,ATTRIBUTE10 ,ATTRIBUTE11 ,ATTRIBUTE12 ,ATTRIBUTE13 ,ATTRIBUTE14 ,ATTRIBUTE15 ,CHOICE_FLAG FROM ( SELECT T.REQ_LINE_NUM ,T.REQ_HEADER_ID ,T.SUPPLIER_ITEM_NUM ,T.SUPPLIER_ITEM_DESC ,T.PRIMARY_UOM_CODE ,T.LOGIST_QUANTITY ,T.RETURN_QUANTITY ,T.REQUEST_QUANTITY ,T.REQ_LOGIST_HEADER_ID ,T.PARAENT_LOGIST_ID ,T.ORDER_HEADER_ID ,T.REQUEST_DATE ,T.RECEIVE_DATE ,T.CURRENCY_CODE ,T.UNIT_PRICE ,T.AMOUNT ,T.BASE_AMOUNT ,T.TAX_PLANNING_FLAG ,T.RETRUN_FLAG ,T.ROLLBACK_FLAG ,T.INVOICE_PRICE_METHOD_DESC ,T.INVOICE_PRICE_SOURCE ,T.AGREEMENT_PRICE ,T.AGREEMENT_AMOUNT ,T.REQUIRE_ITEM_NUM ,T.REQUIRE_ITEM_DESC ,T.PO_NUMBER ,T.PO_LINE_NUM ,T.RECEIPT_NUM ,T.RECEIPT_LINE_NUM ,T.ORDER_NUMBER ,T.OE_LINE_NUMBER ,T.OM_ORDER_TYPE ,T.REQ_LOGIST_ID ,T.AR_TAX_CODE ,T.AP_TAX_CODE ,T.GROUP_NAME ,T.REQUIREMENT_ORG ,T.SUPPLIER_ORG ,T.ORDER_SOURCE_NUM ,T.LOGIST_R_ORDER_NUM ,T.LOGIST_S_ORDER_NUM ,T.SUPPLIER_SHIP_SUBINV ,T.ESB_DATA_SOURCE ,T.INVOICE_GROUP_NAME ,T.ROW_ID ,T.INVOICE_PRICE_METHOD ,T.SUPPLIER_INV_ORG_ID ,T.SUPPLIER_INV_ORG ,T.SUPPLIER_SHIP_LOCATION_ID ,T.ISS_LOT_NUMBER ,T.RECEIVE_INV_ORG_ID ,T.RECEIVE_INV_ORG ,T.RECEIVE_SUBINV ,T.RECEIVE_LOCATION_ID ,T.RECEIVE_LOT_NUMBER ,T.ORDER_STATUS ,T.PRICE_LIST ,T.REQUIREMENT_SYSTEM ,T.REQUIREMENT_ORG_ID ,T.SUPPLIER_SYSTEM ,T.SUPPLIER_ORG_ID ,T.REQ_LINE_ID ,T.PROC_GROUP_ID ,T.GROUP_CODE ,T.REQUIRE_ITEM_ID ,T.SUPPLIER_ITEM_ID ,T.PO_LINE_ID ,T.OE_LINE_ID ,T.RCV_TRANSACTION_ID ,T.STATUS ,T.STATUS_NAME ,T.PROCESS_PHASE ,T.SOURCE_HEADER_ID ,T.ERROR_MESSAGE ,T.CREATED_BY ,T.CREATION_DATE ,T.LAST_UPDATED_BY ,T.LAST_UPDATE_DATE ,T.LAST_UPDATE_LOGIN ,T.PROGRAM_APPLICATION_ID ,T.PROGRAM_ID ,T.PROGRAM_UPDATE_DATE ,T.REQUEST_ID ,T.ATTRIBUTE_CATEGORY ,T.ATTRIBUTE1 ,T.ATTRIBUTE2 ,T.ATTRIBUTE3 ,T.ATTRIBUTE4 ,T.ATTRIBUTE5 ,T.ATTRIBUTE6 ,T.ATTRIBUTE7 ,T.ATTRIBUTE8 ,T.ATTRIBUTE9 ,T.ATTRIBUTE10 ,T.ATTRIBUTE11 ,T.ATTRIBUTE12 ,T.ATTRIBUTE13 ,T.ATTRIBUTE14 ,T.ATTRIBUTE15 ,DECODE(T.AGREEMENT_PRICE,0,'N','Y') CHOICE_FLAG FROM apps.CUX_ICP_INVOICE_REQ_LINES_V T WHERE T.REQ_HEADER_ID IS NULL AND ((T.RETRUN_FLAG = 'Y' /*AND CUX_ICP_STANDARD_PKG.CHECK_LOGIST_INVOICE_FLAG_F(T.REQ_LOGIST_ID) = 'Y'*/) OR (T.RETRUN_FLAG = 'Y' AND /*CUX_ICP_STANDARD_PKG.CHECK_LOGIST_INVOICE_FLAG_F(T.REQ_LOGIST_ID) = 'N' AND*/ T.RECEIVE_DATE IS NOT NULL) OR (T.ROLLBACK_FLAG = 'Y' AND T.RECEIVE_DATE IS NOT NULL)) AND (T.LOGIST_STATUS IN (1,3,5) OR (T.LOGIST_ORDER_STATUS = 'RETURNING' /*AND CUX_ICP_STANDARD_PKG.CHECK_LOGIST_INVOICE_FLAG_F(T.REQ_LOGIST_ID) = 'Y'*/)) AND T.REQUIREMENT_ORG = 'OU_109301_芜湖威灵电机销售' AND T.SUPPLIER_ORG = 'OU_108601_广东威灵电机' AND (T.ESB_DATA_SOURCE = '' OR '' IS NULL) AND (T.OM_ORDER_TYPE = '' OR '' IS NULL) AND (T.SUPPLIER_INV_ORG_ID = '1207' OR '1207' IS NULL) AND (T.CURRENCY_CODE = 'CNY' OR 'CNY' IS NULL) UNION ALL SELECT T.REQ_LINE_NUM ,T.REQ_HEADER_ID ,T.SUPPLIER_ITEM_NUM ,T.SUPPLIER_ITEM_DESC ,T.PRIMARY_UOM_CODE ,T.LOGIST_QUANTITY ,T.RETURN_QUANTITY ,T.REQUEST_QUANTITY ,T.REQ_LOGIST_HEADER_ID ,T.PARAENT_LOGIST_ID ,T.ORDER_HEADER_ID ,T.REQUEST_DATE ,T.RECEIVE_DATE ,T.CURRENCY_CODE ,T.UNIT_PRICE ,T.AMOUNT ,T.BASE_AMOUNT ,T.TAX_PLANNING_FLAG ,T.RETRUN_FLAG ,T.ROLLBACK_FLAG ,T.INVOICE_PRICE_METHOD_DESC ,T.INVOICE_PRICE_SOURCE ,T.AGREEMENT_PRICE ,T.AGREEMENT_AMOUNT ,T.REQUIRE_ITEM_NUM ,T.REQUIRE_ITEM_DESC ,T.PO_NUMBER ,T.PO_LINE_NUM ,T.RECEIPT_NUM ,T.RECEIPT_LINE_NUM ,T.ORDER_NUMBER ,T.OE_LINE_NUMBER ,T.OM_ORDER_TYPE ,T.REQ_LOGIST_ID ,T.AR_TAX_CODE ,T.AP_TAX_CODE ,T.GROUP_NAME ,T.REQUIREMENT_ORG ,T.SUPPLIER_ORG ,T.ORDER_SOURCE_NUM ,T.LOGIST_R_ORDER_NUM ,T.LOGIST_S_ORDER_NUM ,T.SUPPLIER_SHIP_SUBINV ,T.ESB_DATA_SOURCE ,T.INVOICE_GROUP_NAME ,T.ROW_ID ,T.INVOICE_PRICE_METHOD ,T.SUPPLIER_INV_ORG_ID ,T.SUPPLIER_INV_ORG ,T.SUPPLIER_SHIP_LOCATION_ID ,T.ISS_LOT_NUMBER ,T.RECEIVE_INV_ORG_ID ,T.RECEIVE_INV_ORG ,T.RECEIVE_SUBINV ,T.RECEIVE_LOCATION_ID ,T.RECEIVE_LOT_NUMBER ,T.ORDER_STATUS ,T.PRICE_LIST ,T.REQUIREMENT_SYSTEM ,T.REQUIREMENT_ORG_ID ,T.SUPPLIER_SYSTEM ,T.SUPPLIER_ORG_ID ,T.REQ_LINE_ID ,T.PROC_GROUP_ID ,T.GROUP_CODE ,T.REQUIRE_ITEM_ID ,T.SUPPLIER_ITEM_ID ,T.PO_LINE_ID ,T.OE_LINE_ID ,T.RCV_TRANSACTION_ID ,T.STATUS ,T.STATUS_NAME ,T.PROCESS_PHASE ,T.SOURCE_HEADER_ID ,T.ERROR_MESSAGE ,T.CREATED_BY ,T.CREATION_DATE ,T.LAST_UPDATED_BY ,T.LAST_UPDATE_DATE ,T.LAST_UPDATE_LOGIN ,T.PROGRAM_APPLICATION_ID ,T.PROGRAM_ID ,T.PROGRAM_UPDATE_DATE ,T.REQUEST_ID ,T.ATTRIBUTE_CATEGORY ,T.ATTRIBUTE1 ,T.ATTRIBUTE2 ,T.ATTRIBUTE3 ,T.ATTRIBUTE4 ,T.ATTRIBUTE5 ,T.ATTRIBUTE6 ,T.ATTRIBUTE7 ,T.ATTRIBUTE8 ,T.ATTRIBUTE9 ,T.ATTRIBUTE10 ,T.ATTRIBUTE11 ,T.ATTRIBUTE12 ,T.ATTRIBUTE13 ,T.ATTRIBUTE14 ,T.ATTRIBUTE15 ,NVL( (SELECT 'Y' FROM apps.CUX_ICP_LOGIST_REQ_LINES CIL ,apps.CUX_ICP_INVOICE_REQ_LINES_V CIV ,apps.CUX_ICP_LOGIST_REQ_HEADERS CIH WHERE CIL.PARAENT_REQ_LINE_ID = T.REQ_LOGIST_ID AND CIV.REQ_LOGIST_ID = CIL.REQ_LINE_ID AND CIL.REQ_HEADER_ID = CIH.REQ_HEADER_ID AND CIV.RETRUN_FLAG = 'Y' AND CIV.AGREEMENT_PRICE <> 0 AND CIH.ORDER_STATUS <> 'CREATING' AND CIV.REQUIREMENT_ORG = T.REQUIREMENT_ORG AND CIV.SUPPLIER_ORG = T.SUPPLIER_ORG AND CIV.CURRENCY_CODE = T.CURRENCY_CODE AND ROWNUM = 1) ,'N') CHOICE_FLAG FROM apps.CUX_ICP_INVOICE_REQ_LINES_V T WHERE T.REQ_HEADER_ID IS NULL AND T.TAX_PLANNING_FLAG = 'Y' AND (T.LOGIST_STATUS = 5 OR T.LOGIST_ORDER_STATUS = 'PART_CONFIRM') AND T.RECEIVE_DATE <= TO_DATE('2017-2-21 23:59:59','YYYY-MM-DD HH24:MI:SS') AND T.REQUIREMENT_ORG = 'OU_109301_芜湖威灵电机销售' AND T.SUPPLIER_ORG = 'OU_108601_广东威灵电机' AND (T.ESB_DATA_SOURCE = '' OR '' IS NULL) AND (T.OM_ORDER_TYPE = '' OR '' IS NULL) AND (T.SUPPLIER_INV_ORG_ID = '1207' OR '1207' IS NULL) AND (T.CURRENCY_CODE = 'CNY' OR 'CNY' IS NULL) UNION ALL SELECT T.REQ_LINE_NUM ,T.REQ_HEADER_ID ,T.SUPPLIER_ITEM_NUM ,T.SUPPLIER_ITEM_DESC ,T.PRIMARY_UOM_CODE ,T.LOGIST_QUANTITY ,T.RETURN_QUANTITY ,T.REQUEST_QUANTITY ,T.REQ_LOGIST_HEADER_ID ,T.PARAENT_LOGIST_ID ,T.ORDER_HEADER_ID ,T.REQUEST_DATE ,T.RECEIVE_DATE ,T.CURRENCY_CODE ,T.UNIT_PRICE ,T.AMOUNT ,T.BASE_AMOUNT ,T.TAX_PLANNING_FLAG ,T.RETRUN_FLAG ,T.ROLLBACK_FLAG ,T.INVOICE_PRICE_METHOD_DESC ,T.INVOICE_PRICE_SOURCE ,T.AGREEMENT_PRICE ,T.AGREEMENT_AMOUNT ,T.REQUIRE_ITEM_NUM ,T.REQUIRE_ITEM_DESC ,T.PO_NUMBER ,T.PO_LINE_NUM ,T.RECEIPT_NUM ,T.RECEIPT_LINE_NUM ,T.ORDER_NUMBER ,T.OE_LINE_NUMBER ,T.OM_ORDER_TYPE ,T.REQ_LOGIST_ID ,T.AR_TAX_CODE ,T.AP_TAX_CODE ,T.GROUP_NAME ,T.REQUIREMENT_ORG ,T.SUPPLIER_ORG ,T.ORDER_SOURCE_NUM ,T.LOGIST_R_ORDER_NUM ,T.LOGIST_S_ORDER_NUM ,T.SUPPLIER_SHIP_SUBINV ,T.ESB_DATA_SOURCE ,T.INVOICE_GROUP_NAME ,T.ROW_ID ,T.INVOICE_PRICE_METHOD ,T.SUPPLIER_INV_ORG_ID ,T.SUPPLIER_INV_ORG ,T.SUPPLIER_SHIP_LOCATION_ID ,T.ISS_LOT_NUMBER ,T.RECEIVE_INV_ORG_ID ,T.RECEIVE_INV_ORG ,T.RECEIVE_SUBINV ,T.RECEIVE_LOCATION_ID ,T.RECEIVE_LOT_NUMBER ,T.ORDER_STATUS ,T.PRICE_LIST ,T.REQUIREMENT_SYSTEM ,T.REQUIREMENT_ORG_ID ,T.SUPPLIER_SYSTEM ,T.SUPPLIER_ORG_ID ,T.REQ_LINE_ID ,T.PROC_GROUP_ID ,T.GROUP_CODE ,T.REQUIRE_ITEM_ID ,T.SUPPLIER_ITEM_ID ,T.PO_LINE_ID ,T.OE_LINE_ID ,T.RCV_TRANSACTION_ID ,T.STATUS ,T.STATUS_NAME ,T.PROCESS_PHASE ,T.SOURCE_HEADER_ID ,T.ERROR_MESSAGE ,T.CREATED_BY ,T.CREATION_DATE ,T.LAST_UPDATED_BY ,T.LAST_UPDATE_DATE ,T.LAST_UPDATE_LOGIN ,T.PROGRAM_APPLICATION_ID ,T.PROGRAM_ID ,T.PROGRAM_UPDATE_DATE ,T.REQUEST_ID ,T.ATTRIBUTE_CATEGORY ,T.ATTRIBUTE1 ,T.ATTRIBUTE2 ,T.ATTRIBUTE3 ,T.ATTRIBUTE4 ,T.ATTRIBUTE5 ,T.ATTRIBUTE6 ,T.ATTRIBUTE7 ,T.ATTRIBUTE8 ,T.ATTRIBUTE9 ,T.ATTRIBUTE10 ,T.ATTRIBUTE11 ,T.ATTRIBUTE12 ,T.ATTRIBUTE13 ,T.ATTRIBUTE14 ,T.ATTRIBUTE15 ,DECODE(T.AGREEMENT_PRICE,0,'N','Y') CHOICE_FLAG FROM apps.CUX_ICP_INVOICE_REQ_LINES_V T WHERE T.REQ_HEADER_ID IS NULL AND (T.LOGIST_STATUS = 5 OR T.LOGIST_ORDER_STATUS = 'PART_CONFIRM') AND T.TAX_PLANNING_FLAG = 'Y' AND T.RECEIVE_DATE > TO_DATE('2017-2-21 23:59:59','YYYY-MM-DD HH24:MI:SS') AND T.REQUIREMENT_ORG = 'OU_109301_芜湖威灵电机销售' AND T.SUPPLIER_ORG = 'OU_108601_广东威灵电机' AND (T.ESB_DATA_SOURCE = '' OR '' IS NULL) AND (T.OM_ORDER_TYPE = '' OR '' IS NULL) AND (T.SUPPLIER_INV_ORG_ID = '1207' OR '1207' IS NULL) AND (T.CURRENCY_CODE = 'CNY' OR 'CNY' IS NULL) AND EXISTS (SELECT 1 FROM apps.CUX_ICP_LOGIST_REQ_LINES CIL ,apps.CUX_ICP_INVOICE_REQ_LINES_V CIV WHERE CIL.PARAENT_REQ_LINE_ID = T.REQ_LOGIST_ID AND CIV.REQ_LOGIST_ID = CIL.REQ_LINE_ID AND (CIV.LOGIST_STATUS IN (3,5) OR (T.LOGIST_ORDER_STATUS = 'RETURNING' /*AND CUX_ICP_STANDARD_PKG.CHECK_LOGIST_INVOICE_FLAG_F(T.REQ_LOGIST_ID) = 'Y'*/)) AND CIV.RETRUN_FLAG = 'Y' AND CIV.AGREEMENT_PRICE <> 0 AND CIV.REQUIREMENT_ORG = T.REQUIREMENT_ORG AND CIV.SUPPLIER_ORG = T.SUPPLIER_ORG AND CIV.ESB_DATA_SOURCE = T.ESB_DATA_SOURCE AND CIV.CURRENCY_CODE = T.CURRENCY_CODE)) 
/*发货单明细*/
/*限制行，第一部分无意义*/
SELECT SSOQ.LINE_NUMBER,SSOQ.SHIPMENT_DETAIL_ID,SSOQ.SHIPMENT_LINE_ID,SSOQ.SHIPMENT_HEADER_ID,SSOQ.ORGANIZATION_ID,SSOQ.INVENTORY_ITEM_ID,SSOQ.SUBINVENTORY_CODE,SSOQ.SUBINVENTORY,SSOQ.LOCATOR_ID,SSOQ.LOCATOR_CODE,SSOQ.LOT_NUMBER,SSOQ.PO_NUMBER,SSOQ.RECEIPT_NUM,SSOQ.QUANTITY,SSOQ.CHECK_QTY,SSOQ.DATE_RECEIVED 
FROM SCM_SO_ONHAND_QUANTITIES_V SSOQ WHERE 1>2 
UNION ALL 
SELECT SSSD.DETAIL_NUMBER LINE_NUMBER, SSSD.SHIPMENT_DETAIL_ID, SSSD.SHIPMENT_LINE_ID, SSSD.SHIPMENT_HEADER_ID, SSSD.ORGANIZATION_ID, SSSD.INVENTORY_ITEM_ID, SSSD.SUBINVENTORY_CODE, SSOQ.SUBINVENTORY, SSSD.LOCATION_ID, SSOQ.LOCATOR_CODE, SSSD.LOT_NUMBER, SSOQ.PO_NUMBER, SSOQ.RECEIPT_NUM, SSOQ.QUANTITY, SSSD.SHIPMENT_QUANTITY CHECK_QTY, SSOQ.DATE_RECEIVED 
FROM SCM_SO_SHIPMENT_DETAILS SSSD, --发货单明细
SCM_SO_ONHAND_QUANTITIES_V SSOQ --现有量
WHERE SSSD.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID 
AND SSSD.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID 
AND SSSD.SUBINVENTORY_CODE=SSOQ.SUBINVENTORY_CODE 
AND NVL(SSSD.LOCATION_ID,-1)=NVL(SSOQ.LOCATOR_ID,-1) 
AND SSSD.LOT_NUMBER=SSOQ.LOT_NUMBER 
AND SSSD.SHIPMENT_LINE_ID=-1 --还是返回一个空表
UNION ALL 
SELECT SSSD.DETAIL_NUMBER LINE_NUMBER, SSSD.SHIPMENT_DETAIL_ID, SSSD.SHIPMENT_LINE_ID, SSSD.SHIPMENT_HEADER_ID, SSSD.ORGANIZATION_ID, SSSD.INVENTORY_ITEM_ID, SSSD.SUBINVENTORY_CODE, SSOQ.SUBINVENTORY, SSSD.LOCATION_ID, SSOQ.LOCATOR_CODE, SSSD.LOT_NUMBER, SSOQ.PO_NUMBER, SSOQ.RECEIPT_NUM, SSOQ.QUANTITY, SSSD.SHIPMENT_QUANTITY CHECK_QTY, SSOQ.DATE_RECEIVED 
FROM SCM_SO_SHIPMENT_DETAILS SSSD, SCM_SO_ONHAND_QUANTITIES_INT_V SSOQ 
WHERE SSSD.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND SSSD.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND SSSD.SUBINVENTORY_CODE=SSOQ.SUBINVENTORY_CODE 
AND NVL(SSSD.LOCATION_ID,-1)=NVL(SSOQ.LOCATOR_ID,-1) 
AND SSSD.LOT_NUMBER=SSOQ.LOT_NUMBER 
AND SSSD.SHIPMENT_LINE_ID=-1 --空表 × 3
UNION ALL 
/* */
SELECT LINE_NUMBER ,SHIPMENT_DETAIL_ID ,SHIPMENT_LINE_ID ,SHIPMENT_HEADER_ID ,ORGANIZATION_ID ,INVENTORY_ITEM_ID ,SUBINVENTORY_CODE ,SUBINVENTORY ,LOCATOR_ID ,LOCATOR_CODE ,LOT_NUMBER ,PO_NUMBER ,RECEIPT_NUM ,QUANTITY ,CHECK_QTY ,DATE_RECEIVED 
FROM SCM_SO_ONHAND_QUANTITIES_INT_V SSOQ --查找现有量表 
WHERE SSOQ.INVENTORY_ITEM_ID=23859888 AND SSOQ.ORGANIZATION_ID=843 --物料编码和库存组织一致
/*验证同一个库存货位的批次是不是被锁了*/
AND NOT EXISTS (
	SELECT 1 
	FROM CGSCM.SCM_LOCK_LOT SLL --被锁定的批次
	WHERE SLL.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID 
	AND SLL.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID 
	AND SLL.SUBINVENTORY_CODE=SSOQ.SUBINVENTORY_CODE 
	AND NVL(SLL.LOCATION_ID,-1)=NVL(SSOQ.LOCATOR_ID,-1) 
	AND SLL.LOT_NUMBER=SSOQ.LOT_NUMBER 
	AND SLL.LOCK_FLAG='Y'
) 
/*排除已经存在的发货单明细。比较项：现有量的子库货位物料组织批次，现在已经失效，永远是not exist*/
AND NOT EXISTS (
	SELECT 1 
	FROM SCM_SO_SHIPMENT_DETAILS SD 
	WHERE SD.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND SD.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND SD.SUBINVENTORY_CODE=SSOQ.SUBINVENTORY_CODE AND NVL(SD.LOCATION_ID,-1)=NVL(SSOQ.LOCATOR_ID,-1) AND SD.LOT_NUMBER=SSOQ.LOT_NUMBER 
	AND SD.SHIPMENT_LINE_ID=-1 --再次返回空表
) 
AND SSOQ.SUB_TYPE='01' /*子库存的Attribute1的值：01*/
/* new*/
AND (SSOQ.DOCUMENT_DETAIL_ID = 235070 
OR EXISTS ( 
	SELECT 1 
	FROM SCM_SO_LEND_HEADERS LH,
	SCM_SO_LEND_LINES LL
	WHERE LH.HEADER_ID=LL.HEADER_ID
	AND LL.STATUS='APPROVED'
	AND LH.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID 
	AND LL.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID 
	AND LL.LOT_NUMBER=SSOQ.LOT_NUMBER 
	AND LH.TO_SUB_CODE=SSOQ.SUBINVENTORY_CODE 
	AND NVL(LH.TO_LOCATION_ID,-1)=NVL(SSOQ.LOCATOR_ID,-1) 
	AND LL.TO_DOCUMENT_DETAIL_ID=235070 
)
) 
UNION ALL 
SELECT SSOQ.LINE_NUMBER, 
SSOQ.SHIPMENT_DETAIL_ID, S
SOQ.SHIPMENT_LINE_ID, 
SSOQ.SHIPMENT_HEADER_ID, 
SSOQ.ORGANIZATION_ID, 
SSOQ.INVENTORY_ITEM_ID, 
SSOQ.SUBINVENTORY_CODE, 
SSOQ.SUBINVENTORY, 
SSOQ.LOCATOR_ID, 
SSOQ.LOCATOR_CODE, 
SSOQ.LOT_NUMBER, 
SSOQ.PO_NUMBER, 
SSOQ.RECEIPT_NUM, 
SSOQ.QUANTITY, 
SSOQ.CHECK_QTY, 
SSOQ.DATE_RECEIVED 
FROM SCM_SO_ONHAND_QUANTITIES_V SSOQ 
WHERE NOT EXISTS (
	SELECT 1 FROM SCM_SO_SHIPMENT_DETAILS SD 
	WHERE SD.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID 
	AND SD.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID 
	AND SD.SUBINVENTORY_CODE=SSOQ.SUBINVENTORY_CODE 
	AND NVL(SD.LOCATION_ID,-1)=NVL(SSOQ.LOCATOR_ID,-1) 
	AND SD.LOT_NUMBER=SSOQ.LOT_NUMBER 
	AND SD.SHIPMENT_LINE_ID=-1 --？！不存在是-1的line_id？
) 
AND SSOQ.INVENTORY_ITEM_ID=23859985 --限定物料
AND SSOQ.ORGANIZATION_ID=843 AND NOT EXISTS (SELECT 1 FROM CGSCM.SCM_LOCK_LOT SLL WHERE SLL.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND SLL.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND SLL.SUBINVENTORY_CODE=SSOQ.SUBINVENTORY_CODE AND NVL(SLL.LOCATION_ID,-1)=NVL(SSOQ.LOCATOR_ID,-1) AND SLL.LOT_NUMBER=SSOQ.LOT_NUMBER AND SLL.LOCK_FLAG='Y') AND SSOQ.SUB_TYPE='01' AND ( EXISTS ( SELECT 1 FROM RCV_LOT_TRANSACTIONS RLT, RCV_TRANSACTIONS RT, SCM_DM_LINES SDL WHERE (RT.ATTRIBUTE15 IS NULL OR (RT.ATTRIBUTE15 IS NOT NULL AND RT.ATTRIBUTE5 IS NOT NULL)) AND RLT.ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND RLT.LOT_NUM=SSOQ.LOT_NUMBER AND RT.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND RLT.TRANSACTION_ID=RT.TRANSACTION_ID AND RT.PO_LINE_ID=SDL.REF_PO_LINE_ID AND SDL.DOCUMENT_HEADER_ID=51513) OR EXISTS ( SELECT 1 FROM SCM_SO_LEND_HEADERS LH, SCM_SO_LEND_LINES LL WHERE LH.HEADER_ID=LL.HEADER_ID AND LL.STATUS='APPROVED'AND LH.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND LL.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND LL.LOT_NUMBER=SSOQ.LOT_NUMBER AND LH.TO_SUB_CODE=SSOQ.SUBINVENTORY_CODE AND NVL(LH.TO_LOCATION_ID,-1)=NVL(SSOQ.LOCATOR_ID,-1) AND LL.TO_DOCUMENT_DETAIL_ID=235070) ) and (SSOQ.ORGANIZATION_ID=843) and (SSOQ.INVENTORY_ITEM_ID=23859985) order by lot_number
/*new*/
/*old*/
AND (
	--系统存在此批次，MLN.N_ATTRIBUTE30这个属性是NULL
	EXISTS (
		SELECT 1 
		FROM MTL_LOT_NUMBERS MLN 
		WHERE MLN.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND MLN.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND MLN.LOT_NUMBER=SSOQ.LOT_NUMBER AND MLN.N_ATTRIBUTE29 IS NULL AND MLN.N_ATTRIBUTE30 IS NULL
	) 
	OR EXISTS (
		SELECT 1 
		FROM MTL_LOT_NUMBERS MLN 
		WHERE MLN.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND MLN.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND MLN.LOT_NUMBER=SSOQ.LOT_NUMBER AND MLN.N_ATTRIBUTE29 IS NOT NULL AND MLN.N_ATTRIBUTE30 IS NULL
	) 
	OR EXISTS (
		SELECT 1 
		FROM SCM_DM_TYPES DT, --委托书类型
		SCM_DM_HEADERS SD, --委托书头
		SCM_DM_LINES SL, --委托书行
		SCM_DM_DETAILS SDD, --委托书明细
		MTL_LOT_NUMBERS MLN --系统批次
		WHERE DT.DOCUMENT_TYPE_ID=SD.DOCUMENT_TYPE_ID
		AND SD.DOCUMENT_HEADER_ID=SL.DOCUMENT_HEADER_ID 
		AND SL.DOCUMENT_LINE_ID =SDD.DOCUMENT_LINE_ID 
		AND SDD.DOCUMENT_DETAIL_ID=MLN.N_ATTRIBUTE30
		AND MLN.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID 
		AND MLN.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID 
		AND MLN.LOT_NUMBER=SSOQ.LOT_NUMBER 
		AND DT.ATTRIBUTE1='Y'
	) 
	OR EXISTS (
		SELECT 1 
		FROM MTL_ITEM_LOCATIONS MIL 
		WHERE MIL.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND MIL.SUBINVENTORY_CODE=SSOQ.SUBINVENTORY_CODE AND MIL.INVENTORY_LOCATION_ID=SSOQ.LOCATOR_ID AND MIL.ATTRIBUTE1 IS NULL 
	)
) 
/*old*/
UNION ALL 
SELECT SSOQ.LINE_NUMBER, SSOQ.SHIPMENT_DETAIL_ID, SSOQ.SHIPMENT_LINE_ID, SSOQ.SHIPMENT_HEADER_ID, SSOQ.ORGANIZATION_ID, SSOQ.INVENTORY_ITEM_ID, SSOQ.SUBINVENTORY_CODE, SSOQ.SUBINVENTORY, SSOQ.LOCATOR_ID, SSOQ.LOCATOR_CODE, SSOQ.LOT_NUMBER, SSOQ.PO_NUMBER, SSOQ.RECEIPT_NUM, SSOQ.QUANTITY, SSOQ.CHECK_QTY, SSOQ.DATE_RECEIVED 
FROM SCM_SO_ONHAND_QUANTITIES_V SSOQ 
WHERE NOT EXISTS (SELECT 1 FROM SCM_SO_SHIPMENT_DETAILS SD WHERE SD.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND SD.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND SD.SUBINVENTORY_CODE=SSOQ.SUBINVENTORY_CODE AND NVL(SD.LOCATION_ID,-1)=NVL(SSOQ.LOCATOR_ID,-1) AND SD.LOT_NUMBER=SSOQ.LOT_NUMBER AND SD.SHIPMENT_LINE_ID=-1 ) AND SSOQ.INVENTORY_ITEM_ID=23859888 AND SSOQ.ORGANIZATION_ID=843 AND NOT EXISTS (SELECT 1 FROM CGSCM.SCM_LOCK_LOT SLL WHERE SLL.INVENTORY_ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND SLL.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND SLL.SUBINVENTORY_CODE=SSOQ.SUBINVENTORY_CODE AND NVL(SLL.LOCATION_ID,-1)=NVL(SSOQ.LOCATOR_ID,-1) AND SLL.LOT_NUMBER=SSOQ.LOT_NUMBER AND SLL.LOCK_FLAG='Y') AND SSOQ.SUB_TYPE='01' AND (NOT EXISTS (SELECT 1 FROM RCV_LOT_TRANSACTIONS RL, RCV_TRANSACTIONS RT WHERE RT.TRANSACTION_ID=RL.TRANSACTION_ID AND RT.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND RL.ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND RL.LOT_NUM=SSOQ.LOT_NUMBER ) OR EXISTS (SELECT 1 FROM RCV_LOT_TRANSACTIONS RLC, RCV_TRANSACTIONS RTC WHERE RTC.TRANSACTION_ID=RLC.TRANSACTION_ID AND RTC.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND RLC.ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND RLC.LOT_NUM=SSOQ.LOT_NUMBER AND NOT EXISTS (SELECT 1 FROM SCM_DM_LINES SDL WHERE SDL.REF_PO_LINE_ID=RTC.PO_LINE_ID ) AND EXISTS (SELECT 1 FROM MTL_ITEM_LOCATIONS MIL, HR_LOCATIONS_V MLV WHERE MIL.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND MIL.SUBINVENTORY_CODE=SSOQ.SUBINVENTORY_CODE AND MIL.INVENTORY_LOCATION_ID=SSOQ.LOCATOR_ID AND MIL.ATTRIBUTE1=MLV.LOCATION_ID AND MLV.ATTRIBUTE1=1769465)) OR EXISTS (SELECT 1 FROM RCV_LOT_TRANSACTIONS RLD, RCV_TRANSACTIONS RTD WHERE (RTD.ATTRIBUTE15 IS NULL OR (RTD.ATTRIBUTE15 IS NOT NULL AND RTD.ATTRIBUTE5 IS NOT NULL)) AND RTD.TRANSACTION_ID=RLD.TRANSACTION_ID AND RTD.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND RLD.ITEM_ID=SSOQ.INVENTORY_ITEM_ID AND RLD.LOT_NUM=SSOQ.LOT_NUMBER AND EXISTS (SELECT 1 FROM SCM_DM_TYPES DT, SCM_DM_HEADERS SD, SCM_DM_LINES SL WHERE DT.DOCUMENT_TYPE_ID=SD.DOCUMENT_TYPE_ID AND SD.DOCUMENT_HEADER_ID=SL.DOCUMENT_HEADER_ID AND SL.REF_PO_LINE_ID=RTD.PO_LINE_ID AND DT.ATTRIBUTE1='Y')) OR EXISTS (SELECT 1 FROM MTL_ITEM_LOCATIONS MIL WHERE MIL.ORGANIZATION_ID=SSOQ.ORGANIZATION_ID AND MIL.SUBINVENTORY_CODE=SSOQ.SUBINVENTORY_CODE AND MIL.INVENTORY_LOCATION_ID=SSOQ.LOCATOR_ID AND MIL.ATTRIBUTE1 IS NULL )) and (SSOQ.ORGANIZATION_ID=843) and (SSOQ.INVENTORY_ITEM_ID=23859888) order by lot_number
CREATE OR REPLACE VIEW APPS.SCM_SO_ONHAND_QUANTITIES_INT_V AS
SELECT -1 LINE_NUMBER,
       -1 SHIPMENT_DETAIL_ID,
       -1 SHIPMENT_LINE_ID,
       -1 SHIPMENT_HEADER_ID,
       MOQ.ORGANIZATION_ID,
       MOQ.INVENTORY_ITEM_ID,
       MOQ.SUBINVENTORY_CODE,
       MSI.SECONDARY_INVENTORY_NAME||'-'||MSI.DESCRIPTION SUBINVENTORY,
       MOQ.LOCATOR_ID,
       MIL.DESCRIPTION LOCATOR_CODE,
       MOQ.LOT_NUMBER,
       NVL(MSI.ATTRIBUTE1,'*') SUB_TYPE,
       CG_GET_ITEM_PURCHASE_NUMBER(MOQ.ORGANIZATION_ID,MOQ.INVENTORY_ITEM_ID,MOQ.LOT_NUMBER) PO_NUMBER,--从批次和组织、物料编码获取订单号
       SCM_GET_RECEIPT_NUM(MOQ.ORGANIZATION_ID,MOQ.INVENTORY_ITEM_ID,MOQ.LOT_NUMBER) RECEIPT_NUM,
       SUM(NVL(MOQ.TRANSACTION_QUANTITY,0)) QUANTITY,
       0 CHECK_QTY,
       MAX(MOQ.DATE_RECEIVED) DATE_RECEIVED,
       nvl(mln.N_ATTRIBUTE30,-1) DOCUMENT_DETAIL_ID
  FROM MTL_ONHAND_QUANTITIES MOQ,
       MTL_SECONDARY_INVENTORIES MSI,
       MTL_ITEM_LOCATIONS MIL,
       MTL_LOT_NUMBERS   MLN
 WHERE MOQ.ORGANIZATION_ID=MSI.ORGANIZATION_ID
   AND MOQ.SUBINVENTORY_CODE=MSI.SECONDARY_INVENTORY_NAME
   AND MOQ.LOT_NUMBER=MLN.LOT_NUMBER
   AND MOQ.INVENTORY_ITEM_ID=MLN.INVENTORY_ITEM_ID
   AND MOQ.ORGANIZATION_ID=MLN.ORGANIZATION_ID
   AND NVL(MLN.C_ATTRIBUTE30,'N')='Y' --初始数据
   AND MSI.AVAILABILITY_TYPE =1
   AND NVL(MSI.ATTRIBUTE1,'*') IN ('01','07')
   AND NVL(MSI.DISABLE_DATE,SYSDATE+1)>SYSDATE
   AND MOQ.ORGANIZATION_ID=MIL.ORGANIZATION_ID(+)
   AND MOQ.SUBINVENTORY_CODE=MIL.SUBINVENTORY_CODE(+)
   AND MOQ.LOCATOR_ID=MIL.INVENTORY_LOCATION_ID(+)
GROUP BY MOQ.INVENTORY_ITEM_ID,
         MOQ.ORGANIZATION_ID,
         MOQ.SUBINVENTORY_CODE,
         MSI.SECONDARY_INVENTORY_NAME||'-'||MSI.DESCRIPTION,
         MOQ.LOCATOR_ID,
         MIL.DESCRIPTION,
         MOQ.LOT_NUMBER,
         NVL(MSI.ATTRIBUTE1,'*'),
         nvl(mln.N_ATTRIBUTE30,-1)
  HAVING SUM(NVL(MOQ.TRANSACTION_QUANTITY,0))<>0
;
SELECT SSOQ.LINE_NUMBER,SSOQ.SHIPMENT_DETAIL_ID,SSOQ.SHIPMENT_LINE_ID,SSOQ.SHIPMENT_HEADER_ID,SSOQ.ORGANIZATION_ID,SSOQ.INVENTORY_ITEM_ID,SSOQ.SUBINVENTORY_CODE,SSOQ.SUBINVENTORY,SSOQ.LOCATOR_ID,SSOQ.LOCATOR_CODE,SSOQ.LOT_NUMBER,SSOQ.PO_NUMBER,SSOQ.RECEIPT_NUM,SSOQ.QUANTITY,SSOQ.CHECK_QTY,SSOQ.DATE_RECEIVED FROM SCM_SO_ONHAND_QUANTITIES_V SSOQ WHERE 1=2 and (SSOQ.ORGANIZATION_ID=843) and (SSOQ.INVENTORY_ITEM_ID=23859985) order by lot_number；


SELECT SQ.SHIPMENT_HEADER_ID,SQ.SHIPMENT_TYPE_ID,SQ.SHIPMENT_TYPE_NAME,SQ.ORG_ID,SQ.ORG_NAME,SQ.DOCUMENT_HEADER_ID,SQ.DOCUMENT_NUMBER,SQ.CUSTOMER_ID,SQ.CUSTOMER_NUMBER,SQ.CUSTOMER_NAME,SQ.CUSTOMER_SITE_ID,SQ.CUSTOMER_SITE_NAME,SQ.SHIPMENT_NUMBER,SQ.SHIPMENT_DATE,SQ.STATUS,SQ.REMARK,SQ.CREATED_BY,SQ.CREATION_DATE,SQ.LAST_UPDATED_BY,SQ.LAST_UPDATE_DATE,SQ.LAST_UPDATE_LOGIN,SQ.ATTRIBUTE_CATEGORY,SQ.ATTRIBUTE1,SQ.ATTRIBUTE2,SQ.ATTRIBUTE3,SQ.ATTRIBUTE4,SQ.ATTRIBUTE5,SQ.ATTRIBUTE6,SQ.ATTRIBUTE7,SQ.ATTRIBUTE8,SQ.ATTRIBUTE9,SQ.ATTRIBUTE10,SQ.ATTRIBUTE11,SQ.ATTRIBUTE12,SQ.ATTRIBUTE13,SQ.ATTRIBUTE14,SQ.ATTRIBUTE15 FROM SCM_SO_SHIPMENT_HEADERS_V SQ WHERE 1=1 AND SQ.SHIPMENT_NUMBER='1333' AND TRUNC(SQ.SHIPMENT_DATE)<=TRUNC(to_date('12-01-2017','DD-MM-YYYY')) AND EXISTS (
SELECT 1 FROM 
SCM_SM_USER_PERMISSIONS_MV SMV WHERE SMV.CUSTOMER_ID=SQ.CUSTOMER_ID AND SMV.USER_ID=33063 )
AND NOT EXISTS (SELECT 1 FROM SCM_SO_SHIPMENT_TYPES SSST WHERE SSST.SHIPMENT_TYPE_ID=SQ.SHIPMENT_TYPE_ID AND SSST.TRANSACTION_TYPE='04') AND EXISTS (SELECT 1 FROM SCM_SO_SHIPMENT_LINES SL WHERE SL.SHIPMENT_HEADER_ID=SQ.SHIPMENT_HEADER_ID AND SL.SHIPMENT_QUANTITY>SL.INVOICE_QUANTITY ) AND EXISTS (SELECT 1 FROM SCM_SO_CONFIRM_HEADERS CH, SCM_SO_SHIPMENT_ROUTINGS SR WHERE CH.SHIPMENT_HEADER_ID=SQ.SHIPMENT_HEADER_ID AND CH.ROUTING_ID=SR.ROUTING_ID AND NVL(CH.COMPLETE_FLAG,'N')='Y' AND SR.DESTINATION_SUB_TYPE='05')  order by TO_NUMBER(SHIPMENT_NUMBER) DESC

--台账
SELECT INVENTORY_ITEM_ID,ORGANIZATION_ID,attribute3,SALE_DEST,SEGMENT1,DESCRIPTION,PRIMARY_TRANSACTION_QUANTITY,PRIMARY_RESERVATION_QUANTITY,PRIMARY_UNIT_OF_MEASURE,LOT_NUMBER,SUBINVENTORY_CODE,SUBINVENTORY_NAME,LOCATOR_CODE,LOCATION_DESC,DATE_RECEIVED FROM cg_onhand_qty_new_v WHERE trunc(sysdate - DATE_RECEIVED)>=-9999999 AND get_wts_number (organization_id,inventory_item_id,lot_number)= 'WT230116050025' and (ORGANIZATION_ID=843) and (attribute3='02') and (DESCRIPTION LIKE '%%;%%;%%;%%') order by DATE_RECEIVED

SELECT INVENTORY_ITEM_ID,ORGANIZATION_ID,attribute3,SALE_DEST,SEGMENT1,DESCRIPTION,PRIMARY_TRANSACTION_QUANTITY,PRIMARY_RESERVATION_QUANTITY,PRIMARY_UNIT_OF_MEASURE,LOT_NUMBER,SUBINVENTORY_CODE,SUBINVENTORY_NAME,LOCATOR_CODE,LOCATION_DESC,DATE_RECEIVED FROM cg_onhand_qty_new_v WHERE trunc(sysdate - DATE_RECEIVED)>=-9999999 and (ORGANIZATION_ID=1406) and (DESCRIPTION LIKE '%%;%%;%%;%%') and (LOT_NUMBER='BSZ01024') order by DATE_RECEIVED

CREATE OR REPLACE VIEW APPS.CG_ONHAND_QTY_NEW_V AS
SELECT moq.organization_id,
       moq.inventory_item_id,
       hla.location_code sale_dest, --销售意向
       msi.segment1, --编码
       msi.description, --描述
       NULL pur_no, --采购订单号
       NULL wts_number, ----委托书编号
       NULL shipment_number, --发货单编号 add:wuyujin 2009-12-11
       NULL item_ycd, --原产地
       moq.lot_number, --批次/卷号
       SUM(moq.primary_transaction_quantity) primary_transaction_quantity,--现有量
       --现有量-保留数量=可用量
       SUM(DECODE(SIGN(moq.primary_transaction_quantity -
                       NVL(wts_reserve.primary_reservation_quantity, 0)),
                  -1,
                  0,
                  moq.primary_transaction_quantity -
                  NVL(wts_reserve.primary_reservation_quantity, 0)))

       primary_reservation_quantity,
       msi.primary_unit_of_measure,
       moq.subinventory_code, --仓库
       sub.description subinventory_name,
       mil.segment1 locator_code,
       mil.description location_desc, --货位
       moq.date_received, --进仓时间  状况描述
       DECODE(sub.ATTRIBUTE1, '01', '01', '02') ATTRIBUTE3
  FROM 
  --查询批次的现有量，连接了子库存表
	(SELECT moqd.inventory_item_id,
               moqd.organization_id,
               moqd.subinventory_code,
               moqd.locator_id,
               moqd.lot_number,
               moqd.date_received,
               MAX(moqd.create_transaction_id) create_transaction_id, --最新的事务处理id
               SUM(NVL(moqd.primary_transaction_quantity, 0)) primary_transaction_quantity
          FROM apps.mtl_onhand_quantities_detail moqd, --现有量
               apps.mtl_secondary_inventories    sub --子库存
         WHERE moqd.subinventory_code = sub.secondary_inventory_name
           AND moqd.organization_id = sub.organization_id
              -- AND sub.availability_type = '1'
           AND sub.disable_date IS NULL --add by climb 20070831
        -- AND moqd.subinventory_code NOT LIKE 'K%'
        ---update by lingh 20080331
         GROUP BY moqd.inventory_item_id,
                  moqd.organization_id,
                  moqd.subinventory_code,
                  moqd.locator_id,
                  moqd.lot_number,
                  moqd.date_received
        --,moqd.create_transaction_id
        HAVING SUM(NVL(moqd.primary_transaction_quantity, 0)) <> 0) moq,
       apps.mtl_system_items_b msi, --物料
       apps.mtl_item_locations mil, --物料批次
       apps.hr_locations_all hla, --
       apps.mtl_secondary_inventories sub, --子库存表
       (--有行程确认信息，行程确认头未完成，发货单状态不是录入和关闭
	   SELECT sscd.inventory_item_id,
               sscd.source_sub_code subinventory_code,
               sscd.source_location_id locator_id,
               sscd.organization_id,
               sscd.lot_number,
               SUM(NVL(sscd.shipment_quantity, 0)) primary_reservation_quantity
          FROM cgscm.scm_so_confirm_headers  ssch,  --发货单确认
               cgscm.scm_so_confirm_details  sscd,  --发货单确认明细
               cgscm.scm_so_shipment_headers sssh   --发货单
         WHERE ssch.confirm_header_id = sscd.confirm_header_id
           AND ssch.organization_id = sscd.organization_id
           AND ssch.shipment_header_id = sssh.shipment_header_id
           AND sssh.status IN ('OPEN', 'APPROVED')  --发货单生效或者打开状态
              -- AND ssch.source_sub_code = sscd.source_sub_code
              -- AND ssch.source_location_id = sscd.source_location_id
           AND complete_flag <> 'Y' --行程确认未完成
         GROUP BY sscd.inventory_item_id,
                  sscd.source_sub_code,
                  sscd.source_location_id,
                  sscd.organization_id,
                  sscd.lot_number
        UNION
		--录入状态的发货单
        SELECT sssd.inventory_item_id,
               sssd.subinventory_code,
               sssd.location_id,
               sssd.organization_id,
               sssd.lot_number,
               SUM(NVL(sssd.reservation_quantity, 0)) primary_reservation_quantity
          FROM cgscm.scm_so_shipment_details sssd, cgscm.scm_so_shipment_headers sssh --发货单明细
         WHERE sssh.shipment_header_id = sssd.shipment_header_id
           AND sssh.status = 'INITIAL' --录入状态
         GROUP BY sssd.inventory_item_id,
                  sssd.subinventory_code,
                  sssd.location_id,
                  sssd.organization_id,
                  sssd.lot_number
        ------------------------------- add wuyujin 2009-12-23
        UNION
		--库存接口中的数据，已经确认完成但是卡接口的情况
        SELECT sscd.inventory_item_id,
               sscd.source_sub_code subinventory_code,
               sscd.source_location_id locator_id,
               sscd.organization_id,
               sscd.lot_number,
               SUM(NVL(sscd.customer_confirm_qty, 0)) primary_reservation_quantity
          FROM cgscm.scm_so_confirm_headers     ssch,
               cgscm.scm_so_confirm_details     sscd,
               apps.mtl_transactions_interface mti --库存接口
         WHERE ssch.confirm_header_id = sscd.confirm_header_id
           AND ssch.organization_id = sscd.organization_id
           AND ssch.complete_flag = 'Y' --已经完成
           AND mti.source_line_id = sscd.confirm_detail_id --来源行标识跟确认明细标识一致
           AND mti.organization_id = sscd.organization_id
           AND mti.transaction_action_id IN (1, 2) --帐户发放和子库存转移
         GROUP BY sscd.inventory_item_id,
                  sscd.source_sub_code,
                  sscd.source_location_id,
                  sscd.organization_id,
                  sscd.lot_number
         UNION
		 --
         SELECT SLL.INVENTORY_ITEM_ID,
                       SLL.SUBINVENTORY_CODE,
                       SLL.LOCATION_ID,
                       SLL.ORGANIZATION_ID,
                       SLL.LOT_NUMBER,
                       SUM(NVL(MOQD.TRANSACTION_QUANTITY,0)) primary_reservation_quantity
                  FROM cgscm.SCM_LOCK_LOT SLL,mtl_onhand_quantities_detail moqd --被锁的批次
                 WHERE SLL.ORGANIZATION_ID=MOQD.ORGANIZATION_ID
                   AND SLL.INVENTORY_ITEM_ID=MOQD.INVENTORY_ITEM_ID
                   AND SLL.SUBINVENTORY_CODE=MOQD.SUBINVENTORY_CODE
                   AND SLL.LOCATION_ID=MOQD.LOCATOR_ID
                   AND SLL.LOT_NUMBER=MOQD.LOT_NUMBER
                   AND SLL.LOCK_FLAG='Y'
                 GROUP BY sll.inventory_item_id,
                          sll.subinventory_code,
                          sll.location_id,
                          sll.organization_id,
                          sll.lot_number
        ------------------------------- add wuyujin 2009-12-23
        ) wts_reserve --现存的未关闭发货单。BSZ01024只有1868一行
 WHERE msi.organization_id = moq.organization_id
   AND msi.inventory_item_id = moq.inventory_item_id
   AND moq.organization_id = mil.organization_id(+)
   AND moq.locator_id = mil.inventory_location_id(+)
   AND mil.attribute1 = hla.location_id(+)
   AND moq.subinventory_code = sub.secondary_inventory_name
   AND moq.organization_id = sub.organization_id
      -- AND sub.availability_type = '1'
   AND sub.disable_date IS NULL --add by climb 20070831
      --
   AND moq.subinventory_code = wts_reserve.subinventory_code(+)
   AND NVL(moq.locator_id, 0) = NVL(wts_reserve.locator_id(+), 0)
   AND moq.inventory_item_id = wts_reserve.inventory_item_id(+)
   AND moq.organization_id = wts_reserve.organization_id(+)
   AND moq.lot_number = wts_reserve.lot_number(+)
 GROUP BY moq.organization_id,
          moq.inventory_item_id,
          hla.location_code, --销售意向
          msi.segment1, --编码
          msi.description, --描述
          moq.lot_number, --批次/卷号
          msi.primary_unit_of_measure,
          moq.subinventory_code, --仓库
          sub.description,
          mil.segment1,
          mil.description, --货位
          moq.date_received, --进仓时间  状况描述
          sub.ATTRIBUTE1
;
CREATE OR REPLACE VIEW APPS.RCV_VIEW_INTERFACE_V AS
SELECT RTI.ROWID, RTI.CREATION_DATE, RTI.CREATED_BY, RTI.LAST_UPDATE_LOGIN, RTI.LAST_UPDATE_DATE, RTI.LAST_UPDATED_BY, RTI.INTERFACE_TRANSACTION_ID, RTI.TRANSACTION_TYPE, RTI.TRANSACTION_DATE, RTI.QUANTITY, RTI.UNIT_OF_MEASURE, RTI.SHIPMENT_HEADER_ID, RTI.SHIPMENT_LINE_ID, RTI.SOURCE_DOCUMENT_CODE, RTI.DESTINATION_TYPE_CODE, RTI.PRIMARY_UNIT_OF_MEASURE, RTI.PARENT_TRANSACTION_ID, RTI.PO_HEADER_ID, RTI.PO_RELEASE_ID, RTI.PO_LINE_ID, RTI.PO_LINE_LOCATION_ID, RTI.PO_DISTRIBUTION_ID, RTI.PO_REVISION_NUM, RTI.REQUISITION_LINE_ID, RTI.PO_UNIT_PRICE, RTI.CURRENCY_CODE, RTI.CURRENCY_CONVERSION_TYPE, RTI.CURRENCY_CONVERSION_RATE, RTI.CURRENCY_CONVERSION_DATE, RTI.ROUTING_HEADER_ID, RTI.ROUTING_STEP_ID, RTI.DELIVER_TO_PERSON_ID, RTI.DELIVER_TO_LOCATION_ID, RTI.VENDOR_ID, RTI.VENDOR_SITE_ID, RTI.TO_ORGANIZATION_ID, RTI.SUBINVENTORY, RTI.LOCATOR_ID, RTI.LOCATION_ID, RTI.RECEIPT_EXCEPTION_FLAG, RTI.INSPECTION_STATUS_CODE, RTI.VENDOR_LOT_NUM, RTI.COMMENTS, RTI.ATTRIBUTE_CATEGORY, RTI.ATTRIBUTE1, RTI.ATTRIBUTE2, RTI.ATTRIBUTE3, RTI.ATTRIBUTE4, RTI.ATTRIBUTE5, RTI.ATTRIBUTE6, RTI.ATTRIBUTE7, RTI.ATTRIBUTE8, RTI.ATTRIBUTE9, RTI.ATTRIBUTE10, RTI.ATTRIBUTE11, RTI.ATTRIBUTE12, RTI.ATTRIBUTE13, RTI.ATTRIBUTE14, RTI.ATTRIBUTE15, RTI.REQ_DISTRIBUTION_ID, RTI.REASON_ID, RTI.DESTINATION_CONTEXT, RTI.SOURCE_DOC_UNIT_OF_MEASURE, PLC1.DISPLAYED_FIELD TRANSACTION_TYPE_DSP, RSL.GOVERNMENT_CONTEXT, RSL.USSGL_TRANSACTION_CODE, PRL.REQUISITION_HEADER_ID, RSH.RECEIPT_NUM, RSH.SHIPMENT_NUM, RSL.LINE_NUM, RSL.PACKING_SLIP, RTI.ITEM_ID, RTI.ITEM_DESCRIPTION, RTI.CATEGORY_ID, RTI.ITEM_REVISION, RTI.RECEIPT_SOURCE_CODE, MSI.ALLOWED_UNITS_LOOKUP_CODE, MSI.SERIAL_NUMBER_CONTROL_CODE SERIAL_NUMBER_CC, MSI.REVISION_QTY_CONTROL_CODE REVISION_QTY_CONTROL_CODE, MSI.LOT_CONTROL_CODE, NVL(MSI.SHELF_LIFE_CODE, 1) SHELF_LIFE, NVL(MSI.SHELF_LIFE_DAYS, 0) SHELF_DAYS, MSI.ORGANIZATION_ID ITEM_ORGANIZATION_ID, PLC2.DISPLAYED_FIELD INSPECTION_STATUS_DSP, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', NULL, 'PO', PH.SEGMENT1, RSH.SHIPMENT_NUM) PO_NUMBER, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', NULL, PL.LINE_NUM) PO_LINE_NUMBER, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', OEL.SHIPMENT_NUMBER, PLL.SHIPMENT_NUM) PO_SHIPMENT_NUMBER, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', NULL, PR.RELEASE_NUM) PO_RELEASE_NUM, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', NULL, NVL(PL.HAZARD_CLASS_ID, MSI.HAZARD_CLASS_ID)) HAZARD_CLASS_ID, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', NULL, NVL(PL.UN_NUMBER_ID, MSI.UN_NUMBER_ID)) UN_NUMBER_ID, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', NULL, 'PO', POV.VENDOR_NAME, OOD.ORGANIZATION_NAME) VENDOR, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', OETL.NAME, PLC4.DISPLAYED_FIELD) ORDER_TYPE, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', NULL, PH.NOTE_TO_RECEIVER) NOTE_TO_RECEIVER, RSL.COMMENTS INV_REQ_NOTE_TO_RECEIVER, PLC3.DISPLAYED_FIELD DESTINATION_TYPE_DSP, HRL.LOCATION_CODE, RSH.BILL_OF_LADING, RSH.FREIGHT_CARRIER_CODE FREIGHT_CARRIER, RSH.WAYBILL_AIRBILL_NUM, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', NULL, PL.VENDOR_PRODUCT_NUM) VENDOR_ITEM_NUMBER, RRH.ROUTING_NAME, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', OEL.ORDERED_QUANTITY, 'PO', PLL.QUANTITY, RSL.QUANTITY_SHIPPED) ORDERED_QTY, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', OEL.ORDER_QUANTITY_UOM, 'PO', MUM3.UNIT_OF_MEASURE, RSL.UNIT_OF_MEASURE) ORDERED_UOM, TO_DATE(DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', NULL, NVL(PLL.NEED_BY_DATE, PLL.PROMISED_DATE)),'DD-MON-YYYY') DUE_DATE_VENDOR, RSH.EXPECTED_RECEIPT_DATE DUE_DATE_INTERNAL, MTR.REASON_NAME REASON_CODE, HRE.FULL_NAME, RTI.WIP_ENTITY_ID, RTI.WIP_LINE_ID, RTI.WIP_REPETITIVE_SCHEDULE_ID, RTI.WIP_OPERATION_SEQ_NUM, RTI.WIP_RESOURCE_SEQ_NUM, RTI.DEPARTMENT_CODE, RTI.BOM_RESOURCE_ID, PLL.QTY_RCV_EXCEPTION_CODE, RTI.MOVEMENT_ID, RTI.INSPECTION_QUALITY_CODE, RTI.SUBSTITUTE_UNORDERED_CODE, PLC5.DISPLAYED_FIELD, PLC6.DISPLAYED_FIELD, RTI.QA_COLLECTION_ID, RTI.EMPLOYEE_ID, RTI.OE_ORDER_HEADER_ID, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', OEH.ORDER_NUMBER, NULL) OE_ORDER_NUM, RTI.OE_ORDER_LINE_ID, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', OEL.LINE_NUMBER, NULL) OE_ORDER_LINE_NUM, RTI.CUSTOMER_ID, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', OEC.NAME , NULL) CUSTOMER, RTI.CUSTOMER_SITE_ID, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', OEL.SCHEDULE_ARRIVAL_DATE, NULL) DUE_DATE_CUSTOMER, RTI.SECONDARY_QUANTITY, RTI.SECONDARY_UNIT_OF_MEASURE, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', OEL.ORDERED_QUANTITY2, 'PO', PLL.SECONDARY_QUANTITY, RSL.SECONDARY_QUANTITY_SHIPPED) SECONDARY_ORDERED_QTY, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'RMA', MUM5.UNIT_OF_MEASURE, 'PO', MUM4.UNIT_OF_MEASURE, RSL.SECONDARY_UNIT_OF_MEASURE) SECONDARY_ORDERED_UOM, RTI.QC_GRADE QC_GRADE, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'PO', PLL.MATCHING_BASIS,NULL) MATCHING_BASIS, RTI.AMOUNT, FCV.NAME, PJ.NAME, PJA.JOB_DESCRIPTION, DECODE(RTI.ORG_ID, NULL, DECODE(RTI.SOURCE_DOCUMENT_CODE, 'PO', PH.ORG_ID, 'REQ', PRL.ORG_ID, 'RMA', OEH.ORG_ID, NULL), RTI.ORG_ID) ORG_ID, RTI.LCM_SHIPMENT_LINE_ID, RTI.UNIT_LANDED_COST, RTI.PROCESSING_STATUS_CODE, RTI.VALIDATION_FLAG FROM RCV_TRANSACTIONS_INTERFACE RTI, RCV_SHIPMENT_LINES RSL, RCV_SHIPMENT_HEADERS RSH, PO_REQUISITION_LINES PRL, MTL_SYSTEM_ITEMS MSI, MTL_UNITS_OF_MEASURE MUM1, MTL_UNITS_OF_MEASURE MUM2, MTL_UNITS_OF_MEASURE MUM3, MTL_UNITS_OF_MEASURE MUM4, MTL_UNITS_OF_MEASURE MUM5, PO_LOOKUP_CODES PLC1, PO_LOOKUP_CODES PLC2, PO_LOOKUP_CODES PLC3, PO_LOOKUP_CODES PLC4, PO_LOOKUP_CODES PLC5, PO_LOOKUP_CODES PLC6, OE_SOLD_TO_ORGS_V OEC, OE_ORDER_LINES_ALL OEL, OE_ORDER_HEADERS_ALL OEH, OE_TRANSACTION_TYPES_TL OETL, OE_TRANSACTION_TYPES_ALL OET, PO_HEADERS_ALL PH, PO_LINES_ALL PL, PO_LINE_LOCATIONS PLL, PO_RELEASES_ALL PR, PO_VENDORS POV, HR_LOCATIONS_ALL_TL HRL, MTL_TRANSACTION_REASONS MTR, RCV_ROUTING_HEADERS RRH, PER_ALL_PEOPLE_F HRE, ORG_ORGANIZATION_DEFINITIONS OOD, FND_CURRENCIES_VL FCV, PER_JOBS PJ, PO_JOB_ASSOCIATIONS PJA WHERE (RTI.TRANSACTION_TYPE = PLC1.LOOKUP_CODE AND PLC1.LOOKUP_TYPE = 'RCV TRANSACTION TYPE') AND (RTI.SHIPMENT_LINE_ID = RSL.SHIPMENT_LINE_ID(+)) AND (RTI.REQUISITION_LINE_ID = PRL.REQUISITION_LINE_ID (+)) AND (RTI.SHIPMENT_HEADER_ID = RSH.SHIPMENT_HEADER_ID (+)) AND (MSI.INVENTORY_ITEM_ID(+) = RTI.ITEM_ID AND NVL(MSI.ORGANIZATION_ID, RTI.TO_ORGANIZATION_ID) = RTI.TO_ORGANIZATION_ID AND MSI.PRIMARY_UNIT_OF_MEASURE = MUM1.UNIT_OF_MEASURE(+)) AND (RTI.UNIT_OF_MEASURE = MUM2.UNIT_OF_MEASURE(+)) AND (PLC2.LOOKUP_TYPE(+) = 'INSPECTION STATUS' AND PLC2.LOOKUP_CODE(+) = RTI.INSPECTION_STATUS_CODE) AND OEL.LINE_ID(+) = RTI.OE_ORDER_LINE_ID AND OEH.HEADER_ID(+) = RTI.OE_ORDER_HEADER_ID AND OEC.CUSTOMER_ID(+) = RSH.CUSTOMER_ID AND OET.TRANSACTION_TYPE_ID (+) = OEH.ORDER_TYPE_ID AND OET.TRANSACTION_TYPE_ID = OETL.TRANSACTION_TYPE_ID(+) AND OETL.LANGUAGE(+) = USERENV('LANG') AND OET.TRANSACTION_TYPE_CODE(+) = 'ORDER' AND PH.PO_HEADER_ID(+) = RTI.PO_HEADER_ID AND (PL.PO_LINE_ID (+) = RTI.PO_LINE_ID) AND (PLL.LINE_LOCATION_ID (+) = RTI.PO_LINE_LOCATION_ID) AND (PR.PO_RELEASE_ID(+) = RTI.PO_RELEASE_ID) AND POV.VENDOR_ID(+) = RSH.VENDOR_ID AND PLC3.LOOKUP_TYPE(+) = 'RCV DESTINATION TYPE' AND PLC3.LOOKUP_CODE(+) = RTI.DESTINATION_TYPE_CODE AND HRL.LOCATION_ID(+) = NVL(RTI.DELIVER_TO_LOCATION_ID, RTI.LOCATION_ID) AND HRL.LANGUAGE(+) = USERENV('LANG') AND RRH.ROUTING_HEADER_ID(+) = RTI.ROUTING_HEADER_ID AND MUM3.UNIT_OF_MEASURE(+) = PL.UNIT_MEAS_LOOKUP_CODE AND MUM4.UNIT_OF_MEASURE(+) = PLL.SECONDARY_UNIT_OF_MEASURE AND MUM5.UOM_CODE(+) =OEL.ORDERED_QUANTITY_UOM2 AND MTR.REASON_ID (+) = RTI.REASON_ID AND HRE.PERSON_ID (+) = RTI.DELIVER_TO_PERSON_ID AND TRUNC(SYSDATE) BETWEEN HRE.EFFECTIVE_START_DATE (+) AND HRE.EFFECTIVE_END_DATE (+) AND DECODE(HR_SECURITY.VIEW_ALL,'Y','TRUE', HR_SECURITY.SHOW_PERSON (HRE.PERSON_ID (+), HRE.CURRENT_APPLICANT_FLAG (+), HRE.CURRENT_EMPLOYEE_FLAG (+), HRE.CURRENT_NPW_FLAG (+),HRE.EMPLOYEE_NUMBER (+), HRE.APPLICANT_NUMBER (+), HRE.NPW_NUMBER(+))) = 'TRUE' AND DECODE(HR_GENERAL.GET_XBG_PROFILE,'Y', HRE.BUSINESS_GROUP_ID (+), HR_GENERAL.GET_BUSINESS_GROUP_ID) = HRE.BUSINESS_GROUP_ID (+) AND OOD.ORGANIZATION_ID(+) = RTI.FROM_ORGANIZATION_ID AND DECODE(RTI.SOURCE_DOCUMENT_CODE, 'PO', 'PO TYPE', 'SHIPMENT SOURCE TYPE') = PLC4.LOOKUP_TYPE AND DECODE(RTI.TRANSACTION_TYPE, 'UNORDERED', 'STANDARD', DECODE(RTI.SOURCE_DOCUMENT_CODE, 'PO', PH.TYPE_LOOKUP_CODE, RSH.RECEIPT_SOURCE_CODE)) = PLC4.LOOKUP_CODE AND PLC5.LOOKUP_TYPE = 'TRANSACTION STATUS' AND PLC5.LOOKUP_CODE = RTI.TRANSACTION_STATUS_CODE AND PLC6.LOOKUP_TYPE = 'RCV PROCESSING MODE' AND PLC6.LOOKUP_CODE = RTI.PROCESSING_MODE_CODE AND FCV.CURRENCY_CODE (+) = RTI.CURRENCY_CODE AND PJ.JOB_ID (+) = RTI.JOB_ID AND PJA.JOB_ID (+) = RTI.JOB_ID AND NVL(PH.ORG_ID, -99) = NVL(PLL.ORG_ID, -99);

SELECT ROW_ID,NOTIFY_ID,SESSION_ID,FD_SOURCE_ID,FD_SOURCE_TYPE,FD_SOURCE_NAME,ORGANIZATION_ID,INVENTORY_ITEM_ID,ITEM_NO,ITEM_TYPE,VENDOR_ID,VENDOR_CODE,VENDOR_NAME,AGENT_ID,BUYER_ID,FULL_NAME,LOCATION_ID,LOCATION_CODE,SUBINVENTORY,DEPARTMENT_ID,DEPARTMENT_CODE,WIP_ENTITY_ID,WIP_ENTITY_NAME,PLAN_GROUP,SCHEDULED_START_DATE,QUANTITY,PO_ASSIGN_QUANTITY,INSPECT_QTY,UN_ASSIGN_QTY,MATCH_QUANTITY,DATE_REQUIRED,ARRIVED_DATE,COMPLETED_FLAG,COMPLETED_CODE,ITEM_DESCRIPTION,VENDOR_NAME_ALT,VENDOR_NAME_ALT,VENDOR_NAME_ALT,COMMENTS,ERR_MESSAGE,WIP_ENTITY_NAMES,PROJECT_NUMBER,PROJECT_NAME,REQUIRED_QUANTITY,ISSUED_QUANTITY,START_QUANTITY,QUANTITY_COMPLETED,DR_VENDOR_NAME,dr_vendor_id,dr_vendor_site_id,DR_VENDOR_SITE,PROJECT_ID,ATTRIBUTE6 FROM CUX_FED_NOTIFY_V WHERE SESSION_ID = 549491338 AND PO_ASSIGN_QUANTITY > 0 AND ((NVL(ATTRIBUTE6,'N')='Y' AND ORGANIZATION_ID=125) OR ORGANIZATION_ID<>125) AND -1=-1  order by ITEM_NO,FD_SOURCE_ID,VENDOR_CODE,LOCATION_CODE,DEPARTMENT_CODE

--客户开票申请生成
SELECT ROWID,SHIPMENT_NUMBER,LINE_NUMBER,DETAIL_NUMBER,LOT_NUMBER,SHIPMENT_QUANTITY,INVOICE_QUANTITY,BILL_QUANTITY,BACK_QUANTITY,INVOICE_FLAG FROM SCM_SO_SHIPMENT_DETAILS_TMP WHERE (SHIPMENT_NUMBER='192800') and (LINE_NUMBER=1) order by LOT_NUMBER

RA_CUSTOMER_TRX_LINES_V
SELECT ROW_ID,NOTIFY_ID,SESSION_ID,FD_SOURCE_ID,FD_SOURCE_TYPE,FD_SOURCE_NAME,ORGANIZATION_ID,INVENTORY_ITEM_ID,ITEM_NO,ITEM_TYPE,VENDOR_ID,VENDOR_CODE,VENDOR_NAME,AGENT_ID,BUYER_ID,FULL_NAME,LOCATION_ID,LOCATION_CODE,SUBINVENTORY,DEPARTMENT_ID,DEPARTMENT_CODE,WIP_ENTITY_ID,WIP_ENTITY_NAME,PLAN_GROUP,SCHEDULED_START_DATE,QUANTITY,PO_ASSIGN_QUANTITY,INSPECT_QTY,UN_ASSIGN_QTY,MATCH_QUANTITY,DATE_REQUIRED,ARRIVED_DATE,COMPLETED_FLAG,COMPLETED_CODE,ITEM_DESCRIPTION,VENDOR_NAME_ALT,VENDOR_NAME_ALT,VENDOR_NAME_ALT,COMMENTS,ERR_MESSAGE,WIP_ENTITY_NAMES,PROJECT_NUMBER,PROJECT_NAME,REQUIRED_QUANTITY,ISSUED_QUANTITY,START_QUANTITY,QUANTITY_COMPLETED,DR_VENDOR_NAME,dr_vendor_id,dr_vendor_site_id,DR_VENDOR_SITE,PROJECT_ID,ATTRIBUTE6 FROM CUX_FED_NOTIFY_V WHERE SESSION_ID = 501425951 AND PO_ASSIGN_QUANTITY > 0 AND ((NVL(ATTRIBUTE6,'N')='Y' AND ORGANIZATION_ID=125) OR ORGANIZATION_ID<>125) AND -1=-1  order by ITEM_NO,FD_SOURCE_ID,VENDOR_CODE,LOCATION_CODE,DEPARTMENT_CODE


Select * From cgscm.scm_so_shipment_status--AR开票数量取值来源


  CREATE OR REPLACE PACKAGE "APPS"."SCM_AR_REPORT_PKG" is

	function get_pre_date(p_customer_trx_id in number) return date;
	function get_overdue_days_f(p_shipment_id in number) return date;
	function get_overdue_days_f2(p_shipment_id in number) return date;
	function get_overdue_days_f1(p_shipment_number in varchar2
															,p_org_id          in number) return date;
	function get_term(p_customer_trx_id in number) return number;
	function get_order_type(p_order_type_old in varchar2) return varchar2;
	function get_prepay(p_org_id          in number
										 ,p_end_date        in varchar2
										 ,p_customer_id     in number
										 ,p_order_type_name in varchar2) return number;

	-------------------------------------------------------------
	--计算发出商品数据，存入临时表
	-------------------------------------------------------------
	procedure cal_fcsp(p1         out varchar2
										,p2         out varchar2
										,p_end_date varchar2
										,p_org_id   NUMBER
                    ,p_mon_flag varchar2);
	--------------------------------------------------------------------
	--应收帐龄分析总表
	--------------------------------------------------------------------
	procedure jd_receive_report(p_1              out varchar2
														 ,p_2              out varchar2
														 ,p_end_date       in varchar2
														 ,p_org_id         in NUMBER
                             ,p_mon_flag       IN VARCHAR2
														 ,p_order_type     in varchar2
														 ,p_order_type_n   in varchar2 default null
														 ,p_cust_num_start in varchar2
														 ,p_cust_num_end   in varchar2
														 ,p_type           in varchar2);

	--应收帐龄分析总表--按订单类型

	procedure jd_receive_report_type(p_1              out varchar2
																	,p_2              out varchar2
																	,p_end_date       in varchar2
																	,p_request_id     in number
																	,p_order_type     in varchar2
																	,p_order_type_n   in varchar2 default null
																	,p_cust_num_start in varchar2
																	,p_cust_num_end   in varchar2
																	,p_type           in varchar2);
	--应收帐龄分析总表--按产业链

	procedure jd_receive_report_code(p_1              out varchar2
																	,p_2              out varchar2
																	,p_end_date       in varchar2
																	,p_request_id     in number
																	,p_order_type     in varchar2
																	,p_order_type_n   in varchar2 default null
																	,p_cust_num_start in varchar2
																	,p_cust_num_end   in varchar2
																	,p_type           in varchar2);

	--应收帐龄分析总表--按产业链(采购中心)                                  
	procedure jd_receive_report_code_all(p_1              out varchar2
																			,p_2              out varchar2
																			,p_end_date       in varchar2
																			,p_request_id     in varchar2
																			,p_order_type     in varchar2
																			,p_order_type_n   in varchar2 default null
																			,p_cust_num_start in varchar2
																			,p_cust_num_end   in varchar2
																			,p_exclude        in varchar2
																			,p_type           in varchar2);
	--应收帐龄分析总表--按订单类型 (采购中心)                                 
	procedure jd_receive_report_type_all(p_1              out varchar2
																			,p_2              out varchar2
																			,p_end_date       in varchar2
																			,p_request_id     in varchar2
																			,p_order_type     in varchar2
																			,p_order_type_n   in varchar2 default null
																			,p_cust_num_start in varchar2
																			,p_cust_num_end   in varchar2
																			,p_exclude        in varchar2
																			,p_type           in varchar2);
	--JD.客户仓商品帐龄分析表（结算仓）
	procedure jd_goods_account_p(p1                      in varchar2
															,p2                      in varchar2
															,p_organization_id       in number
															,p_customer_number_start in varchar2
															,p_customer_number_end   in varchar2
															,p_big_category_start    in varchar2
															,p_big_category_end      in varchar2
															,p_request_id_new        in number
															,p_request_id_old        in number
															,p_is_temp               in varchar2 default 'N');

	--JD.客户仓商品帐龄分析表（暂收仓）
	procedure jd_goods_account_p2(p1                      in varchar2
															 ,p2                      in varchar2
															 ,p_organization_id       in number
															 ,p_customer_number_start in varchar2
															 ,p_customer_number_end   in varchar2
															 ,p_big_category_start    in varchar2
															 ,p_big_category_end      in varchar2
															 ,p_request_id            in number
															 ,p_is_temp               in varchar2 default 'N');

	--获取某个挑库确认的事务处理的平均成本
	function get_cost(p_transaction_id in number) return number;

	--获取经营单位
	function get_org_id_f(p_organization_id in number) return number;
	--创建临时表数据p_type 01为结算仓，02为暂收仓
	procedure insert_temp(p_org_id                in number
											 ,p_organization_id       in number
											 ,p_customer_number_start in varchar2
											 ,p_customer_number_end   in varchar2
											 ,p_big_category_start    in varchar2
											 ,p_big_category_end      in varchar2
											 ,p_request_id            in number
											 ,p_is_temp               in varchar2
											 ,p_type                  in varchar2);
	--JD.客户仓商品帐龄分析表（结算仓）
	procedure jd_goods_account_p_new(p1                      in varchar2
																	,p2                      in varchar2
																	,p_organization_id       in number
																	,p_customer_number_start in varchar2
																	,p_customer_number_end   in varchar2
																	,p_big_category_start    in varchar2
																	,p_big_category_end      in varchar2
																	,p_request_id_new        in number
																	,p_request_id_old        in number
																	,p_is_temp               in varchar2 default 'N');

	--JD.客户仓商品帐龄分析表（暂收仓）
	procedure jd_goods_account_p2_new(p1                      in varchar2
																	 ,p2                      in varchar2
																	 ,p_organization_id       in number
																	 ,p_customer_number_start in varchar2
																	 ,p_customer_number_end   in varchar2
																	 ,p_big_category_start    in varchar2
																	 ,p_big_category_end      in varchar2
																	 ,p_request_id            in number
																	 ,p_is_temp               in varchar2 default 'N');

	--获取某个挑库确认的事务处理的平均成本
	--  function get_cost(p_transaction_id in number) return number;

	--获取货到逾期天数
	function get_overdue_days_f_new(p_shipment_id in number) return number;
	function get_status(p_confirm_detail_id in number) return varchar2;

	--获取经营单位
	--function get_org_id_f(p_organization_id in number) return number;

	--创建临时表数据p_type 01为结算仓，02为暂收仓
	procedure insert_temp_new(p_org_id                in number
													 ,p_organization_id       in number
													 ,p_customer_number_start in varchar2
													 ,p_customer_number_end   in varchar2
													 ,p_big_category_start    in varchar2
													 ,p_big_category_end      in varchar2
													 ,p_request_id            in number
													 ,p_is_temp               in varchar2
													 ,p_type                  in varchar2);
	--客户对账单  
	procedure jd_ar011(p1                in varchar2
										,p2                in varchar2
										,p_book_id         in number
										,p_org_id          in number
										,p_customer_id     in number
										,p_customer_id_end in number
										,p_date_from       in varchar2
										,p_date_to         in varchar2);

	--应收承兑计息表
	procedure ar_accrual(p1                  out varchar2
											,p2                  out varchar2
											,p_date_b            in varchar2
											,p_date_e            in varchar2
											,p_customer_number_b in varchar2
											,p_customer_number_e in varchar2
											,p_rate              in number
											,p_pay_method        in varchar2
											,p_org_id            in number);

	---销售合同执行情况表                   
	procedure jd_ar005(p1                   in varchar2
										,p2                   in varchar2
										,p_org_id             in number
										,p_customer_num_from  in varchar2
										,p_customer_num_to    in varchar2
										,p_order_date_from    in varchar2
										,p_order_date_to      in varchar2
										,p_pickslip_date_from in varchar2
										,p_pickslip_date_to   in varchar2
										,p_order_num_from     in varchar2
										,p_order_num_to       in varchar2
										,p_order_status       in varchar2
										,p_order_type_id      in number
										,p_type               in varchar2
										,p_userid             in number
										,p_fcsp_schedule      in varchar2
										,p_yn_flag            varchar2 default 'N' --ADDED BY WHJ IN 20050709 清除发出商品余额
										,p_booked_date_from   in varchar2 default null --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户
										,p_booked_date_to     in varchar2 default null --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户
										,p_invoice_date_from  in varchar2 default null
										,p_invoice_date_to    in varchar2 default null
										,p_pick_date_from     in varchar2 default null
										,p_pick_date_to       in varchar2 default null);
	--
	procedure jd_ar005_gy(p1                   in varchar2
											 ,p2                   in varchar2
											 ,p_org_id             in number
											 ,p_customer_num_from  in varchar2
											 ,p_customer_num_to    in varchar2
											 ,p_order_date_from    in varchar2
											 ,p_order_date_to      in varchar2
											 ,p_pickslip_date_from in varchar2
											 ,p_pickslip_date_to   in varchar2
											 ,p_order_num_from     in varchar2
											 ,p_order_num_to       in varchar2
											 ,p_order_status       in varchar2
											 ,p_order_type_id      in number
											 ,p_type               in varchar2
											 ,p_userid             in number
											 ,p_fcsp_schedule      in varchar2
											 ,p_yn_flag            varchar2 default 'N' --ADDED BY WHJ IN 20050709 清除发出商品余额
											 ,p_booked_date_from   in varchar2 default null --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户
											 ,p_booked_date_to     in varchar2 default null --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户
											 ,p_invoice_date_from  in varchar2 default null
											 ,p_invoice_date_to    in varchar2 default null);

	procedure fcsp_jiagong(p_request_id in number
												,p_org_id     in number);

	--JD.应收发票清单                    
	procedure jd_ar002(p1                         in varchar2
										,p2                         in varchar2
										,p_org_id                   in number
										,p_start_date               in varchar2
										,p_end_date                 in varchar2
										,p_customer_number_start    in varchar2
										,p_customer_number_end      in varchar2
										,p_doc_sequence_value_start in varchar2
										,p_doc_sequence_value_end   in varchar2
										,p_cust_trx_type            in varchar2);

	--计算发出商品数据，存入临时表 SCM.
	-------------------------------------------------------------                     
	procedure cal_fcsp_scm(p1         out varchar2
												,p2         out varchar2
												,p_end_date varchar2
												,p_org_id   number);

	--应收账款计息表
	procedure receivables_accrual(p_1              out varchar2
															 ,p_2              out varchar2
															 ,p_end_date       in varchar2
															 ,p_org_id         in number
															 ,p_request_id     in number
															 ,p_order_type     in varchar2
															 ,p_order_type_n   in varchar2 default null
															 ,p_cust_num_start in varchar2
															 ,p_cust_num_end   in varchar2
															 ,p_rate1          in number
															 ,p_rate2          in number
															 ,p_rate3          in number
															 ,p_rate4          in number
															 ,p_rate5          in number);

	--现有量非子库存转移报表
	procedure onhand_notranfer_p(p_1        out varchar2
															,p_2        out varchar2
															,p_end_date in varchar2
															,p_org_id   in number);
end scm_ar_report_pkg;

CREATE OR REPLACE PACKAGE BODY "APPS"."SCM_AR_REPORT_PKG" is
	g_org_id number;

	function get_pre_date(p_customer_trx_id in number) return date is
		v_date         date;
		v_count        integer;
		v_receive_type varchar2(10);
	begin
		--判断时候是新的开票数据
		select count(*)
			into v_count
			from ra_customer_trx_all
		 where customer_trx_id = p_customer_trx_id
			 and attribute2 like 'KP%';
		if v_count = 0
		then
			select distinct trunc(rctlgd.gl_date)
				into v_date
				from ar_receivable_applications_all ara
						,ra_cust_trx_line_gl_dist_all   rctlgd
			 where ara.applied_customer_trx_id = rctlgd.customer_trx_id
				 and rctlgd.account_class = 'REC'
				 and rownum = 1
				 and ara.customer_trx_id = p_customer_trx_id;
		else
			select distinct receive_type
				into v_receive_type
				from scm_dm_headers      sdh
						,ra_customer_trx_all rcta
			 where interface_header_attribute1 = sdh.document_number
				 and rcta.customer_trx_id = p_customer_trx_id;
			if v_receive_type = 'B'
			then
				--票到
				select trunc(min(rcta.trx_date))
					into v_date
					from ra_customer_trx_all rcta
				 where rcta.customer_trx_id = p_customer_trx_id;
			elsif v_receive_type = 'P'
			then
				--预付
				--v_Date := SYSDATE + 1;
				begin
					select get_overdue_days_f2(min(sssl.shipment_header_id)) - 2
						into v_date
						from scm_ra_bill_lines_v       srbl
								,scm_ra_bill_headers       srbh
								,scm_so_shipment_lines     sssl
								,ra_customer_trx_lines_all rctl
								,ra_customer_trx_all       rcta
					 where srbl.header_id = srbh.header_id
						 and rctl.interface_line_attribute4 = srbl.line_id
						 and rctl.customer_trx_id = rcta.customer_trx_id
						 and rctl.interface_line_context(+) = 'DOCUMENT INVOICE'
						 and srbl.shipment_line_id = sssl.shipment_line_id
						 and srbh.status <> 'Cancel'
						 and rcta.customer_trx_id = p_customer_trx_id;
				exception
					when others then
						v_date := sysdate;
				end;
			else
				begin
					select get_overdue_days_f(min(sssl.shipment_header_id))
						into v_date
						from scm_ra_bill_lines_v       srbl
								,scm_ra_bill_headers       srbh
								,scm_so_shipment_lines     sssl
								,ra_customer_trx_lines_all rctl
								,ra_customer_trx_all       rcta
					 where srbl.header_id = srbh.header_id
						 and rctl.interface_line_attribute4 = srbl.line_id
						 and rctl.customer_trx_id = rcta.customer_trx_id
						 and rctl.interface_line_context(+) = 'DOCUMENT INVOICE'
						 and srbl.shipment_line_id = sssl.shipment_line_id
						 and srbh.status <> 'Cancel'
						 and rcta.customer_trx_id = p_customer_trx_id;
				exception
					when others then
						v_date := sysdate;
				end;
			end if;
		
		end if;
	
		return(v_date);
	
	end;
	function get_overdue_days_f(p_shipment_id in number) return date is
		v_confirm_date date; --货到：发货单行程中第一步的确认日期 
		v_pay_days     number; --货到天数
		v_days         number;
	begin
	
		begin
			select sch.confirm_date
				into v_confirm_date
				from scm_so_confirm_details  scd
						,scm_so_shipment_headers ssh
						,scm_so_shipment_lines   ssl
						,scm_so_confirm_headers  sch
						,scm_so_confirm_lines    scl
						,scm_dm_headers          sdh
			 where scd.confirm_line_id = scl.confirm_line_id
				 and scl.shipment_line_id = ssl.shipment_line_id
				 and scl.confirm_header_id = sch.confirm_header_id
				 and ssl.shipment_header_id = ssh.shipment_header_id
				 and ssh.document_header_id = sdh.document_header_id
         AND ssh.shipment_header_id = sch.shipment_header_id
				 and sdh.receive_type = 'S'
				 and sch.confirm_flag = 'Y'
				 and ssh.shipment_header_id = p_shipment_id
				 and rownum = 1
			 order by sch.confirm_header_id;
		exception
			when others then
				v_confirm_date := sysdate + 1;
		end;
		return v_confirm_date;
	
	end get_overdue_days_f;

	function get_overdue_days_f2(p_shipment_id in number) return date is
		v_confirm_date date; --货到：发货单行程中第一步的确认日期 
		v_pay_days     number; --货到天数
		v_days         number;
	begin
	
		begin
			select sch.confirm_date
				into v_confirm_date
				from scm_so_confirm_details  scd
						,scm_so_shipment_headers ssh
						,scm_so_shipment_lines   ssl
						,scm_so_confirm_headers  sch
						,scm_so_confirm_lines    scl
						,scm_dm_headers          sdh
			 where scd.confirm_line_id = scl.confirm_line_id
				 and scl.shipment_line_id = ssl.shipment_line_id
				 and scl.confirm_header_id = sch.confirm_header_id
				 and ssl.shipment_header_id = ssh.shipment_header_id
				 and ssh.document_header_id = sdh.document_header_id
         AND ssh.shipment_header_id = sch.shipment_header_id
				 and sdh.receive_type = 'P'
				 and sch.confirm_flag = 'Y'
				 and ssh.shipment_header_id = p_shipment_id
				 and rownum = 1
			 order by sch.confirm_header_id;
		exception
			when others then
				v_confirm_date := sysdate + 1;
		end;
		return v_confirm_date;
	
	end get_overdue_days_f2;

	function get_overdue_days_f1(p_shipment_number in varchar2
															,p_org_id          in number) return date is
		v_confirm_date date; --货到：发货单行程中第一步的确认日期 
		v_pay_days     number; --货到天数
		v_days         number;
	begin
		if p_shipment_number like 'XN%'
		then
			begin
				select shipment_date
					into v_confirm_date
					from scm_so_shipment_headers_vir
				 where shipment_number = p_shipment_number
					 and org_id = p_org_id;
			exception
				when others then
					v_confirm_date := sysdate;
			end;
		else
			begin
				/*select max(sch.confirm_date)
					into v_confirm_date
					from scm_so_confirm_details  scd
							,scm_so_shipment_headers ssh
							,scm_so_shipment_lines   ssl
							,scm_so_confirm_headers  sch
							,scm_so_confirm_lines    scl
							,scm_dm_headers          sdh
				 where scd.confirm_line_id = scl.confirm_line_id
					 and scl.shipment_line_id = ssl.shipment_line_id
					 and scl.confirm_header_id = sch.confirm_header_id
					 and ssl.shipment_header_id = ssh.shipment_header_id
					 and ssh.document_header_id = sdh.document_header_id
							-- AND sdh.receive_type = 'S'
					 and sch.confirm_flag = 'Y'
					 and ssh.shipment_number = p_shipment_number
					 and scd.organization_id = p_org_id
					 and rownum = 1
				 order by sch.confirm_header_id;*/
        SELECT MAX(SCH.CONFIRM_DATE)
          into v_confirm_date
          FROM CGSCM.SCM_SO_SHIPMENT_HEADERS ssh
              ,SCM_SO_SHIPMENT_LINES         ssl
              ,SCM_SO_CONFIRM_HEADERS        sch
              ,SCM_SO_CONFIRM_LINES          scl
         WHERE ssh.shipment_number = p_shipment_number
           AND ssh.shipment_header_id = ssl.shipment_header_id
           AND ssh.shipment_header_id = sch.shipment_header_id
           AND sch.confirm_header_id = scl.confirm_header_id
           AND ssl.shipment_line_id = scl.shipment_line_id
           AND scl.organization_id = p_org_id
           AND SCH.CONFIRM_FLAG = 'Y'
           ORDER BY SCH.CONFIRM_HEADER_ID;
			exception
				when others then
					v_confirm_date := sysdate;
			end;
		end if;
		return v_confirm_date;
	end get_overdue_days_f1;

	function get_term(p_customer_trx_id in number) return number is
		v_term number;
	begin
		/*SELECT TERM_ID
     INTO v_term
     FROM ra_customer_trx_all
    WHERE CUSTOMER_TRX_ID=p_customer_trx_id;*/
	
		select rct.term_id
			into v_term
			from ar_receivable_applications_all ara
					,ra_customer_trx_all            rct
		 where ara.applied_customer_trx_id = rct.customer_trx_id
			 and rownum = 1
			 and ara.customer_trx_id = p_customer_trx_id;
	
		return(v_term);
	
	end;
	function get_status(p_confirm_detail_id in number) return varchar2 is
		v_count number;
	begin
		select count(*)
			into v_count
			from scm_so_confirm_details ssd
					,mtl_onhand_quantities  moq
		 where ssd.organization_id = moq.organization_id
			 and ssd.inventory_item_id = moq.inventory_item_id
			 and ssd.lot_number = moq.lot_number;
		if v_count = 0
		then
			return '1';
		else
			select count(*)
				into v_count
				from scm_so_confirm_details ssd
						,scm_so_confirm_headers ssh
			 where ssd.confirm_header_id = ssh.confirm_header_id
				 and nvl(ssh.complete_flag
								,'N') = 'N';
			if v_count = 0
			then
				return '2';
			else
				return '3';
			end if;
		end if;
	end;

	function get_order_type(p_order_type_old in varchar2) return varchar2 as
		v_order_type varchar2(100);
	begin
		select document_type_name into v_order_type from jd_order_types_all where order_type_name = p_order_type_old;
		if v_order_type is null
		then
			return p_order_type_old;
		else
			return v_order_type;
		end if;
	exception
		when others then
			return p_order_type_old;
	end;
	function get_prepay(p_org_id          in number
										 ,p_end_date        in varchar2
										 ,p_customer_id     in number
										 ,p_order_type_name in varchar2) return number is
		v_amt_pre_receive number;
	begin
		begin
			select nvl(sum(nvl(araa.amount_applied
												,0) * nvl(acra.exchange_rate
																 ,1))
								,0)
				into v_amt_pre_receive
				from ar_cash_receipts_all           acra
						,ar_receivable_applications_all araa
			 where acra.cash_receipt_id = araa.cash_receipt_id
				 and acra.org_id = p_org_id
				 and acra.pay_from_customer = p_customer_id
				 and get_order_type(nvl(acra.attribute1
															 ,'空订单类型')) like p_order_type_name || '%'
				 and araa.status = 'UNAPP'
				 and araa.gl_date <= to_date(substr(p_end_date
																					 ,1
																					 ,10)
																		,'yyyy/mm/dd');
		exception
			when others then
				v_amt_pre_receive := to_number(null);
		end;
		return v_amt_pre_receive;
	end;

	-----------------------------------------------------------------------
	--计算发出商品的数据，存入临时表
	-----------------------------------------------------------------------
	procedure cal_fcsp(p1         out varchar2
										,p2         out varchar2
										,p_end_date varchar2
										,p_org_id   NUMBER
                    ,p_mon_flag varchar2) is
		v_end_date date;
	
		cursor c(p_organization_id in number) is
		--发货部分
		/*select distinct null Transaction_Id,
                                      --scd.customer_confirm_qty Transaction_Quantity,
                                      Decode(Scd.Customer_Confirm_Qty - Ssd.Invoice_Quantity,
                                       0,
                                       Scd.Customer_Confirm_Qty,
                                       Scd.Customer_Confirm_Qty - Ssd.Invoice_Quantity) Transaction_Quantity,
                                      scd.unit_measure Transaction_Uom,
                                      NVL(sch.CONFIRM_DATE, SYSDATE) Transaction_Date, --Mmt.Transaction_Date
                                      Scd.Confirm_Detail_Id,
                                      Scl.Confirm_Line_Id
                                      
                                     ,
                                      Ssd.Shipment_Detail_Id,
                                      Ssl.Shipment_Line_Id,
                                      Ssl.Sale_Price
                                      
                                     ,
                                      Ssh.Shipment_Header_Id,
                                      Ssh.Customer_Id,
                                      Ssh.Customer_Site_Id
                                      
                                     ,
                                      Dh.Document_Header_Id,
                                      Dh.Document_Type_Id,
                                      Dh.Receive_Type,
                                      Dh.Pay_Days,
                                      '01' sub_type,
                                      scd.inventory_item_id,
                                      scd.lot_number,
                                      ssd.invoice_quantity
                        from cgscm.Scm_So_Confirm_Details  Scd,
                             cgscm.Scm_So_Confirm_Lines    Scl,
                             cgscm.Scm_So_Shipment_Details Ssd,
                             cgscm.Scm_So_Shipment_Lines   Ssl,
                             cgscm.Scm_So_Shipment_Headers Ssh,
                             cgscm.Scm_So_Confirm_Headers  Sch,
                             cgscm.Scm_Dm_Headers          Dh,
                             \* apps.mtl_onhand_quantities    moq,*\
                             SCM_SO_SHIPMENT_ROUTINGS ssu
                       where Scd.Confirm_Line_Id = Scl.Confirm_Line_Id
                         AND Scd.Shipment_Detail_Id = Ssd.Shipment_Detail_Id
                         AND Ssd.Shipment_Line_Id = Ssl.Shipment_Line_Id
                         AND Ssl.Shipment_Header_Id = Ssh.Shipment_Header_Id
                         AND Ssh.Document_Header_Id = Dh.Document_Header_Id
                         and Sch.Confirm_header_Id = Scl.Confirm_header_Id
                         and Sch.CONFIRM_HEADER_ID = scd.CONFIRM_HEADER_ID
                         and nvl(sch.COMPLETE_FLAG, 'N') = 'Y'
                         and sch.routing_id = ssu.routing_id
                         and ssu.forward_status = '05'
                         and ssh.Status in ('APPROVED', 'OPEN', 'CLOSE', 'INITIAL')
                         and decode(scd.confirm_shipment,'N',0,scd.customer_confirm_qty) > 0
                            \*  and MOQ.ORGANIZATION_ID = ssd.organization_id
                                                                                                                         AND MOQ.INVENTORY_ITEM_ID = ssd.INVENTORY_ITEM_ID
                                                                                                                         AND MOQ.TRANSACTION_QUANTITY = scd.customer_confirm_qty
                                                                                                                         AND MOQ.LOT_NUMBER = SSD.LOT_NUMBER
                                                                                                                         and moq.SUBINVENTORY_CODE in
                                                                                                                             (SELECT Msi.Secondary_Inventory_Name
                                                                                                                                FROM apps.Mtl_Secondary_Inventories Msi
                                                                                                                               WHERE Msi.Attribute1 IN ('05')
                                                                                                                                 AND Msi.Organization_Id = P_organization_id)*\
                         and trunc(NVL(sch.CONFIRM_DATE, SYSDATE)) <= trunc(v_End_Date)
                         and ssd.organization_id = P_organization_id \* in
                                                                                                                                         (SELECT Ood.Organization_Id
                                                                                                                                            FROM Org_Organization_Definitions Ood
                                                                                                                                           WHERE Ood.Operating_Unit = p_Org_Id)*\
                         --And (scd.customer_confirm_qty-ssd.invoice_quantity)>0
                         AND NOT EXISTS
                       (SELECT 1
                                FROM Scm_Ra_Bill_Lines_Detail Rbd,
                                     Scm_Ra_Bill_Lines        Rbl,
                                     Scm_Ra_Bill_Headers      Rbh
                               WHERE Rbd.Shipment_Detail_Id = Ssd.Shipment_Detail_Id
                                 AND Rbd.Line_Id = Rbl.Line_Id
                                 AND Rbl.Header_Id = Rbh.Header_Id
                                 And Decode(Rbd.Invoice_Quantity,
                                      0,
                                      Rbd.Bill_Quantity,
                                      Rbd.Invoice_Quantity) = Scd.Customer_Confirm_Qty
                                 AND Rbh.Status = 'Close');*/
		
		--20111202 修改            
			select null transaction_id
						,scd.customer_confirm_qty - nvl(rb.bill_quantity
																					 ,0) transaction_quantity
						,scd.unit_measure transaction_uom
						,nvl(sch.confirm_date
								,sysdate) transaction_date
						,scd.confirm_detail_id
						,scl.confirm_line_id
						,ssd.shipment_detail_id
						,ssl.shipment_line_id
						,ssl.sale_price
						,ssh.shipment_header_id
						,ssh.customer_id
						,ssh.customer_site_id
						,dh.document_header_id
						,dh.document_type_id
						,dh.receive_type
						,dh.pay_days
						,'01' sub_type
						,scd.inventory_item_id
						,scd.lot_number
						,ssd.invoice_quantity
						,rb.bill_quantity
				from cgscm.scm_so_confirm_details scd
						,cgscm.scm_so_confirm_lines scl
						,cgscm.scm_so_shipment_details ssd
						,cgscm.scm_so_shipment_lines ssl
						,cgscm.scm_so_shipment_headers ssh
						,cgscm.scm_so_confirm_headers sch
						,cgscm.scm_dm_headers dh
						,cgscm.scm_so_shipment_routings ssu
						,(select sum(decode(rbd.invoice_quantity
															 ,0
															 ,rbd.bill_quantity
															 ,rbd.invoice_quantity)) bill_quantity
										,rbd.shipment_detail_id
								from cgscm.scm_ra_bill_lines_detail rbd
										,cgscm.scm_ra_bill_lines        rbl
										,cgscm.scm_ra_bill_headers      rbh
							 where rbd.line_id = rbl.line_id
								 and rbl.header_id = rbh.header_id
								 and rbh.status = 'Close'
								 and rbh.org_id = p_org_id
							 group by rbd.shipment_detail_id) rb
			 where scd.confirm_line_id = scl.confirm_line_id
				 and scd.shipment_detail_id = ssd.shipment_detail_id
				 and ssd.shipment_line_id = ssl.shipment_line_id
				 and ssl.shipment_header_id = ssh.shipment_header_id
				 and ssh.document_header_id = dh.document_header_id
				 and sch.confirm_header_id = scl.confirm_header_id
				 and sch.confirm_header_id = scd.confirm_header_id
				 and rb.shipment_detail_id(+) = ssd.shipment_detail_id
				 and nvl(sch.complete_flag
								,'N') = 'Y'
				 and sch.routing_id = ssu.routing_id
				 and ssu.forward_status = '05'
				 and ssh.status in ('APPROVED'
													 ,'OPEN'
													 ,'CLOSE'
													 ,'INITIAL')
				 and decode(scd.confirm_shipment
									 ,'N'
									 ,0
									 ,scd.customer_confirm_qty) > 0
				 and scd.customer_confirm_qty - nvl(rb.bill_quantity
																					 ,0) <> 0
				 and trunc(nvl(sch.confirm_date
											,sysdate)) <= trunc(v_end_date)
				 and ssd.organization_id = p_organization_id;
		--And Ssh.Shipment_Number = '10621'
	
		cursor c_2(p_request_id in number) is
			select null                     transaction_id
						,scd.customer_confirm_qty transaction_quantity
						,scd.unit_measure         transaction_uom
						,
						 --NVL(sch.CONFIRM_DATE, SYSDATE) Transaction_Date --Mmt.Transaction_Date
						 get_overdue_days_f1(ssh.shipment_number
																,ssd.organization_id) transaction_date
						,scd.confirm_detail_id
						,scl.confirm_line_id
						 
						,ssd.shipment_detail_id
						,ssl.shipment_line_id
						,ssl.sale_price
						 
						,ssh.shipment_header_id
						,ssh.customer_id
						,ssh.customer_site_id
						 
						,dh.document_header_id
						,dh.document_type_id
						,dh.receive_type
						,dh.pay_days
						,'02' sub_type
						,scd.inventory_item_id
						,scd.lot_number
						,ssd.invoice_quantity
				from cgscm.scm_so_confirm_details  scd
						,cgscm.scm_so_confirm_lines    scl
						,cgscm.scm_so_shipment_details ssd
						,cgscm.scm_so_shipment_lines   ssl
						,cgscm.scm_so_shipment_headers ssh
						,cgscm.scm_so_confirm_headers  sch
						,cgscm.scm_dm_headers          dh
			 where scd.confirm_line_id = scl.confirm_line_id
				 and scd.shipment_detail_id = ssd.shipment_detail_id
				 and ssd.shipment_line_id = ssl.shipment_line_id
				 and ssl.shipment_header_id = ssh.shipment_header_id
				 and ssh.document_header_id = dh.document_header_id
				 and sch.confirm_header_id = scl.confirm_header_id
				 and sch.confirm_header_id = scd.confirm_header_id
				 and nvl(sch.complete_flag
								,'N') = 'N'
				 and scd.source_sub_code in
						 (select msi.secondary_inventory_name
								from apps.mtl_secondary_inventories msi
							 where msi.attribute1 in ('03'
																			 ,'04')
								 and msi.organization_id in (select ood.organization_id
																							 from apps.org_organization_definitions ood
																							where ood.operating_unit = p_org_id))
				 and trunc(get_overdue_days_f1(ssh.shipment_number
																			,ssd.organization_id)) <= trunc(v_end_date)
				 and ssd.organization_id in
						 (select ood.organization_id from org_organization_definitions ood where ood.operating_unit = p_org_id)
			/*union all
      SELECT null Transaction_Id,
             SSDV.SHIPMENT_QUANTITY,
             SSLV.UNIT_MEASURE,
             SSHV.SHIPMENT_DATE,
             NULL,
             NULL,
             SsdV.Shipment_Detail_Id,
             SslV.Shipment_Line_Id,
             SslV.Sale_Price,
             SshV.Shipment_Header_Id,
             SshV.Customer_Id,
             SshV.Customer_Site_Id,
             Dh.Document_Header_Id,
             Dh.Document_Type_Id,
             Dh.Receive_Type,
             Dh.Pay_Days,
             '03' sub_type,
             SSLV.inventory_item_id,
             SSDV.lot_number,
             SSDV.invoice_quantity
        FROM SCM_SO_SHIPMENT_DETAILS_VIR SSDV,
             SCM_SO_SHIPMENT_HEADERS_VIR SSHV,
             SCM_SO_SHIPMENT_LINES_VIR   SSLV,
             cgscm.Scm_Dm_Headers        Dh
       WHERE SSHV.SHIPMENT_HEADER_ID = SSLV.SHIPMENT_HEADER_ID
         AND SSLV.SHIPMENT_LINE_ID = SSDV.SHIPMENT_LINE_ID
         AND SSHV.SHIPMENT_HEADER_ID = SSDV.SHIPMENT_HEADER_ID
         AND SSHV.DOCUMENT_HEADER_ID = DH.DOCUMENT_HEADER_ID
         AND PROCESS_FLAG = 1
         AND ACTIVE_FLAG = 'Y'
         and trunc(NVL(SSHV.SHIPMENT_DATE, SYSDATE)) <= trunc(v_End_Date)
         and ssdv.organization_id in
             (SELECT Ood.Organization_Id
                FROM Org_Organization_Definitions Ood
               WHERE Ood.Operating_Unit = p_Org_Id)*/
			;
	
		v_request_id       number;
		v_transaction_date date;
		v_organization_id  number;
		v_count            number;
	begin
		select cgscm.scm_rpt_fcsp_request_s.nextval into v_request_id from dual;
		v_end_date := to_date(p_end_date
												 ,'YYYY/MM/DD hh24:mi:ss');
		fnd_file.put_line(fnd_file.log
										 ,'v_End_Date:' || v_end_date);
		/*    SELECT Ood.Organization_Id
     INTO V_Organization_Id
     FROM Org_Organization_Definitions Ood
    WHERE Ood.Operating_Unit = p_Org_Id;*/
	
		/*    select hoiv.organization_id
     into v_organization_id
     from hr_organization_information_v hoiv,
          org_organization_definitions  ood
    where hoiv.organization_id = ood.organization_id
      and hoiv.org_information_context = 'CLASS'
      and ood.operating_unit = p_org_id
      and ood.organization_name not like '%主组织%'
      AND ood.organization_id <> 662;*/
	
		select hoiv.organization_id
			into v_organization_id
			from hr_organization_information_v hoiv
					,org_organization_definitions  ood
					,fnd_lookup_values_vl          flv
		 where hoiv.organization_id = ood.organization_id
			 and hoiv.org_information_context = 'CLASS'
			 and flv.lookup_code = hoiv.organization_id
			 and flv.lookup_type = 'SCM_IND_PRICE_ORG'
			 and ood.operating_unit = p_org_id
			 and hoiv.organization_id <> 662
			 and organization_name not like '%库存主组织%';
	
		--1.发出商品数据：取库存事物类型已SCM开头（即发货时子库转移，不包含开票时的账户别名发放），仓库为结算仓的库存事物。
		/*    DELETE FROM SCM_RPT_FCSP_DETAILS
    WHERE Org_Id = p_Org_Id
      AND End_Date = v_End_Date;*/
		for r in c(v_organization_id)
		loop
			--计算发货单开始计算账龄的时间和
			if r.receive_type <> 'S'
			then
				--票到
				/*begin
         select Trunc(min(rcta.CREATION_DATE))
           into v_Transaction_Date
           from scm_ra_bill_lines_v srbl,
                scm_ra_bill_headers srbh,
                RA_CUSTOMER_TRX_LINES_ALL rctl,
                RA_CUSTOMER_TRX_ALL RCTA
          where srbl.header_id =srbh.header_id
            and RCTL.INTERFACE_LINE_ATTRIBUTE4 = SRBL.LINE_ID
            and RCTL.CUSTOMER_TRX_ID = RCTA.CUSTOMER_TRX_ID
            and RCTL.INTERFACE_LINE_CONTEXT(+) = 'DOCUMENT INVOICE'
            and srbl.shipment_line_id =r.Shipment_Line_Id
            and srbh.status<>'Cancel';
         exception 
            when others then
              v_Transaction_Date:=sysdate;
        end ; */
				v_transaction_date := sysdate + 1;
			else
				v_transaction_date := get_overdue_days_f(r.shipment_header_id);
			end if;
		
			--判断是否存在库存
			select count(*)
				into v_count
				from apps.mtl_onhand_quantities moq
			 where moq.organization_id = v_organization_id
				 and moq.inventory_item_id = r.inventory_item_id
				 and moq.lot_number = r.lot_number;
			if v_count > 0
			then
			
				insert into scm_rpt_fcsp_details
					(request_id
					,end_date
					,org_id
					,customer_id
					,customer_site_id
					 
					,transaction_id
					,confirm_detail_id
					,confirm_line_id
					,shipment_detail_id
					,shipment_line_id
					,shipment_header_id
					,document_header_id
					 
					,transaction_quantity
					,transaction_uom
					,transaction_date
					,sale_price
					,receive_type
					,due_days
					,document_type_id
					 
					,created_by
					,creation_date
					,last_updated_by
					,last_update_date
					,sub_type
					,transaction_date_old
					,inventory_item_id
					,lot_number
					,invoice_quantity
          ,mon_flag)
					select v_request_id
								,v_end_date
								,p_org_id
								,r.customer_id
								,r.customer_site_id
								 
								,r.transaction_id
								,r.confirm_detail_id
								,r.confirm_line_id
								,r.shipment_detail_id
								,r.shipment_line_id
								,r.shipment_header_id
								,r.document_header_id
								 
								,r.transaction_quantity
								,r.transaction_uom
								,v_transaction_date
								,r.sale_price
								,r.receive_type
								,nvl(r.pay_days
										,0)
								,r.document_type_id
								 
								,0
								,sysdate
								,0
								,sysdate
								,r.sub_type
								,r.transaction_date
								,r.inventory_item_id
								,r.lot_number
								,r.invoice_quantity
                ,p_mon_flag
						from dual;
			end if;
		end loop;
		fnd_file.put_line(fnd_file.log
										 ,'detail complieted');
		/*    --根据销售结算方式，取不同的计算到期日期：货到，转移到结算子库的事物日期；票到、预付款，无逾期
    Update Scm_Rpt_Fcsp_Details
       Set Due_Days = 999999999 --设为最大数，代表不逾期
     Where Receive_Type In ('B', 'P')
       And Request_Id = v_Request_Id
       And Org_Id = p_Org_Id
       and sub_type='01';*/
		fnd_file.put_line(fnd_file.log
										 ,'begin sum');
		for r in c_2(v_request_id)
		loop
			if r.receive_type <> 'S'
			then
				--票到
				/*begin
         select Trunc(min(rcta.CREATION_DATE))
           into v_Transaction_Date
           from scm_ra_bill_lines_v srbl,
                scm_ra_bill_headers srbh,
                RA_CUSTOMER_TRX_LINES_ALL rctl,
                RA_CUSTOMER_TRX_ALL RCTA
          where srbl.header_id =srbh.header_id
            and RCTL.INTERFACE_LINE_ATTRIBUTE4 = SRBL.LINE_ID
            and RCTL.CUSTOMER_TRX_ID = RCTA.CUSTOMER_TRX_ID
            and RCTL.INTERFACE_LINE_CONTEXT(+) = 'DOCUMENT INVOICE'
            and srbl.shipment_line_id =r.Shipment_Line_Id
            and srbh.status<>'Cancel';
         exception 
            when others then
              v_Transaction_Date:=sysdate;
        end ; */
				v_transaction_date := sysdate + 1;
			else
				v_transaction_date := get_overdue_days_f(r.shipment_header_id);
			end if;
		
			insert into scm_rpt_fcsp_details
				(request_id
				,end_date
				,org_id
				,customer_id
				,customer_site_id
				 
				,transaction_id
				,confirm_detail_id
				,confirm_line_id
				,shipment_detail_id
				,shipment_line_id
				,shipment_header_id
				,document_header_id
				 
				,transaction_quantity
				,transaction_uom
				,transaction_date
				,sale_price
				,receive_type
				,due_days
				,document_type_id
				 
				,created_by
				,creation_date
				,last_updated_by
				,last_update_date
				,sub_type
				,transaction_date_old
				,inventory_item_id
				,lot_number
				,invoice_quantity
        ,mon_flag)
				select v_request_id
							,v_end_date
							,p_org_id
							,r.customer_id
							,r.customer_site_id
							 
							,r.transaction_id
							,r.confirm_detail_id
							,r.confirm_line_id
							,r.shipment_detail_id
							,r.shipment_line_id
							,r.shipment_header_id
							,r.document_header_id
							 
							,r.transaction_quantity
							,r.transaction_uom
							,v_transaction_date
							,r.sale_price
							,r.receive_type
							,nvl(r.pay_days
									,0)
							,r.document_type_id
							 
							,0
							,sysdate
							,0
							,sysdate
							,r.sub_type
							,r.transaction_date
							,r.inventory_item_id
							,r.lot_number
							,r.invoice_quantity
              ,p_mon_flag
					from dual;
		
		end loop;
		fnd_file.put_line(fnd_file.log
										 ,'detail complieted');
		--根据销售结算方式，取不同的计算到期日期：货到，转移到结算子库的事物日期；票到、预付款，无逾期
		/*    Update Scm_Rpt_Fcsp_Details
      Set Due_Days = 999999999 --设为最大数，代表不逾期
    Where Receive_Type In ('B', 'P')
      And Request_Id = v_Request_Id
      And Org_Id = p_Org_Id
      and sub_type='02';*/
		fnd_file.put_line(fnd_file.log
										 ,'begin sum');
	
		/*    DELETE FROM SCM_RPT_FCSP_SUM
    WHERE Org_Id = p_Org_Id
      AND End_Date = v_End_Date;*/
	
		insert into scm_rpt_fcsp_sum
			(request_id
			,end_date
			,org_id
			,customer_number
			,customer_name
			,order_type_name
			,txn_transaction_date
			,due_days
			,quantity_cust
			,actual_quantity_cust
			,amount_cust
			,actual_amount_cust
			,sub_type
			,transaction_date
      ,mon_flag)
			select rfd.request_id
						,rfd.end_date
						,p_org_id
						,cust.account_number
						,party.party_name
						,dt.document_type_name order_type_name
						,transaction_date txn_transaction_date
						,due_days
						,nvl(sum(round(transaction_quantity
													,5))
								,0) quantity_cust
						,nvl(sum(round(transaction_quantity
													,5))
								,0) actual_quantity_cust
						,nvl(sum(round(transaction_quantity
													,5) * sale_price)
								,0) amount_cust
						,nvl(sum(round(transaction_quantity
													,5) * sale_price)
								,0) actual_amount_cust
						,decode(sub_type
									 ,'03'
									 ,'02'
									 ,sub_type)
						,transaction_date_old
            ,p_mon_flag
				from scm_rpt_fcsp_details rfd
						,scm_dm_types         dt
						,hz_cust_accounts     cust
						,hz_parties           party
			 where rfd.document_type_id = dt.document_type_id
				 and rfd.customer_id = cust.cust_account_id
				 and cust.party_id = party.party_id
				 and cust.status = 'A'
				 and rfd.request_id = v_request_id
				 and rfd.org_id = p_org_id
			 group by rfd.request_id
							 ,rfd.end_date
							 ,cust.account_number
							 ,party.party_name
							 ,dt.document_type_name
							 ,transaction_date
							 ,due_days
							 ,sub_type
							 ,transaction_date_old;
		fnd_file.put_line(fnd_file.log
										 ,'end sum');
		--2.客户结算仓库存其他来源数据
		/*DELETE FROM SCM_RPT_ACCOUNT_OINV_DETAILS
     WHERE End_Date = v_End_Date
       AND Org_Id = p_Org_Id;
    INSERT INTO SCM_RPT_ACCOUNT_OINV_DETAILS
      (Request_Id,
       End_Date,
       Org_Id,
       Subinventory_Code,
       Customer_Number,
       Customer_Name,
       Date_Received,
       Transaction_Type_Name,
       Uom,
       Qty)
      SELECT v_Request_Id,
             v_End_Date,
             p_Org_Id,
             Moqd.Subinventory_Code,
             Rc.Customer_Number,
             Rc.Customer_Name,
             TRUNC(Moqd.Date_Received) Date_Received,
             Mtt.Transaction_Type_Name,
             Sib.Primary_Unit_Of_Measure Uom,
             SUM(Moqd.Primary_Transaction_Quantity) Qty
        FROM Mtl_Onhand_Quantities_Detail Moqd,
             Mtl_System_Items_b           Sib,
             Mtl_Secondary_Inventories    Msi,
             Mtl_Material_Transactions    Mmt,
             Mtl_Transaction_Types        Mtt,
             Ra_Customers                 Rc
       WHERE Moqd.Inventory_Item_Id = Sib.Inventory_Item_Id
         AND Moqd.Organization_Id = Sib.Organization_Id
         AND Moqd.Subinventory_Code = Msi.Secondary_Inventory_Name
         AND Moqd.Create_Transaction_Id = Mmt.Transaction_Id
         AND Mmt.Transaction_Type_Id = Mtt.Transaction_Type_Id
         AND Sib.Segment1 NOT LIKE '106%'
            --And Moqd.Subinventory_Code Like 'K%'
            --And Moqd.Subinventory_Code Not Like 'KB%'
            --And Moqd.Subinventory_Code Not Like 'KP%'
         AND Moqd.Subinventory_Code IN
             (SELECT Msi.Secondary_Inventory_Name
                FROM Mtl_Secondary_Inventories Msi
               WHERE Msi.Attribute3 = '05'
                 AND Msi.Organization_Id IN
                     (SELECT Ood.Organization_Id
                        FROM Org_Organization_Definitions Ood
                       WHERE Ood.Operating_Unit = p_Org_Id))
         AND Mtt.Transaction_Type_Name NOT LIKE 'SCM%'
         AND Mtt.Transaction_Type_Name != '销售订单挑库' --排出历史销售订单挑库数据
            
         AND Msi.Attribute1 = Rc.Customer_Id(+) --?此弹性域是否尚使用
            --参数
         AND Moqd.Organization_Id IN
             (SELECT Ood.Organization_Id
                FROM Org_Organization_Definitions Ood
               WHERE Ood.Operating_Unit = p_Org_Id)
      --And Rc.Customer_Number >= Nvl(p_Customer_Number_Start
      --                             ,Rc.Customer_Number)
      --And Rc.Customer_Number <= Nvl(p_Customer_Number_End
      --                             ,Rc.Customer_Number)
       GROUP BY Moqd.Subinventory_Code,
                Mtt.Transaction_Type_Name,
                Rc.Customer_Number,
                Rc.Customer_Name,
                TRUNC(Moqd.Date_Received),
                Sib.Primary_Unit_Of_Measure;*/
		commit;
	end;
	procedure jd_receive_report(p_1              out varchar2
														 ,p_2              out varchar2
														 ,p_end_date       in varchar2
														 ,p_org_id         in NUMBER
                             ,p_mon_flag       IN VARCHAR2
														 ,p_order_type     in varchar2
														 ,p_order_type_n   in varchar2 default null
														 ,p_cust_num_start in varchar2
														 ,p_cust_num_end   in varchar2
														 ,p_type           in varchar2) is
		v_line_str       varchar2(4000);
		v_sep            varchar2(5);
		v_request_id     number;
		v_request_id_old number;
		--
		v_qty number := 0;
		v_amt number := 0;
		--
		v_flag  varchar2(1);
		v_flag1 varchar2(1);
		--
		cursor c1(c_request_id in number) is
			select customer_id
						,customer_number
						,customer_name
						,customer_class_code
						,customer_type_1
						,order_type_name
						,nvl(round(sum(amt_pre_receive)
											,2)
								,0) amt_pre_receive
						,nvl(round(sum(amt_receive)
											,2)
								,0) amt_receive
						,nvl(round(sum(amt_fcsp)
											,2)
								,0) amt_fcsp
						,nvl(round(sum(amt_fcsp1)
											,2)
								,0) amt_fcsp1
						,nvl(round(sum(amt_receive_not_due)
											,2)
								,0) amt_receive_not_due
						,nvl(round(sum(amt_fcsp_not_due)
											,2)
								,0) amt_fcsp_not_due
						,nvl(round(sum(amt_fcsp_not_due1)
											,2)
								,0) amt_fcsp_not_due1
						,nvl(round(sum(amt_receive_0_30)
											,2)
								,0) amt_receive_0_30
						,nvl(round(sum(amt_fcsp_0_30)
											,2)
								,0) amt_fcsp_0_30
						,nvl(round(sum(amt_fcsp_0_301)
											,2)
								,0) amt_fcsp_0_301
						,nvl(round(sum(amt_receive_31_60)
											,2)
								,0) amt_receive_31_60
						,nvl(round(sum(amt_fcsp_31_60)
											,2)
								,0) amt_fcsp_31_60
						,nvl(round(sum(amt_fcsp_31_601)
											,2)
								,0) amt_fcsp_31_601
						,nvl(round(sum(amt_receive_61_90)
											,2)
								,0) amt_receive_61_90
						,nvl(round(sum(amt_fcsp_61_90)
											,2)
								,0) amt_fcsp_61_90
						,nvl(round(sum(amt_fcsp_61_901)
											,2)
								,0) amt_fcsp_61_901
						,nvl(round(sum(amt_receive_91_180)
											,2)
								,0) amt_receive_91_180
						,nvl(round(sum(amt_fcsp_91_180)
											,2)
								,0) amt_fcsp_91_180
						,nvl(round(sum(amt_fcsp_91_1801)
											,2)
								,0) amt_fcsp_91_1801
						,nvl(round(sum(amt_receive_181_270)
											,2)
								,0) amt_receive_181_270
						,nvl(round(sum(amt_fcsp_181_270)
											,2)
								,0) amt_fcsp_181_270
						,nvl(round(sum(amt_fcsp_181_2701)
											,2)
								,0) amt_fcsp_181_2701
						,nvl(round(sum(amt_receive_271_360)
											,2)
								,0) amt_receive_271_360
						,nvl(round(sum(amt_fcsp_271_360)
											,2)
								,0) amt_fcsp_271_360
						,nvl(round(sum(amt_fcsp_271_3601)
											,2)
								,0) amt_fcsp_271_3601
						,nvl(round(sum(amt_receive_361)
											,2)
								,0) amt_receive_361
						,nvl(round(sum(amt_fcsp_361)
											,2)
								,0) amt_fcsp_361
						,nvl(round(sum(amt_fcsp_3611)
											,2)
								,0) amt_fcsp_3611
				from (
							--发出商品
							select customer_id
										 ,customer_number
										 ,customer_name
										 ,customer_class_code
										 ,customer_type_1
										 ,order_type_name
										 ,sum(0) amt_pre_receive
										 ,0 amt_receive
										 ,sum(nvl(amt
														 ,0)) amt_fcsp
										 ,sum(nvl(amt1
														 ,0)) amt_fcsp1
										 ,0 amt_receive_not_due
										 ,sum(nvl(amt_not_due
														 ,0)) amt_fcsp_not_due
										 ,sum(nvl(amt_not_due1
														 ,0)) amt_fcsp_not_due1
										 ,0 amt_receive_0_30
										 ,sum(nvl(amt_0_30
														 ,0)) amt_fcsp_0_30
										 ,sum(nvl(amt_0_301
														 ,0)) amt_fcsp_0_301
										 ,0 amt_receive_31_60
										 ,sum(nvl(amt_31_60
														 ,0)) amt_fcsp_31_60
										 ,sum(nvl(amt_31_601
														 ,0)) amt_fcsp_31_601
										 ,0 amt_receive_61_90
										 ,sum(nvl(amt_61_90
														 ,0)) amt_fcsp_61_90
										 ,sum(nvl(amt_61_901
														 ,0)) amt_fcsp_61_901
										 ,0 amt_receive_91_180
										 ,sum(nvl(amt_91_180
														 ,0)) amt_fcsp_91_180
										 ,sum(nvl(amt_91_1801
														 ,0)) amt_fcsp_91_1801
										 ,0 amt_receive_181_270
										 ,sum(nvl(amt_181_270
														 ,0)) amt_fcsp_181_270
										 ,sum(nvl(amt_181_2701
														 ,0)) amt_fcsp_181_2701
										 ,0 amt_receive_271_360
										 ,sum(nvl(amt_271_360
														 ,0)) amt_fcsp_271_360
										 ,sum(nvl(amt_271_3601
														 ,0)) amt_fcsp_271_3601
										 ,0 amt_receive_361
										 ,sum(nvl(amt_361
														 ,0)) amt_fcsp_361
										 ,sum(nvl(amt_3611
														 ,0)) amt_fcsp_3611
								from (select rc.customer_id
														 ,jat2.customer_number
														 ,jat2.customer_name
														 ,rc.customer_class_code
														 ,rc.attribute1 customer_type_1
														 ,get_order_type(jat2.order_type_name) order_type_name
														 ,sum(nvl(jat2.actual_quantity_cust
																		 ,jat2.quantity_cust)) qty
														 ,sum(nvl(jat2.actual_amount_cust
																		 ,jat2.amount_cust)) amt
														 ,0 amt1
															--
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0))
																		,-1
																		,sum(nvl(nvl(actual_quantity_cust
																								,quantity_cust)
																						,0))
																		,0) qty_not_due
														 ,0 qty_not_due1 --<0
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0))
																		,-1
																		,sum(nvl(actual_amount_cust
																						,amount_cust))
																		,0) amt_not_due
														 ,0 amt_not_due1 --<0
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0))
																		,-1
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 30)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_0_30
														 ,0 qty_0_301 -->=0 and <=30
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0))
																		,-1
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 30)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_0_30
														 ,0 amt_0_301 -->=0 and <=30
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 30)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 60)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_31_60
														 ,0 qty_31_601 -->30 and <=60
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 30)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 60)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_31_60
														 ,0 amt_31_601 -->30 and <=60
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 60)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 90)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_61_90
														 ,0 qty_61_901 -->60 and <=90
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 60)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 90)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_61_90
														 ,0 amt_61_901 -->60 and <=90
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 90)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 180)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_91_180
														 ,0 qty_91_1801 -->90 and <=180
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 90)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 180)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_91_180
														 ,0 amt_91_1801 -->90 and <=180
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 180)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 270)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_181_270
														 ,0 qty_181_2701 -->180 and <=270
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 180)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 270)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_181_270
														 ,0 amt_181_2701 -->180 and <=270
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 270)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 360)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_271_360
														 ,0 qty_271_3601 -->270 and <=360
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 270)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 360)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_271_360
														 ,0 amt_271_3601 -->270 and <=360
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 360)
																		,-1
																		,0
																		,0
																		,0
																		,sum(nvl(nvl(actual_quantity_cust
																								,quantity_cust)
																						,0))) qty_361
														 ,0 qty_3611 -->360
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 360)
																		,-1
																		,0
																		,0
																		,0
																		,sum(nvl(actual_amount_cust
																						,amount_cust))) amt_361
														 ,0 amt_3611 -->360
												 from scm_rpt_fcsp_sum jat2
														 ,ar_customers     rc
												where jat2.quantity_cust > 0
													and jat2.customer_number = rc.customer_number
													and jat2.sub_type = '01'
														 --                             --另外需要获取最大的request_id
													and jat2.request_id = v_request_id
													and jat2.customer_number between nvl(p_cust_num_start
																															,jat2.customer_number) and
															nvl(p_cust_num_end
																 ,jat2.customer_number)
													and jat2.order_type_name = nvl(p_order_type_n
																												,jat2.order_type_name)
												group by rc.customer_id
																,jat2.customer_number
																,jat2.customer_name
																,rc.customer_class_code
																,rc.attribute1
																,get_order_type(jat2.order_type_name)
																,jat2.txn_transaction_date
																,jat2.due_days
											 union all
											 select rc.customer_id
														 ,jat2.customer_number
														 ,jat2.customer_name
														 ,rc.customer_class_code
														 ,rc.attribute1 customer_type_1
														 ,get_order_type(jat2.order_type_name)
														 ,sum(nvl(jat2.actual_quantity_cust
																		 ,jat2.quantity_cust)) qty
														 ,0 amt
														 ,sum(nvl(jat2.actual_amount_cust
																		 ,jat2.amount_cust)) amt1
															--
														 ,0 qty_not_due
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0))
																		,-1
																		,sum(nvl(nvl(actual_quantity_cust
																								,quantity_cust)
																						,0))
																		,0) qty_not_due1
														 ,0 amt_not_due1 --<0
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0))
																		,-1
																		,sum(nvl(actual_amount_cust
																						,amount_cust))
																		,0) amt_not_due1
														 ,0 qty_0_30 --<0
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0))
																		,-1
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 30)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_0_301
														 ,0 amt_0_30 -->=0 and <=30
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0))
																		,-1
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 30)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_0_301
														 ,0 qty_31_60 -->=0 and <=30
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 30)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 60)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_31_601
														 ,0 amt_31_60 -->30 and <=60
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 30)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 60)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_31_601
														 ,0 qty_61_90 -->30 and <=60
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 60)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 90)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_61_901
														 ,0 amt_61_90 -->60 and <=90
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 60)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 90)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_61_901
														 ,0 qty_91_180 -->60 and <=90
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 90)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 180)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_91_1801
														 ,0 amt_91_180 -->90 and <=180
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 90)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 180)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_91_1801
														 ,0 qty_181_270 -->90 and <=180
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 180)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 270)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_181_2701
														 ,0 amt_181_270 -->180 and <=270
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 180)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 270)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_181_2701
														 ,0 qty_271_360 -->180 and <=270
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 270)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 360)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_271_3601
														 ,0 amt_271_360 -->270 and <=360
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 270)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																								 nvl(due_days
																										,0) - 360)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_271_3601
														 ,0 qty_361 -->270 and <=360
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 360)
																		,-1
																		,0
																		,0
																		,0
																		,sum(nvl(nvl(actual_quantity_cust
																								,quantity_cust)
																						,0))) qty_3611
														 ,0 amt_361 -->360
														 ,decode(sign(trunc(sysdate) - trunc(txn_transaction_date) -
																					nvl(due_days
																						 ,0) - 360)
																		,-1
																		,0
																		,0
																		,0
																		,sum(nvl(actual_amount_cust
																						,amount_cust))) amt_3611 -->360
												 from scm_rpt_fcsp_sum jat2
														 ,ar_customers     rc
												where jat2.quantity_cust > 0
													and jat2.customer_number = rc.customer_number
													and jat2.sub_type = '02'
														 --                             --另外需要获取最大的request_id
													and jat2.request_id = v_request_id
													and jat2.customer_number between nvl(p_cust_num_start
																															,jat2.customer_number) and
															nvl(p_cust_num_end
																 ,jat2.customer_number)
													and jat2.order_type_name = nvl(p_order_type_n
																												,jat2.order_type_name)
												group by rc.customer_id
																,jat2.customer_number
																,jat2.customer_name
																,rc.customer_class_code
																,rc.attribute1
																,get_order_type(jat2.order_type_name)
																,jat2.txn_transaction_date
																,jat2.due_days)
							 group by customer_id
												,customer_number
												,customer_name
												,customer_class_code
												,customer_type_1
												,order_type_name
							--应收帐款
							union all
							select t.customer_id
										 ,hca.account_number
										 ,hp.party_name
										 ,hca.customer_class_code cust_class
										 ,hca.attribute1 customer_type_1
										 ,t.order_type
										 ,get_prepay(p_org_id
																,p_end_date
																,t.customer_id
																,t.order_type) amt_pre_receive
										 ,sum(ar_amount) amt_receive
										 ,0 amt_fcsp
										 ,0 amt_fcsp1
										 ,sum(ar_00) amt_receive_not_due
										 ,0 amt_fcsp_not_due
										 ,0
										 ,sum(ar_30) amt_receive_0_30
										 ,0 amt_fcsp_0_30
										 ,0
										 ,sum(ar_60) amt_receive_31_60
										 ,0 amt_fcsp_31_60
										 ,0
										 ,sum(ar_90) amt_receive_61_90
										 ,0 amt_fcsp_61_90
										 ,0
										 ,sum(ar_180) amt_receive_91_180
										 ,0 amt_fcsp_91_180
										 ,0
										 ,sum(ar_270) amt_receive_181_270
										 ,0 amt_fcsp_181_270
										 ,0
										 ,sum(ar_360) amt_receive_271_360
										 ,0 amt_fcsp_271_360
										 ,0
										 ,sum(ar_361) amt_receive_361
										 ,0 amt_fcsp_361
										 ,0
								from (select a.customer_id
															--,c.Name
														 ,a.order_type
														 ,(a.sum_amount - nvl(b.app_amount
																								 ,0)) * nvl(c.rate
																													 ,1) ar_amount
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - nvl(c.due_days
																																									,0))
																		,1
																		,0
																		,(a.sum_amount - nvl(b.app_amount
																												,0)) * nvl(c.rate
																																	,1)) ar_00
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - nvl(c.due_days
																																									,0))
																		,1
																		,decode(sign(to_date(substr(p_end_date
																															 ,1
																															 ,10)
																												,'yyyy/mm/dd') - a.trx_date -
																								 nvl(c.due_days
																										,0) - 30)
																					 ,1
																					 ,0
																					 ,a.sum_amount - nvl(b.app_amount
																															,0)) * nvl(c.rate
																																				,1)) ar_30
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - nvl(c.due_days
																																									,0) - 30)
																		,1
																		,decode(sign(to_date(substr(p_end_date
																															 ,1
																															 ,10)
																												,'yyyy/mm/dd') - a.trx_date -
																								 nvl(c.due_days
																										,0) - 60)
																					 ,1
																					 ,0
																					 ,a.sum_amount - nvl(b.app_amount
																															,0)) * nvl(c.rate
																																				,1)) ar_60
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - nvl(c.due_days
																																									,0) - 60)
																		,1
																		,decode(sign(to_date(substr(p_end_date
																															 ,1
																															 ,10)
																												,'yyyy/mm/dd') - a.trx_date -
																								 nvl(c.due_days
																										,0) - 90)
																					 ,1
																					 ,0
																					 ,sum_amount - nvl(b.app_amount
																														,0)) * nvl(c.rate
																																			,1)) ar_90
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - nvl(c.due_days
																																									,0) - 90)
																		,1
																		,decode(sign(to_date(substr(p_end_date
																															 ,1
																															 ,10)
																												,'yyyy/mm/dd') - a.trx_date -
																								 nvl(c.due_days
																										,0) - 180)
																					 ,1
																					 ,0
																					 ,sum_amount - nvl(b.app_amount
																														,0)) * nvl(c.rate
																																			,1)) ar_180
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - nvl(c.due_days
																																									,0) - 180)
																		,1
																		,decode(sign(to_date(substr(p_end_date
																															 ,1
																															 ,10)
																												,'yyyy/mm/dd') - a.trx_date -
																								 nvl(c.due_days
																										,0) - 270)
																					 ,1
																					 ,0
																					 ,sum_amount - nvl(b.app_amount
																														,0)) * nvl(c.rate
																																			,1)) ar_270
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - nvl(c.due_days
																																									,0) - 270)
																		,1
																		,decode(sign(to_date(substr(p_end_date
																															 ,1
																															 ,10)
																												,'yyyy/mm/dd') - a.trx_date -
																								 nvl(c.due_days
																										,0) - 360)
																					 ,1
																					 ,0
																					 ,sum_amount - nvl(b.app_amount
																														,0)) * nvl(c.rate
																																			,1)) ar_360
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - nvl(c.due_days
																																									,0) - 360)
																		,1
																		,a.sum_amount - nvl(b.app_amount
																											 ,0)) * nvl(c.rate
																																 ,1) ar_361
											 
												 from (select rcta.trx_number
																		 ,rcta.customer_trx_id
																		 ,rcta.bill_to_customer_id customer_id
																		 ,nvl(get_pre_date(rcta.customer_trx_id)
																				 ,trunc(rcta.trx_date) --2012-3-26修改
																					/*decode(TRUNC(Rctlgd.Gl_Date),
                                          to_date('2010-9-30', 'yyyy-mm-dd'),
                                          trunc(rcta.trx_date),
                                          TRUNC(Rctlgd.Gl_Date))*/) trx_date
																		 , --updated by wuyujin 2010-10-16
																			rctt.name inv_type
																		 ,nvl(get_term(rcta.customer_trx_id)
																				 ,rcta.term_id) term_id
																		 ,get_order_type(decode(nvl(rcta.attribute11
																															 ,'N/A')
																													 ,'N/A'
																													 ,decode(substr(interface_header_attribute3
																																				 ,1
																																				 ,2)
																																	,'KP'
																																	,decode(rcta.interface_header_attribute12
																																				 ,'N/A'
																																				 ,interface_header_attribute2
																																				 ,null
																																				 ,'空订单类型'
																																				 ,rcta.interface_header_attribute12)
																																	,decode(rcta.interface_header_attribute2
																																				 ,'0'
																																				 ,'空订单类型'
																																				 ,null
																																				 ,'空订单类型'
																																				 ,rcta.interface_header_attribute2))
																													 ,rcta.attribute11)) order_type --
																		 ,rcta.invoice_currency_code curr_code
																		 ,sum(rctlgd.amount * nvl(rcta.exchange_rate
																														 ,1)) sum_amount
																 from ra_customer_trx_all          rcta
																		 ,ra_customer_trx_lines_all    rctla
																		 ,ra_cust_trx_types_all        rctt
																		 ,ra_cust_trx_line_gl_dist_all rctlgd
																where rcta.customer_trx_id = rctla.customer_trx_id
																	and rcta.org_id = p_org_id
																	and rcta.complete_flag = 'Y'
																	and rcta.cust_trx_type_id = rctt.cust_trx_type_id
																	and rctla.customer_trx_line_id = rctlgd.customer_trx_line_id
																	and rctt.post_to_gl = 'Y'
																	and rctt.accounting_affect_flag = 'Y' --过滤发票
																		 --2011-09-29
																	and rcta.previous_customer_trx_id is null
																	and not exists
																(select 1
																				 from ra_customer_trx_all r
																				where r.previous_customer_trx_id = rcta.customer_trx_id)
																		 --单据类型
																	and (get_order_type(decode(nvl(rcta.attribute11
																																,'N/A')
																														,'N/A'
																														,decode(rcta.interface_header_attribute2
																																	 ,'0'
																																	 ,'空订单类型'
																																	 ,null
																																	 ,'空订单类型'
																																	 ,rcta.interface_header_attribute2)
																														,rcta.attribute11)) in
																			(p_order_type
																			 ,p_order_type_n) or (p_order_type is null and p_order_type_n is null))
																		 
																	and rctlgd.gl_date <= to_date(substr(p_end_date
																																			,1
																																			,10)
																															 ,'yyyy/mm/dd') + 1439 / 1440
																group by rcta.trx_number
																				,rcta.customer_trx_id
																				,rcta.bill_to_customer_id
																				,
																				 /*decode(TRUNC(Rctlgd.Gl_Date),
                                         to_date('2010-9-30', 'yyyy-mm-dd'),
                                         trunc(rcta.trx_date),
                                         TRUNC(Rctlgd.Gl_Date)),*/ --2012-3-26修改
																				 trunc(rcta.trx_date)
																				,rctt.name
																				,rcta.invoice_currency_code
																				,get_order_type(decode(nvl(rcta.attribute11
																																	,'N/A')
																															,'N/A'
																															,decode(substr(interface_header_attribute3
																																						,1
																																						,2)
																																		 ,'KP'
																																		 ,decode(rcta.interface_header_attribute12
																																						,'N/A'
																																						,interface_header_attribute2
																																						,null
																																						,'空订单类型'
																																						,rcta.interface_header_attribute12)
																																		 ,decode(rcta.interface_header_attribute2
																																						,'0'
																																						,'空订单类型'
																																						,null
																																						,'空订单类型'
																																						,rcta.interface_header_attribute2))
																															,rcta.attribute11))
																				,rcta.term_id) a
														 ,(select araa.applied_customer_trx_id
																		 ,sum(araa.amount_applied * nvl(ps.exchange_rate
																																	 ,1)) app_amount
																 from ar_receivable_applications_all araa
																		 ,ar_cash_receipts_all           acra
																		 ,ar_payment_schedules_all       ps
																where araa.cash_receipt_id = acra.cash_receipt_id
																	and ps.payment_schedule_id = araa.applied_payment_schedule_id
																	and nvl(araa.status
																				 ,'APP') = 'APP'
																	and araa.gl_date <= to_date(substr(p_end_date
																																		,1
																																		,10)
																														 ,'yyyy/mm/dd') + 1439 / 1440
																	and nvl(acra.org_id
																				 ,2) = p_org_id
																		 
																	and (get_order_type(nvl(acra.attribute1
																												 ,'空订单类型')) in (p_order_type
																																				,p_order_type_n) or
																			(p_order_type is null and p_order_type_n is null))
															 
																group by araa.applied_customer_trx_id
															 having sum(araa.amount_applied) <> 0) b
														 ,(select rcta.customer_trx_id
																		 ,nvl(sdh.pay_days
																				 ,0) due_days
																		 ,1 rate
																 from ra_customer_trx_all rcta
																		 ,scm_dm_headers      sdh
																where rcta.interface_header_attribute1 = sdh.document_number
																	and rcta.attribute2 like 'KP%'
															 union all
															 select rcta.customer_trx_id
																		 ,rtl.due_days
																		 ,rtl.relative_amount / rtb.base_amount rate
																 from ra_terms_b          rtb
																		 ,ra_terms_lines      rtl
																		 ,ra_terms_tl         rtt
																		 ,ra_customer_trx_all rcta
																where rtb.term_id = rtl.term_id
																	and rtb.term_id = rtt.term_id
																	and rcta.term_id = rtb.term_id
																	and rtt.language = userenv('LANG')
																	and nvl(rcta.attribute2
																				 ,'AA') not like 'KP%') c
												where b.applied_customer_trx_id(+) = a.customer_trx_id
													and a.customer_trx_id = c.customer_trx_id(+)) t
										 ,hz_cust_accounts hca
										 ,hz_parties hp
							 where t.customer_id = hca.cust_account_id
								 and hca.party_id = hp.party_id
								 and hca.account_number between nvl(p_cust_num_start
																									 ,hca.account_number) and
										 nvl(p_cust_num_end
												,hca.account_number)
							 group by hca.customer_class_code
												,hca.attribute1
												,hp.party_name
												,t.order_type
												,t.customer_id
												,hca.account_number
							--预收款，不能获取帐龄，只反应总金额
							union all
							select acra.pay_from_customer customer_id_1
										 ,hca.account_number account_number_1
										 ,hp.party_name party_name_1
										 ,hca.customer_class_code cust_class_1
										 ,hca.attribute1 customer_type_1
										 ,get_order_type(nvl(acra.attribute1
																				,'空订单类型')) order_type_1
										 ,sum(araa.amount_applied * nvl(acra.exchange_rate
																									 ,1)) amt_pre_receive
										 ,0 amt_receive
										 ,0 amt_fcsp
										 ,0 amt_fcsp1
										 ,0 amt_receive_not_due
										 ,0 amt_fcsp_not_due
										 ,0
										 ,0 amt_receive_0_30
										 ,0 amt_fcsp_0_30
										 ,0
										 ,0 amt_receive_31_60
										 ,0 amt_fcsp_31_60
										 ,0
										 ,0 amt_receive_61_90
										 ,0 amt_fcsp_61_90
										 ,0
										 ,0 amt_receive_91_180
										 ,0 amt_fcsp_91_180
										 ,0
										 ,0 amt_receive_181_270
										 ,0 amt_fcsp_181_270
										 ,0
										 ,0 amt_receive_271_360
										 ,0 amt_fcsp_271_360
										 ,0
										 ,0 amt_receive_361
										 ,0 amt_fcsp_361
										 ,0
								from ar_cash_receipts_all           acra
										 ,ar_receivable_applications_all araa
										 ,hz_cust_accounts               hca
										 ,hz_parties                     hp
							 where acra.cash_receipt_id = araa.cash_receipt_id
								 and acra.org_id = p_org_id
								 and hca.account_number between nvl(p_cust_num_start
																									 ,hca.account_number) and
										 nvl(p_cust_num_end
												,hca.account_number)
								 and araa.gl_date <= to_date(substr(p_end_date
																									 ,1
																									 ,10)
																						,'yyyy/mm/dd')
								 and acra.pay_from_customer = hca.cust_account_id
								 and hca.party_id = hp.party_id
										
								 and (get_order_type(nvl(acra.attribute1
																				,'空订单类型')) in (p_order_type
																											 ,p_order_type_n) or
										 (p_order_type is null and p_order_type_n is null))
										
								 and araa.status = 'UNAPP'
								 and not exists (select 1
												from ra_customer_trx_all          rcta
														,ra_customer_trx_lines_all    rctla
														,ra_cust_trx_types_all        rctt
														,ra_cust_trx_line_gl_dist_all rctlgd
											 where rcta.customer_trx_id = rctla.customer_trx_id
												 and rcta.org_id = p_org_id
												 and rcta.complete_flag = 'Y'
												 and rcta.customer_trx_id = rctlgd.customer_trx_id
												 and rctla.customer_trx_line_id = rctlgd.customer_trx_line_id
												 and rcta.cust_trx_type_id = rctt.cust_trx_type_id
												 and rctt.post_to_gl = 'Y'
												 and rctt.accounting_affect_flag = 'Y' --过滤发票
												 and rcta.bill_to_customer_id = acra.pay_from_customer
												 and get_order_type(decode(nvl(rcta.attribute11
																											,'N/A')
																									,'N/A'
																									,decode(substr(interface_header_attribute3
																																,1
																																,2)
																												 ,'KP'
																												 ,decode(rcta.interface_header_attribute12
																																,'N/A'
																																,interface_header_attribute2
																																,null
																																,'空订单类型'
																																,rcta.interface_header_attribute12)
																												 ,decode(rcta.interface_header_attribute2
																																,'0'
																																,'空订单类型'
																																,null
																																,'空订单类型'
																																,rcta.interface_header_attribute2))
																									,rcta.attribute11)) =
														 get_order_type(nvl(acra.attribute1
																							 ,'空订单类型'))
												 and rctlgd.gl_date <= to_date(substr(p_end_date
																														 ,1
																														 ,10)
																											,'yyyy/mm/dd') + 1439 / 1440)
							 group by hca.customer_class_code
												,hca.attribute1
												,acra.pay_from_customer
												,hca.account_number
												,hp.party_name
												,get_order_type(nvl(acra.attribute1
																					 ,'空订单类型'))
							having sum(araa.amount_applied * nvl(acra.exchange_rate, 1)) != 0)
			 group by customer_class_code
							 ,customer_type_1
							 ,customer_number
							 ,customer_id
							 ,customer_name
							 ,order_type_name;
		cursor c2(c_request_id in number) is
			select *
				from scm_rpt_account_oinv_details jat
			 where to_char(jat.end_date
										,'yyyy/mm/dd') = substr(p_end_date
																					 ,1
																					 ,10)
						--另外需要获取最大的request_id
				 and jat.request_id = c_request_id
				 and jat.customer_number between nvl(p_cust_num_start
																						,jat.customer_number) and
						 nvl(p_cust_num_end
								,jat.customer_number);
	
		v_amt_receive_total   number;
		v_amt_actual_receive  number;
		v_amt_pre_receive     number;
		v_org_id              number;
		v_organization_id     number;
		v_req_id              number;
		v_order_type          varchar2(100);
		v_count               integer;
		v_receive             number;
		v_fcsp                number;
		v_fcsp1               number;
		v_customer_class_code varchar2(100);
		v_customer_type       varchar2(100);
	begin
		/*SELECT t.Organization_Id
      INTO v_Org_Id
      FROM Hr_Organization_Information_v t
     WHERE t.Org_Information_Context = 'Operating Unit Information'
       AND t.Org_Information3 = p_Set_Of_Books_Id
       AND ROWNUM = 1;
    SELECT DECODE(p_Org_Id, 322, 324, 94, 95, 98, 100, 134, 135, 126, 127, 0)
      INTO v_Organization_Id
      FROM Dual;*/
		select hoiv.organization_id
			into v_organization_id
			from hr_organization_information_v hoiv
					,org_organization_definitions  ood
					,fnd_lookup_values_vl          flv
		 where hoiv.organization_id = ood.organization_id
			 and hoiv.org_information_context = 'CLASS'
			 and flv.lookup_code = hoiv.organization_id
			 and flv.lookup_type = 'SCM_IND_PRICE_ORG'
			 and ood.operating_unit = p_org_id
			 and hoiv.organization_id <> 662
			 and organization_name not like '%库存主组织%';
    ---added by xzg 增加月报表标识，月报表输出发出商品数据为时点数据，其他为实时数据   
    IF nvl(p_mon_flag,'N') = 'Y' THEN  
		select max(request_id)
			into v_request_id
			from scm_rpt_fcsp_sum
		 where end_date = trunc(to_date(p_end_date
																	 ,'YYYY/MM/DD hh24:mi:ss'))
			 and org_id = p_org_id
       AND mon_flag = 'Y';
			 --and 1 = 2;
    END IF;
		if (v_request_id is null)
		then
			cal_fcsp(p_1
							,p_2
							,p_end_date
							,p_org_id
              ,p_mon_flag);
			commit;
		
    IF nvl(p_mon_flag,'N') = 'Y' THEN
			select max(request_id)
				into v_request_id
				from scm_rpt_fcsp_sum
			 where end_date = trunc(to_date(p_end_date
																		 ,'YYYY/MM/DD hh24:mi:ss'))
				 and org_id = p_org_id
         AND mon_flag = 'Y';
     ELSE
      select max(request_id)
				into v_request_id
				from scm_rpt_fcsp_sum
			 where end_date = trunc(to_date(p_end_date
																		 ,'YYYY/MM/DD hh24:mi:ss'))
				 and org_id = p_org_id;    
     END IF;
		end if;
		if v_request_id is null
		then
			select cgscm.scm_rpt_fcsp_request_s.nextval into v_request_id from dual;
		end if;
		fnd_file.put_line(fnd_file.log
										 ,'v_Request_Id' || v_request_id);
	
		---提交SCM.客户仓商品帐龄分析表(新)      
		v_req_id := fnd_request.submit_request('SCM'
																					, --模块名
																					 'SCM_JD_GOODS_ACCOUNT_REPORT_S'
																					, --报表名称 例如:CUX:费用报表
																					 null
																					,null
																					,false
																					,v_organization_id
																					, --参数1
																					 ''
																					, --参数2
																					 ''
																					,''
																					,''
																					,v_request_id
																					,v_request_id_old
																					,'Y');
		fnd_file.put_line(fnd_file.log
										 ,'v_req_id_1' || v_req_id);
		commit;
		---提交SCM.客户仓商品帐龄分析表     
		/*v_req_id := fnd_request.submit_request('SCM'
																					, --模块名
																					 'SCM_JD_GOODS_ACCOUNT_REPORT'
																					, --报表名称 例如:CUX:费用报表
																					 null
																					,null
																					,false
																					,v_organization_id
																					, --参数1
																					 ''
																					, --参数2
																					 ''
																					,''
																					,''
																					,v_request_id
																					,v_request_id_old
																					,'Y');
		fnd_file.put_line(fnd_file.log
										 ,'v_req_id_2' || v_req_id);
		commit;*/
	
		fnd_file.put_line(fnd_file.log
										 ,'v_Request_Id_Old' || v_request_id_old);
	
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '####';
		html_report_pkg.html_title(p_program_title => '应收帐款帐龄分析总表'
															,p_report_title  => '应收帐款帐龄分析总表');
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		html_report_pkg.output_line('报表序号：' || v_request_id);
		html_report_pkg.output_line('<BR>截止日期：' || substr(p_end_date
																										 ,1
																										 ,10));
	
		if p_cust_num_start is not null or
			 p_cust_num_end is not null
		then
			html_report_pkg.output_line('<BR>客户编号，自：' || p_cust_num_start || '，至：' || p_cust_num_end);
		end if;
	
		if p_order_type is not null
		then
			html_report_pkg.output_line('<BR>订单类型：' || p_order_type);
		end if;
	
		html_report_pkg.output_line('<table width=2400 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '客户类别***rowspan=2 align=center,产业链***rowspan=2 align=center,客户编号***rowspan=2 align=center,客户名称***rowspan=2 align=center,订单类型***rowspan=2 align=center,实际应收余额***rowspan=2 align=center,预收余额***rowspan=2 align=center,应收余额***colspan=4 align=center,未到期***colspan=3 align=center,逾期0－30天***colspan=3 align=center,逾期31－60天***colspan=3 align=center,逾期61－90天***colspan=3 align=center,逾期91－180天***colspan=3 align=center,逾期181－270天***colspan=3 align=center,逾期271－360天***colspan=3 align=center,逾期360天以上***colspan=3 align=center,';
		html_report_pkg.line_title(p_title_string    => v_line_str
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***'
															,p_with_tr_flag    => 'Y');
	
		v_line_str := '合计*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,';
		html_report_pkg.line_title(p_title_string    => v_line_str
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***'
															,p_with_tr_flag    => 'Y');
		--判断临时是否已经有数据 
		select count(*) into v_count from scm_yszl_temp where request_id = v_request_id;
    
    IF v_count <> 0 THEN
      INSERT INTO scm_yszl_temp_his SELECT * FROM scm_yszl_temp WHERE request_id = v_request_id;
      DELETE FROM scm_yszl_temp WHERE request_id = v_request_id;
    END IF;
	
		for r1 in c1(v_request_id)
		loop
			v_amt_pre_receive := 0;
			--加上未发货部分的
			r1.amt_pre_receive := nvl(r1.amt_pre_receive
															 ,0) + nvl(v_amt_pre_receive
																				,0);
		
			v_amt_actual_receive := nvl(r1.amt_receive
																 ,0) + nvl(r1.amt_fcsp
																					,0) + nvl(r1.amt_fcsp1
																									 ,0);
			v_amt_receive_total  := nvl(v_amt_actual_receive
																 ,0) - nvl(r1.amt_pre_receive
																					,0);
			--if v_count = 0 THEN
				insert into scm_yszl_temp
					(request_id
					,customer_class_code
					,customer_type
					,customer_number
					,customer_name
					,order_type
					,amt_receive_total
					,amt_pre_receive
					,amt_actual_receive
					,amt_receive
					,amt_fcsp1
					,amt_fcsp
					,amt_receive_not_due
					,amt_fcsp_not_due1
					,amt_fcsp_not_due
					,amt_receive_0_30
					,amt_fcsp_not_0_301
					,amt_fcsp_not_0_30
					,amt_receive_31_60
					,amt_fcsp_not_31_601
					,amt_fcsp_not_31_60
					,amt_receive_61_90
					,amt_fcsp_not_61_901
					,amt_fcsp_not_61_90
					,amt_receive_91_180
					,amt_fcsp_not_91_1801
					,amt_fcsp_not_91_180
					,amt_receive_181_270
					,amt_fcsp_not_181_2701
					,amt_fcsp_not_181_270
					,amt_receive_271_360
					,amt_fcsp_not_271_3601
					,amt_fcsp_not_271_360
					,amt_receive_361
					,amt_fcsp_not_3611
					,amt_fcsp_not_361
					,old_request_id)
				values
					(v_request_id
					,nvl(r1.customer_class_code
							,'空白')
					,nvl(r1.customer_type_1
							,'空白')
					,r1.customer_number
					,r1.customer_name
					,r1.order_type_name
					,v_amt_receive_total
					,r1.amt_pre_receive
					,v_amt_actual_receive
					,r1.amt_receive
					,r1.amt_fcsp1
					,r1.amt_fcsp
					,nvl(r1.amt_receive_not_due
							,0)
					,nvl(r1.amt_fcsp_not_due1
							,0)
					,nvl(r1.amt_fcsp_not_due
							,0)
					,nvl(r1.amt_receive_0_30
							,0)
					,nvl(r1.amt_fcsp_0_301
							,0)
					,nvl(r1.amt_fcsp_0_30
							,0)
					,nvl(r1.amt_receive_31_60
							,0)
					,nvl(r1.amt_fcsp_31_601
							,0)
					,nvl(r1.amt_fcsp_31_60
							,0)
					,nvl(r1.amt_receive_61_90
							,0)
					,nvl(r1.amt_fcsp_61_901
							,0)
					,nvl(r1.amt_fcsp_61_90
							,0)
					,nvl(r1.amt_receive_91_180
							,0)
					,nvl(r1.amt_fcsp_91_1801
							,0)
					,nvl(r1.amt_fcsp_91_180
							,0)
					,nvl(r1.amt_receive_181_270
							,0)
					,nvl(r1.amt_fcsp_181_2701
							,0)
					,nvl(r1.amt_fcsp_181_270
							,0)
					,nvl(r1.amt_receive_271_360
							,0)
					,nvl(r1.amt_fcsp_271_3601
							,0)
					,nvl(r1.amt_fcsp_271_360
							,0)
					,nvl(r1.amt_receive_361
							,0)
					,nvl(r1.amt_fcsp_3611
							,0)
					,nvl(r1.amt_fcsp_361
							,0)
					,0);
				commit;
			--end if;
			html_report_pkg.line_title(p_title_string => r1.customer_class_code || v_sep || r1.customer_type_1 || v_sep ||
																									 r1.customer_number || v_sep || r1.customer_name || v_sep ||
																									 r1.order_type_name || v_sep || v_amt_receive_total --实际应收余额＝应收余额＋发出商品余额－预收余额
																									 || v_sep || r1.amt_pre_receive || v_sep || v_amt_actual_receive --应收余额合计＝应收余额＋发出商品余额
																									 || v_sep || r1.amt_receive || v_sep || r1.amt_fcsp1 || v_sep ||
																									 r1.amt_fcsp || v_sep || r1.amt_receive_not_due || v_sep ||
																									 r1.amt_fcsp_not_due1 || v_sep || r1.amt_fcsp_not_due || v_sep ||
																									 r1.amt_receive_0_30 || v_sep || r1.amt_fcsp_0_301 || v_sep ||
																									 r1.amt_fcsp_0_30 || v_sep || r1.amt_receive_31_60 || v_sep ||
																									 r1.amt_fcsp_31_601 || v_sep || r1.amt_fcsp_31_60 || v_sep ||
																									 r1.amt_receive_61_90 || v_sep || r1.amt_fcsp_61_901 || v_sep ||
																									 r1.amt_fcsp_61_90 || v_sep || r1.amt_receive_91_180 || v_sep ||
																									 r1.amt_fcsp_91_1801 || v_sep || r1.amt_fcsp_91_180 || v_sep ||
																									 r1.amt_receive_181_270 || v_sep || r1.amt_fcsp_181_2701 || v_sep ||
																									 r1.amt_fcsp_181_270 || v_sep || r1.amt_receive_271_360 || v_sep ||
																									 r1.amt_fcsp_271_3601 || v_sep || r1.amt_fcsp_271_360 || v_sep ||
																									 r1.amt_receive_361 || v_sep || r1.amt_fcsp_3611 || v_sep ||
																									 r1.amt_fcsp_361 || v_sep
																,p_delimiter    => v_sep);
		end loop;
		html_report_pkg.output_line('</tr></table>');
		--
		html_report_pkg.output_line('<BR><BR><B>非挑库确认的客户仓数量列表：');
		html_report_pkg.output_line('<table width=1000 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '客户编号,客户名称,子库编号,入库日期,事务处理类型,单位,数量,';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		v_qty := 0;
		v_amt := 0;
		for r1 in c2(v_request_id)
		loop
			html_report_pkg.line_title(p_title_string => r1.customer_number || v_sep || r1.customer_name || v_sep ||
																									 r1.subinventory_code || v_sep ||
																									 to_char(r1.date_received
																													,'yyyy-mm-dd') || v_sep || r1.transaction_type_name || v_sep ||
																									 r1.uom || v_sep || r1.qty || v_sep
																,p_delimiter    => v_sep);
		
			v_qty := nvl(v_qty
									,0) + nvl(r1.qty
													 ,0);
		end loop;
		html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=6' || v_sep || v_qty || v_sep
															,p_delimiter       => v_sep
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***');
		html_report_pkg.output_line('</tr></table></html>');
	
		---提交两个简表     
		v_req_id := fnd_request.submit_request('SCM'
																					, --模块名
																					 'SCM_REVZL_RPT_NEW_TYPE'
																					, --报表名称 例如:CUX:费用报表
																					 null
																					,null
																					,false
																					,p_end_date
																					,v_request_id
																					,p_order_type
																					,p_order_type_n
																					,p_cust_num_start
																					,p_cust_num_end
																					,p_type);
		fnd_file.put_line(fnd_file.log
										 ,'v_req_id_3' || v_req_id);
		commit;
		---提交两个简表     
		v_req_id := fnd_request.submit_request('SCM'
																					, --模块名
																					 'SCM_REVZL_RPT_NEW_CODE'
																					, --报表名称 例如:CUX:费用报表
																					 null
																					,null
																					,false
																					,p_end_date
																					,v_request_id
																					,p_order_type
																					,p_order_type_n
																					,p_cust_num_start
																					,p_cust_num_end
																					,p_type);
		fnd_file.put_line(fnd_file.log
										 ,'v_req_id_3' || v_req_id);
		commit;
		---提交现有量非子库存转移报表  add wuyujin 2010-11-17     
		v_req_id := fnd_request.submit_request('SCM'
																					, --模块名
																					 'SCM_ONHAND_NOTRANFER_RPT'
																					, --报表名称 例如:CUX:费用报表
																					 null
																					,null
																					,false
																					,p_end_date
																					,p_org_id);
		fnd_file.put_line(fnd_file.log
										 ,'v_req_id_4' || v_req_id);
		commit;
	end jd_receive_report;
	procedure jd_receive_report_type(p_1              out varchar2
																	,p_2              out varchar2
																	,p_end_date       in varchar2
																	,p_request_id     in number
																	,p_order_type     in varchar2
																	,p_order_type_n   in varchar2 default null
																	,p_cust_num_start in varchar2
																	,p_cust_num_end   in varchar2
																	,p_type           in varchar2) as
		v_line_str   varchar2(4000);
		v_sep        varchar2(5);
		v_order_type varchar2(50);
		v_count      integer;
		v_receive    number;
		v_fcsp1      number;
		v_fcsp       number;
		v_flag       varchar2(1);
		cursor c3(p_request_id in number) is
			select rowid
						,request_id
						,customer_class_code
						,customer_type
						,customer_number
						,customer_name
						,order_type
						,amt_receive_total
						,amt_pre_receive
						,amt_actual_receive
						,amt_receive
						,amt_fcsp1
						,amt_fcsp
						,amt_receive_not_due
						,amt_fcsp_not_due1
						,amt_fcsp_not_due
						,amt_receive_0_30
						,amt_fcsp_not_0_301
						,amt_fcsp_not_0_30
						,amt_receive_31_60
						,amt_fcsp_not_31_601
						,amt_fcsp_not_31_60
						,amt_receive_61_90
						,amt_fcsp_not_61_901
						,amt_fcsp_not_61_90
						,amt_receive_91_180
						,amt_fcsp_not_91_1801
						,amt_fcsp_not_91_180
						,amt_receive_181_270
						,amt_fcsp_not_181_2701
						,amt_fcsp_not_181_270
						,amt_receive_271_360
						,amt_fcsp_not_271_3601
						,amt_fcsp_not_271_360
						,amt_receive_361
						,amt_fcsp_not_3611
						,amt_fcsp_not_361
				from scm_yszl_temp a
			 where request_id = p_request_id
				 and customer_type <> '采购中心'
				 and order_type <> '空订单类型'
				 and order_type <> 'N/A' --add wuyujin 2010-10-16
			;
	
		cursor c4(p_request_id in number) is
			select rowid
						,request_id
						,customer_class_code
						,customer_type
						,customer_number
						,customer_name
						,order_type
						,amt_receive_total
						,amt_pre_receive
						,amt_actual_receive
						,amt_receive
						,amt_fcsp1
						,amt_fcsp
						,amt_receive_not_due
						,amt_fcsp_not_due1
						,amt_fcsp_not_due
						,amt_receive_0_30
						,amt_fcsp_not_0_301
						,amt_fcsp_not_0_30
						,amt_receive_31_60
						,amt_fcsp_not_31_601
						,amt_fcsp_not_31_60
						,amt_receive_61_90
						,amt_fcsp_not_61_901
						,amt_fcsp_not_61_90
						,amt_receive_91_180
						,amt_fcsp_not_91_1801
						,amt_fcsp_not_91_180
						,amt_receive_181_270
						,amt_fcsp_not_181_2701
						,amt_fcsp_not_181_270
						,amt_receive_271_360
						,amt_fcsp_not_271_3601
						,amt_fcsp_not_271_360
						,amt_receive_361
						,amt_fcsp_not_3611
						,amt_fcsp_not_361
				from scm_yszl_temp_type
			 where request_id = p_request_id
				 and amt_receive_total <> 0
			 order by order_type
							 ,amt_receive_total desc;
		/*ORDER BY DECODE(TRANSLATE(order_type,'ABCDEFGHIJKLMNOPQRSTUVWXYZ.',' '),
            '钢材订单',1,
    '塑料订单',2,
    '铝材订单',3,
    '铜杆订单',4,
    '漆包线订单',5,
    '铜管订单',6,
    '开料加工',7,
    '包装材料订单',8,
    '芯片订单',9,
    '电源线订单',10,
    '钢材订单 (开料部)',11,
    '代理进口销售订单',12,
    13);*/
		cursor c5(p_request_id in number
						 ,p_order_type in varchar2) is
			select order_type
						,sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_type
			 where request_id = p_request_id
				 and order_type = p_order_type
				 and amt_receive_total <> 0
			 group by order_type;
	
		cursor c51(p_request_id in number) is
			select sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_type
			 where request_id = p_request_id
				 and amt_receive_total <> 0;
	begin
		delete from scm_yszl_temp_type where request_id = p_request_id;
		--插入临时表
		for r1 in c3(p_request_id)
		loop
			insert into scm_yszl_temp_type
				(request_id
				,customer_class_code
				,customer_type
				,customer_number
				,customer_name
				,order_type
				,amt_receive_total
				,amt_pre_receive
				,amt_actual_receive
				,amt_receive
				,amt_fcsp1
				,amt_fcsp
				,amt_receive_not_due
				,amt_fcsp_not_due1
				,amt_fcsp_not_due
				,amt_receive_0_30
				,amt_fcsp_not_0_301
				,amt_fcsp_not_0_30
				,amt_receive_31_60
				,amt_fcsp_not_31_601
				,amt_fcsp_not_31_60
				,amt_receive_61_90
				,amt_fcsp_not_61_901
				,amt_fcsp_not_61_90
				,amt_receive_91_180
				,amt_fcsp_not_91_1801
				,amt_fcsp_not_91_180
				,amt_receive_181_270
				,amt_fcsp_not_181_2701
				,amt_fcsp_not_181_270
				,amt_receive_271_360
				,amt_fcsp_not_271_3601
				,amt_fcsp_not_271_360
				,amt_receive_361
				,amt_fcsp_not_3611
				,amt_fcsp_not_361)
			values
				(r1.request_id
				,r1.customer_class_code
				,r1.customer_type
				,r1.customer_number
				,r1.customer_name
				,r1.order_type
				,r1.amt_receive_total
				,r1.amt_pre_receive
				,r1.amt_actual_receive
				,r1.amt_receive
				,r1.amt_fcsp1
				,r1.amt_fcsp
				,r1.amt_receive_not_due
				,r1.amt_fcsp_not_due1
				,r1.amt_fcsp_not_due
				,r1.amt_receive_0_30
				,r1.amt_fcsp_not_0_301
				,r1.amt_fcsp_not_0_30
				,r1.amt_receive_31_60
				,r1.amt_fcsp_not_31_601
				,r1.amt_fcsp_not_31_60
				,r1.amt_receive_61_90
				,r1.amt_fcsp_not_61_901
				,r1.amt_fcsp_not_61_90
				,r1.amt_receive_91_180
				,r1.amt_fcsp_not_91_1801
				,r1.amt_fcsp_not_91_180
				,r1.amt_receive_181_270
				,r1.amt_fcsp_not_181_2701
				,r1.amt_fcsp_not_181_270
				,r1.amt_receive_271_360
				,r1.amt_fcsp_not_271_3601
				,r1.amt_fcsp_not_271_360
				,r1.amt_receive_361
				,r1.amt_fcsp_not_3611
				,r1.amt_fcsp_not_361);
		end loop;
	
		if p_type = 1
		then
			--核销已开票和发出商品
		
			--核销预付款
			for x in c4(p_request_id)
			loop
				if x.amt_pre_receive > 0
				then
					if x.amt_pre_receive > x.amt_receive_361
					then
						x.amt_pre_receive := x.amt_pre_receive - x.amt_receive_361;
						x.amt_receive_361 := 0;
					else
						x.amt_receive_361 := x.amt_receive_361 - x.amt_pre_receive;
						x.amt_pre_receive := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_361
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_fcsp_not_361;
						x.amt_fcsp_not_361 := 0;
					else
						x.amt_fcsp_not_361 := x.amt_fcsp_not_361 - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_3611
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_3611;
						x.amt_fcsp_not_3611 := 0;
					else
						x.amt_fcsp_not_3611 := x.amt_fcsp_not_3611 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
					------
					if x.amt_pre_receive > x.amt_receive_271_360
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_271_360;
						x.amt_receive_271_360 := 0;
					else
						x.amt_receive_271_360 := x.amt_receive_271_360 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_271_360
					then
						x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_271_360;
						x.amt_fcsp_not_271_360 := 0;
					else
						x.amt_fcsp_not_271_360 := x.amt_fcsp_not_271_360 - x.amt_pre_receive;
						x.amt_pre_receive      := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_271_3601
					then
						x.amt_pre_receive       := x.amt_pre_receive - x.amt_fcsp_not_271_3601;
						x.amt_fcsp_not_271_3601 := 0;
					else
						x.amt_fcsp_not_271_3601 := x.amt_fcsp_not_271_3601 - x.amt_pre_receive;
						x.amt_pre_receive       := 0;
					end if;
					---- 
					if x.amt_pre_receive > x.amt_receive_181_270
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_181_270;
						x.amt_receive_181_270 := 0;
					else
					
						x.amt_receive_181_270 := x.amt_receive_181_270 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_181_270
					then
						x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_181_270;
						x.amt_fcsp_not_181_270 := 0;
					else
						x.amt_fcsp_not_181_270 := x.amt_fcsp_not_181_270 - x.amt_pre_receive;
						x.amt_pre_receive      := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_181_2701
					then
						x.amt_pre_receive       := x.amt_pre_receive - x.amt_fcsp_not_181_2701;
						x.amt_fcsp_not_181_2701 := 0;
					else
						x.amt_fcsp_not_181_2701 := x.amt_fcsp_not_181_2701 - x.amt_pre_receive;
						x.amt_pre_receive       := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_91_180
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_receive_91_180;
						x.amt_receive_91_180 := 0;
					else
						x.amt_receive_91_180 := x.amt_receive_91_180 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_91_180
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_91_180;
						x.amt_fcsp_not_91_180 := 0;
					else
						x.amt_fcsp_not_91_180 := x.amt_fcsp_not_91_180 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_91_1801
					then
						x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_91_1801;
						x.amt_fcsp_not_91_1801 := 0;
					else
						x.amt_fcsp_not_91_1801 := x.amt_fcsp_not_91_1801 - x.amt_pre_receive;
						x.amt_pre_receive      := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_61_90
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_61_90;
						x.amt_receive_61_90 := 0;
					else
						x.amt_receive_61_90 := x.amt_receive_61_90 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_61_90
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_61_90;
						x.amt_fcsp_not_61_90 := 0;
					else
						x.amt_fcsp_not_61_90 := x.amt_fcsp_not_61_90 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_61_901
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_61_901;
						x.amt_fcsp_not_61_901 := 0;
					else
						x.amt_fcsp_not_61_901 := x.amt_fcsp_not_61_901 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_31_60
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_31_60;
						x.amt_receive_31_60 := 0;
					else
						x.amt_receive_31_60 := x.amt_receive_31_60 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_31_60
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_31_60;
						x.amt_fcsp_not_31_60 := 0;
					else
						x.amt_fcsp_not_31_60 := x.amt_fcsp_not_31_60 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_31_601
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_31_601;
						x.amt_fcsp_not_31_601 := 0;
					else
						x.amt_fcsp_not_31_601 := x.amt_fcsp_not_31_601 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_0_30
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_receive_0_30;
						x.amt_receive_0_30 := 0;
					else
						x.amt_receive_0_30 := x.amt_receive_0_30 - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_0_30
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_0_30;
						x.amt_fcsp_not_0_30 := 0;
					else
					
						x.amt_fcsp_not_0_30 := x.amt_fcsp_not_0_30 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_0_301
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_0_301;
						x.amt_fcsp_not_0_301 := 0;
					else
					
						x.amt_fcsp_not_0_301 := x.amt_fcsp_not_0_301 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_not_due
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_not_due;
						x.amt_receive_not_due := 0;
					else
					
						x.amt_receive_not_due := x.amt_receive_not_due - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_due
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_fcsp_not_due;
						x.amt_fcsp_not_due := 0;
					else
					
						x.amt_fcsp_not_due := x.amt_fcsp_not_due - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_due1
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_due1;
						x.amt_fcsp_not_due1 := 0;
					else
					
						x.amt_fcsp_not_due1 := x.amt_fcsp_not_due1 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					update scm_yszl_temp_type
						 set amt_pre_receive       = x.amt_pre_receive
								,amt_receive_not_due   = x.amt_receive_not_due
								,amt_fcsp_not_due1     = x.amt_fcsp_not_due1
								,amt_fcsp_not_due      = x.amt_fcsp_not_due
								,amt_receive_0_30      = x.amt_receive_0_30
								,amt_fcsp_not_0_301    = x.amt_fcsp_not_0_301
								,amt_fcsp_not_0_30     = x.amt_fcsp_not_0_30
								,amt_receive_31_60     = x.amt_receive_31_60
								,amt_fcsp_not_31_601   = x.amt_fcsp_not_31_601
								,amt_fcsp_not_31_60    = x. amt_fcsp_not_31_60
								,amt_receive_61_90     = x.amt_receive_61_90
								,amt_fcsp_not_61_901   = x.amt_fcsp_not_61_901
								,amt_fcsp_not_61_90    = x.amt_fcsp_not_61_90
								,amt_receive_91_180    = x.amt_receive_91_180
								,amt_fcsp_not_91_1801  = x.amt_fcsp_not_91_1801
								,amt_fcsp_not_91_180   = x. amt_fcsp_not_91_180
								,amt_receive_181_270   = x.amt_receive_181_270
								,amt_fcsp_not_181_2701 = x.amt_fcsp_not_181_2701
								,amt_fcsp_not_181_270  = x. amt_fcsp_not_181_270
								,amt_receive_271_360   = x.amt_receive_271_360
								,amt_fcsp_not_271_3601 = x.amt_fcsp_not_271_3601
								,amt_fcsp_not_271_360  = x.amt_fcsp_not_271_360
								,amt_receive_361       = x.amt_receive_361
								,amt_fcsp_not_3611     = x.amt_fcsp_not_3611
								,amt_fcsp_not_361      = x.amt_fcsp_not_361
					 where rowid = x.rowid;
					commit;
				end if;
			end loop;
		elsif p_type = 2
		then
			--不核销
			null;
		else
			--核销已开票数据
			--核销预付款
			for x in c4(p_request_id)
			loop
				if x.amt_pre_receive > 0
				then
					if x.amt_pre_receive > x.amt_receive_361
					then
						x.amt_pre_receive := x.amt_pre_receive - x.amt_receive_361;
						x.amt_receive_361 := 0;
					else
						x.amt_receive_361 := x.amt_receive_361 - x.amt_pre_receive;
						x.amt_pre_receive := 0;
					end if;
				
					------
					if x.amt_pre_receive > x.amt_receive_271_360
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_271_360;
						x.amt_receive_271_360 := 0;
					else
						x.amt_receive_271_360 := x.amt_receive_271_360 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_181_270
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_181_270;
						x.amt_receive_181_270 := 0;
					else
					
						x.amt_receive_181_270 := x.amt_receive_181_270 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_91_180
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_receive_91_180;
						x.amt_receive_91_180 := 0;
					else
						x.amt_receive_91_180 := x.amt_receive_91_180 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_61_90
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_61_90;
						x.amt_receive_61_90 := 0;
					else
						x.amt_receive_61_90 := x.amt_receive_61_90 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_31_60
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_31_60;
						x.amt_receive_31_60 := 0;
					else
						x.amt_receive_31_60 := x.amt_receive_31_60 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_0_30
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_receive_0_30;
						x.amt_receive_0_30 := 0;
					else
						x.amt_receive_0_30 := x.amt_receive_0_30 - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_not_due
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_not_due;
						x.amt_receive_not_due := 0;
					else
					
						x.amt_receive_not_due := x.amt_receive_not_due - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					update scm_yszl_temp_type
						 set amt_pre_receive     = x.amt_pre_receive
								,amt_receive_not_due = x.amt_receive_not_due
								,amt_receive_0_30    = x.amt_receive_0_30
								,amt_receive_31_60   = x.amt_receive_31_60
								,amt_receive_61_90   = x.amt_receive_61_90
								,amt_receive_91_180  = x.amt_receive_91_180
								,amt_receive_181_270 = x.amt_receive_181_270
								,amt_receive_271_360 = x.amt_receive_271_360
								,amt_receive_361     = x.amt_receive_361
					 where rowid = x.rowid;
					commit;
				end if;
			end loop;
		end if;
		update scm_yszl_temp_type
			 set amt_receive = amt_receive_not_due + amt_receive_0_30 + amt_receive_31_60 + amt_receive_61_90 +
												 amt_receive_91_180 + amt_receive_181_270 + amt_receive_271_360 + amt_receive_361
					,amt_fcsp    = amt_fcsp_not_due + amt_fcsp_not_0_30 + amt_fcsp_not_31_60 + amt_fcsp_not_61_90 +
												 amt_fcsp_not_91_180 + amt_fcsp_not_181_270 + amt_fcsp_not_271_360 + amt_fcsp_not_361
					,amt_fcsp1   = amt_fcsp_not_due1 + amt_fcsp_not_0_301 + amt_fcsp_not_31_601 + amt_fcsp_not_61_901 +
												 amt_fcsp_not_91_1801 + amt_fcsp_not_181_2701 + amt_fcsp_not_271_3601 + amt_fcsp_not_3611
		 where request_id = p_request_id;
	
		update scm_yszl_temp_type
			 set amt_actual_receive = amt_receive + amt_fcsp + amt_fcsp1
		 where request_id = p_request_id;
		update scm_yszl_temp_type
			 set amt_receive_total = amt_actual_receive - amt_pre_receive
		 where request_id = p_request_id;
	
		update scm_yszl_temp_type
			 set amt_receive_total = amt_actual_receive - amt_pre_receive
		 where request_id = p_request_id;
		commit;
	
		update scm_yszl_temp_type a
			 set customer_type = '空白'
		 where customer_type is null
			 and request_id = p_request_id;
	
		update scm_yszl_temp_type a
			 set customer_class_code = '空白'
		 where customer_class_code is null
			 and request_id = p_request_id;
		commit;
		--按订单类型
	
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '####';
		html_report_pkg.html_title(p_program_title => '应收帐款帐龄分析总表-材料类别'
															,p_report_title  => '应收帐款帐龄分析总表-材料类别');
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		html_report_pkg.output_line('报表序号：' || p_request_id);
		html_report_pkg.output_line('<BR>截止日期：' || substr(p_end_date
																										 ,1
																										 ,10));
	
		if p_cust_num_start is not null or
			 p_cust_num_end is not null
		then
			html_report_pkg.output_line('<BR>客户编号，自：' || p_cust_num_start || '，至：' || p_cust_num_end);
		end if;
	
		if p_order_type is not null
		then
			html_report_pkg.output_line('<BR>订单类型：' || p_order_type);
		end if;
	
		html_report_pkg.output_line('<table width=2400 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '订单类型***rowspan=2 align=center,客户名称***rowspan=2 align=center,客户编号***rowspan=2 align=center,实际应收余额***rowspan=2 align=center,预收余额***rowspan=2 align=center,应收余额***colspan=4 align=center,未到期***colspan=3 align=center,逾期合计***colspan=3 align=center,逾期0－30天***colspan=3 align=center,逾期31－60天***colspan=3 align=center,逾期61－90天***colspan=3 align=center,逾期91－180天***colspan=3 align=center,逾期181－270天***colspan=3 align=center,逾期271－360天***colspan=3 align=center,逾期360天以上***colspan=3 align=center,';
		html_report_pkg.line_title(p_title_string    => v_line_str
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***'
															,p_with_tr_flag    => 'Y');
	
		v_line_str := '合计*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,';
		html_report_pkg.line_title(p_title_string    => v_line_str
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***'
															,p_with_tr_flag    => 'Y');
		v_order_type := 'aa';
		for r1 in c4(p_request_id)
		loop
		
			html_report_pkg.output_line('<tr>');
			if v_order_type <> r1.order_type
			then
				if v_flag = 'Y'
				then
					for x in c5(p_request_id
										 ,v_order_type)
					loop
						html_report_pkg.output_line('<td colspan=3 >' || v_order_type || '合计' || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
					
						--逾期合计  
					
						v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
												 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
						v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
												 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
					
						v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
											x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
					
						html_report_pkg.output_line('<td>' || v_receive || '</td>');
						html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
						html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
						html_report_pkg.output_line('</tr>');
					end loop;
				end if;
				v_flag := 'Y';
				select count(*)
					into v_count
					from scm_yszl_temp_type
				 where order_type = r1.order_type
					 and request_id = p_request_id
					 and amt_receive_total <> 0;
				html_report_pkg.output_line('<td rowspan=' || v_count || '>' || r1.order_type || '</td>');
				v_order_type := r1.order_type;
			end if;
			html_report_pkg.output_line('<td>' || r1.customer_name || '</td>');
			html_report_pkg.output_line('<td>' || r1.customer_number || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_receive_total || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_pre_receive || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_actual_receive || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_receive || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_not_due || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_due1 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_due || '</td>');
		
			--逾期合计  
		
			v_receive := r1.amt_receive_0_30 + r1.amt_receive_31_60 + r1.amt_receive_61_90 + r1.amt_receive_91_180 +
									 r1.amt_receive_181_270 + r1.amt_receive_271_360 + r1.amt_receive_361;
			v_fcsp1   := r1.amt_fcsp_not_0_301 + r1.amt_fcsp_not_31_601 + r1.amt_fcsp_not_61_901 + r1.amt_fcsp_not_91_1801 +
									 r1.amt_fcsp_not_181_2701 + r1.amt_fcsp_not_271_3601 + r1.amt_fcsp_not_3611;
		
			v_fcsp := r1.amt_fcsp_not_0_30 + r1.amt_fcsp_not_31_60 + r1.amt_fcsp_not_61_90 + r1.amt_fcsp_not_91_180 +
								r1.amt_fcsp_not_181_270 + r1.amt_fcsp_not_271_360 + r1.amt_fcsp_not_361;
		
			html_report_pkg.output_line('<td>' || v_receive || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_0_30 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_0_301 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_0_30 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_31_60 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_31_601 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_31_60 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_61_90 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_61_901 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_61_90 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_91_180 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_91_1801 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_91_180 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_181_270 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_181_2701 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_181_270 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_271_360 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_271_3601 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_271_360 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_361 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_3611 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_361 || '</td>');
			html_report_pkg.output_line('</tr>');
		end loop;
		for x in c5(p_request_id
							 ,v_order_type)
		loop
			html_report_pkg.output_line('<td colspan=3 >' || v_order_type || '合计' || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
		
			--逾期合计  
		
			v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
									 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
			v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
									 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
		
			v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
								x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
		
			html_report_pkg.output_line('<td>' || v_receive || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
			html_report_pkg.output_line('</tr>');
		end loop;
		for x in c51(p_request_id)
		loop
			html_report_pkg.output_line('<td colspan=3 >总计' || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
		
			--逾期合计  
		
			v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
									 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
			v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
									 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
		
			v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
								x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
		
			html_report_pkg.output_line('<td>' || v_receive || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
			html_report_pkg.output_line('</tr>');
		end loop;
		html_report_pkg.output_line('</tr></table></html>');
	end;

	---按产业链  
	procedure jd_receive_report_code(p_1              out varchar2
																	,p_2              out varchar2
																	,p_end_date       in varchar2
																	,p_request_id     in number
																	,p_order_type     in varchar2
																	,p_order_type_n   in varchar2 default null
																	,p_cust_num_start in varchar2
																	,p_cust_num_end   in varchar2
																	,p_type           in varchar2) as
		v_line_str            varchar2(4000);
		v_sep                 varchar2(5);
		v_order_type          varchar2(50);
		v_count               integer;
		v_receive             number;
		v_fcsp1               number;
		v_fcsp                number;
		v_customer_class_code varchar2(100);
		v_customer_type       varchar2(100);
		v_flag                varchar2(1);
		v_flag1               varchar2(1);
		cursor c4(p_request_id in number) is
			select customer_class_code
						,customer_type
						,customer_name
						,customer_number
						,sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp
			 where request_id = p_request_id
				 and customer_type <> '采购中心'
				 and order_type <> '空订单类型'
				 and order_type <> 'N/A' --add wuyujin 2010-10-16
			 group by customer_class_code
							 ,customer_type
							 ,customer_name
							 ,customer_number;
	
		cursor c7(p_request_id in number) is
			select rowid
						,customer_class_code
						,customer_type
						,customer_name
						,amt_receive_total
						,amt_pre_receive
						,amt_actual_receive
						,amt_receive
						,amt_fcsp1
						,amt_fcsp
						,amt_receive_not_due
						,amt_fcsp_not_due1
						,amt_fcsp_not_due
						,amt_receive_0_30
						,amt_fcsp_not_0_301
						,amt_fcsp_not_0_30
						,amt_receive_31_60
						,amt_fcsp_not_31_601
						,amt_fcsp_not_31_60
						,amt_receive_61_90
						,amt_fcsp_not_61_901
						,amt_fcsp_not_61_90
						,amt_receive_91_180
						,amt_fcsp_not_91_1801
						,amt_fcsp_not_91_180
						,amt_receive_181_270
						,amt_fcsp_not_181_2701
						,amt_fcsp_not_181_270
						,amt_receive_271_360
						,amt_fcsp_not_271_3601
						,amt_fcsp_not_271_360
						,amt_receive_361
						,amt_fcsp_not_3611
						,amt_fcsp_not_361
				from scm_yszl_temp_code
			 where request_id = p_request_id
				 and amt_receive_total <> 0
			 order by customer_class_code
							 ,customer_type
							 ,amt_receive_total desc;
		/*  ORDER BY DECODE(CUSTOMER_CLASS_CODE,'内部',1,'关联',2,'外协',3,'外部',4,5),
     DECODE(CUSTOMER_TYPE,
        '微电机',1,
    '洗涤电机',2,
    '清江电机',3,
    '冰洗',4,
    '美芝',5,
    '空调',6,
    '厨卫电器',7,
    '环境电器',8,
    '精品电器',9,
    '生活电器',10,
    '微波电器',11,
    '洗涤电器',12,
    '开料加工',13,
    '百年',14,
    '威奇',15,
    '外部单位',16,
     17);*/
	
		--按产业链小计
		cursor c5(p_request_id          in number
						 ,p_customer_class_code in varchar2
						 ,p_customer_type       in varchar2) is
			select customer_class_code
						,customer_type
						,sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_code
			 where request_id = p_request_id
				 and customer_class_code = p_customer_class_code
				 and customer_type = p_customer_type
				 and amt_receive_total <> 0
			 group by customer_class_code
							 ,customer_type;
	
		--按客户类别小计
		cursor c6(p_request_id          in number
						 ,p_customer_class_code in varchar2) is
			select customer_class_code
						,sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_code
			 where request_id = p_request_id
				 and customer_class_code = p_customer_class_code
				 and amt_receive_total <> 0
			 group by customer_class_code;
	
		--总计
		cursor c8(p_request_id in number) is
			select sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_code
			 where request_id = p_request_id
				 and amt_receive_total <> 0;
	begin
		delete from scm_yszl_temp_code where request_id = p_request_id;
		for r1 in c4(p_request_id)
		loop
			insert into scm_yszl_temp_code
			values
				(p_request_id
				,r1.customer_class_code
				,r1.customer_type
				,r1.customer_name
				,r1.amt_receive_total
				,r1.amt_pre_receive
				,r1.amt_actual_receive
				,r1.amt_receive
				,r1.amt_fcsp1
				,r1.amt_fcsp
				,r1.amt_receive_not_due
				,r1.amt_fcsp_not_due1
				,r1.amt_fcsp_not_due
				,r1.amt_receive_0_30
				,r1.amt_fcsp_not_0_301
				,r1.amt_fcsp_not_0_30
				,r1.amt_receive_31_60
				,r1.amt_fcsp_not_31_601
				,r1.amt_fcsp_not_31_60
				,r1.amt_receive_61_90
				,r1.amt_fcsp_not_61_901
				,r1.amt_fcsp_not_61_90
				,r1.amt_receive_91_180
				,r1.amt_fcsp_not_91_1801
				,r1.amt_fcsp_not_91_180
				,r1.amt_receive_181_270
				,r1.amt_fcsp_not_181_2701
				,r1.amt_fcsp_not_181_270
				,r1.amt_receive_271_360
				,r1.amt_fcsp_not_271_3601
				,r1.amt_fcsp_not_271_360
				,r1.amt_receive_361
				,r1.amt_fcsp_not_3611
				,r1.amt_fcsp_not_361
				,r1.customer_number
				,'');
		end loop;
		commit;
		if p_type = 1
		then
			--核销
			for x in c7(p_request_id)
			loop
				if x.amt_pre_receive > 0
				then
					if x.amt_pre_receive > x.amt_receive_361
					then
						x.amt_pre_receive := x.amt_pre_receive - x.amt_receive_361;
						x.amt_receive_361 := 0;
					else
						x.amt_receive_361 := x.amt_receive_361 - x.amt_pre_receive;
						x.amt_pre_receive := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_361
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_fcsp_not_361;
						x.amt_fcsp_not_361 := 0;
					else
						x.amt_fcsp_not_361 := x.amt_fcsp_not_361 - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_3611
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_3611;
						x.amt_fcsp_not_3611 := 0;
					else
						x.amt_fcsp_not_3611 := x.amt_fcsp_not_3611 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
					------
					if x.amt_pre_receive > x.amt_receive_271_360
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_271_360;
						x.amt_receive_271_360 := 0;
					else
						x.amt_receive_271_360 := x.amt_receive_271_360 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_271_360
					then
						x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_271_360;
						x.amt_fcsp_not_271_360 := 0;
					else
						x.amt_fcsp_not_271_360 := x.amt_fcsp_not_271_360 - x.amt_pre_receive;
						x.amt_pre_receive      := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_271_3601
					then
						x.amt_pre_receive       := x.amt_pre_receive - x.amt_fcsp_not_271_3601;
						x.amt_fcsp_not_271_3601 := 0;
					else
						x.amt_fcsp_not_271_3601 := x.amt_fcsp_not_271_3601 - x.amt_pre_receive;
						x.amt_pre_receive       := 0;
					end if;
					---- 
					if x.amt_pre_receive > x.amt_receive_181_270
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_181_270;
						x.amt_receive_181_270 := 0;
					else
					
						x.amt_receive_181_270 := x.amt_receive_181_270 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_181_270
					then
						x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_181_270;
						x.amt_fcsp_not_181_270 := 0;
					else
						x.amt_fcsp_not_181_270 := x.amt_fcsp_not_181_270 - x.amt_pre_receive;
						x.amt_pre_receive      := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_181_2701
					then
						x.amt_pre_receive       := x.amt_pre_receive - x.amt_fcsp_not_181_2701;
						x.amt_fcsp_not_181_2701 := 0;
					else
						x.amt_fcsp_not_181_2701 := x.amt_fcsp_not_181_2701 - x.amt_pre_receive;
						x.amt_pre_receive       := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_91_180
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_receive_91_180;
						x.amt_receive_91_180 := 0;
					else
						x.amt_receive_91_180 := x.amt_receive_91_180 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_91_180
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_91_180;
						x.amt_fcsp_not_91_180 := 0;
					else
						x.amt_fcsp_not_91_180 := x.amt_fcsp_not_91_180 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_91_1801
					then
						x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_91_1801;
						x.amt_fcsp_not_91_1801 := 0;
					else
						x.amt_fcsp_not_91_1801 := x.amt_fcsp_not_91_1801 - x.amt_pre_receive;
						x.amt_pre_receive      := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_61_90
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_61_90;
						x.amt_receive_61_90 := 0;
					else
						x.amt_receive_61_90 := x.amt_receive_61_90 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_61_90
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_61_90;
						x.amt_fcsp_not_61_90 := 0;
					else
						x.amt_fcsp_not_61_90 := x.amt_fcsp_not_61_90 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_61_901
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_61_901;
						x.amt_fcsp_not_61_901 := 0;
					else
						x.amt_fcsp_not_61_901 := x.amt_fcsp_not_61_901 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_31_60
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_31_60;
						x.amt_receive_31_60 := 0;
					else
						x.amt_receive_31_60 := x.amt_receive_31_60 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_31_60
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_31_60;
						x.amt_fcsp_not_31_60 := 0;
					else
						x.amt_fcsp_not_31_60 := x.amt_fcsp_not_31_60 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_31_601
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_31_601;
						x.amt_fcsp_not_31_601 := 0;
					else
						x.amt_fcsp_not_31_601 := x.amt_fcsp_not_31_601 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_0_30
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_receive_0_30;
						x.amt_receive_0_30 := 0;
					else
						x.amt_receive_0_30 := x.amt_receive_0_30 - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_0_30
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_0_30;
						x.amt_fcsp_not_0_30 := 0;
					else
					
						x.amt_fcsp_not_0_30 := x.amt_fcsp_not_0_30 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_0_301
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_0_301;
						x.amt_fcsp_not_0_301 := 0;
					else
					
						x.amt_fcsp_not_0_301 := x.amt_fcsp_not_0_301 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_not_due
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_not_due;
						x.amt_receive_not_due := 0;
					else
					
						x.amt_receive_not_due := x.amt_receive_not_due - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_due
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_fcsp_not_due;
						x.amt_fcsp_not_due := 0;
					else
					
						x.amt_fcsp_not_due := x.amt_fcsp_not_due - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_due1
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_due1;
						x.amt_fcsp_not_due1 := 0;
					else
					
						x.amt_fcsp_not_due1 := x.amt_fcsp_not_due1 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
					update scm_yszl_temp_code
						 set amt_pre_receive       = x.amt_pre_receive
								,amt_receive_not_due   = x.amt_receive_not_due
								,amt_fcsp_not_due1     = x.amt_fcsp_not_due1
								,amt_fcsp_not_due      = x.amt_fcsp_not_due
								,amt_receive_0_30      = x.amt_receive_0_30
								,amt_fcsp_not_0_301    = x.amt_fcsp_not_0_301
								,amt_fcsp_not_0_30     = x.amt_fcsp_not_0_30
								,amt_receive_31_60     = x.amt_receive_31_60
								,amt_fcsp_not_31_601   = x.amt_fcsp_not_31_601
								,amt_fcsp_not_31_60    = x.amt_fcsp_not_31_60
								,amt_receive_61_90     = x.amt_receive_61_90
								,amt_fcsp_not_61_901   = x.amt_fcsp_not_61_901
								,amt_fcsp_not_61_90    = x.amt_fcsp_not_61_90
								,amt_receive_91_180    = x.amt_receive_91_180
								,amt_fcsp_not_91_1801  = x.amt_fcsp_not_91_1801
								,amt_fcsp_not_91_180   = x.amt_fcsp_not_91_180
								,amt_receive_181_270   = x.amt_receive_181_270
								,amt_fcsp_not_181_2701 = x.amt_fcsp_not_181_2701
								,amt_fcsp_not_181_270  = x.amt_fcsp_not_181_270
								,amt_receive_271_360   = x.amt_receive_271_360
								,amt_fcsp_not_271_3601 = x.amt_fcsp_not_271_3601
								,amt_fcsp_not_271_360  = x.amt_fcsp_not_271_360
								,amt_receive_361       = x.amt_receive_361
								,amt_fcsp_not_3611     = x.amt_fcsp_not_3611
								,amt_fcsp_not_361      = x.amt_fcsp_not_361
					 where rowid = x.rowid;
				end if;
			end loop;
		elsif p_type = 3
		then
			for x in c7(p_request_id)
			loop
				if x.amt_pre_receive > 0
				then
					if x.amt_pre_receive > x.amt_receive_361
					then
						x.amt_pre_receive := x.amt_pre_receive - x.amt_receive_361;
						x.amt_receive_361 := 0;
					else
						x.amt_receive_361 := x.amt_receive_361 - x.amt_pre_receive;
						x.amt_pre_receive := 0;
					end if;
				
					------
					if x.amt_pre_receive > x.amt_receive_271_360
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_271_360;
						x.amt_receive_271_360 := 0;
					else
						x.amt_receive_271_360 := x.amt_receive_271_360 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_181_270
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_181_270;
						x.amt_receive_181_270 := 0;
					else
					
						x.amt_receive_181_270 := x.amt_receive_181_270 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_91_180
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_receive_91_180;
						x.amt_receive_91_180 := 0;
					else
						x.amt_receive_91_180 := x.amt_receive_91_180 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_61_90
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_61_90;
						x.amt_receive_61_90 := 0;
					else
						x.amt_receive_61_90 := x.amt_receive_61_90 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_31_60
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_31_60;
						x.amt_receive_31_60 := 0;
					else
						x.amt_receive_31_60 := x.amt_receive_31_60 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_0_30
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_receive_0_30;
						x.amt_receive_0_30 := 0;
					else
						x.amt_receive_0_30 := x.amt_receive_0_30 - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_not_due
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_not_due;
						x.amt_receive_not_due := 0;
					else
					
						x.amt_receive_not_due := x.amt_receive_not_due - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					update scm_yszl_temp_code
						 set amt_pre_receive     = x.amt_pre_receive
								,amt_receive_not_due = x.amt_receive_not_due
								,amt_receive_0_30    = x.amt_receive_0_30
								,amt_receive_31_60   = x.amt_receive_31_60
								,amt_receive_61_90   = x.amt_receive_61_90
								,amt_receive_91_180  = x.amt_receive_91_180
								,amt_receive_181_270 = x.amt_receive_181_270
								,amt_receive_271_360 = x.amt_receive_271_360
								,amt_receive_361     = x.amt_receive_361
					 where rowid = x.rowid;
				end if;
			end loop;
		else
			null;
		end if;
		update scm_yszl_temp_code
			 set amt_receive = amt_receive_not_due + amt_receive_0_30 + amt_receive_31_60 + amt_receive_61_90 +
												 amt_receive_91_180 + amt_receive_181_270 + amt_receive_271_360 + amt_receive_361
					,amt_fcsp    = amt_fcsp_not_due + amt_fcsp_not_0_30 + amt_fcsp_not_31_60 + amt_fcsp_not_61_90 +
												 amt_fcsp_not_91_180 + amt_fcsp_not_181_270 + amt_fcsp_not_271_360 + amt_fcsp_not_361
					,amt_fcsp1   = amt_fcsp_not_due1 + amt_fcsp_not_0_301 + amt_fcsp_not_31_601 + amt_fcsp_not_61_901 +
												 amt_fcsp_not_91_1801 + amt_fcsp_not_181_2701 + amt_fcsp_not_271_3601 + amt_fcsp_not_3611
		 where request_id = p_request_id;
	
		update scm_yszl_temp_code
			 set amt_actual_receive = amt_receive + amt_fcsp + amt_fcsp1
		 where request_id = p_request_id;
	
		update scm_yszl_temp_code
			 set amt_receive_total = amt_actual_receive - amt_pre_receive
		 where request_id = p_request_id;
	
		update scm_yszl_temp_code a
			 set customer_type = '空白'
		 where customer_type is null
			 and request_id = p_request_id;
	
		update scm_yszl_temp_code a
			 set customer_class_code = '空白'
		 where customer_class_code is null
			 and request_id = p_request_id;
		commit;
	
		---输入报表格式
	
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '####';
		html_report_pkg.html_title(p_program_title => '应收帐款帐龄分析总表（客户类别）'
															,p_report_title  => '应收帐款帐龄分析总表（客户类别）');
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		html_report_pkg.output_line('报表序号：' || p_request_id);
		html_report_pkg.output_line('<BR>截止日期：' || substr(p_end_date
																										 ,1
																										 ,10));
	
		if p_cust_num_start is not null or
			 p_cust_num_end is not null
		then
			html_report_pkg.output_line('<BR>客户编号，自：' || p_cust_num_start || '，至：' || p_cust_num_end);
		end if;
	
		if p_order_type is not null
		then
			html_report_pkg.output_line('<BR>订单类型：' || p_order_type);
		end if;
	
		html_report_pkg.output_line('<table width=2400 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '客户类别***rowspan=2 align=center,产业链***rowspan=2 align=center,客户名称***rowspan=2 align=center,实际应收余额***rowspan=2 align=center,预收余额***rowspan=2 align=center,应收余额***colspan=4 align=center,未到期***colspan=3 align=center,逾期合计***colspan=3 align=center,逾期0－30天***colspan=3 align=center,逾期31－60天***colspan=3 align=center,逾期61－90天***colspan=3 align=center,逾期91－180天***colspan=3 align=center,逾期181－270天***colspan=3 align=center,逾期271－360天***colspan=3 align=center,逾期360天以上***colspan=3 align=center,';
		html_report_pkg.line_title(p_title_string    => v_line_str
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***'
															,p_with_tr_flag    => 'Y');
	
		v_line_str := '合计*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,';
		html_report_pkg.line_title(p_title_string    => v_line_str
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***'
															,p_with_tr_flag    => 'Y');
		v_customer_class_code := 'aa';
		v_customer_type       := 'bb';
		v_flag                := 'N';
		v_flag1               := 'N';
		for r1 in c7(p_request_id)
		loop
			html_report_pkg.output_line('<tr>');
			if v_customer_class_code <> r1.customer_class_code
			then
				if v_flag1 = 'Y'
				then
					for x in c5(p_request_id
										 ,v_customer_class_code
										 ,v_customer_type)
					loop
					
						html_report_pkg.output_line('<td>' || v_customer_type || '小计' || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
					
						--逾期合计  
					
						v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
												 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
						v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
												 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
					
						v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
											x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
					
						html_report_pkg.output_line('<td>' || v_receive || '</td>');
						html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
						html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
						html_report_pkg.output_line('</tr>');
					end loop;
				
					for x in c6(p_request_id
										 ,v_customer_class_code)
					loop
						html_report_pkg.output_line('<td colspan=2 >' || v_customer_class_code || '合计' || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
					
						--逾期合计  
					
						v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
												 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
						v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
												 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
					
						v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
											x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
					
						html_report_pkg.output_line('<td>' || v_receive || '</td>');
						html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
						html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
						html_report_pkg.output_line('</tr>');
					end loop;
				end if;
				v_flag1 := 'Y';
			
				select count(customer_name) + count(distinct customer_type) + 1
					into v_count
					from scm_yszl_temp_code
				 where customer_class_code = r1.customer_class_code
					 and request_id = p_request_id
					 and amt_receive_total <> 0;
				html_report_pkg.output_line('<td rowspan=' || v_count || '>' || r1.customer_class_code || '</td>');
				v_customer_class_code := r1.customer_class_code;
				v_customer_type       := 'bb';
			end if;
		
			if v_customer_type <> nvl(r1.customer_type
															 ,'cc') and
				 v_customer_class_code = r1.customer_class_code
			then
				if v_flag = 'Y'
				then
					for x in c5(p_request_id
										 ,r1.customer_class_code
										 ,v_customer_type)
					loop
					
						html_report_pkg.output_line('<td>' || v_customer_type || '小计' || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
					
						--逾期合计  
					
						v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
												 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
						v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
												 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
					
						v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
											x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
					
						html_report_pkg.output_line('<td>' || v_receive || '</td>');
						html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
						html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
						html_report_pkg.output_line('</tr>');
					end loop;
				end if;
				v_flag := 'Y';
			
				select count(customer_name) + 1
					into v_count
					from scm_yszl_temp_code
				 where customer_type = r1.customer_type
					 and request_id = p_request_id
					 and customer_class_code = r1.customer_class_code
					 and amt_receive_total <> 0;
				if v_count = 0
				then
					html_report_pkg.output_line('<td>' || r1.customer_type || '</td>');
				else
					html_report_pkg.output_line('<td rowspan=' || v_count || '>' || r1.customer_type || '</td>');
				end if;
				v_customer_type := nvl(r1.customer_type
															,'cc');
			end if;
		
			--html_report_pkg.output_line('<td>'||r1.CUSTOMER_TYPE||'</td>');
			html_report_pkg.output_line('<td>' || r1.customer_name || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_receive_total || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_pre_receive || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_actual_receive || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_receive || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_not_due || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_due1 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_due || '</td>');
		
			--逾期合计  
		
			v_receive := r1.amt_receive_0_30 + r1.amt_receive_31_60 + r1.amt_receive_61_90 + r1.amt_receive_91_180 +
									 r1.amt_receive_181_270 + r1.amt_receive_271_360 + r1.amt_receive_361;
			v_fcsp1   := r1.amt_fcsp_not_0_301 + r1.amt_fcsp_not_31_601 + r1.amt_fcsp_not_61_901 + r1.amt_fcsp_not_91_1801 +
									 r1.amt_fcsp_not_181_2701 + r1.amt_fcsp_not_271_3601 + r1.amt_fcsp_not_3611;
		
			v_fcsp := r1.amt_fcsp_not_0_30 + r1.amt_fcsp_not_31_60 + r1.amt_fcsp_not_61_90 + r1.amt_fcsp_not_91_180 +
								r1.amt_fcsp_not_181_270 + r1.amt_fcsp_not_271_360 + r1.amt_fcsp_not_361;
		
			html_report_pkg.output_line('<td>' || v_receive || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_0_30 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_0_301 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_0_30 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_31_60 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_31_601 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_31_60 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_61_90 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_61_901 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_61_90 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_91_180 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_91_1801 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_91_180 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_181_270 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_181_2701 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_181_270 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_271_360 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_271_3601 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_271_360 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_361 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_3611 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_361 || '</td>');
			html_report_pkg.output_line('</tr>');
		
		end loop;
		---最后的合计
		for x in c5(p_request_id
							 ,v_customer_class_code
							 ,v_customer_type)
		loop
		
			html_report_pkg.output_line('<td>' || v_customer_type || '小计' || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
		
			--逾期合计  
		
			v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
									 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
			v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
									 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
		
			v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
								x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
		
			html_report_pkg.output_line('<td>' || v_receive || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
			html_report_pkg.output_line('</tr>');
		end loop;
	
		for x in c6(p_request_id
							 ,v_customer_class_code)
		loop
			html_report_pkg.output_line('<td colspan=2 >' || v_customer_class_code || '合计' || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
		
			--逾期合计  
		
			v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
									 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
			v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
									 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
		
			v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
								x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
		
			html_report_pkg.output_line('<td>' || v_receive || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
			html_report_pkg.output_line('</tr>');
		end loop;
		---总的合计
		for x in c8(p_request_id)
		loop
			html_report_pkg.output_line('<td colspan=3 >' || '总计' || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
		
			--逾期合计  
		
			v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
									 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
			v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
									 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
		
			v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
								x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
		
			html_report_pkg.output_line('<td>' || v_receive || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
			html_report_pkg.output_line('</tr>');
		end loop;
	
		html_report_pkg.output_line('</tr></table></html>');
		/*    delete SCM_YSZL_TEMP where  Request_Id=v_Request_Id;
      delete scm_yszl_temp_code  where  Request_Id=v_Request_Id;
    commit; */
	end;

	procedure jd_receive_report_code_all(p_1              out varchar2
																			,p_2              out varchar2
																			,p_end_date       in varchar2
																			,p_request_id     in varchar2
																			,p_order_type     in varchar2
																			,p_order_type_n   in varchar2 default null
																			,p_cust_num_start in varchar2
																			,p_cust_num_end   in varchar2
																			,p_exclude        in varchar2
																			,p_type           in varchar2) as
		v_line_str            varchar2(4000);
		v_sep                 varchar2(5);
		v_order_type          varchar2(50);
		v_count               integer;
		v_receive             number;
		v_fcsp1               number;
		v_fcsp                number;
		v_customer_class_code varchar2(100);
		v_customer_type       varchar2(100);
		v_flag                varchar2(1);
		v_flag1               varchar2(1);
		v_customer_name       varchar2(100);
		v_count_tax           number;
		v_count_type          number;
		cursor c7(p_request_id in varchar2) is
			select a.customer_class_code
						,a.customer_type
						,nvl(attribute3
								,rc.customer_name) tax_reference
						,sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_code a
						,ar_customers       rc
			 where instr(p_request_id
									,a.request_id) > 0
				 and a.customer_number = rc.customer_number
			-- AND (p_exclude ='N' OR TRANSLATE(ORDER_TYPE,'ABCDEFGHIJKLMNOPQRSTUVWXYZ.',' ') NOT IN ('铜管订单','漆包线订单'))
			 group by a.customer_class_code
							 ,a.customer_type
							 ,nvl(attribute3
									 ,rc.customer_name);
	
		cursor c71(p_request_id in varchar2) is
			select a.customer_class_code
						,a.customer_type
						,nvl(attribute3
								,rc.customer_name) tax_reference
						,sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp a
						,ar_customers  rc
			 where instr(p_request_id
									,a.request_id) > 0
				 and a.customer_number = rc.customer_number
				 and a.customer_type <> '采购中心'
				 and order_type <> '空订单类型'
				 and order_type <> 'N/A' --add wuyujin 2010-10-16
				 and translate(order_type
											,'ABCDEFGHIJKLMNOPQRSTUVWXYZ.'
											,' ') not in ('铜管订单'
																	 ,'漆包线订单')
			 group by a.customer_class_code
							 ,a.customer_type
							 ,nvl(attribute3
									 ,rc.customer_name);
	
		--按产业链小计
		cursor c5(p_customer_class_code in varchar2
						 ,p_customer_type       in varchar2) is
			select customer_class_code
						,customer_type
						,sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_code_all
			 where customer_class_code = p_customer_class_code
				 and customer_type = p_customer_type
				 and amt_receive_total <> 0
			 group by customer_class_code
							 ,customer_type;
	
		--按客户类别小计
		cursor c6(p_customer_class_code in varchar2) is
			select customer_class_code
						,sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_code_all
			 where customer_class_code = p_customer_class_code
				 and amt_receive_total <> 0
			 group by customer_class_code;
	
		--总计
		cursor c8 is
			select sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_code_all
			 where amt_receive_total <> 0;
	
		cursor c9 is
			select rowid
						,a.*
				from scm_yszl_temp_code_all a
			 where amt_receive_total <> 0
			 order by customer_class_code
							 ,customer_type
							 ,amt_receive_total desc;
		/*ORDER BY DECODE(CUSTOMER_CLASS_CODE,'内部',1,'关联',2,'外协',3,'外部',4,5),
     DECODE(CUSTOMER_TYPE,
        '微电机',1,
    '洗涤电机',2,
    '清江电机',3,
    '冰洗',4,
    '美芝',5,
    '空调',6,
    '厨卫电器',7,
    '环境电器',8,
    '精品电器',9,
    '生活电器',10,
    '微波电器',11,
    '洗涤电器',12,
    '开料加工',13,
    '百年',14,
    '威奇',15,
    '外部单位',16,
     17);   */
	begin
	
		if p_exclude = 'Y'
		then
			for x in c71(p_request_id)
			loop
				insert into scm_yszl_temp_code_all
				values
					(x.customer_class_code
					,x.customer_type
					,x.tax_reference
					,x.amt_receive_total
					,x.amt_pre_receive
					,x.amt_actual_receive
					,x.amt_receive
					,x.amt_fcsp1
					,x.amt_fcsp
					,x.amt_receive_not_due
					,x.amt_fcsp_not_due1
					,x.amt_fcsp_not_due
					,x.amt_receive_0_30
					,x.amt_fcsp_not_0_301
					,x.amt_fcsp_not_0_30
					,x.amt_receive_31_60
					,x.amt_fcsp_not_31_601
					,x.amt_fcsp_not_31_60
					,x.amt_receive_61_90
					,x.amt_fcsp_not_61_901
					,x.amt_fcsp_not_61_90
					,x.amt_receive_91_180
					,x.amt_fcsp_not_91_1801
					,x.amt_fcsp_not_91_180
					,x.amt_receive_181_270
					,x.amt_fcsp_not_181_2701
					,x.amt_fcsp_not_181_270
					,x.amt_receive_271_360
					,x.amt_fcsp_not_271_3601
					,x.amt_fcsp_not_271_360
					,x.amt_receive_361
					,x.amt_fcsp_not_3611
					,x.amt_fcsp_not_361
					,'');
				commit;
			end loop;
			if p_type = 1
			then
				--核销预付款
				for x in c9
				loop
					if x.amt_pre_receive > 0
					then
						if x.amt_pre_receive > x.amt_receive_361
						then
							x.amt_pre_receive := x.amt_pre_receive - x.amt_receive_361;
							x.amt_receive_361 := 0;
						else
							x.amt_receive_361 := x.amt_receive_361 - x.amt_pre_receive;
							x.amt_pre_receive := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_361
						then
							x.amt_pre_receive  := x.amt_pre_receive - x.amt_fcsp_not_361;
							x.amt_fcsp_not_361 := 0;
						else
							x.amt_fcsp_not_361 := x.amt_fcsp_not_361 - x.amt_pre_receive;
							x.amt_pre_receive  := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_3611
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_3611;
							x.amt_fcsp_not_3611 := 0;
						else
							x.amt_fcsp_not_3611 := x.amt_fcsp_not_3611 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
						------
						if x.amt_pre_receive > x.amt_receive_271_360
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_271_360;
							x.amt_receive_271_360 := 0;
						else
							x.amt_receive_271_360 := x.amt_receive_271_360 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_271_360
						then
							x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_271_360;
							x.amt_fcsp_not_271_360 := 0;
						else
							x.amt_fcsp_not_271_360 := x.amt_fcsp_not_271_360 - x.amt_pre_receive;
							x.amt_pre_receive      := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_271_3601
						then
							x.amt_pre_receive       := x.amt_pre_receive - x.amt_fcsp_not_271_3601;
							x.amt_fcsp_not_271_3601 := 0;
						else
							x.amt_fcsp_not_271_3601 := x.amt_fcsp_not_271_3601 - x.amt_pre_receive;
							x.amt_pre_receive       := 0;
						end if;
						---- 
						if x.amt_pre_receive > x.amt_receive_181_270
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_181_270;
							x.amt_receive_181_270 := 0;
						else
						
							x.amt_receive_181_270 := x.amt_receive_181_270 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_181_270
						then
							x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_181_270;
							x.amt_fcsp_not_181_270 := 0;
						else
							x.amt_fcsp_not_181_270 := x.amt_fcsp_not_181_270 - x.amt_pre_receive;
							x.amt_pre_receive      := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_181_2701
						then
							x.amt_pre_receive       := x.amt_pre_receive - x.amt_fcsp_not_181_2701;
							x.amt_fcsp_not_181_2701 := 0;
						else
							x.amt_fcsp_not_181_2701 := x.amt_fcsp_not_181_2701 - x.amt_pre_receive;
							x.amt_pre_receive       := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_91_180
						then
							x.amt_pre_receive    := x.amt_pre_receive - x.amt_receive_91_180;
							x.amt_receive_91_180 := 0;
						else
							x.amt_receive_91_180 := x.amt_receive_91_180 - x.amt_pre_receive;
							x.amt_pre_receive    := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_91_180
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_91_180;
							x.amt_fcsp_not_91_180 := 0;
						else
							x.amt_fcsp_not_91_180 := x.amt_fcsp_not_91_180 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_91_1801
						then
							x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_91_1801;
							x.amt_fcsp_not_91_1801 := 0;
						else
							x.amt_fcsp_not_91_1801 := x.amt_fcsp_not_91_1801 - x.amt_pre_receive;
							x.amt_pre_receive      := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_61_90
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_61_90;
							x.amt_receive_61_90 := 0;
						else
							x.amt_receive_61_90 := x.amt_receive_61_90 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_61_90
						then
							x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_61_90;
							x.amt_fcsp_not_61_90 := 0;
						else
							x.amt_fcsp_not_61_90 := x.amt_fcsp_not_61_90 - x.amt_pre_receive;
							x.amt_pre_receive    := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_61_901
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_61_901;
							x.amt_fcsp_not_61_901 := 0;
						else
							x.amt_fcsp_not_61_901 := x.amt_fcsp_not_61_901 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_31_60
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_31_60;
							x.amt_receive_31_60 := 0;
						else
							x.amt_receive_31_60 := x.amt_receive_31_60 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_31_60
						then
							x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_31_60;
							x.amt_fcsp_not_31_60 := 0;
						else
							x.amt_fcsp_not_31_60 := x.amt_fcsp_not_31_60 - x.amt_pre_receive;
							x.amt_pre_receive    := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_31_601
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_31_601;
							x.amt_fcsp_not_31_601 := 0;
						else
							x.amt_fcsp_not_31_601 := x.amt_fcsp_not_31_601 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_0_30
						then
							x.amt_pre_receive  := x.amt_pre_receive - x.amt_receive_0_30;
							x.amt_receive_0_30 := 0;
						else
							x.amt_receive_0_30 := x.amt_receive_0_30 - x.amt_pre_receive;
							x.amt_pre_receive  := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_0_30
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_0_30;
							x.amt_fcsp_not_0_30 := 0;
						else
						
							x.amt_fcsp_not_0_30 := x.amt_fcsp_not_0_30 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_0_301
						then
							x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_0_301;
							x.amt_fcsp_not_0_301 := 0;
						else
						
							x.amt_fcsp_not_0_301 := x.amt_fcsp_not_0_301 - x.amt_pre_receive;
							x.amt_pre_receive    := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_not_due
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_not_due;
							x.amt_receive_not_due := 0;
						else
						
							x.amt_receive_not_due := x.amt_receive_not_due - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_due
						then
							x.amt_pre_receive  := x.amt_pre_receive - x.amt_fcsp_not_due;
							x.amt_fcsp_not_due := 0;
						else
						
							x.amt_fcsp_not_due := x.amt_fcsp_not_due - x.amt_pre_receive;
							x.amt_pre_receive  := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_due1
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_due1;
							x.amt_fcsp_not_due1 := 0;
						else
						
							x.amt_fcsp_not_due1 := x.amt_fcsp_not_due1 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
						update scm_yszl_temp_code_all
							 set amt_pre_receive       = x.amt_pre_receive
									,amt_receive_not_due   = x.amt_receive_not_due
									,amt_fcsp_not_due1     = x.amt_fcsp_not_due1
									,amt_fcsp_not_due      = x.amt_fcsp_not_due
									,amt_receive_0_30      = x.amt_receive_0_30
									,amt_fcsp_not_0_301    = x.amt_fcsp_not_0_301
									,amt_fcsp_not_0_30     = x.amt_fcsp_not_0_30
									,amt_receive_31_60     = x.amt_receive_31_60
									,amt_fcsp_not_31_601   = x.amt_fcsp_not_31_601
									,amt_fcsp_not_31_60    = x.amt_fcsp_not_31_60
									,amt_receive_61_90     = x.amt_receive_61_90
									,amt_fcsp_not_61_901   = x.amt_fcsp_not_61_901
									,amt_fcsp_not_61_90    = x.amt_fcsp_not_61_90
									,amt_receive_91_180    = x.amt_receive_91_180
									,amt_fcsp_not_91_1801  = x.amt_fcsp_not_91_1801
									,amt_fcsp_not_91_180   = x.amt_fcsp_not_91_180
									,amt_receive_181_270   = x.amt_receive_181_270
									,amt_fcsp_not_181_2701 = x.amt_fcsp_not_181_2701
									,amt_fcsp_not_181_270  = x.amt_fcsp_not_181_270
									,amt_receive_271_360   = x.amt_receive_271_360
									,amt_fcsp_not_271_3601 = x.amt_fcsp_not_271_3601
									,amt_fcsp_not_271_360  = x.amt_fcsp_not_271_360
									,amt_receive_361       = x.amt_receive_361
									,amt_fcsp_not_3611     = x.amt_fcsp_not_3611
									,amt_fcsp_not_361      = x.amt_fcsp_not_361
						 where rowid = x.rowid;
					end if;
				end loop;
			elsif p_type = 2
			then
				null;
			else
				--核销预付款
				for x in c9
				loop
					if x.amt_pre_receive > 0
					then
						if x.amt_pre_receive > x.amt_receive_361
						then
							x.amt_pre_receive := x.amt_pre_receive - x.amt_receive_361;
							x.amt_receive_361 := 0;
						else
							x.amt_receive_361 := x.amt_receive_361 - x.amt_pre_receive;
							x.amt_pre_receive := 0;
						end if;
					
						------
						if x.amt_pre_receive > x.amt_receive_271_360
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_271_360;
							x.amt_receive_271_360 := 0;
						else
							x.amt_receive_271_360 := x.amt_receive_271_360 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_181_270
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_181_270;
							x.amt_receive_181_270 := 0;
						else
						
							x.amt_receive_181_270 := x.amt_receive_181_270 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_91_180
						then
							x.amt_pre_receive    := x.amt_pre_receive - x.amt_receive_91_180;
							x.amt_receive_91_180 := 0;
						else
							x.amt_receive_91_180 := x.amt_receive_91_180 - x.amt_pre_receive;
							x.amt_pre_receive    := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_61_90
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_61_90;
							x.amt_receive_61_90 := 0;
						else
							x.amt_receive_61_90 := x.amt_receive_61_90 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_31_60
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_31_60;
							x.amt_receive_31_60 := 0;
						else
							x.amt_receive_31_60 := x.amt_receive_31_60 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_0_30
						then
							x.amt_pre_receive  := x.amt_pre_receive - x.amt_receive_0_30;
							x.amt_receive_0_30 := 0;
						else
							x.amt_receive_0_30 := x.amt_receive_0_30 - x.amt_pre_receive;
							x.amt_pre_receive  := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_not_due
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_not_due;
							x.amt_receive_not_due := 0;
						else
						
							x.amt_receive_not_due := x.amt_receive_not_due - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						update scm_yszl_temp_code_all
							 set amt_pre_receive     = x.amt_pre_receive
									,amt_receive_not_due = x.amt_receive_not_due
									,
									 
									 amt_receive_0_30 = x.amt_receive_0_30
									,
									 
									 amt_receive_31_60 = x.amt_receive_31_60
									,
									 
									 amt_receive_61_90 = x.amt_receive_61_90
									,
									 
									 amt_receive_91_180 = x.amt_receive_91_180
									,
									 
									 amt_receive_181_270 = x.amt_receive_181_270
									,
									 
									 amt_receive_271_360 = x.amt_receive_271_360
									,
									 
									 amt_receive_361 = x.amt_receive_361
						
						 where rowid = x.rowid;
					end if;
				end loop;
			end if;
			update scm_yszl_temp_code_all
				 set amt_receive = amt_receive_not_due + amt_receive_0_30 + amt_receive_31_60 + amt_receive_61_90 +
													 amt_receive_91_180 + amt_receive_181_270 + amt_receive_271_360 + amt_receive_361
						,amt_fcsp    = amt_fcsp_not_due + amt_fcsp_not_0_30 + amt_fcsp_not_31_60 + amt_fcsp_not_61_90 +
													 amt_fcsp_not_91_180 + amt_fcsp_not_181_270 + amt_fcsp_not_271_360 + amt_fcsp_not_361
						,amt_fcsp1   = amt_fcsp_not_due1 + amt_fcsp_not_0_301 + amt_fcsp_not_31_601 + amt_fcsp_not_61_901 +
													 amt_fcsp_not_91_1801 + amt_fcsp_not_181_2701 + amt_fcsp_not_271_3601 + amt_fcsp_not_3611;
		
			update scm_yszl_temp_code_all set amt_actual_receive = amt_receive + amt_fcsp + amt_fcsp1;
		
			update scm_yszl_temp_code_all set amt_receive_total = amt_actual_receive - amt_pre_receive;
		
			commit;
		
			---输入报表格式
		
			html_report_pkg.v_report_output_mode := 'F';
		
			v_sep := '####';
			html_report_pkg.html_title(p_program_title => '应收帐款帐龄分析总表--客户类别(采购中心)'
																,p_report_title  => '应收帐款帐龄分析总表--客户类别(采购中心)');
			html_report_pkg.output_line('打印时间：' || to_char(sysdate
																										,'yyyy-mm-dd hh24:mi'));
			html_report_pkg.output_line('报表序号：' || p_request_id);
			html_report_pkg.output_line('<BR>截止日期：' || substr(p_end_date
																											 ,1
																											 ,10));
		
			if p_cust_num_start is not null or
				 p_cust_num_end is not null
			then
				html_report_pkg.output_line('<BR>客户编号，自：' || p_cust_num_start || '，至：' || p_cust_num_end);
			end if;
		
			if p_order_type is not null
			then
				html_report_pkg.output_line('<BR>订单类型：' || p_order_type);
			end if;
		
			html_report_pkg.output_line('<table width=2400 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
		
			v_line_str := '客户类别***rowspan=2 align=center,产业链***rowspan=2 align=center,客户名称***rowspan=2 align=center,实际应收余额***rowspan=2 align=center,预收余额***rowspan=2 align=center,应收余额***colspan=4 align=center,未到期***colspan=3 align=center,逾期合计***colspan=3 align=center,逾期0－30天***colspan=3 align=center,逾期31－60天***colspan=3 align=center,逾期61－90天***colspan=3 align=center,逾期91－180天***colspan=3 align=center,逾期181－270天***colspan=3 align=center,逾期271－360天***colspan=3 align=center,逾期360天以上***colspan=3 align=center,';
			html_report_pkg.line_title(p_title_string    => v_line_str
																,p_with_other_attr => 'Y'
																,p_attr_delimiter  => '***'
																,p_with_tr_flag    => 'Y');
		
			v_line_str := '合计*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,';
			html_report_pkg.line_title(p_title_string    => v_line_str
																,p_with_other_attr => 'Y'
																,p_attr_delimiter  => '***'
																,p_with_tr_flag    => 'Y');
			v_customer_class_code := 'aa';
			v_customer_type       := 'bb';
			v_flag                := 'N';
			v_flag1               := 'N';
			for r1 in c9
			loop
				dbms_output.put_line(r1.customer_class_code);
				html_report_pkg.output_line('<tr>');
				if v_customer_class_code <> r1.customer_class_code
				then
					if v_flag1 = 'Y'
					then
						for x in c5(v_customer_class_code
											 ,v_customer_type)
						loop
						
							html_report_pkg.output_line('<td>' || v_customer_type || '小计' || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
						
							--逾期合计  
						
							v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
													 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
							v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 +
													 x.amt_fcsp_not_91_1801 + x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 +
													 x.amt_fcsp_not_3611;
						
							v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
												x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
						
							html_report_pkg.output_line('<td>' || v_receive || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
							html_report_pkg.output_line('</tr>');
						end loop;
					
						for x in c6(v_customer_class_code)
						loop
							html_report_pkg.output_line('<td colspan=2 >' || v_customer_class_code || '合计' || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
						
							--逾期合计  
						
							v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
													 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
							v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 +
													 x.amt_fcsp_not_91_1801 + x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 +
													 x.amt_fcsp_not_3611;
						
							v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
												x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
						
							html_report_pkg.output_line('<td>' || v_receive || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
							html_report_pkg.output_line('</tr>');
						end loop;
					end if;
					v_flag1 := 'Y';
				
					/*      select count( nvl(rc.TAX_REFERENCE,99999999))+count(distinct a.CUSTOMER_TYPE )+1
          into v_count
           FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
          where instr(p_REQUEST_ID,a.REQUEST_ID)>0 
            and a.customer_number =rc.customer_number
            and a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE; */
					/*      SELECT count( nvl(rc.TAX_REFERENCE,99999999))+count(distinct a.CUSTOMER_TYPE )+1
             into v_count
             FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
            WHERE INSTR(p_REQUEST_ID,a.REQUEST_ID)>0 
              AND a.customer_number =rc.customer_number
              AND a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE
          GROUP BY a.CUSTOMER_CLASS_CODE;*/
					/*           select sum(count1)
                 into v_count_tax
                 from(   
           SELECT count( distinct nvl(rc.TAX_REFERENCE,99999999))count1
             FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
            WHERE INSTR(p_REQUEST_ID,a.REQUEST_ID)>0 
              AND a.customer_number =rc.customer_number
              AND a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE
          GROUP BY a.CUSTOMER_CLASS_CODE,a.CUSTOMER_TYPE,TAX_REFERENCE);
          
          select count(distinct a.CUSTOMER_TYPE)
           into v_count_type
           FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
            WHERE INSTR(p_REQUEST_ID,a.REQUEST_ID)>0 
              AND a.customer_number =rc.customer_number
              AND a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE;*/
				
					--v_count:=v_count_tax+v_count_type+1;   
				
					select count(tax_reference) + count(distinct customer_type) + 1
						into v_count
						from scm_yszl_temp_code_all
					 where customer_class_code = r1.customer_class_code
						 and amt_receive_total <> 0;
				
					html_report_pkg.output_line('<td rowspan=' || v_count || '>' || r1.customer_class_code || '</td>');
					v_customer_class_code := r1.customer_class_code;
					v_customer_type       := 'bb';
				end if;
			
				if v_customer_type <> nvl(r1.customer_type
																 ,'cc') and
					 v_customer_class_code = r1.customer_class_code
				then
					if v_flag = 'Y'
					then
						for x in c5(r1.customer_class_code
											 ,v_customer_type)
						loop
						
							html_report_pkg.output_line('<td>' || v_customer_type || '小计' || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
						
							--逾期合计  
						
							v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
													 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
							v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 +
													 x.amt_fcsp_not_91_1801 + x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 +
													 x.amt_fcsp_not_3611;
						
							v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
												x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
						
							html_report_pkg.output_line('<td>' || v_receive || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
							html_report_pkg.output_line('</tr>');
						end loop;
					end if;
					v_flag := 'Y';
					/*      select count( nvl(rc.TAX_REFERENCE,99999999))+1
             into v_count
             FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
            WHERE INSTR(p_REQUEST_ID,a.REQUEST_ID)>0 
              AND a.customer_number =rc.customer_number
              AND a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE
              and a.CUSTOMER_TYPE=r1.CUSTOMER_TYPE 
          GROUP BY a.CUSTOMER_CLASS_CODE,a.CUSTOMER_TYPE;  */
				
					/*      select sum(count1)+1
             into v_count 
            from(   
           SELECT COUNT( DISTINCT NVL(rc.TAX_REFERENCE,99999999))COUNT1
             FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
            WHERE INSTR(p_REQUEST_ID,a.REQUEST_ID)>0 
              AND a.customer_number =rc.customer_number
              AND a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE
              AND a.CUSTOMER_TYPE=r1.CUSTOMER_TYPE 
          GROUP BY a.CUSTOMER_CLASS_CODE,a.CUSTOMER_TYPE,TAX_REFERENCE);  */
				
					select count(tax_reference) + 1
						into v_count
						from scm_yszl_temp_code_all
					 where customer_class_code = r1.customer_class_code
						 and customer_type = r1.customer_type
						 and amt_receive_total <> 0;
				
					if v_count = 0
					then
						html_report_pkg.output_line('<td>' || r1.customer_type || '</td>');
					else
						html_report_pkg.output_line('<td rowspan=' || v_count || '>' || r1.customer_type || '</td>');
					end if;
					v_customer_type := nvl(r1.customer_type
																,'cc');
				end if;
				begin
					select substr(customer_name
											 ,3)
						into v_customer_name
						from ar_customers
					 where nvl(attribute3
										,99999999) = r1.tax_reference
						 and rownum = 1;
				exception
					when others then
						v_customer_name := 'aa';
				end;
			
				--html_report_pkg.output_line('<td>'||r1.CUSTOMER_TYPE||'</td>');
				html_report_pkg.output_line('<td>' || r1.tax_reference || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_receive_total || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_pre_receive || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_actual_receive || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_receive || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_not_due || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_due1 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_due || '</td>');
			
				--逾期合计  
			
				v_receive := r1.amt_receive_0_30 + r1.amt_receive_31_60 + r1.amt_receive_61_90 + r1.amt_receive_91_180 +
										 r1.amt_receive_181_270 + r1.amt_receive_271_360 + r1.amt_receive_361;
				v_fcsp1   := r1.amt_fcsp_not_0_301 + r1.amt_fcsp_not_31_601 + r1.amt_fcsp_not_61_901 + r1.amt_fcsp_not_91_1801 +
										 r1.amt_fcsp_not_181_2701 + r1.amt_fcsp_not_271_3601 + r1.amt_fcsp_not_3611;
			
				v_fcsp := r1.amt_fcsp_not_0_30 + r1.amt_fcsp_not_31_60 + r1.amt_fcsp_not_61_90 + r1.amt_fcsp_not_91_180 +
									r1.amt_fcsp_not_181_270 + r1.amt_fcsp_not_271_360 + r1.amt_fcsp_not_361;
			
				html_report_pkg.output_line('<td>' || v_receive || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_0_30 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_0_301 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_0_30 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_31_60 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_31_601 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_31_60 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_61_90 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_61_901 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_61_90 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_91_180 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_91_1801 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_91_180 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_181_270 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_181_2701 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_181_270 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_271_360 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_271_3601 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_271_360 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_361 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_3611 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_361 || '</td>');
				html_report_pkg.output_line('</tr>');
			
			end loop;
			---最后的合计
			for x in c5(v_customer_class_code
								 ,v_customer_type)
			loop
			
				html_report_pkg.output_line('<td>' || v_customer_type || '小计' || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
			
				--逾期合计  
			
				v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
										 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
				v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
										 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
			
				v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
									x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
			
				html_report_pkg.output_line('<td>' || v_receive || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
				html_report_pkg.output_line('</tr>');
			end loop;
		
			for x in c6(v_customer_class_code)
			loop
				html_report_pkg.output_line('<td colspan=2 >' || v_customer_class_code || '合计' || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
			
				--逾期合计  
			
				v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
										 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
				v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
										 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
			
				v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
									x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
			
				html_report_pkg.output_line('<td>' || v_receive || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
				html_report_pkg.output_line('</tr>');
			end loop;
			---总的合计
			for x in c8
			loop
				html_report_pkg.output_line('<td colspan=3 >' || '总计' || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
			
				--逾期合计  
			
				v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
										 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
				v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
										 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
			
				v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
									x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
			
				html_report_pkg.output_line('<td>' || v_receive || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
				html_report_pkg.output_line('</tr>');
			end loop;
		
			html_report_pkg.output_line('</tr></table></html>');
		
		else
			--插入临时表
			for x in c7(p_request_id)
			loop
				insert into scm_yszl_temp_code_all
				values
					(x.customer_class_code
					,x.customer_type
					,x.tax_reference
					,x.amt_receive_total
					,x.amt_pre_receive
					,x.amt_actual_receive
					,x.amt_receive
					,x.amt_fcsp1
					,x.amt_fcsp
					,x.amt_receive_not_due
					,x.amt_fcsp_not_due1
					,x.amt_fcsp_not_due
					,x.amt_receive_0_30
					,x.amt_fcsp_not_0_301
					,x.amt_fcsp_not_0_30
					,x.amt_receive_31_60
					,x.amt_fcsp_not_31_601
					,x.amt_fcsp_not_31_60
					,x.amt_receive_61_90
					,x.amt_fcsp_not_61_901
					,x.amt_fcsp_not_61_90
					,x.amt_receive_91_180
					,x.amt_fcsp_not_91_1801
					,x.amt_fcsp_not_91_180
					,x.amt_receive_181_270
					,x.amt_fcsp_not_181_2701
					,x.amt_fcsp_not_181_270
					,x.amt_receive_271_360
					,x.amt_fcsp_not_271_3601
					,x.amt_fcsp_not_271_360
					,x.amt_receive_361
					,x.amt_fcsp_not_3611
					,x.amt_fcsp_not_361
					,'');
				commit;
			end loop;
			if p_type = 1
			then
				--核销预付款
				for x in c9
				loop
					if x.amt_pre_receive > 0
					then
						if x.amt_pre_receive > x.amt_receive_361
						then
							x.amt_pre_receive := x.amt_pre_receive - x.amt_receive_361;
							x.amt_receive_361 := 0;
						else
							x.amt_receive_361 := x.amt_receive_361 - x.amt_pre_receive;
							x.amt_pre_receive := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_361
						then
							x.amt_pre_receive  := x.amt_pre_receive - x.amt_fcsp_not_361;
							x.amt_fcsp_not_361 := 0;
						else
							x.amt_fcsp_not_361 := x.amt_fcsp_not_361 - x.amt_pre_receive;
							x.amt_pre_receive  := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_3611
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_3611;
							x.amt_fcsp_not_3611 := 0;
						else
							x.amt_fcsp_not_3611 := x.amt_fcsp_not_3611 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
						------
						if x.amt_pre_receive > x.amt_receive_271_360
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_271_360;
							x.amt_receive_271_360 := 0;
						else
							x.amt_receive_271_360 := x.amt_receive_271_360 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_271_360
						then
							x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_271_360;
							x.amt_fcsp_not_271_360 := 0;
						else
							x.amt_fcsp_not_271_360 := x.amt_fcsp_not_271_360 - x.amt_pre_receive;
							x.amt_pre_receive      := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_271_3601
						then
							x.amt_pre_receive       := x.amt_pre_receive - x.amt_fcsp_not_271_3601;
							x.amt_fcsp_not_271_3601 := 0;
						else
							x.amt_fcsp_not_271_3601 := x.amt_fcsp_not_271_3601 - x.amt_pre_receive;
							x.amt_pre_receive       := 0;
						end if;
						---- 
						if x.amt_pre_receive > x.amt_receive_181_270
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_181_270;
							x.amt_receive_181_270 := 0;
						else
						
							x.amt_receive_181_270 := x.amt_receive_181_270 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_181_270
						then
							x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_181_270;
							x.amt_fcsp_not_181_270 := 0;
						else
							x.amt_fcsp_not_181_270 := x.amt_fcsp_not_181_270 - x.amt_pre_receive;
							x.amt_pre_receive      := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_181_2701
						then
							x.amt_pre_receive       := x.amt_pre_receive - x.amt_fcsp_not_181_2701;
							x.amt_fcsp_not_181_2701 := 0;
						else
							x.amt_fcsp_not_181_2701 := x.amt_fcsp_not_181_2701 - x.amt_pre_receive;
							x.amt_pre_receive       := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_91_180
						then
							x.amt_pre_receive    := x.amt_pre_receive - x.amt_receive_91_180;
							x.amt_receive_91_180 := 0;
						else
							x.amt_receive_91_180 := x.amt_receive_91_180 - x.amt_pre_receive;
							x.amt_pre_receive    := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_91_180
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_91_180;
							x.amt_fcsp_not_91_180 := 0;
						else
							x.amt_fcsp_not_91_180 := x.amt_fcsp_not_91_180 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_91_1801
						then
							x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_91_1801;
							x.amt_fcsp_not_91_1801 := 0;
						else
							x.amt_fcsp_not_91_1801 := x.amt_fcsp_not_91_1801 - x.amt_pre_receive;
							x.amt_pre_receive      := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_61_90
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_61_90;
							x.amt_receive_61_90 := 0;
						else
							x.amt_receive_61_90 := x.amt_receive_61_90 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_61_90
						then
							x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_61_90;
							x.amt_fcsp_not_61_90 := 0;
						else
							x.amt_fcsp_not_61_90 := x.amt_fcsp_not_61_90 - x.amt_pre_receive;
							x.amt_pre_receive    := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_61_901
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_61_901;
							x.amt_fcsp_not_61_901 := 0;
						else
							x.amt_fcsp_not_61_901 := x.amt_fcsp_not_61_901 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_31_60
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_31_60;
							x.amt_receive_31_60 := 0;
						else
							x.amt_receive_31_60 := x.amt_receive_31_60 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_31_60
						then
							x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_31_60;
							x.amt_fcsp_not_31_60 := 0;
						else
							x.amt_fcsp_not_31_60 := x.amt_fcsp_not_31_60 - x.amt_pre_receive;
							x.amt_pre_receive    := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_31_601
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_31_601;
							x.amt_fcsp_not_31_601 := 0;
						else
							x.amt_fcsp_not_31_601 := x.amt_fcsp_not_31_601 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_0_30
						then
							x.amt_pre_receive  := x.amt_pre_receive - x.amt_receive_0_30;
							x.amt_receive_0_30 := 0;
						else
							x.amt_receive_0_30 := x.amt_receive_0_30 - x.amt_pre_receive;
							x.amt_pre_receive  := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_0_30
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_0_30;
							x.amt_fcsp_not_0_30 := 0;
						else
						
							x.amt_fcsp_not_0_30 := x.amt_fcsp_not_0_30 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_0_301
						then
							x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_0_301;
							x.amt_fcsp_not_0_301 := 0;
						else
						
							x.amt_fcsp_not_0_301 := x.amt_fcsp_not_0_301 - x.amt_pre_receive;
							x.amt_pre_receive    := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_not_due
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_not_due;
							x.amt_receive_not_due := 0;
						else
						
							x.amt_receive_not_due := x.amt_receive_not_due - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_due
						then
							x.amt_pre_receive  := x.amt_pre_receive - x.amt_fcsp_not_due;
							x.amt_fcsp_not_due := 0;
						else
						
							x.amt_fcsp_not_due := x.amt_fcsp_not_due - x.amt_pre_receive;
							x.amt_pre_receive  := 0;
						end if;
					
						if x.amt_pre_receive > x.amt_fcsp_not_due1
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_due1;
							x.amt_fcsp_not_due1 := 0;
						else
						
							x.amt_fcsp_not_due1 := x.amt_fcsp_not_due1 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
						update scm_yszl_temp_code_all
							 set amt_pre_receive       = x.amt_pre_receive
									,amt_receive_not_due   = x.amt_receive_not_due
									,amt_fcsp_not_due1     = x.amt_fcsp_not_due1
									,amt_fcsp_not_due      = x.amt_fcsp_not_due
									,amt_receive_0_30      = x.amt_receive_0_30
									,amt_fcsp_not_0_301    = x.amt_fcsp_not_0_301
									,amt_fcsp_not_0_30     = x.amt_fcsp_not_0_30
									,amt_receive_31_60     = x.amt_receive_31_60
									,amt_fcsp_not_31_601   = x.amt_fcsp_not_31_601
									,amt_fcsp_not_31_60    = x.amt_fcsp_not_31_60
									,amt_receive_61_90     = x.amt_receive_61_90
									,amt_fcsp_not_61_901   = x.amt_fcsp_not_61_901
									,amt_fcsp_not_61_90    = x.amt_fcsp_not_61_90
									,amt_receive_91_180    = x.amt_receive_91_180
									,amt_fcsp_not_91_1801  = x.amt_fcsp_not_91_1801
									,amt_fcsp_not_91_180   = x.amt_fcsp_not_91_180
									,amt_receive_181_270   = x.amt_receive_181_270
									,amt_fcsp_not_181_2701 = x.amt_fcsp_not_181_2701
									,amt_fcsp_not_181_270  = x.amt_fcsp_not_181_270
									,amt_receive_271_360   = x.amt_receive_271_360
									,amt_fcsp_not_271_3601 = x.amt_fcsp_not_271_3601
									,amt_fcsp_not_271_360  = x.amt_fcsp_not_271_360
									,amt_receive_361       = x.amt_receive_361
									,amt_fcsp_not_3611     = x.amt_fcsp_not_3611
									,amt_fcsp_not_361      = x.amt_fcsp_not_361
						 where rowid = x.rowid;
					end if;
				end loop;
			elsif p_type = 2
			then
				null;
			else
				--核销预付款
				for x in c9
				loop
					if x.amt_pre_receive > 0
					then
						if x.amt_pre_receive > x.amt_receive_361
						then
							x.amt_pre_receive := x.amt_pre_receive - x.amt_receive_361;
							x.amt_receive_361 := 0;
						else
							x.amt_receive_361 := x.amt_receive_361 - x.amt_pre_receive;
							x.amt_pre_receive := 0;
						end if;
						------
						if x.amt_pre_receive > x.amt_receive_271_360
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_271_360;
							x.amt_receive_271_360 := 0;
						else
							x.amt_receive_271_360 := x.amt_receive_271_360 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_181_270
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_181_270;
							x.amt_receive_181_270 := 0;
						else
						
							x.amt_receive_181_270 := x.amt_receive_181_270 - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_91_180
						then
							x.amt_pre_receive    := x.amt_pre_receive - x.amt_receive_91_180;
							x.amt_receive_91_180 := 0;
						else
							x.amt_receive_91_180 := x.amt_receive_91_180 - x.amt_pre_receive;
							x.amt_pre_receive    := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_61_90
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_61_90;
							x.amt_receive_61_90 := 0;
						else
							x.amt_receive_61_90 := x.amt_receive_61_90 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_31_60
						then
							x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_31_60;
							x.amt_receive_31_60 := 0;
						else
							x.amt_receive_31_60 := x.amt_receive_31_60 - x.amt_pre_receive;
							x.amt_pre_receive   := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_0_30
						then
							x.amt_pre_receive  := x.amt_pre_receive - x.amt_receive_0_30;
							x.amt_receive_0_30 := 0;
						else
							x.amt_receive_0_30 := x.amt_receive_0_30 - x.amt_pre_receive;
							x.amt_pre_receive  := 0;
						end if;
					
						---- 
						if x.amt_pre_receive > x.amt_receive_not_due
						then
							x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_not_due;
							x.amt_receive_not_due := 0;
						else
						
							x.amt_receive_not_due := x.amt_receive_not_due - x.amt_pre_receive;
							x.amt_pre_receive     := 0;
						end if;
					
						update scm_yszl_temp_code_all
							 set amt_pre_receive     = x.amt_pre_receive
									,amt_receive_not_due = x.amt_receive_not_due
									,amt_receive_0_30    = x.amt_receive_0_30
									,amt_receive_31_60   = x.amt_receive_31_60
									,amt_receive_61_90   = x.amt_receive_61_90
									,amt_receive_91_180  = x.amt_receive_91_180
									,amt_receive_181_270 = x.amt_receive_181_270
									,amt_receive_271_360 = x.amt_receive_271_360
									,amt_receive_361     = x.amt_receive_361
						 where rowid = x.rowid;
					end if;
				end loop;
			end if;
			update scm_yszl_temp_code_all
				 set amt_receive = amt_receive_not_due + amt_receive_0_30 + amt_receive_31_60 + amt_receive_61_90 +
													 amt_receive_91_180 + amt_receive_181_270 + amt_receive_271_360 + amt_receive_361
						,amt_fcsp    = amt_fcsp_not_due + amt_fcsp_not_0_30 + amt_fcsp_not_31_60 + amt_fcsp_not_61_90 +
													 amt_fcsp_not_91_180 + amt_fcsp_not_181_270 + amt_fcsp_not_271_360 + amt_fcsp_not_361
						,amt_fcsp1   = amt_fcsp_not_due1 + amt_fcsp_not_0_301 + amt_fcsp_not_31_601 + amt_fcsp_not_61_901 +
													 amt_fcsp_not_91_1801 + amt_fcsp_not_181_2701 + amt_fcsp_not_271_3601 + amt_fcsp_not_3611;
		
			update scm_yszl_temp_code_all set amt_actual_receive = amt_receive + amt_fcsp + amt_fcsp1;
		
			update scm_yszl_temp_code_all set amt_receive_total = amt_actual_receive - amt_pre_receive;
		
			commit;
		
			---输入报表格式
		
			html_report_pkg.v_report_output_mode := 'F';
		
			v_sep := '####';
			html_report_pkg.html_title(p_program_title => '应收帐款帐龄分析总表--客户类别(采购中心)'
																,p_report_title  => '应收帐款帐龄分析总表--客户类别(采购中心)');
			html_report_pkg.output_line('打印时间：' || to_char(sysdate
																										,'yyyy-mm-dd hh24:mi'));
			html_report_pkg.output_line('报表序号：' || p_request_id);
			html_report_pkg.output_line('<BR>截止日期：' || substr(p_end_date
																											 ,1
																											 ,10));
		
			if p_cust_num_start is not null or
				 p_cust_num_end is not null
			then
				html_report_pkg.output_line('<BR>客户编号，自：' || p_cust_num_start || '，至：' || p_cust_num_end);
			end if;
		
			if p_order_type is not null
			then
				html_report_pkg.output_line('<BR>订单类型：' || p_order_type);
			end if;
		
			html_report_pkg.output_line('<table width=2400 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
		
			v_line_str := '客户类别***rowspan=2 align=center,产业链***rowspan=2 align=center,客户名称***rowspan=2 align=center,实际应收余额***rowspan=2 align=center,预收余额***rowspan=2 align=center,应收余额***colspan=4 align=center,未到期***colspan=3 align=center,逾期合计***colspan=3 align=center,逾期0－30天***colspan=3 align=center,逾期31－60天***colspan=3 align=center,逾期61－90天***colspan=3 align=center,逾期91－180天***colspan=3 align=center,逾期181－270天***colspan=3 align=center,逾期271－360天***colspan=3 align=center,逾期360天以上***colspan=3 align=center,';
			html_report_pkg.line_title(p_title_string    => v_line_str
																,p_with_other_attr => 'Y'
																,p_attr_delimiter  => '***'
																,p_with_tr_flag    => 'Y');
		
			v_line_str := '合计*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,';
			html_report_pkg.line_title(p_title_string    => v_line_str
																,p_with_other_attr => 'Y'
																,p_attr_delimiter  => '***'
																,p_with_tr_flag    => 'Y');
			v_customer_class_code := 'aa';
			v_customer_type       := 'bb';
			v_flag                := 'N';
			v_flag1               := 'N';
			for r1 in c9
			loop
				dbms_output.put_line(r1.customer_class_code);
				html_report_pkg.output_line('<tr>');
				if v_customer_class_code <> r1.customer_class_code
				then
					if v_flag1 = 'Y'
					then
						for x in c5(v_customer_class_code
											 ,v_customer_type)
						loop
						
							html_report_pkg.output_line('<td>' || v_customer_type || '小计' || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
						
							--逾期合计  
						
							v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
													 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
							v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 +
													 x.amt_fcsp_not_91_1801 + x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 +
													 x.amt_fcsp_not_3611;
						
							v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
												x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
						
							html_report_pkg.output_line('<td>' || v_receive || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
							html_report_pkg.output_line('</tr>');
						end loop;
					
						for x in c6(v_customer_class_code)
						loop
							html_report_pkg.output_line('<td colspan=2 >' || v_customer_class_code || '合计' || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
						
							--逾期合计  
						
							v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
													 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
							v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 +
													 x.amt_fcsp_not_91_1801 + x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 +
													 x.amt_fcsp_not_3611;
						
							v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
												x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
						
							html_report_pkg.output_line('<td>' || v_receive || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
							html_report_pkg.output_line('</tr>');
						end loop;
					end if;
					v_flag1 := 'Y';
				
					/*      select count( nvl(rc.TAX_REFERENCE,99999999))+count(distinct a.CUSTOMER_TYPE )+1
          into v_count
           FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
          where instr(p_REQUEST_ID,a.REQUEST_ID)>0 
            and a.customer_number =rc.customer_number
            and a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE; */
					/*      SELECT count( nvl(rc.TAX_REFERENCE,99999999))+count(distinct a.CUSTOMER_TYPE )+1
             into v_count
             FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
            WHERE INSTR(p_REQUEST_ID,a.REQUEST_ID)>0 
              AND a.customer_number =rc.customer_number
              AND a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE
          GROUP BY a.CUSTOMER_CLASS_CODE;*/
					/*           select sum(count1)
                 into v_count_tax
                 from(   
           SELECT count( distinct nvl(rc.TAX_REFERENCE,99999999))count1
             FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
            WHERE INSTR(p_REQUEST_ID,a.REQUEST_ID)>0 
              AND a.customer_number =rc.customer_number
              AND a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE
          GROUP BY a.CUSTOMER_CLASS_CODE,a.CUSTOMER_TYPE,TAX_REFERENCE);
          
          select count(distinct a.CUSTOMER_TYPE)
           into v_count_type
           FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
            WHERE INSTR(p_REQUEST_ID,a.REQUEST_ID)>0 
              AND a.customer_number =rc.customer_number
              AND a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE;*/
				
					--v_count:=v_count_tax+v_count_type+1;   
				
					select count(tax_reference) + count(distinct customer_type) + 1
						into v_count
						from scm_yszl_temp_code_all
					 where customer_class_code = r1.customer_class_code
						 and amt_receive_total <> 0;
				
					html_report_pkg.output_line('<td rowspan=' || v_count || '>' || r1.customer_class_code || '</td>');
					v_customer_class_code := r1.customer_class_code;
					v_customer_type       := 'bb';
				end if;
			
				if v_customer_type <> nvl(r1.customer_type
																 ,'cc') and
					 v_customer_class_code = r1.customer_class_code
				then
					if v_flag = 'Y'
					then
						for x in c5(r1.customer_class_code
											 ,v_customer_type)
						loop
						
							html_report_pkg.output_line('<td>' || v_customer_type || '小计' || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
						
							--逾期合计  
						
							v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
													 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
							v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 +
													 x.amt_fcsp_not_91_1801 + x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 +
													 x.amt_fcsp_not_3611;
						
							v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
												x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
						
							html_report_pkg.output_line('<td>' || v_receive || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
							html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
						
							html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
							html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
							html_report_pkg.output_line('</tr>');
						end loop;
					end if;
					v_flag := 'Y';
					/*      select count( nvl(rc.TAX_REFERENCE,99999999))+1
             into v_count
             FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
            WHERE INSTR(p_REQUEST_ID,a.REQUEST_ID)>0 
              AND a.customer_number =rc.customer_number
              AND a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE
              and a.CUSTOMER_TYPE=r1.CUSTOMER_TYPE 
          GROUP BY a.CUSTOMER_CLASS_CODE,a.CUSTOMER_TYPE;  */
				
					/*      select sum(count1)+1
             into v_count 
            from(   
           SELECT COUNT( DISTINCT NVL(rc.TAX_REFERENCE,99999999))COUNT1
             FROM scm_yszl_temp_code a,ar_CUSTOMERS rc
            WHERE INSTR(p_REQUEST_ID,a.REQUEST_ID)>0 
              AND a.customer_number =rc.customer_number
              AND a.CUSTOMER_CLASS_CODE=r1.CUSTOMER_CLASS_CODE
              AND a.CUSTOMER_TYPE=r1.CUSTOMER_TYPE 
          GROUP BY a.CUSTOMER_CLASS_CODE,a.CUSTOMER_TYPE,TAX_REFERENCE);  */
				
					select count(tax_reference) + 1
						into v_count
						from scm_yszl_temp_code_all
					 where customer_class_code = r1.customer_class_code
						 and customer_type = r1.customer_type
						 and amt_receive_total <> 0;
				
					if v_count = 0
					then
						html_report_pkg.output_line('<td>' || r1.customer_type || '</td>');
					else
						html_report_pkg.output_line('<td rowspan=' || v_count || '>' || r1.customer_type || '</td>');
					end if;
					v_customer_type := nvl(r1.customer_type
																,'cc');
				end if;
				begin
					select substr(customer_name
											 ,3)
						into v_customer_name
						from ar_customers
					 where nvl(attribute3
										,99999999) = r1.tax_reference
						 and rownum = 1;
				exception
					when others then
						v_customer_name := 'aa';
				end;
			
				--html_report_pkg.output_line('<td>'||r1.CUSTOMER_TYPE||'</td>');
				html_report_pkg.output_line('<td>' || r1.tax_reference || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_receive_total || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_pre_receive || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_actual_receive || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_receive || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_not_due || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_due1 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_due || '</td>');
			
				--逾期合计  
			
				v_receive := r1.amt_receive_0_30 + r1.amt_receive_31_60 + r1.amt_receive_61_90 + r1.amt_receive_91_180 +
										 r1.amt_receive_181_270 + r1.amt_receive_271_360 + r1.amt_receive_361;
				v_fcsp1   := r1.amt_fcsp_not_0_301 + r1.amt_fcsp_not_31_601 + r1.amt_fcsp_not_61_901 + r1.amt_fcsp_not_91_1801 +
										 r1.amt_fcsp_not_181_2701 + r1.amt_fcsp_not_271_3601 + r1.amt_fcsp_not_3611;
			
				v_fcsp := r1.amt_fcsp_not_0_30 + r1.amt_fcsp_not_31_60 + r1.amt_fcsp_not_61_90 + r1.amt_fcsp_not_91_180 +
									r1.amt_fcsp_not_181_270 + r1.amt_fcsp_not_271_360 + r1.amt_fcsp_not_361;
			
				html_report_pkg.output_line('<td>' || v_receive || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_0_30 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_0_301 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_0_30 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_31_60 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_31_601 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_31_60 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_61_90 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_61_901 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_61_90 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_91_180 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_91_1801 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_91_180 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_181_270 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_181_2701 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_181_270 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_271_360 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_271_3601 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_271_360 || '</td>');
			
				html_report_pkg.output_line('<td>' || r1.amt_receive_361 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_3611 || '</td>');
				html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_361 || '</td>');
				html_report_pkg.output_line('</tr>');
			
			end loop;
			---最后的合计
			for x in c5(v_customer_class_code
								 ,v_customer_type)
			loop
			
				html_report_pkg.output_line('<td>' || v_customer_type || '小计' || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
			
				--逾期合计  
			
				v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
										 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
				v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
										 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
			
				v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
									x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
			
				html_report_pkg.output_line('<td>' || v_receive || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
				html_report_pkg.output_line('</tr>');
			end loop;
		
			for x in c6(v_customer_class_code)
			loop
				html_report_pkg.output_line('<td colspan=2 >' || v_customer_class_code || '合计' || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
			
				--逾期合计  
			
				v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
										 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
				v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
										 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
			
				v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
									x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
			
				html_report_pkg.output_line('<td>' || v_receive || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
				html_report_pkg.output_line('</tr>');
			end loop;
			---总的合计
			for x in c8
			loop
				html_report_pkg.output_line('<td colspan=3 >' || '总计' || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
			
				--逾期合计  
			
				v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
										 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
				v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
										 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
			
				v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
									x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
			
				html_report_pkg.output_line('<td>' || v_receive || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
				html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
			
				html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
				html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
				html_report_pkg.output_line('</tr>');
			end loop;
		
			html_report_pkg.output_line('</tr></table></html>');
		end if;
	end;

	procedure jd_receive_report_type_all(p_1              out varchar2
																			,p_2              out varchar2
																			,p_end_date       in varchar2
																			,p_request_id     in varchar2
																			,p_order_type     in varchar2
																			,p_order_type_n   in varchar2 default null
																			,p_cust_num_start in varchar2
																			,p_cust_num_end   in varchar2
																			,p_exclude        in varchar2
																			,p_type           in varchar2) as
		v_line_str      varchar2(4000);
		v_sep           varchar2(5);
		v_order_type    varchar2(50);
		v_count         integer;
		v_receive       number;
		v_fcsp1         number;
		v_fcsp          number;
		v_customer_name varchar2(200);
		v_flag          varchar2(1);
		cursor c3(p_request_id in varchar2) is
			select translate(order_type
											,'ABCDEFGHIJKLMNOPQRSTUVWXYZ.'
											,' ') order_type
						,nvl(attribute3
								,rc.customer_name) tax_reference
						,sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_type a
						,ar_customers       rc
			 where instr(p_request_id
									,a.request_id) > 0
				 and a.customer_number = rc.customer_number
				 and (p_exclude = 'N' or
							translate(order_type
											 ,'ABCDEFGHIJKLMNOPQRSTUVWXYZ.'
											 ,' ') not in ('铜管订单'
																		,'漆包线订单'))
				 and order_type <> 'N/A' --add wuyujin 2010-10-16      
			 group by translate(order_type
												 ,'ABCDEFGHIJKLMNOPQRSTUVWXYZ.'
												 ,' ')
							 ,nvl(attribute3
									 ,rc.customer_name);
		cursor c4 is
			select rowid
						,a.*
				from scm_yszl_temp_type_all a
			--where amt_receive_total <> 0
			--changed where by yaoxun 2013-10-17 
			 where amt_receive_total <> 0
					or a.amt_pre_receive <> 0
			 order by order_type
							 ,amt_receive_total desc;
		/*ORDER BY DECODE(TRANSLATE(order_type,'ABCDEFGHIJKLMNOPQRSTUVWXYZ.',' '),
            '钢材订单',1,
    '塑料订单',2,
    '铝材订单',3,
    '铜杆订单',4,
    '漆包线订单',5,
    '铜管订单',6,
    '开料加工',7,
    '包装材料订单',8,
    '芯片订单',9,
    '电源线订单',10,
    '钢材订单 (开料部)',11,
    '代理进口销售订单',12,
    13);*/
		cursor c5(p_order_type in varchar2) is
			select order_type
						,sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_type_all
			 where order_type = p_order_type
						--and amt_receive_total <> 0
						--changed where by yaoxun 2013-10-17 
				 and (amt_receive_total <> 0 or amt_pre_receive <> 0)
			 group by order_type;
		cursor c51 is
			select sum(amt_receive_total) amt_receive_total
						,sum(amt_pre_receive) amt_pre_receive
						,sum(amt_actual_receive) amt_actual_receive
						,sum(amt_receive) amt_receive
						,sum(amt_fcsp1) amt_fcsp1
						,sum(amt_fcsp) amt_fcsp
						,sum(amt_receive_not_due) amt_receive_not_due
						,sum(amt_fcsp_not_due1) amt_fcsp_not_due1
						,sum(amt_fcsp_not_due) amt_fcsp_not_due
						,sum(amt_receive_0_30) amt_receive_0_30
						,sum(amt_fcsp_not_0_301) amt_fcsp_not_0_301
						,sum(amt_fcsp_not_0_30) amt_fcsp_not_0_30
						,sum(amt_receive_31_60) amt_receive_31_60
						,sum(amt_fcsp_not_31_601) amt_fcsp_not_31_601
						,sum(amt_fcsp_not_31_60) amt_fcsp_not_31_60
						,sum(amt_receive_61_90) amt_receive_61_90
						,sum(amt_fcsp_not_61_901) amt_fcsp_not_61_901
						,sum(amt_fcsp_not_61_90) amt_fcsp_not_61_90
						,sum(amt_receive_91_180) amt_receive_91_180
						,sum(amt_fcsp_not_91_1801) amt_fcsp_not_91_1801
						,sum(amt_fcsp_not_91_180) amt_fcsp_not_91_180
						,sum(amt_receive_181_270) amt_receive_181_270
						,sum(amt_fcsp_not_181_2701) amt_fcsp_not_181_2701
						,sum(amt_fcsp_not_181_270) amt_fcsp_not_181_270
						,sum(amt_receive_271_360) amt_receive_271_360
						,sum(amt_fcsp_not_271_3601) amt_fcsp_not_271_3601
						,sum(amt_fcsp_not_271_360) amt_fcsp_not_271_360
						,sum(amt_receive_361) amt_receive_361
						,sum(amt_fcsp_not_3611) amt_fcsp_not_3611
						,sum(amt_fcsp_not_361) amt_fcsp_not_361
				from scm_yszl_temp_type_all
			--where amt_receive_total <> 0
			--changed where by yaoxun 2013-10-17 
			 where amt_receive_total <> 0
					or amt_pre_receive <> 0;
	begin
	
		---插入临时表
		for x in c3(p_request_id)
		loop
			insert into scm_yszl_temp_type_all
			values
				(x.order_type
				,x.tax_reference
				,x.amt_receive_total
				,x.amt_pre_receive
				,x.amt_actual_receive
				,x.amt_receive
				,x.amt_fcsp1
				,x.amt_fcsp
				,x.amt_receive_not_due
				,x.amt_fcsp_not_due1
				,x.amt_fcsp_not_due
				,x.amt_receive_0_30
				,x.amt_fcsp_not_0_301
				,x.amt_fcsp_not_0_30
				,x.amt_receive_31_60
				,x.amt_fcsp_not_31_601
				,x.amt_fcsp_not_31_60
				,x.amt_receive_61_90
				,x.amt_fcsp_not_61_901
				,x.amt_fcsp_not_61_90
				,x.amt_receive_91_180
				,x.amt_fcsp_not_91_1801
				,x.amt_fcsp_not_91_180
				,x.amt_receive_181_270
				,x.amt_fcsp_not_181_2701
				,x.amt_fcsp_not_181_270
				,x.amt_receive_271_360
				,x.amt_fcsp_not_271_3601
				,x.amt_fcsp_not_271_360
				,x.amt_receive_361
				,x.amt_fcsp_not_3611
				,x.amt_fcsp_not_361
				,'');
			commit;
		end loop;
	
		if p_type = 1
		then
			--核销预付款
			for x in c4
			loop
				if x.amt_pre_receive > 0
				then
					if x.amt_pre_receive > x.amt_receive_361
					then
						x.amt_pre_receive := x.amt_pre_receive - x.amt_receive_361;
						x.amt_receive_361 := 0;
					else
						x.amt_receive_361 := x.amt_receive_361 - x.amt_pre_receive;
						x.amt_pre_receive := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_361
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_fcsp_not_361;
						x.amt_fcsp_not_361 := 0;
					else
						x.amt_fcsp_not_361 := x.amt_fcsp_not_361 - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_3611
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_3611;
						x.amt_fcsp_not_3611 := 0;
					else
						x.amt_fcsp_not_3611 := x.amt_fcsp_not_3611 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
					------
					if x.amt_pre_receive > x.amt_receive_271_360
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_271_360;
						x.amt_receive_271_360 := 0;
					else
						x.amt_receive_271_360 := x.amt_receive_271_360 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_271_360
					then
						x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_271_360;
						x.amt_fcsp_not_271_360 := 0;
					else
						x.amt_fcsp_not_271_360 := x.amt_fcsp_not_271_360 - x.amt_pre_receive;
						x.amt_pre_receive      := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_271_3601
					then
						x.amt_pre_receive       := x.amt_pre_receive - x.amt_fcsp_not_271_3601;
						x.amt_fcsp_not_271_3601 := 0;
					else
						x.amt_fcsp_not_271_3601 := x.amt_fcsp_not_271_3601 - x.amt_pre_receive;
						x.amt_pre_receive       := 0;
					end if;
					---- 
					if x.amt_pre_receive > x.amt_receive_181_270
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_181_270;
						x.amt_receive_181_270 := 0;
					else
					
						x.amt_receive_181_270 := x.amt_receive_181_270 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_181_270
					then
						x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_181_270;
						x.amt_fcsp_not_181_270 := 0;
					else
						x.amt_fcsp_not_181_270 := x.amt_fcsp_not_181_270 - x.amt_pre_receive;
						x.amt_pre_receive      := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_181_2701
					then
						x.amt_pre_receive       := x.amt_pre_receive - x.amt_fcsp_not_181_2701;
						x.amt_fcsp_not_181_2701 := 0;
					else
						x.amt_fcsp_not_181_2701 := x.amt_fcsp_not_181_2701 - x.amt_pre_receive;
						x.amt_pre_receive       := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_91_180
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_receive_91_180;
						x.amt_receive_91_180 := 0;
					else
						x.amt_receive_91_180 := x.amt_receive_91_180 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_91_180
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_91_180;
						x.amt_fcsp_not_91_180 := 0;
					else
						x.amt_fcsp_not_91_180 := x.amt_fcsp_not_91_180 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_91_1801
					then
						x.amt_pre_receive      := x.amt_pre_receive - x.amt_fcsp_not_91_1801;
						x.amt_fcsp_not_91_1801 := 0;
					else
						x.amt_fcsp_not_91_1801 := x.amt_fcsp_not_91_1801 - x.amt_pre_receive;
						x.amt_pre_receive      := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_61_90
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_61_90;
						x.amt_receive_61_90 := 0;
					else
						x.amt_receive_61_90 := x.amt_receive_61_90 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_61_90
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_61_90;
						x.amt_fcsp_not_61_90 := 0;
					else
						x.amt_fcsp_not_61_90 := x.amt_fcsp_not_61_90 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_61_901
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_61_901;
						x.amt_fcsp_not_61_901 := 0;
					else
						x.amt_fcsp_not_61_901 := x.amt_fcsp_not_61_901 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_31_60
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_31_60;
						x.amt_receive_31_60 := 0;
					else
						x.amt_receive_31_60 := x.amt_receive_31_60 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_31_60
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_31_60;
						x.amt_fcsp_not_31_60 := 0;
					else
						x.amt_fcsp_not_31_60 := x.amt_fcsp_not_31_60 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_31_601
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_fcsp_not_31_601;
						x.amt_fcsp_not_31_601 := 0;
					else
						x.amt_fcsp_not_31_601 := x.amt_fcsp_not_31_601 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_0_30
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_receive_0_30;
						x.amt_receive_0_30 := 0;
					else
						x.amt_receive_0_30 := x.amt_receive_0_30 - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_0_30
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_0_30;
						x.amt_fcsp_not_0_30 := 0;
					else
					
						x.amt_fcsp_not_0_30 := x.amt_fcsp_not_0_30 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_0_301
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_fcsp_not_0_301;
						x.amt_fcsp_not_0_301 := 0;
					else
					
						x.amt_fcsp_not_0_301 := x.amt_fcsp_not_0_301 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_not_due
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_not_due;
						x.amt_receive_not_due := 0;
					else
					
						x.amt_receive_not_due := x.amt_receive_not_due - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_due
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_fcsp_not_due;
						x.amt_fcsp_not_due := 0;
					else
					
						x.amt_fcsp_not_due := x.amt_fcsp_not_due - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					if x.amt_pre_receive > x.amt_fcsp_not_due1
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_fcsp_not_due1;
						x.amt_fcsp_not_due1 := 0;
					else
					
						x.amt_fcsp_not_due1 := x.amt_fcsp_not_due1 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					update scm_yszl_temp_type_all
						 set amt_pre_receive       = x.amt_pre_receive
								,amt_receive_not_due   = x.amt_receive_not_due
								,amt_fcsp_not_due1     = x.amt_fcsp_not_due1
								,amt_fcsp_not_due      = x.amt_fcsp_not_due
								,amt_receive_0_30      = x.amt_receive_0_30
								,amt_fcsp_not_0_301    = x.amt_fcsp_not_0_301
								,amt_fcsp_not_0_30     = x.amt_fcsp_not_0_30
								,amt_receive_31_60     = x.amt_receive_31_60
								,amt_fcsp_not_31_601   = x.amt_fcsp_not_31_601
								,amt_fcsp_not_31_60    = x.amt_fcsp_not_31_60
								,amt_receive_61_90     = x.amt_receive_61_90
								,amt_fcsp_not_61_901   = x.amt_fcsp_not_61_901
								,amt_fcsp_not_61_90    = x.amt_fcsp_not_61_90
								,amt_receive_91_180    = x.amt_receive_91_180
								,amt_fcsp_not_91_1801  = x.amt_fcsp_not_91_1801
								,amt_fcsp_not_91_180   = x. amt_fcsp_not_91_180
								,amt_receive_181_270   = x.amt_receive_181_270
								,amt_fcsp_not_181_2701 = x.amt_fcsp_not_181_2701
								,amt_fcsp_not_181_270  = x. amt_fcsp_not_181_270
								,amt_receive_271_360   = x.amt_receive_271_360
								,amt_fcsp_not_271_3601 = x.amt_fcsp_not_271_3601
								,amt_fcsp_not_271_360  = x.amt_fcsp_not_271_360
								,amt_receive_361       = x.amt_receive_361
								,amt_fcsp_not_3611     = x.amt_fcsp_not_3611
								,amt_fcsp_not_361      = x.amt_fcsp_not_361
					 where rowid = x.rowid;
					commit;
				end if;
			end loop;
		elsif p_type = 2
		then
			null;
		else
			--核销预付款
			for x in c4
			loop
				if x.amt_pre_receive > 0
				then
					if x.amt_pre_receive > x.amt_receive_361
					then
						x.amt_pre_receive := x.amt_pre_receive - x.amt_receive_361;
						x.amt_receive_361 := 0;
					else
						x.amt_receive_361 := x.amt_receive_361 - x.amt_pre_receive;
						x.amt_pre_receive := 0;
					end if;
				
					------
					if x.amt_pre_receive > x.amt_receive_271_360
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_271_360;
						x.amt_receive_271_360 := 0;
					else
						x.amt_receive_271_360 := x.amt_receive_271_360 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_181_270
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_181_270;
						x.amt_receive_181_270 := 0;
					else
					
						x.amt_receive_181_270 := x.amt_receive_181_270 - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_91_180
					then
						x.amt_pre_receive    := x.amt_pre_receive - x.amt_receive_91_180;
						x.amt_receive_91_180 := 0;
					else
						x.amt_receive_91_180 := x.amt_receive_91_180 - x.amt_pre_receive;
						x.amt_pre_receive    := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_61_90
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_61_90;
						x.amt_receive_61_90 := 0;
					else
						x.amt_receive_61_90 := x.amt_receive_61_90 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_31_60
					then
						x.amt_pre_receive   := x.amt_pre_receive - x.amt_receive_31_60;
						x.amt_receive_31_60 := 0;
					else
						x.amt_receive_31_60 := x.amt_receive_31_60 - x.amt_pre_receive;
						x.amt_pre_receive   := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_0_30
					then
						x.amt_pre_receive  := x.amt_pre_receive - x.amt_receive_0_30;
						x.amt_receive_0_30 := 0;
					else
						x.amt_receive_0_30 := x.amt_receive_0_30 - x.amt_pre_receive;
						x.amt_pre_receive  := 0;
					end if;
				
					---- 
					if x.amt_pre_receive > x.amt_receive_not_due
					then
						x.amt_pre_receive     := x.amt_pre_receive - x.amt_receive_not_due;
						x.amt_receive_not_due := 0;
					else
					
						x.amt_receive_not_due := x.amt_receive_not_due - x.amt_pre_receive;
						x.amt_pre_receive     := 0;
					end if;
				
					update scm_yszl_temp_type_all
						 set amt_pre_receive     = x.amt_pre_receive
								,amt_receive_not_due = x.amt_receive_not_due
								,
								 
								 amt_receive_0_30 = x.amt_receive_0_30
								,
								 
								 amt_receive_31_60 = x.amt_receive_31_60
								,
								 
								 amt_receive_61_90 = x.amt_receive_61_90
								,
								 
								 amt_receive_91_180 = x.amt_receive_91_180
								,
								 
								 amt_receive_181_270 = x.amt_receive_181_270
								,
								 
								 amt_receive_271_360 = x.amt_receive_271_360
								,
								 
								 amt_receive_361 = x.amt_receive_361
					
					 where rowid = x.rowid;
					commit;
				end if;
			end loop;
		end if;
		update scm_yszl_temp_type_all
			 set amt_receive = amt_receive_not_due + amt_receive_0_30 + amt_receive_31_60 + amt_receive_61_90 +
												 amt_receive_91_180 + amt_receive_181_270 + amt_receive_271_360 + amt_receive_361
					,amt_fcsp    = amt_fcsp_not_due + amt_fcsp_not_0_30 + amt_fcsp_not_31_60 + amt_fcsp_not_61_90 +
												 amt_fcsp_not_91_180 + amt_fcsp_not_181_270 + amt_fcsp_not_271_360 + amt_fcsp_not_361
					,amt_fcsp1   = amt_fcsp_not_due1 + amt_fcsp_not_0_301 + amt_fcsp_not_31_601 + amt_fcsp_not_61_901 +
												 amt_fcsp_not_91_1801 + amt_fcsp_not_181_2701 + amt_fcsp_not_271_3601 + amt_fcsp_not_3611;
	
		update scm_yszl_temp_type_all set amt_actual_receive = amt_receive + amt_fcsp + amt_fcsp1;
	
		update scm_yszl_temp_type_all set amt_receive_total = amt_actual_receive - amt_pre_receive;
	
		--按订单类型
	
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '####';
		html_report_pkg.html_title(p_program_title => '应收帐款帐龄分析总表-材料类别(采购中心)'
															,p_report_title  => '应收帐款帐龄分析总表-材料类别(采购中心)');
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		html_report_pkg.output_line('报表序号：' || p_request_id);
		html_report_pkg.output_line('<BR>截止日期：' || substr(p_end_date
																										 ,1
																										 ,10));
	
		if p_cust_num_start is not null or
			 p_cust_num_end is not null
		then
			html_report_pkg.output_line('<BR>客户编号，自：' || p_cust_num_start || '，至：' || p_cust_num_end);
		end if;
	
		if p_order_type is not null
		then
			html_report_pkg.output_line('<BR>订单类型：' || p_order_type);
		end if;
	
		html_report_pkg.output_line('<table width=2400 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '订单类型***rowspan=2 align=center,客户名称***rowspan=2 align=center,实际应收余额***rowspan=2 align=center,预收余额***rowspan=2 align=center,应收余额***colspan=4 align=center,未到期***colspan=3 align=center,逾期合计***colspan=3 align=center,逾期0－30天***colspan=3 align=center,逾期31－60天***colspan=3 align=center,逾期61－90天***colspan=3 align=center,逾期91－180天***colspan=3 align=center,逾期181－270天***colspan=3 align=center,逾期271－360天***colspan=3 align=center,逾期360天以上***colspan=3 align=center,';
		html_report_pkg.line_title(p_title_string    => v_line_str
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***'
															,p_with_tr_flag    => 'Y');
	
		v_line_str := '合计*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,已开票*** align=center,暂收仓*** align=center,结算仓*** align=center,';
		html_report_pkg.line_title(p_title_string    => v_line_str
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***'
															,p_with_tr_flag    => 'Y');
		v_order_type := 'aa';
		for r1 in c4
		loop
		
			html_report_pkg.output_line('<tr>');
			if v_order_type <> r1.order_type
			then
				if v_flag = 'Y'
				then
					for x in c5(v_order_type)
					loop
						html_report_pkg.output_line('<td colspan=2 >' || v_order_type || '合计' || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
					
						--逾期合计  
					
						v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
												 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
						v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
												 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
					
						v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
											x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
					
						html_report_pkg.output_line('<td>' || v_receive || '</td>');
						html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
						html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
					
						html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
						html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
						html_report_pkg.output_line('</tr>');
					end loop;
				end if;
				v_flag := 'Y';
			
				select count(*)
					into v_count
					from scm_yszl_temp_type_all
				 where order_type = r1.order_type
							--and amt_receive_total <> 0
							--changed where by yaoxun 2013-10-17 
					 and (amt_receive_total <> 0 or amt_pre_receive <> 0);
				html_report_pkg.output_line('<td rowspan=' || v_count || '>' || r1.order_type || '</td>');
				v_order_type := r1.order_type;
			end if;
		
			begin
				select substr(customer_name
										 ,3)
					into v_customer_name
					from ar_customers
				 where nvl(attribute3
									,99999999) = r1.tax_reference
					 and rownum = 1;
			exception
				when others then
					v_customer_name := 'aa';
			end;
		
			html_report_pkg.output_line('<td>' || r1.tax_reference || '</td>');
			--html_report_pkg.output_line('<td>'||R1.Customer_number||'</td>');
			html_report_pkg.output_line('<td>' || r1.amt_receive_total || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_pre_receive || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_actual_receive || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_receive || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_not_due || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_due1 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_due || '</td>');
		
			--逾期合计  
		
			v_receive := r1.amt_receive_0_30 + r1.amt_receive_31_60 + r1.amt_receive_61_90 + r1.amt_receive_91_180 +
									 r1.amt_receive_181_270 + r1.amt_receive_271_360 + r1.amt_receive_361;
			v_fcsp1   := r1.amt_fcsp_not_0_301 + r1.amt_fcsp_not_31_601 + r1.amt_fcsp_not_61_901 + r1.amt_fcsp_not_91_1801 +
									 r1.amt_fcsp_not_181_2701 + r1.amt_fcsp_not_271_3601 + r1.amt_fcsp_not_3611;
		
			v_fcsp := r1.amt_fcsp_not_0_30 + r1.amt_fcsp_not_31_60 + r1.amt_fcsp_not_61_90 + r1.amt_fcsp_not_91_180 +
								r1.amt_fcsp_not_181_270 + r1.amt_fcsp_not_271_360 + r1.amt_fcsp_not_361;
		
			html_report_pkg.output_line('<td>' || v_receive || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_0_30 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_0_301 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_0_30 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_31_60 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_31_601 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_31_60 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_61_90 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_61_901 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_61_90 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_91_180 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_91_1801 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_91_180 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_181_270 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_181_2701 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_181_270 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_271_360 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_271_3601 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_271_360 || '</td>');
		
			html_report_pkg.output_line('<td>' || r1.amt_receive_361 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_3611 || '</td>');
			html_report_pkg.output_line('<td>' || r1.amt_fcsp_not_361 || '</td>');
			html_report_pkg.output_line('</tr>');
		end loop;
		for x in c5(v_order_type)
		loop
			html_report_pkg.output_line('<td colspan=2 >' || v_order_type || '合计' || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
		
			--逾期合计  
		
			v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
									 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
			v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
									 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
		
			v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
								x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
		
			html_report_pkg.output_line('<td>' || v_receive || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
			html_report_pkg.output_line('</tr>');
		end loop;
		for x in c51
		loop
			html_report_pkg.output_line('<td colspan=2 >总计' || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive_total || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_pre_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_actual_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_receive || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_not_due || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due1 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_due || '</td>');
		
			--逾期合计  
		
			v_receive := x.amt_receive_0_30 + x.amt_receive_31_60 + x.amt_receive_61_90 + x.amt_receive_91_180 +
									 x.amt_receive_181_270 + x.amt_receive_271_360 + x.amt_receive_361;
			v_fcsp1   := x.amt_fcsp_not_0_301 + x.amt_fcsp_not_31_601 + x.amt_fcsp_not_61_901 + x.amt_fcsp_not_91_1801 +
									 x.amt_fcsp_not_181_2701 + x.amt_fcsp_not_271_3601 + x.amt_fcsp_not_3611;
		
			v_fcsp := x.amt_fcsp_not_0_30 + x.amt_fcsp_not_31_60 + x.amt_fcsp_not_61_90 + x.amt_fcsp_not_91_180 +
								x.amt_fcsp_not_181_270 + x.amt_fcsp_not_271_360 + x.amt_fcsp_not_361;
		
			html_report_pkg.output_line('<td>' || v_receive || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp1 || '</td>');
			html_report_pkg.output_line('<td>' || v_fcsp || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_0_30 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_301 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_0_30 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_31_60 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_31_60 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_61_90 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_901 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_61_90 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_91_180 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_1801 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_91_180 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_181_270 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_2701 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_181_270 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_271_360 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_3601 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_271_360 || '</td>');
		
			html_report_pkg.output_line('<td>' || x.amt_receive_361 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_3611 || '</td>');
			html_report_pkg.output_line('<td>' || x.amt_fcsp_not_361 || '</td>');
			html_report_pkg.output_line('</tr>');
		end loop;
		html_report_pkg.output_line('</tr></table></html>');
	end;
	procedure jd_goods_account_p(p1                      in varchar2
															,p2                      in varchar2
															,p_organization_id       in number
															,p_customer_number_start in varchar2
															,p_customer_number_end   in varchar2
															,p_big_category_start    in varchar2
															,p_big_category_end      in varchar2
															,p_request_id_new        in number --新ID
															,p_request_id_old        in number --旧ID
															,p_is_temp               in varchar2 default 'N') is
	
		--发货确认的客户仓帐龄
		cursor c1(v_sub_type varchar2) is
			select item_big_category_name
						,customer_number
						,customer_name
						,confirm_date
						,shipment_number
						,document_number
						,document_type_name
						,item_segment
						,item_description
						,unit_measure
						,source_sale_price
						,material_cost
						,sum(amount_cost) amount_cost
						,sum(quantity) quantity
						,sum(amount) amount
						,sum(qty_0) qty_not_due
						,sum(amt_0) amt_not_due
						,sum(qty_0_30) qty_0_30
						,sum(amt_0_30) amt_0_30
						,sum(qty_31_60) qty_31_60
						,sum(amt_31_60) amt_31_60
						,sum(qty_61_90) qty_61_90
						,sum(amt_61_90) amt_61_90
						,sum(qty_91) qty_91
						,sum(amt_91) amt_91
				from (select t.item_big_category_name
										,cust.account_number customer_number
										,party.party_name customer_name
										,sch.confirm_date
										,ssh.shipment_number
										,sdh.document_number
										,sdt.document_type_name
										,t.item_segment
										,t.item_description
										,t.unit_measure
										,ssl.source_sale_price
										,round(nvl(t.material_cost
															,0)
													,7) material_cost
										,round(sum(t.quantity) * nvl(t.material_cost
																								,0)
													,7) amount_cost
										,sum(t.quantity) quantity
										,sum(t.quantity * ssl.source_sale_price) amount
										,decode(sign(trunc(sysdate) - trunc(t.date_received))
													 ,-1
													 ,sum(nvl(t.quantity
																	 ,0))
													 ,0) qty_0 --- <0
										,decode(sign(trunc(sysdate) - trunc(t.date_received))
													 ,-1
													 ,sum(nvl(t.quantity
																	 ,0) * nvl(ssl.source_sale_price
																						,0))
													 ,0) amt_0 --<0
										,decode(sign(trunc(sysdate) - trunc(t.date_received))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 30)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_0_30
										,decode(sign(trunc(sysdate) - trunc(t.date_received))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 30)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_0_30
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 60)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_31_60
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 60)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_31_60
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 90)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_61_90
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 90)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_61_90
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(t.quantity
																	 ,0))) qty_91
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(t.quantity
																	 ,0) * nvl(ssl.source_sale_price
																						,0))) amt_91
								from scm_so_confirm_details  scd
										,scm_so_shipment_headers ssh
										,scm_so_shipment_lines   ssl
										,scm_so_confirm_headers  sch
										,scm_so_confirm_lines    scl
										,scm_dm_headers          sdh
										,scm_dm_types            sdt
										,hz_cust_accounts        cust
										,hz_parties              party
										 --  ,ra_terms_lines          rtl
										 ------
										,scm_jd_goods_account t
							 where t.source_line_id = scd.confirm_detail_id
										--and t.subinventory_code = scd.destination_sub_code
								 and scd.confirm_line_id = scl.confirm_line_id
								 and scl.shipment_line_id = ssl.shipment_line_id
								 and scl.confirm_header_id = sch.confirm_header_id
								 and ssl.shipment_header_id = ssh.shipment_header_id
								 and ssh.document_header_id = sdh.document_header_id
								 and sdh.document_type_id = sdt.document_type_id
								 and sch.confirm_date is not null
								 and ssh.customer_id = cust.cust_account_id
								 and cust.party_id = party.party_id
								 and cust.status = 'A'
										--and sdh.receive_term = rtl.term_id
										--and rtl.sequence_num = 1
										
										--参数
								 and cust.account_number >= nvl(p_customer_number_start
																							 ,cust.account_number)
								 and cust.account_number <= nvl(p_customer_number_end
																							 ,cust.account_number)
							 group by t.item_big_category_name
											 ,cust.account_number
											 ,party.party_name
											 ,sch.confirm_date
											 ,ssh.shipment_number
											 ,sdh.document_number
											 ,sdt.document_type_name
											 ,t.item_segment
											 ,t.item_description
											 ,t.unit_measure
											 ,ssl.source_sale_price
											 ,t.material_cost
											 ,t.date_received
							-- ,rtl.due_days
							)
			 group by item_big_category_name
							 ,customer_number
							 ,customer_name
							 ,confirm_date
							 ,shipment_number
							 ,document_number
							 ,document_type_name
							 ,item_segment
							 ,item_description
							 ,unit_measure
							 ,source_sale_price
							 ,material_cost;
	
		--非发货确认，非销售订单挑库的客户仓帐龄
		cursor c2(v_sub_type varchar2) is
			select moqd.subinventory_code
						,cust.account_number customer_number
						,party.party_name customer_name
						,trunc(moqd.date_received) date_received
						,mtt.transaction_type_name
						,sib.primary_unit_of_measure uom
						,sum(moqd.primary_transaction_quantity) qty
				from mtl_onhand_quantities_detail moqd
						,mtl_system_items_b           sib
						,mtl_secondary_inventories    msi
						,hz_cust_accounts             cust
						,hz_parties                   party
						,mtl_material_transactions    mmt
						,mtl_transaction_types        mtt
			 where moqd.inventory_item_id = sib.inventory_item_id
				 and moqd.organization_id = sib.organization_id
				 and moqd.subinventory_code = msi.secondary_inventory_name
				 and msi.attribute1 = cust.cust_account_id(+)
				 and cust.party_id = party.party_id
				 and cust.status = 'A'
				 and moqd.create_transaction_id = mmt.transaction_id
				 and mmt.transaction_type_id = mtt.transaction_type_id
				 and sib.segment1 not like '106%'
				 and moqd.subinventory_code like 'K%'
				 and moqd.subinventory_code not like 'KB%'
				 and moqd.subinventory_code not like 'KP%'
				 and mtt.transaction_type_name != '销售订单挑库'
				 and mtt.transaction_type_name not like 'SCM%'
				 and instr(v_sub_type
									,msi.attribute1) <> 0 --03客户外协仓，04客户暂收仓，05客户结算仓
						--参数
				 and moqd.organization_id = p_organization_id
				 and cust.account_number >= nvl(p_customer_number_start
																			 ,cust.account_number)
				 and cust.account_number <= nvl(p_customer_number_end
																			 ,cust.account_number)
			 group by moqd.subinventory_code
							 ,mtt.transaction_type_name
							 ,mmt.trx_source_line_id
							 ,cust.account_number
							 ,party.party_name
							 ,trunc(moqd.date_received)
							 ,sib.primary_unit_of_measure;
	
		--销售订单挑库
		/*cursor c3 is
     select jat2.item_big_category_name
           ,jat2.customer_number
           ,jat2.customer_name
           ,jat2.pick_slip_number request_number
           ,to_date(substr(jat2.txn_transaction_date ,1,10)
                                                 ,'yyyy-mm-dd') date_received
           ,jat2.order_number
           ,jat2.order_type_name
           ,jat2.item_number
           ,jat2.item_description
           ,jat2.order_quantity_uom uom
           ,jat2.unit_selling_price
           ,round(nvl(cic.material_cost,0),6) transaction_cost
           ,round(jat2.quantity_cust*nvl(cic.material_cost,0),6)  amount_cost
           ,jat2.quantity_cust primary_quantity
           ,jat2.amount_cust amount
           ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0))
                   ,-1
                   ,jat2.quantity_cust
                   ,0) qty_not_due --<0
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0))
                   ,-1
                   ,jat2.amount_cust
                   ,0) amt_not_due --<0
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0))
                   ,-1
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 30)
                          ,1
                          ,0
                          ,jat2.quantity_cust)) qty_0_30 -->=0 and <=30
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0))
                   ,-1
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 30)
                          ,1
                          ,0
                          ,jat2.amount_cust)) amt_0_30 -->=0 and <=30
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 30)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 60)
                          ,1
                          ,0
                          ,jat2.quantity_cust)) qty_31_60 -->30 and <=60
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 30)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 60)
                          ,1
                          ,0
                          ,jat2.amount_cust)) amt_31_60 -->30 and <=60
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 60)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 90)
                          ,1
                          ,0
                          ,jat2.quantity_cust)) qty_61_90 -->60 and <=90
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 60)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 90)
                          ,1
                          ,0
                          ,jat2.amount_cust)) amt_61_90 -->60 and <=90
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 90)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,jat2.quantity_cust) qty_91 -->90
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 90)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,jat2.amount_cust) amt_91 -->90   
    from apps.jd_ar005_temp2 jat2
        ,apps.cst_item_cost_type_v cic
    where jat2.item_number = cic.item_number(+)
        and cic.organization_id = p_organization_id
        and jat2.request_id=p_request_id_old; */
	
		--退货 add 2010-1-5
		cursor c4 is
			select item_big_category_name
						,customer_number
						,customer_name
						,confirm_date
						,shipment_number
						,document_number
						,document_type_name
						,item_segment
						,item_description
						,unit_measure
						,source_sale_price
						,material_cost
						,sum(amount_cost) amount_cost
						,sum(quantity) quantity
						,sum(amount) amount
						,sum(qty_0) qty_not_due
						,sum(amt_0) amt_not_due
						,sum(qty_0_30) qty_0_30
						,sum(amt_0_30) amt_0_30
						,sum(qty_31_60) qty_31_60
						,sum(amt_31_60) amt_31_60
						,sum(qty_61_90) qty_61_90
						,sum(amt_61_90) amt_61_90
						,sum(qty_91) qty_91
						,sum(amt_91) amt_91
				from (select fvt2.description item_big_category_name
										,cust.account_number customer_number
										,party.party_name customer_name
										,sch.confirm_date
										,ssh.shipment_number
										,sdh.document_number
										,sdt.document_type_name
										,msib.segment1 item_segment
										,msib.description item_description
										,msib.primary_unit_of_measure unit_measure
										,ssl.source_sale_price
										,round(nvl(cic.material_cost
															,0)
													,7) material_cost
										,round(sum(scd.customer_confirm_qty) * nvl(cic.material_cost
																															,0)
													,7) amount_cost
										,sum(scd.customer_confirm_qty) quantity
										,sum(scd.customer_confirm_qty * ssl.source_sale_price) amount
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date))
													 ,-1
													 ,sum(nvl(scd.customer_confirm_qty
																	 ,0))
													 ,0) qty_0 --- <0
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date))
													 ,-1
													 ,sum(nvl(scd.customer_confirm_qty
																	 ,0) * nvl(ssl.source_sale_price
																						,0))
													 ,0) amt_0 --<0
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 30)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0)))) qty_0_30
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 30)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_0_30
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 60)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0)))) qty_31_60
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 60)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_31_60
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 90)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0)))) qty_61_90
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 90)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_61_90
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(scd.customer_confirm_qty
																	 ,0))) qty_91
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(scd.customer_confirm_qty
																	 ,0) * nvl(ssl.source_sale_price
																						,0))) amt_91
								from scm_so_confirm_details  scd
										,scm_so_shipment_headers ssh
										,scm_so_shipment_lines   ssl
										,scm_so_confirm_headers  sch
										,scm_so_confirm_lines    scl
										,scm_dm_headers          sdh
										,scm_dm_types            sdt
										,hz_cust_accounts        cust
										,hz_parties              party
										 --,ra_terms_lines          rtl
										 
										 ------
										,mtl_system_items_b   msib
										,cst_item_cost_type_v cic
										,mtl_item_categories  mic
										,mtl_categories_b     mcb
										,fnd_flex_value_sets  fvs
										,fnd_flex_values      ffv2
										,fnd_flex_values_tl   fvt2
							 where scd.confirm_line_id = scl.confirm_line_id
								 and scl.shipment_line_id = ssl.shipment_line_id
								 and scl.confirm_header_id = sch.confirm_header_id
								 and ssl.shipment_header_id = ssh.shipment_header_id
								 and ssh.document_header_id = sdh.document_header_id
								 and sdh.document_type_id = sdt.document_type_id
								 and sch.confirm_date is not null
								 and ssh.customer_id = cust.cust_account_id
								 and cust.party_id = party.party_id
								 and cust.status = 'A'
										-- and sdh.receive_term = rtl.term_id
										-- and rtl.sequence_num = 1
								 and sch.complete_flag = 'Y'
								 and ssh.shipment_type_id = 8 --退货 
								 and nvl(ssl.invoice_quantity
												,0) = 0
										
										----------------
								 and scd.inventory_item_id = msib.inventory_item_id
								 and scd.organization_id = msib.organization_id
								 and msib.inventory_item_id = cic.inventory_item_id(+)
								 and msib.organization_id = cic.organization_id(+)
								 and cic.cost_type_id = 2 --平均成本
								 and msib.inventory_item_id = mic.inventory_item_id
								 and msib.organization_id = mic.organization_id
								 and mic.category_id = mcb.category_id
								 and mic.category_set_id = 1
								 and mcb.segment1 = ffv2.flex_value
								 and fvs.flex_value_set_id = ffv2.flex_value_set_id
								 and ffv2.flex_value_id = fvt2.flex_value_id
								 and fvt2.language = 'ZHS' --userenv('LANG')
								 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
										--参数
										
								 and scd.organization_id = p_organization_id
								 and mcb.segment1 >= nvl(p_big_category_start
																				,mcb.segment1)
								 and mcb.segment1 <= nvl(p_big_category_end
																				,mcb.segment1)
								 and cust.account_number >= nvl(p_customer_number_start
																							 ,cust.account_number)
								 and cust.account_number <= nvl(p_customer_number_end
																							 ,cust.account_number)
							 group by fvt2.description
											 ,cust.account_number
											 ,party.party_name
											 ,sch.confirm_date
											 ,ssh.shipment_number
											 ,sdh.document_number
											 ,sdt.document_type_name
											 ,msib.segment1
											 ,msib.description
											 ,msib.primary_unit_of_measure
											 ,ssl.source_sale_price
											 ,cic.material_cost
											 ,sch.confirm_date)
			 group by item_big_category_name
							 ,customer_number
							 ,customer_name
							 ,confirm_date
							 ,shipment_number
							 ,document_number
							 ,document_type_name
							 ,item_segment
							 ,item_description
							 ,unit_measure
							 ,source_sale_price
							 ,material_cost;
	
		v_line_str varchar2(4000);
		v_sep      varchar2(5);
		v_sub_type varchar2(30);
		v_title    varchar2(100);
		v_l_title1 varchar2(100);
		v_l_title2 varchar2(100);
		v_l_title3 varchar2(100);
		-------
		v_qty         number;
		v_amt         number;
		v_amt_cost    number;
		v_qty_not_due number;
		v_amt_not_due number;
		v_qty_0_30    number;
		v_amt_0_30    number;
		v_qty_31_60   number;
		v_amt_31_60   number;
		v_qty_61_90   number;
		v_amt_61_90   number;
		v_qty_91      number;
		v_amt_91      number;
		p_type        varchar2(10);
		v_org_id      number;
	begin
		p_type := '01';
		if (p_type = '02')
		then
			v_sub_type := '03,04'; --目标子库类型是“客户暂收仓”和“客户外协仓”
			v_title    := '客户仓商品帐龄分析表';
			v_l_title1 := '<BR><BR><B>发货确认的暂收仓帐龄：';
			v_l_title2 := '<BR><BR><B>挑库确认的暂收仓帐龄：';
			v_l_title3 := '<BR><BR><B>非发货确认、非挑库确认的暂收仓数量列表：';
		elsif (p_type = '01')
		then
			v_sub_type := '05'; --目标子库类型是“客户结算仓”
			v_title    := '客户仓商品帐龄分析表';
			v_l_title1 := '<BR><BR><B>发货确认的结算仓帐龄：';
			v_l_title2 := '<BR><BR><B>挑库确认的结算仓帐龄：';
			v_l_title3 := '<BR><BR><B>非发货确认、非挑库确认的结算仓数量列表：';
		end if;
	
		v_org_id := get_org_id_f(p_organization_id);
		---------------插入临时表-------------------
		insert_temp(v_org_id
							 ,p_organization_id
							 ,p_customer_number_start
							 ,p_customer_number_end
							 ,p_big_category_start
							 ,p_big_category_end
							 ,p_request_id_new
							 ,p_is_temp
							 ,p_type);
	
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '####';
		html_report_pkg.html_title(p_program_title => v_title
															,p_report_title  => v_title);
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		if (p_customer_number_start is not null or p_customer_number_end is not null)
		then
			html_report_pkg.output_line('<BR>客户编号，自：' || p_customer_number_start || '，至：' || p_customer_number_end);
		end if;
	
		if (p_big_category_start is not null or p_big_category_end is not null)
		then
			html_report_pkg.output_line('<BR>物料大类，自：' || p_big_category_start || '，至：' || p_big_category_end);
		end if;
		------------------------------------------------------------------------------------
		---暂收仓
		jd_goods_account_p2(p1
											 ,p2
											 ,p_organization_id
											 ,p_customer_number_start
											 ,p_customer_number_end
											 ,p_big_category_start
											 ,p_big_category_end
											 ,p_request_id_new
											 ,p_is_temp);
	
		------------------------------------------------------------------------------------                            
	
		html_report_pkg.output_line(v_l_title1);
		html_report_pkg.output_line('<table width=2500 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '物料大类,客户编号,客户名称,发货确认日期,发货单号,委托书编号,委托书类型,物料编码,物料名称,单位,数量,平均成本单价,平均成本金额,销售订单价,销售金额,0－30天(数量),0－30天(金额),31－60天(数量),31－60天(金额),61－90天(数量),61－90天(金额),超过90天(数量),超过90天(金额),';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		v_qty         := 0;
		v_amt         := 0;
		v_amt_cost    := 0;
		v_qty_not_due := 0;
		v_amt_not_due := 0;
		v_qty_0_30    := 0;
		v_amt_0_30    := 0;
		v_qty_31_60   := 0;
		v_amt_31_60   := 0;
		v_qty_61_90   := 0;
		v_amt_61_90   := 0;
		v_qty_91      := 0;
		v_amt_91      := 0;
		for r1 in c1(v_sub_type)
		loop
			html_report_pkg.line_title(p_title_string => r1.item_big_category_name || v_sep || r1.customer_number || v_sep ||
																									 r1.customer_name || v_sep ||
																									 to_char(r1.confirm_date
																													,'yyyy-mm-dd') || v_sep || r1.shipment_number || v_sep ||
																									 r1.document_number || v_sep || r1.document_type_name || v_sep ||
																									 r1.item_segment || v_sep || r1.item_description || v_sep ||
																									 r1.unit_measure || v_sep || r1.quantity || v_sep || r1.material_cost ||
																									 v_sep || r1.amount_cost || v_sep || r1.source_sale_price || v_sep ||
																									 r1.amount ||
																									-- v_sep || r1.qty_not_due ||
																									-- v_sep || r1.amt_not_due ||
																									 v_sep || r1.qty_0_30 || v_sep || r1.amt_0_30 || v_sep ||
																									 r1.qty_31_60 || v_sep || r1.amt_31_60 || v_sep || r1.qty_61_90 ||
																									 v_sep || r1.amt_61_90 || v_sep || r1.qty_91 || v_sep || r1.amt_91 ||
																									 v_sep
																,p_delimiter    => v_sep);
		
			v_qty         := nvl(v_qty
													,0) + nvl(r1.quantity
																	 ,0);
			v_amt_cost    := nvl(v_amt_cost
													,0) + nvl(r1.amount_cost
																	 ,0);
			v_amt         := nvl(v_amt
													,0) + nvl(r1.amount
																	 ,0);
			v_qty_not_due := nvl(v_qty_not_due
													,0) + nvl(r1.qty_not_due
																	 ,0);
			v_amt_not_due := nvl(v_amt_not_due
													,0) + nvl(r1.amt_not_due
																	 ,0);
			v_qty_0_30    := nvl(v_qty_0_30
													,0) + nvl(r1.qty_0_30
																	 ,0);
			v_amt_0_30    := nvl(v_amt_0_30
													,0) + nvl(r1.amt_0_30
																	 ,0);
			v_qty_31_60   := nvl(v_qty_31_60
													,0) + nvl(r1.qty_31_60
																	 ,0);
			v_amt_31_60   := nvl(v_amt_31_60
													,0) + nvl(r1.amt_31_60
																	 ,0);
			v_qty_61_90   := nvl(v_qty_61_90
													,0) + nvl(r1.qty_61_90
																	 ,0);
			v_amt_61_90   := nvl(v_amt_61_90
													,0) + nvl(r1.amt_61_90
																	 ,0);
			v_qty_91      := nvl(v_qty_91
													,0) + nvl(r1.qty_91
																	 ,0);
			v_amt_91      := nvl(v_amt_91
													,0) + nvl(r1.amt_91
																	 ,0);
		end loop;
		html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=10' || v_sep || v_qty || v_sep ||
																										'－***align=center' || v_sep || v_amt_cost || v_sep ||
																										'－***align=center' || v_sep || v_amt || v_sep ||
																									 -- v_qty_not_due || v_sep ||
																									 -- v_amt_not_due || v_sep ||
																										v_qty_0_30 || v_sep || v_amt_0_30 || v_sep || v_qty_31_60 || v_sep ||
																										v_amt_31_60 || v_sep || v_qty_61_90 || v_sep || v_amt_61_90 ||
																										v_sep || v_qty_91 || v_sep || v_amt_91 || v_sep
															,p_delimiter       => v_sep
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***');
		html_report_pkg.output_line('</tr></table>');
	
		---------------------------------------------
		/*if (p_type = '01')
    then
      html_report_pkg.output_line(v_l_title2);
      html_report_pkg.output_line('<table width=2500 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
    
      v_line_str := '物料大类,客户编号,客户名称,挑库确认日期,出库单号,订单号,订单类型,物料编码,物料名称,单位,数量,平均成本单价,平均成本金额,销售订单价,销售金额,未到期(数量),未到期(金额),0－30天(数量),0－30天(金额),31－60天(数量),31－60天(金额),61－90天(数量),61－90天(金额),超过90天(数量),超过90天(金额),';
      html_report_pkg.line_title(p_title_string => v_line_str);
    
      v_qty         := 0;
      v_amt         := 0;
      v_amt_cost    := 0;
      v_qty_not_due := 0;
      v_amt_not_due := 0;
      v_qty_0_30    := 0;
      v_amt_0_30    := 0;
      v_qty_31_60   := 0;
      v_amt_31_60   := 0;
      v_qty_61_90   := 0;
      v_amt_61_90   := 0;
      v_qty_91      := 0;
      v_amt_91      := 0;
      for r1 in c3
      loop
        html_report_pkg.line_title(p_title_string => r1.item_big_category_name ||
                                                     v_sep ||
                                                     r1.customer_number ||
                                                     v_sep ||
                                                     r1.customer_name ||
                                                     v_sep ||
                                                     to_char(r1.date_received
                                                            ,'yyyy-mm-dd') ||
                                                     v_sep ||
                                                     r1.request_number ||
                                                     v_sep ||
                                                     r1.order_number ||
                                                     v_sep ||
                                                     r1.order_type_name ||
                                                     v_sep ||
                                                     r1.item_number ||
                                                     v_sep ||
                                                     r1.item_description ||
                                                     v_sep || r1.uom ||
                                                     v_sep ||
                                                     r1.primary_quantity ||
                                                     v_sep ||
                                                     r1.transaction_cost ||
                                                     v_sep ||
                                                     r1.amount_cost ||
                                                     v_sep ||
                                                     r1.unit_selling_price ||
                                                     v_sep || r1.amount ||
                                                     v_sep ||
                                                     r1.qty_not_due ||
                                                     v_sep ||
                                                     r1.amt_not_due ||
                                                     v_sep || r1.qty_0_30 ||
                                                     v_sep || r1.amt_0_30 ||
                                                     v_sep || r1.qty_31_60 ||
                                                     v_sep || r1.amt_31_60 ||
                                                     v_sep || r1.qty_61_90 ||
                                                     v_sep || r1.amt_61_90 ||
                                                     v_sep || r1.qty_91 ||
                                                     v_sep || r1.amt_91 ||
                                                     v_sep
                                  ,p_delimiter    => v_sep);
      
        v_qty         := nvl(v_qty
                            ,0) + nvl(r1.primary_quantity
                                     ,0);
        v_amt_cost    := nvl(v_amt_cost
                            ,0) + nvl(r1.amount_cost
                                     ,0);
        v_amt         := nvl(v_amt
                            ,0) + nvl(r1.amount
                                     ,0);
        v_qty_not_due := nvl(v_qty_not_due
                            ,0) + nvl(r1.qty_not_due
                                     ,0);
        v_amt_not_due := nvl(v_amt_not_due
                            ,0) + nvl(r1.amt_not_due
                                     ,0);
        v_qty_0_30    := nvl(v_qty_0_30
                            ,0) + nvl(r1.qty_0_30
                                     ,0);
        v_amt_0_30    := nvl(v_amt_0_30
                            ,0) + nvl(r1.amt_0_30
                                     ,0);
        v_qty_31_60   := nvl(v_qty_31_60
                            ,0) + nvl(r1.qty_31_60
                                     ,0);
        v_amt_31_60   := nvl(v_amt_31_60
                            ,0) + nvl(r1.amt_31_60
                                     ,0);
        v_qty_61_90   := nvl(v_qty_61_90
                            ,0) + nvl(r1.qty_61_90
                                     ,0);
        v_amt_61_90   := nvl(v_amt_61_90
                            ,0) + nvl(r1.amt_61_90
                                     ,0);
        v_qty_91      := nvl(v_qty_91
                            ,0) + nvl(r1.qty_91
                                     ,0);
        v_amt_91      := nvl(v_amt_91
                            ,0) + nvl(r1.amt_91
                                     ,0);
      end loop;
      html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=10' ||
                                                      v_sep || v_qty ||
                                                      v_sep ||
                                                      '－***align=center' ||
                                                      v_sep || v_amt_cost ||
                                                      v_sep ||
                                                      '－***align=center' ||
                                                      v_sep || v_amt ||
                                                      v_sep ||
                                                      v_qty_not_due ||
                                                      v_sep ||
                                                      v_amt_not_due ||
                                                      v_sep || v_qty_0_30 ||
                                                      v_sep || v_amt_0_30 ||
                                                      v_sep || v_qty_31_60 ||
                                                      v_sep || v_amt_31_60 ||
                                                      v_sep || v_qty_61_90 ||
                                                      v_sep || v_amt_61_90 ||
                                                      v_sep || v_qty_91 ||
                                                      v_sep || v_amt_91 ||
                                                      v_sep
                                ,p_delimiter       => v_sep
                                ,p_with_other_attr => 'Y'
                                ,p_attr_delimiter  => '***');
      html_report_pkg.output_line('</tr></table>');
    end if;*/
		---------------------------------------------
		html_report_pkg.output_line(v_l_title3);
		html_report_pkg.output_line('<table width=1000 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '客户编号,客户名称,子库编号,入库日期,事务处理类型,单位,数量,';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		v_qty := 0;
		v_amt := 0;
		for r1 in c2(v_sub_type)
		loop
			html_report_pkg.line_title(p_title_string => r1.customer_number || v_sep || r1.customer_name || v_sep ||
																									 r1.subinventory_code || v_sep ||
																									 to_char(r1.date_received
																													,'yyyy-mm-dd') || v_sep || r1.transaction_type_name || v_sep ||
																									 r1.uom || v_sep || r1.qty || v_sep
																,p_delimiter    => v_sep);
		
			v_qty := nvl(v_qty
									,0) + nvl(r1.qty
													 ,0);
		end loop;
		html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=6' || v_sep || v_qty || v_sep
															,p_delimiter       => v_sep
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***');
		html_report_pkg.output_line('</tr></table>');
	
		--退货 add 2010-1-5
		html_report_pkg.output_line('<BR><BR><B>退货的帐龄：');
		html_report_pkg.output_line('<table width=2500 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '物料大类,客户编号,客户名称,发货确认日期,发货单号,委托书编号,委托书类型,物料编码,物料名称,单位,数量,平均成本单价,平均成本金额,销售订单价,销售金额,未到期(数量),未到期(金额),0－30天(数量),0－30天(金额),31－60天(数量),31－60天(金额),61－90天(数量),61－90天(金额),超过90天(数量),超过90天(金额),';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		v_qty         := 0;
		v_amt         := 0;
		v_amt_cost    := 0;
		v_qty_not_due := 0;
		v_amt_not_due := 0;
		v_qty_0_30    := 0;
		v_amt_0_30    := 0;
		v_qty_31_60   := 0;
		v_amt_31_60   := 0;
		v_qty_61_90   := 0;
		v_amt_61_90   := 0;
		v_qty_91      := 0;
		v_amt_91      := 0;
		for r4 in c4
		loop
			html_report_pkg.line_title(p_title_string => r4.item_big_category_name || v_sep || r4.customer_number || v_sep ||
																									 r4.customer_name || v_sep ||
																									 to_char(r4.confirm_date
																													,'yyyy-mm-dd') || v_sep || r4.shipment_number || v_sep ||
																									 r4.document_number || v_sep || r4.document_type_name || v_sep ||
																									 r4.item_segment || v_sep || r4.item_description || v_sep ||
																									 r4.unit_measure || v_sep || r4.quantity || v_sep || r4.material_cost ||
																									 v_sep || r4.amount_cost || v_sep || r4.source_sale_price || v_sep ||
																									 r4.amount || v_sep || r4.qty_not_due || v_sep || r4.amt_not_due ||
																									 v_sep || r4.qty_0_30 || v_sep || r4.amt_0_30 || v_sep ||
																									 r4.qty_31_60 || v_sep || r4.amt_31_60 || v_sep || r4.qty_61_90 ||
																									 v_sep || r4.amt_61_90 || v_sep || r4.qty_91 || v_sep || r4.amt_91 ||
																									 v_sep
																,p_delimiter    => v_sep);
		
			v_qty         := nvl(v_qty
													,0) + nvl(r4.quantity
																	 ,0);
			v_amt_cost    := nvl(v_amt_cost
													,0) + nvl(r4.amount_cost
																	 ,0);
			v_amt         := nvl(v_amt
													,0) + nvl(r4.amount
																	 ,0);
			v_qty_not_due := nvl(v_qty_not_due
													,0) + nvl(r4.qty_not_due
																	 ,0);
			v_amt_not_due := nvl(v_amt_not_due
													,0) + nvl(r4.amt_not_due
																	 ,0);
			v_qty_0_30    := nvl(v_qty_0_30
													,0) + nvl(r4.qty_0_30
																	 ,0);
			v_amt_0_30    := nvl(v_amt_0_30
													,0) + nvl(r4.amt_0_30
																	 ,0);
			v_qty_31_60   := nvl(v_qty_31_60
													,0) + nvl(r4.qty_31_60
																	 ,0);
			v_amt_31_60   := nvl(v_amt_31_60
													,0) + nvl(r4.amt_31_60
																	 ,0);
			v_qty_61_90   := nvl(v_qty_61_90
													,0) + nvl(r4.qty_61_90
																	 ,0);
			v_amt_61_90   := nvl(v_amt_61_90
													,0) + nvl(r4.amt_61_90
																	 ,0);
			v_qty_91      := nvl(v_qty_91
													,0) + nvl(r4.qty_91
																	 ,0);
			v_amt_91      := nvl(v_amt_91
													,0) + nvl(r4.amt_91
																	 ,0);
		end loop;
		html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=10' || v_sep || v_qty || v_sep ||
																										'－***align=center' || v_sep || v_amt_cost || v_sep ||
																										'－***align=center' || v_sep || v_amt || v_sep || v_qty_not_due ||
																										v_sep || v_amt_not_due || v_sep || v_qty_0_30 || v_sep ||
																										v_amt_0_30 || v_sep || v_qty_31_60 || v_sep || v_amt_31_60 || v_sep ||
																										v_qty_61_90 || v_sep || v_amt_61_90 || v_sep || v_qty_91 || v_sep ||
																										v_amt_91 || v_sep
															,p_delimiter       => v_sep
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***');
		html_report_pkg.output_line('</tr></table>');
	
		html_report_pkg.output_line('</html>');
	end jd_goods_account_p;

	--JD.客户仓商品帐龄分析表（暂收仓）
	procedure jd_goods_account_p2(p1                      in varchar2
															 ,p2                      in varchar2
															 ,p_organization_id       in number
															 ,p_customer_number_start in varchar2
															 ,p_customer_number_end   in varchar2
															 ,p_big_category_start    in varchar2
															 ,p_big_category_end      in varchar2
															 ,p_request_id            in number
															 ,p_is_temp               in varchar2 default 'N') is
	
		--发货确认的客户仓帐龄
		cursor c1(v_sub_type varchar2) is
			select item_big_category_name
						,customer_number
						,customer_name
						,
						 --confirm_date,
						 --nvl(confirm_date, sysdate) confirm_date,
						 get_overdue_days_f1(shipment_number
																,p_organization_id) confirm_date
						,shipment_number
						,document_number
						,document_type_name
						,item_segment
						,item_description
						,unit_measure
						,source_sale_price
						,material_cost
						,sum(amount_cost) amount_cost
						,sum(quantity) quantity
						,sum(amount) amount
						,sum(qty_0) qty_not_due
						,sum(amt_0) amt_not_due
						,sum(qty_0_30) qty_0_30
						,sum(amt_0_30) amt_0_30
						,sum(qty_31_60) qty_31_60
						,sum(amt_31_60) amt_31_60
						,sum(qty_61_90) qty_61_90
						,sum(amt_61_90) amt_61_90
						,sum(qty_91) qty_91
						,sum(amt_91) amt_91
				from (select t.item_big_category_name
										,cust.account_number customer_number
										,party.party_name customer_name
										,sch.confirm_date
										,ssh.shipment_number
										,sdh.document_number
										,sdt.document_type_name
										,t.item_segment
										,t.item_description
										,t.unit_measure
										,ssl.source_sale_price
										,round(nvl(t.material_cost
															,0)
													,7) material_cost
										,round(sum(t.quantity) * nvl(t.material_cost
																								,0)
													,7) amount_cost
										,sum(t.quantity) quantity
										,sum(t.quantity * ssl.source_sale_price) amount
										,decode(sign(trunc(sysdate) - trunc(t.date_received))
													 ,-1
													 ,sum(nvl(t.quantity
																	 ,0))
													 ,0) qty_0 --- <0
										,decode(sign(trunc(sysdate) - trunc(t.date_received))
													 ,-1
													 ,sum(nvl(t.quantity
																	 ,0) * nvl(ssl.source_sale_price
																						,0))
													 ,0) amt_0 --<0
										,decode(sign(trunc(sysdate) - trunc(t.date_received))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 30)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_0_30
										,decode(sign(trunc(sysdate) - trunc(t.date_received))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 30)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_0_30
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 60)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_31_60
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 60)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_31_60
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 90)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_61_90
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) - 90)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_61_90
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(t.quantity
																	 ,0))) qty_91
										,decode(sign(trunc(sysdate) - trunc(t.date_received) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(t.quantity
																	 ,0) * nvl(ssl.source_sale_price
																						,0))) amt_91
								from scm_so_confirm_details  scd
										,scm_so_shipment_headers ssh
										,scm_so_shipment_lines   ssl
										,scm_so_confirm_headers  sch
										,scm_so_confirm_lines    scl
										,scm_dm_headers          sdh
										,scm_dm_types            sdt
										,hz_cust_accounts        cust
										,hz_parties              party
										 -- ,ra_terms_lines          rtl
										 ------
										,scm_jd_goods_account2 t
							 where t.source_line_id = scd.confirm_detail_id
										--and t.subinventory_code = scd.destination_sub_code
								 and scd.confirm_line_id = scl.confirm_line_id
								 and scl.shipment_line_id = ssl.shipment_line_id
								 and scl.confirm_header_id = sch.confirm_header_id
								 and ssl.shipment_header_id = ssh.shipment_header_id
								 and ssh.document_header_id = sdh.document_header_id
								 and sdh.document_type_id = sdt.document_type_id
										--and sch.confirm_date is not null
								 and ssh.customer_id = cust.cust_account_id
								 and cust.party_id = party.party_id
								 and cust.status = 'A'
										--and sdh.receive_term = rtl.term_id
										-- and rtl.sequence_num = 1
										
										--参数
								 and cust.account_number >= nvl(p_customer_number_start
																							 ,cust.account_number)
								 and cust.account_number <= nvl(p_customer_number_end
																							 ,cust.account_number)
							 group by t.item_big_category_name
											 ,cust.account_number
											 ,party.party_name
											 ,sch.confirm_date
											 ,ssh.shipment_number
											 ,sdh.document_number
											 ,sdt.document_type_name
											 ,t.item_segment
											 ,t.item_description
											 ,t.unit_measure
											 ,ssl.source_sale_price
											 ,t.material_cost
											 ,t.date_received
							--,rtl.due_days
							/*union all
              select t.item_big_category_name,
                     cust.account_number customer_number,
                     party.party_name customer_name,
                     ssh.shipment_date,
                     ssh.shipment_number,
                     sdh.document_number,
                     sdt.document_type_name,
                     t.item_segment,
                     t.item_description,
                     t.unit_measure,
                     ssl.source_sale_price,
                     round(nvl(t.material_cost, 0), 7) material_cost,
                     round(sum(t.quantity) * nvl(t.material_cost, 0), 7) amount_cost,
                     sum(t.quantity) quantity,
                     sum(t.quantity * ssl.source_sale_price) amount,
                     decode(sign(trunc(sysdate) - trunc(t.date_received)),
                            -1,
                            sum(nvl(t.quantity, 0)),
                            0) qty_0 --- <0
                    ,
                     decode(sign(trunc(sysdate) - trunc(t.date_received)),
                            -1,
                            sum(nvl(t.quantity, 0) *
                                nvl(ssl.source_sale_price, 0)),
                            0) amt_0 --<0
                    ,
                     decode(sign(trunc(sysdate) - trunc(t.date_received)),
                            -1,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) - 30),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0)))) qty_0_30,
                     decode(sign(trunc(sysdate) - trunc(t.date_received)),
                            -1,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) - 30),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0) *
                                       nvl(ssl.source_sale_price, 0)))) amt_0_30,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) - 30),
                            -1,
                            0,
                            0,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) - 60),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0)))) qty_31_60,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) - 30),
                            -1,
                            0,
                            0,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) - 60),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0) *
                                       nvl(ssl.source_sale_price, 0)))) amt_31_60,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) - 60),
                            -1,
                            0,
                            0,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) - 90),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0)))) qty_61_90,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) - 60),
                            -1,
                            0,
                            0,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) - 90),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0) *
                                       nvl(ssl.source_sale_price, 0)))) amt_61_90,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) - 90),
                            -1,
                            0,
                            0,
                            0,
                            sum(nvl(t.quantity, 0))) qty_91,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) - 90),
                            -1,
                            0,
                            0,
                            0,
                            sum(nvl(t.quantity, 0) *
                                nvl(ssl.source_sale_price, 0))) amt_91
                from scm_so_shipment_headers_vir ssh,
                     scm_so_shipment_lines_vir   ssl,
                     scm_so_shipment_details_vir ssd,
                     scm_dm_headers              sdh,
                     scm_dm_types                sdt,
                     hz_cust_accounts            cust,
                     hz_parties                  party
                     -- ,ra_terms_lines          rtl
                     ------
                    ,
                     scm_jd_goods_account2 t
               where t.SOURCE_LINE_ID = ssd.shipment_detail_id
                 and ssd.shipment_header_id = ssh.shipment_header_id
                 and ssl.shipment_header_id = ssh.shipment_header_id
                 and ssd.shipment_line_id = ssl.shipment_line_id
                 and ssl.shipment_header_id = ssh.shipment_header_id
                 and ssh.document_header_id = sdh.document_header_id
                 and sdh.document_type_id = sdt.document_type_id
                    --and sch.confirm_date is not null
                 and ssh.customer_id = cust.cust_account_id
                 and cust.party_id = party.party_id
                 and cust.status = 'A'
                 and cust.account_number >=
                     nvl(p_customer_number_start, cust.account_number)
                 and cust.account_number <=
                     nvl(p_customer_number_end, cust.account_number)
               group by t.item_big_category_name,
                        cust.account_number,
                        party.party_name,
                        ssh.shipment_date,
                        ssh.shipment_number,
                        sdh.document_number,
                        sdt.document_type_name,
                        t.item_segment,
                        t.item_description,
                        t.unit_measure,
                        ssl.source_sale_price,
                        t.material_cost,
                        t.date_received*/
							--,rtl.due_days  
							)
			 group by item_big_category_name
							 ,customer_number
							 ,customer_name
							 ,confirm_date
							 ,shipment_number
							 ,document_number
							 ,document_type_name
							 ,item_segment
							 ,item_description
							 ,unit_measure
							 ,source_sale_price
							 ,material_cost;
	
		--非发货确认，非销售订单挑库的客户仓帐龄
		cursor c2(v_sub_type varchar2) is
			select moqd.subinventory_code
						,cust.account_number customer_number
						,party.party_name customer_name
						,trunc(moqd.date_received) date_received
						,mtt.transaction_type_name
						,sib.primary_unit_of_measure uom
						,sum(moqd.primary_transaction_quantity) qty
				from mtl_onhand_quantities_detail moqd
						,mtl_system_items_b           sib
						,mtl_secondary_inventories    msi
						,hz_cust_accounts             cust
						,hz_parties                   party
						,mtl_material_transactions    mmt
						,mtl_transaction_types        mtt
			 where moqd.inventory_item_id = sib.inventory_item_id
				 and moqd.organization_id = sib.organization_id
				 and moqd.subinventory_code = msi.secondary_inventory_name
				 and msi.attribute1 = cust.cust_account_id(+)
				 and moqd.create_transaction_id = mmt.transaction_id
				 and mmt.transaction_type_id = mtt.transaction_type_id
				 and cust.party_id = party.party_id
				 and cust.status = 'A'
				 and sib.segment1 not like '106%'
				 and moqd.subinventory_code like 'K%'
				 and moqd.subinventory_code not like 'KB%'
				 and moqd.subinventory_code not like 'KP%'
				 and mtt.transaction_type_name != '销售订单挑库'
				 and mtt.transaction_type_name not like 'SCM%'
				 and instr(v_sub_type
									,msi.attribute1) <> 0 --03客户外协仓，04客户暂收仓，05客户结算仓
						--参数
				 and moqd.organization_id = p_organization_id
				 and cust.account_number >= nvl(p_customer_number_start
																			 ,cust.account_number)
				 and cust.account_number <= nvl(p_customer_number_end
																			 ,cust.account_number)
			 group by moqd.subinventory_code
							 ,mtt.transaction_type_name
							 ,mmt.trx_source_line_id
							 ,cust.account_number
							 ,party.party_name
							 ,trunc(moqd.date_received)
							 ,sib.primary_unit_of_measure;
	
		v_line_str varchar2(4000);
		v_sep      varchar2(5);
		v_sub_type varchar2(30);
		v_title    varchar2(100);
		v_l_title1 varchar2(100);
		v_l_title2 varchar2(100);
		v_l_title3 varchar2(100);
		-------
		v_qty         number;
		v_amt         number;
		v_amt_cost    number;
		v_qty_not_due number;
		v_amt_not_due number;
		v_qty_0_30    number;
		v_amt_0_30    number;
		v_qty_31_60   number;
		v_amt_31_60   number;
		v_qty_61_90   number;
		v_amt_61_90   number;
		v_qty_91      number;
		v_amt_91      number;
		p_type        varchar2(10);
		v_org_id      number;
	begin
		p_type := '02';
		if (p_type = '02')
		then
			v_sub_type := '03,04'; --目标子库类型是“客户暂收仓”和“客户外协仓”
			v_title    := '客户仓商品帐龄分析表（暂收仓）';
			v_l_title1 := '<BR><BR><B>发货确认的暂收仓帐龄：';
			-- v_l_title2 := '<BR><BR><B>挑库确认的暂收仓帐龄：';
			v_l_title3 := '<BR><BR><B>非发货确认、非挑库确认的暂收仓数量列表：';
		end if;
	
		v_org_id := get_org_id_f(p_organization_id);
		---------------插入临时表-------------------
		insert_temp(v_org_id
							 ,p_organization_id
							 ,p_customer_number_start
							 ,p_customer_number_end
							 ,p_big_category_start
							 ,p_big_category_end
							 ,p_request_id
							 ,p_is_temp
							 ,p_type);
	
		v_sep := '####';
		/*    html_report_pkg.v_report_output_mode := 'F';
    
    v_sep := '####';
    html_report_pkg.html_title(p_program_title => v_title
                              ,p_report_title  => v_title);
    html_report_pkg.output_line('打印时间：' ||
                                to_char(sysdate
                                       ,'yyyy-mm-dd hh24:mi'));
    html_report_pkg.output_line('<BR>客户编号，自：' ||
                                p_customer_number_start || '，至：' ||
                                p_customer_number_end);*/
		html_report_pkg.output_line(v_l_title1);
		html_report_pkg.output_line('<table width=2500 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '物料大类,客户编号,客户名称,发货确认日期,发货单号,委托书编号,委托书类型,物料编码,物料名称,单位,数量,平均成本单价,平均成本金额,销售订单价,销售金额,0－30天(数量),0－30天(金额),31－60天(数量),31－60天(金额),61－90天(数量),61－90天(金额),超过90天(数量),超过90天(金额),';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		v_qty         := 0;
		v_amt         := 0;
		v_amt_cost    := 0;
		v_qty_not_due := 0;
		v_amt_not_due := 0;
		v_qty_0_30    := 0;
		v_amt_0_30    := 0;
		v_qty_31_60   := 0;
		v_amt_31_60   := 0;
		v_qty_61_90   := 0;
		v_amt_61_90   := 0;
		v_qty_91      := 0;
		v_amt_91      := 0;
		for r1 in c1(v_sub_type)
		loop
			html_report_pkg.line_title(p_title_string => r1.item_big_category_name || v_sep || r1.customer_number || v_sep ||
																									 r1.customer_name || v_sep ||
																									 to_char(r1.confirm_date
																													,'yyyy-mm-dd') || v_sep || r1.shipment_number || v_sep ||
																									 r1.document_number || v_sep || r1.document_type_name || v_sep ||
																									 r1.item_segment || v_sep || r1.item_description || v_sep ||
																									 r1.unit_measure || v_sep || r1.quantity || v_sep || r1.material_cost ||
																									 v_sep || r1.amount_cost || v_sep || r1.source_sale_price || v_sep ||
																									 r1.amount ||
																									-- v_sep || r1.qty_not_due ||
																									--  v_sep || r1.amt_not_due ||
																									 v_sep || r1.qty_0_30 || v_sep || r1.amt_0_30 || v_sep ||
																									 r1.qty_31_60 || v_sep || r1.amt_31_60 || v_sep || r1.qty_61_90 ||
																									 v_sep || r1.amt_61_90 || v_sep || r1.qty_91 || v_sep || r1.amt_91 ||
																									 v_sep
																,p_delimiter    => v_sep);
		
			v_qty         := nvl(v_qty
													,0) + nvl(r1.quantity
																	 ,0);
			v_amt_cost    := nvl(v_amt_cost
													,0) + nvl(r1.amount_cost
																	 ,0);
			v_amt         := nvl(v_amt
													,0) + nvl(r1.amount
																	 ,0);
			v_qty_not_due := nvl(v_qty_not_due
													,0) + nvl(r1.qty_not_due
																	 ,0);
			v_amt_not_due := nvl(v_amt_not_due
													,0) + nvl(r1.amt_not_due
																	 ,0);
			v_qty_0_30    := nvl(v_qty_0_30
													,0) + nvl(r1.qty_0_30
																	 ,0);
			v_amt_0_30    := nvl(v_amt_0_30
													,0) + nvl(r1.amt_0_30
																	 ,0);
			v_qty_31_60   := nvl(v_qty_31_60
													,0) + nvl(r1.qty_31_60
																	 ,0);
			v_amt_31_60   := nvl(v_amt_31_60
													,0) + nvl(r1.amt_31_60
																	 ,0);
			v_qty_61_90   := nvl(v_qty_61_90
													,0) + nvl(r1.qty_61_90
																	 ,0);
			v_amt_61_90   := nvl(v_amt_61_90
													,0) + nvl(r1.amt_61_90
																	 ,0);
			v_qty_91      := nvl(v_qty_91
													,0) + nvl(r1.qty_91
																	 ,0);
			v_amt_91      := nvl(v_amt_91
													,0) + nvl(r1.amt_91
																	 ,0);
		end loop;
		html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=10' || v_sep || v_qty || v_sep ||
																										'－***align=center' || v_sep || v_amt_cost || v_sep ||
																										'－***align=center' || v_sep || v_amt || v_sep ||
																									 --  v_qty_not_due || v_sep ||
																									 --   v_amt_not_due || v_sep ||
																										v_qty_0_30 || v_sep || v_amt_0_30 || v_sep || v_qty_31_60 || v_sep ||
																										v_amt_31_60 || v_sep || v_qty_61_90 || v_sep || v_amt_61_90 ||
																										v_sep || v_qty_91 || v_sep || v_amt_91 || v_sep
															,p_delimiter       => v_sep
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***');
		html_report_pkg.output_line('</tr></table>');
	
		---------------------------------------------
		html_report_pkg.output_line(v_l_title3);
		html_report_pkg.output_line('<table width=1000 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '客户编号,客户名称,子库编号,入库日期,事务处理类型,单位,数量,';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		v_qty := 0;
		v_amt := 0;
		for r1 in c2(v_sub_type)
		loop
			html_report_pkg.line_title(p_title_string => r1.customer_number || v_sep || r1.customer_name || v_sep ||
																									 r1.subinventory_code || v_sep ||
																									 to_char(r1.date_received
																													,'yyyy-mm-dd') || v_sep || r1.transaction_type_name || v_sep ||
																									 r1.uom || v_sep || r1.qty || v_sep
																,p_delimiter    => v_sep);
		
			v_qty := nvl(v_qty
									,0) + nvl(r1.qty
													 ,0);
		end loop;
		html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=6' || v_sep || v_qty || v_sep
															,p_delimiter       => v_sep
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***');
		html_report_pkg.output_line('</tr></table>');
	
	end jd_goods_account_p2;

	--获取某个挑库确认的事务处理的平均成本
	function get_cost(p_transaction_id in number) return number is
		v_cost_price number;
	begin
		select round(to_number(substr(max(to_char(cst.transaction_costed_date
																						 ,'yyyy/mm/dd hh24:mi:ss') || '|' || to_char(cst.new_cost))
																 ,21))
								,6)
			into v_cost_price
			from mtl_material_transactions   mmt
					,mtl_cst_actual_cost_details cst
		 where mmt.transaction_id = p_transaction_id
			 and mmt.inventory_item_id = cst.inventory_item_id
			 and mmt.organization_id = cst.organization_id
		/*And cst.TRANSACTION_COSTED_DATE <= nvl(to_date(mmt.attribute1,'yyyy/mm/dd hh24:mi:ss'),mmt.transaction_date)*/
		;
		return(v_cost_price);
	end get_cost;

	--获取经营单位
	function get_org_id_f(p_organization_id in number) return number is
		v_org_id number;
	begin
		select operating_unit into v_org_id from org_organization_definitions where organization_id = p_organization_id;
	
		return v_org_id;
	exception
		when others then
			return 0;
	end get_org_id_f;

	--创建临时表数据p_type 01为结算仓，02为暂收仓
	procedure insert_temp(p_org_id                in number
											 ,p_organization_id       in number
											 ,p_customer_number_start in varchar2
											 ,p_customer_number_end   in varchar2
											 ,p_big_category_start    in varchar2
											 ,p_big_category_end      in varchar2
											 ,p_request_id            in number
											 ,p_is_temp               in varchar2
											 ,p_type                  in varchar2) is
		v_sub_type varchar2(10);
	begin
		if (p_type = '01')
		then
			v_sub_type := '05';
		elsif (p_type = '02')
		then
			v_sub_type := '03,04';
		end if;
	
		if (p_is_temp = 'Y')
		then
			if p_type = '02'
			then
				insert into scm_jd_goods_account2
					(inventory_item_id
					,organization_id
					,item_big_category_name
					,item_segment
					,item_description
					,unit_measure
					,material_cost
					,quantity
					,date_received
					,source_line_id
					,subinventory_code)
					select msib.inventory_item_id
								,msib.organization_id
								,fvt2.description
								,msib.segment1
								,msib.description
								,msib.primary_unit_of_measure
								,cic.material_cost
								,srfd.transaction_quantity
								,srfd.transaction_date_old
								,srfd.confirm_detail_id
								,scd.destination_sub_code
						from scm_rpt_fcsp_details   srfd
								,scm_so_confirm_details scd
								 ------
								,mtl_system_items_b   msib
								,cst_item_cost_type_v cic
								,mtl_item_categories  mic
								,mtl_categories_b     mcb
								,fnd_flex_value_sets  fvs
								,fnd_flex_values      ffv2
								,fnd_flex_values_tl   fvt2
					 where srfd.confirm_detail_id = scd.confirm_detail_id
						 and srfd.sub_type = p_type --'02' --暂收
						 and srfd.request_id = p_request_id
								
						 and scd.inventory_item_id = msib.inventory_item_id
						 and scd.organization_id = msib.organization_id
						 and msib.inventory_item_id = cic.inventory_item_id(+)
						 and msib.organization_id = cic.organization_id(+)
						 and cic.cost_type_id = 2 --平均成本
						 and msib.inventory_item_id = mic.inventory_item_id
						 and msib.organization_id = mic.organization_id
						 and mic.category_id = mcb.category_id
						 and mic.category_set_id = 1
						 and mcb.segment1 = ffv2.flex_value
						 and fvs.flex_value_set_id = ffv2.flex_value_set_id
						 and ffv2.flex_value_id = fvt2.flex_value_id
						 and fvt2.language = 'ZHS' --userenv('LANG')
						 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
								
								--参数
						 and msib.organization_id = p_organization_id
						 and srfd.org_id = p_org_id
						 and mcb.segment1 >= nvl(p_big_category_start
																		,mcb.segment1)
						 and mcb.segment1 <= nvl(p_big_category_end
																		,mcb.segment1);
				---受托发货单             
				insert into scm_jd_goods_account2
					(inventory_item_id
					,organization_id
					,item_big_category_name
					,item_segment
					,item_description
					,unit_measure
					,material_cost
					,quantity
					,date_received
					,source_line_id
					,subinventory_code)
					select msib.inventory_item_id
								,msib.organization_id
								,fvt2.description
								,msib.segment1
								,msib.description
								,msib.primary_unit_of_measure
								,cic.material_cost
								,srfd.transaction_quantity
								,srfd.transaction_date_old
								,srfd.shipment_detail_id
								,scd.subinventory_code
						from scm_rpt_fcsp_details        srfd
								,scm_so_shipment_details_vir scd
								 ------
								,mtl_system_items_b   msib
								,cst_item_cost_type_v cic
								,mtl_item_categories  mic
								,mtl_categories_b     mcb
								,fnd_flex_value_sets  fvs
								,fnd_flex_values      ffv2
								,fnd_flex_values_tl   fvt2
					 where srfd.shipment_detail_id = scd.shipment_detail_id
						 and srfd.sub_type = '03' --'02' --暂收
						 and srfd.request_id = p_request_id
								
						 and scd.inventory_item_id = msib.inventory_item_id
						 and scd.organization_id = msib.organization_id
						 and msib.inventory_item_id = cic.inventory_item_id(+)
						 and msib.organization_id = cic.organization_id(+)
						 and cic.cost_type_id = 2 --平均成本
						 and msib.inventory_item_id = mic.inventory_item_id
						 and msib.organization_id = mic.organization_id
						 and mic.category_id = mcb.category_id
						 and mic.category_set_id = 1
						 and mcb.segment1 = ffv2.flex_value
						 and fvs.flex_value_set_id = ffv2.flex_value_set_id
						 and ffv2.flex_value_id = fvt2.flex_value_id
						 and fvt2.language = 'ZHS' --userenv('LANG')
						 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
								
								--参数
						 and msib.organization_id = p_organization_id
						 and srfd.org_id = p_org_id
						 and mcb.segment1 >= nvl(p_big_category_start
																		,mcb.segment1)
						 and mcb.segment1 <= nvl(p_big_category_end
																		,mcb.segment1);
			else
				insert into scm_jd_goods_account
					(inventory_item_id
					,organization_id
					,item_big_category_name
					,item_segment
					,item_description
					,unit_measure
					,material_cost
					,quantity
					,date_received
					,source_line_id
					,subinventory_code)
					select msib.inventory_item_id
								,msib.organization_id
								,fvt2.description
								,msib.segment1
								,msib.description
								,msib.primary_unit_of_measure
								,cic.material_cost
								,srfd.transaction_quantity
								,srfd.transaction_date_old
								,srfd.confirm_detail_id
								,scd.destination_sub_code
						from scm_rpt_fcsp_details   srfd
								,scm_so_confirm_details scd
								 ------
								,mtl_system_items_b   msib
								,cst_item_cost_type_v cic
								,mtl_item_categories  mic
								,mtl_categories_b     mcb
								,fnd_flex_value_sets  fvs
								,fnd_flex_values      ffv2
								,fnd_flex_values_tl   fvt2
					 where srfd.confirm_detail_id = scd.confirm_detail_id
						 and srfd.sub_type = p_type --'02' --暂收
						 and srfd.request_id = p_request_id
								
						 and scd.inventory_item_id = msib.inventory_item_id
						 and scd.organization_id = msib.organization_id
						 and msib.inventory_item_id = cic.inventory_item_id(+)
						 and msib.organization_id = cic.organization_id(+)
						 and cic.cost_type_id = 2 --平均成本
						 and msib.inventory_item_id = mic.inventory_item_id
						 and msib.organization_id = mic.organization_id
						 and mic.category_id = mcb.category_id
						 and mic.category_set_id = 1
						 and mcb.segment1 = ffv2.flex_value
						 and fvs.flex_value_set_id = ffv2.flex_value_set_id
						 and ffv2.flex_value_id = fvt2.flex_value_id
						 and fvt2.language = 'ZHS' --userenv('LANG')
						 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
								
								--参数
						 and msib.organization_id = p_organization_id
						 and srfd.org_id = p_org_id
						 and mcb.segment1 >= nvl(p_big_category_start
																		,mcb.segment1)
						 and mcb.segment1 <= nvl(p_big_category_end
																		,mcb.segment1);
			end if;
		else
			if p_type = '02'
			then
				insert into scm_jd_goods_account2
					(inventory_item_id
					,organization_id
					,item_big_category_name
					,item_segment
					,item_description
					,unit_measure
					,material_cost
					,quantity
					,date_received
					,source_line_id
					,subinventory_code)
					select moq.inventory_item_id
								,moq.organization_id
								,fvt2.description
								,msib.segment1
								,msib.description
								,msib.primary_unit_of_measure
								,cic.material_cost
								,moq.primary_transaction_quantity
								,moq.date_received
								,mmt.source_line_id
								,mmt.subinventory_code
						from mtl_onhand_quantities_detail moq
								,mtl_material_transactions    mmt
								,mtl_transaction_types        mtt
								,mtl_secondary_inventories    msi
								 
								 ------
								,mtl_system_items_b   msib
								,cst_item_cost_type_v cic
								,mtl_item_categories  mic
								,mtl_categories_b     mcb
								,fnd_flex_value_sets  fvs
								,fnd_flex_values      ffv2
								,fnd_flex_values_tl   fvt2
					 where moq.create_transaction_id = mmt.transaction_id
						 and moq.organization_id = mmt.organization_id
						 and mmt.transaction_type_id = mtt.transaction_type_id
						 and mtt.transaction_type_name like 'SCM%'
						 and moq.subinventory_code = msi.secondary_inventory_name
						 and moq.organization_id = msi.organization_id
						 and instr(v_sub_type
											,msi.attribute1) <> 0 --03客户外协仓，04客户暂收仓，05客户结算仓
								
						 and moq.inventory_item_id = msib.inventory_item_id
						 and moq.organization_id = msib.organization_id
						 and msib.inventory_item_id = cic.inventory_item_id(+)
						 and msib.organization_id = cic.organization_id(+)
						 and cic.cost_type_id = 2 --平均成本
						 and msib.inventory_item_id = mic.inventory_item_id
						 and msib.organization_id = mic.organization_id
						 and mic.category_id = mcb.category_id
						 and mic.category_set_id = 1
						 and mcb.segment1 = ffv2.flex_value
						 and fvs.flex_value_set_id = ffv2.flex_value_set_id
						 and ffv2.flex_value_id = fvt2.flex_value_id
						 and fvt2.language = 'ZHS' --userenv('LANG')
						 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
								
								--参数
						 and moq.organization_id = p_organization_id
						 and mcb.segment1 >= nvl(p_big_category_start
																		,mcb.segment1)
						 and mcb.segment1 <= nvl(p_big_category_end
																		,mcb.segment1);
			else
				insert into scm_jd_goods_account
					(inventory_item_id
					,organization_id
					,item_big_category_name
					,item_segment
					,item_description
					,unit_measure
					,material_cost
					,quantity
					,date_received
					,source_line_id
					,subinventory_code)
					select moq.inventory_item_id
								,moq.organization_id
								,fvt2.description
								,msib.segment1
								,msib.description
								,msib.primary_unit_of_measure
								,cic.material_cost
								,moq.primary_transaction_quantity
								,moq.date_received
								,mmt.source_line_id
								,mmt.subinventory_code
						from mtl_onhand_quantities_detail moq
								,mtl_material_transactions    mmt
								,mtl_transaction_types        mtt
								,mtl_secondary_inventories    msi
								 
								 ------
								,mtl_system_items_b   msib
								,cst_item_cost_type_v cic
								,mtl_item_categories  mic
								,mtl_categories_b     mcb
								,fnd_flex_value_sets  fvs
								,fnd_flex_values      ffv2
								,fnd_flex_values_tl   fvt2
					 where moq.create_transaction_id = mmt.transaction_id
						 and moq.organization_id = mmt.organization_id
						 and mmt.transaction_type_id = mtt.transaction_type_id
						 and mtt.transaction_type_name like 'SCM%'
						 and moq.subinventory_code = msi.secondary_inventory_name
						 and moq.organization_id = msi.organization_id
						 and instr(v_sub_type
											,msi.attribute1) <> 0 --03客户外协仓，04客户暂收仓，05客户结算仓
								
						 and moq.inventory_item_id = msib.inventory_item_id
						 and moq.organization_id = msib.organization_id
						 and msib.inventory_item_id = cic.inventory_item_id(+)
						 and msib.organization_id = cic.organization_id(+)
						 and cic.cost_type_id = 2 --平均成本
						 and msib.inventory_item_id = mic.inventory_item_id
						 and msib.organization_id = mic.organization_id
						 and mic.category_id = mcb.category_id
						 and mic.category_set_id = 1
						 and mcb.segment1 = ffv2.flex_value
						 and fvs.flex_value_set_id = ffv2.flex_value_set_id
						 and ffv2.flex_value_id = fvt2.flex_value_id
						 and fvt2.language = 'ZHS' --userenv('LANG')
						 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
								
								--参数
						 and moq.organization_id = p_organization_id
						 and mcb.segment1 >= nvl(p_big_category_start
																		,mcb.segment1)
						 and mcb.segment1 <= nvl(p_big_category_end
																		,mcb.segment1);
			end if;
		end if;
	end insert_temp;
	--JD.客户仓商品帐龄分析表（结算仓）
	procedure jd_goods_account_p_new(p1                      in varchar2
																	,p2                      in varchar2
																	,p_organization_id       in number
																	,p_customer_number_start in varchar2
																	,p_customer_number_end   in varchar2
																	,p_big_category_start    in varchar2
																	,p_big_category_end      in varchar2
																	,p_request_id_new        in number
																	,p_request_id_old        in number
																	,p_is_temp               in varchar2 default 'N') is
	
		--发货确认的客户仓帐龄
		cursor c1(v_sub_type varchar2) is
			select item_big_category_name
						,customer_number
						,customer_name
						,confirm_date
						,shipment_number
						,document_number
						,document_type_name
						,item_segment
						,item_description
						,unit_measure
						,source_sale_price
						,material_cost
						,sum(amount_cost) amount_cost
						,sum(quantity) quantity
						,sum(amount) amount
						,sum(qty_0) qty_not_due
						,sum(amt_0) amt_not_due
						,sum(qty_0_30) qty_0_30
						,sum(amt_0_30) amt_0_30
						,sum(qty_31_60) qty_31_60
						,sum(amt_31_60) amt_31_60
						,sum(qty_61_90) qty_61_90
						,sum(amt_61_90) amt_61_90
						,sum(qty_91) qty_91
						,sum(amt_91) amt_91
				from (select t.item_big_category_name
										,cust.account_number customer_number
										,party.party_name customer_name
										,sch.confirm_date
										,ssh.shipment_number
										,sdh.document_number
										,sdt.document_type_name
										,t.item_segment
										,t.item_description
										,t.unit_measure
										,ssl.source_sale_price
										,round(nvl(t.material_cost
															,0)
													,7) material_cost
										,round(sum(t.quantity) * nvl(t.material_cost
																								,0)
													,7) amount_cost
										,sum(t.quantity) quantity
										,sum(t.quantity * ssl.source_sale_price) amount
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0))
													 ,-1
													 ,sum(nvl(t.quantity
																	 ,0))
													 ,0) qty_0 --- <0
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0))
													 ,-1
													 ,sum(nvl(t.quantity
																	 ,0) * nvl(ssl.source_sale_price
																						,0))
													 ,0) amt_0 --<0
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 30)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_0_30
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 30)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_0_30
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 60)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_31_60
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 60)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_31_60
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 90)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_61_90
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 90)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_61_90
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(t.quantity
																	 ,0))) qty_91
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(t.quantity
																	 ,0) * nvl(ssl.source_sale_price
																						,0))) amt_91
								from scm_so_confirm_details  scd
										,scm_so_shipment_headers ssh
										,scm_so_shipment_lines   ssl
										,scm_so_confirm_headers  sch
										,scm_so_confirm_lines    scl
										,scm_dm_headers          sdh
										,scm_dm_types            sdt
										,hz_cust_accounts        cust
										,hz_parties              party
										,ra_terms_lines          rtl
										 ------
										,scm_jd_goods_account t
							 where t.source_line_id = scd.confirm_detail_id
										--and t.subinventory_code = scd.destination_sub_code
								 and scd.confirm_line_id = scl.confirm_line_id
								 and scl.shipment_line_id = ssl.shipment_line_id
								 and scl.confirm_header_id = sch.confirm_header_id
								 and ssl.shipment_header_id = ssh.shipment_header_id
								 and ssh.document_header_id = sdh.document_header_id
								 and sdh.document_type_id = sdt.document_type_id
								 and sch.confirm_date is not null
								 and ssh.customer_id = cust.cust_account_id
								 and cust.party_id = party.party_id
								 and cust.status = 'A'
								 and sdh.receive_term = rtl.term_id
								 and rtl.sequence_num = 1
										
										--参数
								 and cust.account_number >= nvl(p_customer_number_start
																							 ,cust.account_number)
								 and cust.account_number <= nvl(p_customer_number_end
																							 ,cust.account_number)
							 group by t.item_big_category_name
											 ,cust.account_number
											 ,party.party_name
											 ,sch.confirm_date
											 ,ssh.shipment_number
											 ,sdh.document_number
											 ,sdt.document_type_name
											 ,t.item_segment
											 ,t.item_description
											 ,t.unit_measure
											 ,ssl.source_sale_price
											 ,t.material_cost
											 ,t.date_received
											 ,rtl.due_days)
			 group by item_big_category_name
							 ,customer_number
							 ,customer_name
							 ,confirm_date
							 ,shipment_number
							 ,document_number
							 ,document_type_name
							 ,item_segment
							 ,item_description
							 ,unit_measure
							 ,source_sale_price
							 ,material_cost;
	
		--非发货确认，非销售订单挑库的客户仓帐龄
		cursor c2(v_sub_type varchar2) is
			select moqd.subinventory_code
						,cust.account_number customer_number
						,party.party_name customer_name
						,trunc(moqd.date_received) date_received
						,mtt.transaction_type_name
						,sib.primary_unit_of_measure uom
						,sum(moqd.primary_transaction_quantity) qty
				from mtl_onhand_quantities_detail moqd
						,mtl_system_items_b           sib
						,mtl_secondary_inventories    msi
						,hz_cust_accounts             cust
						,hz_parties                   party
						,mtl_material_transactions    mmt
						,mtl_transaction_types        mtt
			 where moqd.inventory_item_id = sib.inventory_item_id
				 and moqd.organization_id = sib.organization_id
				 and moqd.subinventory_code = msi.secondary_inventory_name
				 and msi.attribute1 = cust.cust_account_id(+)
				 and cust.party_id = party.party_id
				 and cust.status = 'A'
				 and moqd.create_transaction_id = mmt.transaction_id
				 and mmt.transaction_type_id = mtt.transaction_type_id
				 and sib.segment1 not like '106%'
				 and moqd.subinventory_code like 'K%'
				 and moqd.subinventory_code not like 'KB%'
				 and moqd.subinventory_code not like 'KP%'
				 and mtt.transaction_type_name != '销售订单挑库'
				 and mtt.transaction_type_name not like 'SCM%'
				 and instr(v_sub_type
									,msi.attribute1) <> 0 --03客户外协仓，04客户暂收仓，05客户结算仓
						--参数
				 and moqd.organization_id = p_organization_id
				 and cust.account_number >= nvl(p_customer_number_start
																			 ,cust.account_number)
				 and cust.account_number <= nvl(p_customer_number_end
																			 ,cust.account_number)
			 group by moqd.subinventory_code
							 ,mtt.transaction_type_name
							 ,mmt.trx_source_line_id
							 ,cust.account_number
							 ,party.party_name
							 ,trunc(moqd.date_received)
							 ,sib.primary_unit_of_measure;
	
		--销售订单挑库
		/*cursor c3 is
     select jat2.item_big_category_name
           ,jat2.customer_number
           ,jat2.customer_name
           ,jat2.pick_slip_number request_number
           ,to_date(substr(jat2.txn_transaction_date ,1,10)
                                                 ,'yyyy-mm-dd') date_received
           ,jat2.order_number
           ,jat2.order_type_name
           ,jat2.item_number
           ,jat2.item_description
           ,jat2.order_quantity_uom uom
           ,jat2.unit_selling_price
           ,round(nvl(cic.material_cost,0),6) transaction_cost
           ,round(jat2.quantity_cust*nvl(cic.material_cost,0),6)  amount_cost
           ,jat2.quantity_cust primary_quantity
           ,jat2.amount_cust amount
           ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0))
                   ,-1
                   ,jat2.quantity_cust
                   ,0) qty_not_due --<0
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0))
                   ,-1
                   ,jat2.amount_cust
                   ,0) amt_not_due --<0
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0))
                   ,-1
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 30)
                          ,1
                          ,0
                          ,jat2.quantity_cust)) qty_0_30 -->=0 and <=30
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0))
                   ,-1
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 30)
                          ,1
                          ,0
                          ,jat2.amount_cust)) amt_0_30 -->=0 and <=30
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 30)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 60)
                          ,1
                          ,0
                          ,jat2.quantity_cust)) qty_31_60 -->30 and <=60
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 30)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 60)
                          ,1
                          ,0
                          ,jat2.amount_cust)) amt_31_60 -->30 and <=60
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 60)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 90)
                          ,1
                          ,0
                          ,jat2.quantity_cust)) qty_61_90 -->60 and <=90
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 60)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,decode(sign(trunc(sysdate) -
                                to_date(substr(jat2.txn_transaction_date
                                              ,1
                                              ,10)
                                       ,'yyyy-mm-dd') -
                                nvl(jat2.due_days
                                   ,0) - 90)
                          ,1
                          ,0
                          ,jat2.amount_cust)) amt_61_90 -->60 and <=90
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 90)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,jat2.quantity_cust) qty_91 -->90
            ,decode(sign(trunc(sysdate) - to_date(substr(jat2.txn_transaction_date
                                                        ,1
                                                        ,10)
                                                 ,'yyyy-mm-dd') -
                         nvl(jat2.due_days
                            ,0) - 90)
                   ,-1
                   ,0
                   ,0
                   ,0
                   ,jat2.amount_cust) amt_91 -->90   
    from apps.jd_ar005_temp2 jat2
        ,apps.cst_item_cost_type_v cic
    where jat2.item_number = cic.item_number(+)
        and cic.organization_id = p_organization_id
        and jat2.request_id=p_request_id_old;*/
	
		--退货 add 2010-1-5
		cursor c4 is
			select item_big_category_name
						,customer_number
						,customer_name
						,confirm_date
						,shipment_number
						,document_number
						,document_type_name
						,item_segment
						,item_description
						,unit_measure
						,source_sale_price
						,material_cost
						,sum(amount_cost) amount_cost
						,sum(quantity) quantity
						,sum(amount) amount
						,sum(qty_0) qty_not_due
						,sum(amt_0) amt_not_due
						,sum(qty_0_30) qty_0_30
						,sum(amt_0_30) amt_0_30
						,sum(qty_31_60) qty_31_60
						,sum(amt_31_60) amt_31_60
						,sum(qty_61_90) qty_61_90
						,sum(amt_61_90) amt_61_90
						,sum(qty_91) qty_91
						,sum(amt_91) amt_91
				from (select fvt2.description item_big_category_name
										,cust.account_number customer_number
										,party.party_name customer_name
										,sch.confirm_date
										,ssh.shipment_number
										,sdh.document_number
										,sdt.document_type_name
										,msib.segment1 item_segment
										,msib.description item_description
										,msib.primary_unit_of_measure unit_measure
										,ssl.source_sale_price
										,round(nvl(cic.material_cost
															,0)
													,7) material_cost
										,round(sum(scd.customer_confirm_qty) * nvl(cic.material_cost
																															,0)
													,7) amount_cost
										,sum(scd.customer_confirm_qty) quantity
										,sum(scd.customer_confirm_qty * ssl.source_sale_price) amount
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date))
													 ,-1
													 ,sum(nvl(scd.customer_confirm_qty
																	 ,0))
													 ,0) qty_0 --- <0
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date))
													 ,-1
													 ,sum(nvl(scd.customer_confirm_qty
																	 ,0) * nvl(ssl.source_sale_price
																						,0))
													 ,0) amt_0 --<0
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 30)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0)))) qty_0_30
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 30)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_0_30
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 60)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0)))) qty_31_60
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 60)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_31_60
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 90)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0)))) qty_61_90
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 90)
																	,1
																	,0
																	,sum(nvl(scd.customer_confirm_qty
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_61_90
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(scd.customer_confirm_qty
																	 ,0))) qty_91
										,decode(sign(trunc(sysdate) - trunc(sch.confirm_date) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(scd.customer_confirm_qty
																	 ,0) * nvl(ssl.source_sale_price
																						,0))) amt_91
								from scm_so_confirm_details  scd
										,scm_so_shipment_headers ssh
										,scm_so_shipment_lines   ssl
										,scm_so_confirm_headers  sch
										,scm_so_confirm_lines    scl
										,scm_dm_headers          sdh
										,scm_dm_types            sdt
										,hz_cust_accounts        cust
										,hz_parties              party
										 --,ra_terms_lines          rtl
										 
										 ------
										,mtl_system_items_b   msib
										,cst_item_cost_type_v cic
										,mtl_item_categories  mic
										,mtl_categories_b     mcb
										,fnd_flex_value_sets  fvs
										,fnd_flex_values      ffv2
										,fnd_flex_values_tl   fvt2
							 where scd.confirm_line_id = scl.confirm_line_id
								 and scl.shipment_line_id = ssl.shipment_line_id
								 and scl.confirm_header_id = sch.confirm_header_id
								 and ssl.shipment_header_id = ssh.shipment_header_id
								 and ssh.document_header_id = sdh.document_header_id
								 and sdh.document_type_id = sdt.document_type_id
								 and sch.confirm_date is not null
								 and ssh.customer_id = cust.cust_account_id
								 and cust.party_id = party.party_id
								 and cust.status = 'A'
										-- and sdh.receive_term = rtl.term_id
										-- and rtl.sequence_num = 1
								 and sch.complete_flag = 'Y'
								 and ssh.shipment_type_id = 8 --退货 
								 and nvl(ssl.invoice_quantity
												,0) = 0
										
										----------------
								 and scd.inventory_item_id = msib.inventory_item_id
								 and scd.organization_id = msib.organization_id
								 and msib.inventory_item_id = cic.inventory_item_id(+)
								 and msib.organization_id = cic.organization_id(+)
								 and cic.cost_type_id = 2 --平均成本
								 and msib.inventory_item_id = mic.inventory_item_id
								 and msib.organization_id = mic.organization_id
								 and mic.category_id = mcb.category_id
								 and mic.category_set_id = 1
								 and mcb.segment1 = ffv2.flex_value
								 and fvs.flex_value_set_id = ffv2.flex_value_set_id
								 and ffv2.flex_value_id = fvt2.flex_value_id
								 and fvt2.language = 'ZHS' --userenv('LANG')
								 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
										--参数
										
								 and scd.organization_id = p_organization_id
								 and mcb.segment1 >= nvl(p_big_category_start
																				,mcb.segment1)
								 and mcb.segment1 <= nvl(p_big_category_end
																				,mcb.segment1)
								 and cust.account_number >= nvl(p_customer_number_start
																							 ,cust.account_number)
								 and cust.account_number <= nvl(p_customer_number_end
																							 ,cust.account_number)
							 group by fvt2.description
											 ,cust.account_number
											 ,party.party_name
											 ,sch.confirm_date
											 ,ssh.shipment_number
											 ,sdh.document_number
											 ,sdt.document_type_name
											 ,msib.segment1
											 ,msib.description
											 ,msib.primary_unit_of_measure
											 ,ssl.source_sale_price
											 ,cic.material_cost
											 ,sch.confirm_date)
			 group by item_big_category_name
							 ,customer_number
							 ,customer_name
							 ,confirm_date
							 ,shipment_number
							 ,document_number
							 ,document_type_name
							 ,item_segment
							 ,item_description
							 ,unit_measure
							 ,source_sale_price
							 ,material_cost;
	
		v_line_str varchar2(4000);
		v_sep      varchar2(5);
		v_sub_type varchar2(30);
		v_title    varchar2(100);
		v_l_title1 varchar2(100);
		v_l_title2 varchar2(100);
		v_l_title3 varchar2(100);
		-------
		v_qty         number;
		v_amt         number;
		v_amt_cost    number;
		v_qty_not_due number;
		v_amt_not_due number;
		v_qty_0_30    number;
		v_amt_0_30    number;
		v_qty_31_60   number;
		v_amt_31_60   number;
		v_qty_61_90   number;
		v_amt_61_90   number;
		v_qty_91      number;
		v_amt_91      number;
		p_type        varchar2(10);
		v_org_id      number;
	begin
		p_type := '01';
		if (p_type = '02')
		then
			v_sub_type := '03,04'; --目标子库类型是“客户暂收仓”和“客户外协仓”
			v_title    := '客户仓商品帐龄分析表';
			v_l_title1 := '<BR><BR><B>发货确认的暂收仓帐龄：';
			v_l_title2 := '<BR><BR><B>挑库确认的暂收仓帐龄：';
			v_l_title3 := '<BR><BR><B>非发货确认、非挑库确认的暂收仓数量列表：';
		elsif (p_type = '01')
		then
			v_sub_type := '05'; --目标子库类型是“客户结算仓”
			v_title    := '客户仓商品帐龄分析表';
			v_l_title1 := '<BR><BR><B>发货确认的结算仓帐龄：';
			v_l_title2 := '<BR><BR><B>挑库确认的结算仓帐龄：';
			v_l_title3 := '<BR><BR><B>非发货确认、非挑库确认的结算仓数量列表：';
		end if;
	
		v_org_id := get_org_id_f(p_organization_id);
		---------------插入临时表-------------------
		insert_temp_new(v_org_id
									 ,p_organization_id
									 ,p_customer_number_start
									 ,p_customer_number_end
									 ,p_big_category_start
									 ,p_big_category_end
									 ,p_request_id_new
									 ,p_is_temp
									 ,p_type);
	
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '####';
		html_report_pkg.html_title(p_program_title => v_title
															,p_report_title  => v_title);
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		if (p_customer_number_start is not null or p_customer_number_end is not null)
		then
			html_report_pkg.output_line('<BR>客户编号，自：' || p_customer_number_start || '，至：' || p_customer_number_end);
		end if;
	
		if (p_big_category_start is not null or p_big_category_end is not null)
		then
			html_report_pkg.output_line('<BR>物料类别，自：' || p_big_category_start || '，至：' || p_big_category_end);
		end if;
		------------------------------------------------------------------------------------
		---暂收仓
		jd_goods_account_p2_new(p1
													 ,p2
													 ,p_organization_id
													 ,p_customer_number_start
													 ,p_customer_number_end
													 ,p_big_category_start
													 ,p_big_category_end
													 ,p_request_id_new
													 ,p_is_temp);
	
		------------------------------------------------------------------------------------                            
	
		html_report_pkg.output_line(v_l_title1);
		html_report_pkg.output_line('<table width=2500 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '物料大类,客户编号,客户名称,发货确认日期,发货单号,委托书编号,委托书类型,物料编码,物料名称,单位,数量,平均成本单价,平均成本金额,销售订单价,销售金额,未到期(数量),未到期(金额),0－30天(数量),0－30天(金额),31－60天(数量),31－60天(金额),61－90天(数量),61－90天(金额),超过90天(数量),超过90天(金额),';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		v_qty         := 0;
		v_amt         := 0;
		v_amt_cost    := 0;
		v_qty_not_due := 0;
		v_amt_not_due := 0;
		v_qty_0_30    := 0;
		v_amt_0_30    := 0;
		v_qty_31_60   := 0;
		v_amt_31_60   := 0;
		v_qty_61_90   := 0;
		v_amt_61_90   := 0;
		v_qty_91      := 0;
		v_amt_91      := 0;
		for r1 in c1(v_sub_type)
		loop
			html_report_pkg.line_title(p_title_string => r1.item_big_category_name || v_sep || r1.customer_number || v_sep ||
																									 r1.customer_name || v_sep ||
																									 to_char(r1.confirm_date
																													,'yyyy-mm-dd') || v_sep || r1.shipment_number || v_sep ||
																									 r1.document_number || v_sep || r1.document_type_name || v_sep ||
																									 r1.item_segment || v_sep || r1.item_description || v_sep ||
																									 r1.unit_measure || v_sep || r1.quantity || v_sep || r1.material_cost ||
																									 v_sep || r1.amount_cost || v_sep || r1.source_sale_price || v_sep ||
																									 r1.amount || v_sep || r1.qty_not_due || v_sep || r1.amt_not_due ||
																									 v_sep || r1.qty_0_30 || v_sep || r1.amt_0_30 || v_sep ||
																									 r1.qty_31_60 || v_sep || r1.amt_31_60 || v_sep || r1.qty_61_90 ||
																									 v_sep || r1.amt_61_90 || v_sep || r1.qty_91 || v_sep || r1.amt_91 ||
																									 v_sep
																,p_delimiter    => v_sep);
		
			v_qty         := nvl(v_qty
													,0) + nvl(r1.quantity
																	 ,0);
			v_amt_cost    := nvl(v_amt_cost
													,0) + nvl(r1.amount_cost
																	 ,0);
			v_amt         := nvl(v_amt
													,0) + nvl(r1.amount
																	 ,0);
			v_qty_not_due := nvl(v_qty_not_due
													,0) + nvl(r1.qty_not_due
																	 ,0);
			v_amt_not_due := nvl(v_amt_not_due
													,0) + nvl(r1.amt_not_due
																	 ,0);
			v_qty_0_30    := nvl(v_qty_0_30
													,0) + nvl(r1.qty_0_30
																	 ,0);
			v_amt_0_30    := nvl(v_amt_0_30
													,0) + nvl(r1.amt_0_30
																	 ,0);
			v_qty_31_60   := nvl(v_qty_31_60
													,0) + nvl(r1.qty_31_60
																	 ,0);
			v_amt_31_60   := nvl(v_amt_31_60
													,0) + nvl(r1.amt_31_60
																	 ,0);
			v_qty_61_90   := nvl(v_qty_61_90
													,0) + nvl(r1.qty_61_90
																	 ,0);
			v_amt_61_90   := nvl(v_amt_61_90
													,0) + nvl(r1.amt_61_90
																	 ,0);
			v_qty_91      := nvl(v_qty_91
													,0) + nvl(r1.qty_91
																	 ,0);
			v_amt_91      := nvl(v_amt_91
													,0) + nvl(r1.amt_91
																	 ,0);
		end loop;
		html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=10' || v_sep || v_qty || v_sep ||
																										'－***align=center' || v_sep || v_amt_cost || v_sep ||
																										'－***align=center' || v_sep || v_amt || v_sep || v_qty_not_due ||
																										v_sep || v_amt_not_due || v_sep || v_qty_0_30 || v_sep ||
																										v_amt_0_30 || v_sep || v_qty_31_60 || v_sep || v_amt_31_60 || v_sep ||
																										v_qty_61_90 || v_sep || v_amt_61_90 || v_sep || v_qty_91 || v_sep ||
																										v_amt_91 || v_sep
															,p_delimiter       => v_sep
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***');
		html_report_pkg.output_line('</tr></table>');
	
		---------------------------------------------
		/*if (p_type = '01')
    then
      html_report_pkg.output_line(v_l_title2);
      html_report_pkg.output_line('<table width=2500 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
    
      v_line_str := '物料大类,客户编号,客户名称,挑库确认日期,出库单号,订单号,订单类型,物料编码,物料名称,单位,数量,平均成本单价,平均成本金额,销售订单价,销售金额,未到期(数量),未到期(金额),0－30天(数量),0－30天(金额),31－60天(数量),31－60天(金额),61－90天(数量),61－90天(金额),超过90天(数量),超过90天(金额),';
      html_report_pkg.line_title(p_title_string => v_line_str);
    
      v_qty         := 0;
      v_amt         := 0;
      v_amt_cost    := 0;
      v_qty_not_due := 0;
      v_amt_not_due := 0;
      v_qty_0_30    := 0;
      v_amt_0_30    := 0;
      v_qty_31_60   := 0;
      v_amt_31_60   := 0;
      v_qty_61_90   := 0;
      v_amt_61_90   := 0;
      v_qty_91      := 0;
      v_amt_91      := 0;
      for r1 in c3
      loop
        html_report_pkg.line_title(p_title_string => r1.item_big_category_name ||
                                                     v_sep ||
                                                     r1.customer_number ||
                                                     v_sep ||
                                                     r1.customer_name ||
                                                     v_sep ||
                                                     to_char(r1.date_received
                                                            ,'yyyy-mm-dd') ||
                                                     v_sep ||
                                                     r1.request_number ||
                                                     v_sep ||
                                                     r1.order_number ||
                                                     v_sep ||
                                                     r1.order_type_name ||
                                                     v_sep ||
                                                     r1.item_number ||
                                                     v_sep ||
                                                     r1.item_description ||
                                                     v_sep || r1.uom ||
                                                     v_sep ||
                                                     r1.primary_quantity ||
                                                     v_sep ||
                                                     r1.transaction_cost ||
                                                     v_sep ||
                                                     r1.amount_cost ||
                                                     v_sep ||
                                                     r1.unit_selling_price ||
                                                     v_sep || r1.amount ||
                                                     v_sep ||
                                                     r1.qty_not_due ||
                                                     v_sep ||
                                                     r1.amt_not_due ||
                                                     v_sep || r1.qty_0_30 ||
                                                     v_sep || r1.amt_0_30 ||
                                                     v_sep || r1.qty_31_60 ||
                                                     v_sep || r1.amt_31_60 ||
                                                     v_sep || r1.qty_61_90 ||
                                                     v_sep || r1.amt_61_90 ||
                                                     v_sep || r1.qty_91 ||
                                                     v_sep || r1.amt_91 ||
                                                     v_sep
                                  ,p_delimiter    => v_sep);
      
        v_qty         := nvl(v_qty
                            ,0) + nvl(r1.primary_quantity
                                     ,0);
        v_amt_cost    := nvl(v_amt_cost
                            ,0) + nvl(r1.amount_cost
                                     ,0);
        v_amt         := nvl(v_amt
                            ,0) + nvl(r1.amount
                                     ,0);
        v_qty_not_due := nvl(v_qty_not_due
                            ,0) + nvl(r1.qty_not_due
                                     ,0);
        v_amt_not_due := nvl(v_amt_not_due
                            ,0) + nvl(r1.amt_not_due
                                     ,0);
        v_qty_0_30    := nvl(v_qty_0_30
                            ,0) + nvl(r1.qty_0_30
                                     ,0);
        v_amt_0_30    := nvl(v_amt_0_30
                            ,0) + nvl(r1.amt_0_30
                                     ,0);
        v_qty_31_60   := nvl(v_qty_31_60
                            ,0) + nvl(r1.qty_31_60
                                     ,0);
        v_amt_31_60   := nvl(v_amt_31_60
                            ,0) + nvl(r1.amt_31_60
                                     ,0);
        v_qty_61_90   := nvl(v_qty_61_90
                            ,0) + nvl(r1.qty_61_90
                                     ,0);
        v_amt_61_90   := nvl(v_amt_61_90
                            ,0) + nvl(r1.amt_61_90
                                     ,0);
        v_qty_91      := nvl(v_qty_91
                            ,0) + nvl(r1.qty_91
                                     ,0);
        v_amt_91      := nvl(v_amt_91
                            ,0) + nvl(r1.amt_91
                                     ,0);
      end loop;
      html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=10' ||
                                                      v_sep || v_qty ||
                                                      v_sep ||
                                                      '－***align=center' ||
                                                      v_sep || v_amt_cost ||
                                                      v_sep ||
                                                      '－***align=center' ||
                                                      v_sep || v_amt ||
                                                      v_sep ||
                                                      v_qty_not_due ||
                                                      v_sep ||
                                                      v_amt_not_due ||
                                                      v_sep || v_qty_0_30 ||
                                                      v_sep || v_amt_0_30 ||
                                                      v_sep || v_qty_31_60 ||
                                                      v_sep || v_amt_31_60 ||
                                                      v_sep || v_qty_61_90 ||
                                                      v_sep || v_amt_61_90 ||
                                                      v_sep || v_qty_91 ||
                                                      v_sep || v_amt_91 ||
                                                      v_sep
                                ,p_delimiter       => v_sep
                                ,p_with_other_attr => 'Y'
                                ,p_attr_delimiter  => '***');
      html_report_pkg.output_line('</tr></table>');
    end if;*/
		---------------------------------------------
		html_report_pkg.output_line(v_l_title3);
		html_report_pkg.output_line('<table width=1000 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '客户编号,客户名称,子库编号,入库日期,事务处理类型,单位,数量,';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		v_qty := 0;
		v_amt := 0;
		for r1 in c2(v_sub_type)
		loop
			html_report_pkg.line_title(p_title_string => r1.customer_number || v_sep || r1.customer_name || v_sep ||
																									 r1.subinventory_code || v_sep ||
																									 to_char(r1.date_received
																													,'yyyy-mm-dd') || v_sep || r1.transaction_type_name || v_sep ||
																									 r1.uom || v_sep || r1.qty || v_sep
																,p_delimiter    => v_sep);
		
			v_qty := nvl(v_qty
									,0) + nvl(r1.qty
													 ,0);
		end loop;
		html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=6' || v_sep || v_qty || v_sep
															,p_delimiter       => v_sep
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***');
		html_report_pkg.output_line('</tr></table>');
	
		--退货 add 2010-1-5
		html_report_pkg.output_line('<BR><BR><B>退货的帐龄：');
		html_report_pkg.output_line('<table width=2500 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '物料大类,客户编号,客户名称,发货确认日期,发货单号,委托书编号,委托书类型,物料编码,物料名称,单位,数量,平均成本单价,平均成本金额,销售订单价,销售金额,未到期(数量),未到期(金额),0－30天(数量),0－30天(金额),31－60天(数量),31－60天(金额),61－90天(数量),61－90天(金额),超过90天(数量),超过90天(金额),';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		v_qty         := 0;
		v_amt         := 0;
		v_amt_cost    := 0;
		v_qty_not_due := 0;
		v_amt_not_due := 0;
		v_qty_0_30    := 0;
		v_amt_0_30    := 0;
		v_qty_31_60   := 0;
		v_amt_31_60   := 0;
		v_qty_61_90   := 0;
		v_amt_61_90   := 0;
		v_qty_91      := 0;
		v_amt_91      := 0;
		for r4 in c4
		loop
			html_report_pkg.line_title(p_title_string => r4.item_big_category_name || v_sep || r4.customer_number || v_sep ||
																									 r4.customer_name || v_sep ||
																									 to_char(r4.confirm_date
																													,'yyyy-mm-dd') || v_sep || r4.shipment_number || v_sep ||
																									 r4.document_number || v_sep || r4.document_type_name || v_sep ||
																									 r4.item_segment || v_sep || r4.item_description || v_sep ||
																									 r4.unit_measure || v_sep || r4.quantity || v_sep || r4.material_cost ||
																									 v_sep || r4.amount_cost || v_sep || r4.source_sale_price || v_sep ||
																									 r4.amount || v_sep || r4.qty_not_due || v_sep || r4.amt_not_due ||
																									 v_sep || r4.qty_0_30 || v_sep || r4.amt_0_30 || v_sep ||
																									 r4.qty_31_60 || v_sep || r4.amt_31_60 || v_sep || r4.qty_61_90 ||
																									 v_sep || r4.amt_61_90 || v_sep || r4.qty_91 || v_sep || r4.amt_91 ||
																									 v_sep
																,p_delimiter    => v_sep);
		
			v_qty         := nvl(v_qty
													,0) + nvl(r4.quantity
																	 ,0);
			v_amt_cost    := nvl(v_amt_cost
													,0) + nvl(r4.amount_cost
																	 ,0);
			v_amt         := nvl(v_amt
													,0) + nvl(r4.amount
																	 ,0);
			v_qty_not_due := nvl(v_qty_not_due
													,0) + nvl(r4.qty_not_due
																	 ,0);
			v_amt_not_due := nvl(v_amt_not_due
													,0) + nvl(r4.amt_not_due
																	 ,0);
			v_qty_0_30    := nvl(v_qty_0_30
													,0) + nvl(r4.qty_0_30
																	 ,0);
			v_amt_0_30    := nvl(v_amt_0_30
													,0) + nvl(r4.amt_0_30
																	 ,0);
			v_qty_31_60   := nvl(v_qty_31_60
													,0) + nvl(r4.qty_31_60
																	 ,0);
			v_amt_31_60   := nvl(v_amt_31_60
													,0) + nvl(r4.amt_31_60
																	 ,0);
			v_qty_61_90   := nvl(v_qty_61_90
													,0) + nvl(r4.qty_61_90
																	 ,0);
			v_amt_61_90   := nvl(v_amt_61_90
													,0) + nvl(r4.amt_61_90
																	 ,0);
			v_qty_91      := nvl(v_qty_91
													,0) + nvl(r4.qty_91
																	 ,0);
			v_amt_91      := nvl(v_amt_91
													,0) + nvl(r4.amt_91
																	 ,0);
		end loop;
		html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=10' || v_sep || v_qty || v_sep ||
																										'－***align=center' || v_sep || v_amt_cost || v_sep ||
																										'－***align=center' || v_sep || v_amt || v_sep || v_qty_not_due ||
																										v_sep || v_amt_not_due || v_sep || v_qty_0_30 || v_sep ||
																										v_amt_0_30 || v_sep || v_qty_31_60 || v_sep || v_amt_31_60 || v_sep ||
																										v_qty_61_90 || v_sep || v_amt_61_90 || v_sep || v_qty_91 || v_sep ||
																										v_amt_91 || v_sep
															,p_delimiter       => v_sep
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***');
		html_report_pkg.output_line('</tr></table>');
	
		html_report_pkg.output_line('</html>');
	end jd_goods_account_p_new;

	--JD.客户仓商品帐龄分析表（暂收仓）
	procedure jd_goods_account_p2_new(p1                      in varchar2
																	 ,p2                      in varchar2
																	 ,p_organization_id       in number
																	 ,p_customer_number_start in varchar2
																	 ,p_customer_number_end   in varchar2
																	 ,p_big_category_start    in varchar2
																	 ,p_big_category_end      in varchar2
																	 ,p_request_id            in number
																	 ,p_is_temp               in varchar2 default 'N') is
	
		--发货确认的客户仓帐龄
		cursor c1(v_sub_type varchar2) is
			select item_big_category_name
						,customer_number
						,customer_name
						,
						 --nvl(confirm_date, sysdate) confirm_date,
						 get_overdue_days_f1(shipment_number
																,p_organization_id) confirm_date
						,shipment_number
						,document_number
						,document_type_name
						,item_segment
						,item_description
						,unit_measure
						,source_sale_price
						,material_cost
						,sum(amount_cost) amount_cost
						,sum(quantity) quantity
						,sum(amount) amount
						,sum(qty_0) qty_not_due
						,sum(amt_0) amt_not_due
						,sum(qty_0_30) qty_0_30
						,sum(amt_0_30) amt_0_30
						,sum(qty_31_60) qty_31_60
						,sum(amt_31_60) amt_31_60
						,sum(qty_61_90) qty_61_90
						,sum(amt_61_90) amt_61_90
						,sum(qty_91) qty_91
						,sum(amt_91) amt_91
				from (select t.item_big_category_name
										,cust.account_number customer_number
										,party.party_name customer_name
										,sch.confirm_date
										,ssh.shipment_number
										,sdh.document_number
										,sdt.document_type_name
										,t.item_segment
										,t.item_description
										,t.unit_measure
										,ssl.source_sale_price
										,round(nvl(t.material_cost
															,0)
													,7) material_cost
										,round(sum(t.quantity) * nvl(t.material_cost
																								,0)
													,7) amount_cost
										,sum(t.quantity) quantity
										,sum(t.quantity * ssl.source_sale_price) amount
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0))
													 ,-1
													 ,sum(nvl(t.quantity
																	 ,0))
													 ,0) qty_0 --- <0
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0))
													 ,-1
													 ,sum(nvl(t.quantity
																	 ,0) * nvl(ssl.source_sale_price
																						,0))
													 ,0) amt_0 --<0
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 30)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_0_30
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0))
													 ,-1
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 30)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_0_30
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 60)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_31_60
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 30)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 60)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_31_60
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 90)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0)))) qty_61_90
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 60)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																				nvl(rtl.due_days
																					 ,0) - 90)
																	,1
																	,0
																	,sum(nvl(t.quantity
																					,0) * nvl(ssl.source_sale_price
																									 ,0)))) amt_61_90
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(t.quantity
																	 ,0))) qty_91
										,decode(sign(trunc(sysdate) - trunc(t.date_received) -
																 nvl(rtl.due_days
																		,0) - 90)
													 ,-1
													 ,0
													 ,0
													 ,0
													 ,sum(nvl(t.quantity
																	 ,0) * nvl(ssl.source_sale_price
																						,0))) amt_91
								from scm_so_confirm_details  scd
										,scm_so_shipment_headers ssh
										,scm_so_shipment_lines   ssl
										,scm_so_confirm_headers  sch
										,scm_so_confirm_lines    scl
										,scm_dm_headers          sdh
										,scm_dm_types            sdt
										,hz_cust_accounts        cust
										,hz_parties              party
										,ra_terms_lines          rtl
										 ------
										,scm_jd_goods_account2 t
							 where t.source_line_id = scd.confirm_detail_id
										--and t.subinventory_code = scd.destination_sub_code
								 and scd.confirm_line_id = scl.confirm_line_id
								 and scl.shipment_line_id = ssl.shipment_line_id
								 and scl.confirm_header_id = sch.confirm_header_id
								 and ssl.shipment_header_id = ssh.shipment_header_id
								 and ssh.document_header_id = sdh.document_header_id
								 and sdh.document_type_id = sdt.document_type_id
										--and sch.confirm_date is not null
								 and ssh.customer_id = cust.cust_account_id
								 and cust.party_id = party.party_id
								 and cust.status = 'A'
								 and sdh.receive_term = rtl.term_id
								 and rtl.sequence_num = 1
										
										--参数
								 and cust.account_number >= nvl(p_customer_number_start
																							 ,cust.account_number)
								 and cust.account_number <= nvl(p_customer_number_end
																							 ,cust.account_number)
							 group by t.item_big_category_name
											 ,cust.account_number
											 ,party.party_name
											 ,sch.confirm_date
											 ,ssh.shipment_number
											 ,sdh.document_number
											 ,sdt.document_type_name
											 ,t.item_segment
											 ,t.item_description
											 ,t.unit_measure
											 ,ssl.source_sale_price
											 ,t.material_cost
											 ,t.date_received
											 ,rtl.due_days
							/*union all
              select t.item_big_category_name,
                     cust.account_number customer_number,
                     party.party_name customer_name,
                     ssh.shipment_date,
                     ssh.shipment_number,
                     sdh.document_number,
                     sdt.document_type_name,
                     t.item_segment,
                     t.item_description,
                     t.unit_measure,
                     ssl.source_sale_price,
                     round(nvl(t.material_cost, 0), 7) material_cost,
                     round(sum(t.quantity) * nvl(t.material_cost, 0), 7) amount_cost,
                     sum(t.quantity) quantity,
                     sum(t.quantity * ssl.source_sale_price) amount,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) -
                                 nvl(rtl.due_days, 0)),
                            -1,
                            sum(nvl(t.quantity, 0)),
                            0) qty_0 --- <0
                    ,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) -
                                 nvl(rtl.due_days, 0)),
                            -1,
                            sum(nvl(t.quantity, 0) *
                                nvl(ssl.source_sale_price, 0)),
                            0) amt_0 --<0
                    ,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) -
                                 nvl(rtl.due_days, 0)),
                            -1,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) -
                                        nvl(rtl.due_days, 0) - 30),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0)))) qty_0_30,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) -
                                 nvl(rtl.due_days, 0)),
                            -1,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) -
                                        nvl(rtl.due_days, 0) - 30),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0) *
                                       nvl(ssl.source_sale_price, 0)))) amt_0_30,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) -
                                 nvl(rtl.due_days, 0) - 30),
                            -1,
                            0,
                            0,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) -
                                        nvl(rtl.due_days, 0) - 60),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0)))) qty_31_60,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) -
                                 nvl(rtl.due_days, 0) - 30),
                            -1,
                            0,
                            0,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) -
                                        nvl(rtl.due_days, 0) - 60),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0) *
                                       nvl(ssl.source_sale_price, 0)))) amt_31_60,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) -
                                 nvl(rtl.due_days, 0) - 60),
                            -1,
                            0,
                            0,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) -
                                        nvl(rtl.due_days, 0) - 90),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0)))) qty_61_90,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) -
                                 nvl(rtl.due_days, 0) - 60),
                            -1,
                            0,
                            0,
                            0,
                            decode(sign(trunc(sysdate) -
                                        trunc(t.date_received) -
                                        nvl(rtl.due_days, 0) - 90),
                                   1,
                                   0,
                                   sum(nvl(t.quantity, 0) *
                                       nvl(ssl.source_sale_price, 0)))) amt_61_90,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) -
                                 nvl(rtl.due_days, 0) - 90),
                            -1,
                            0,
                            0,
                            0,
                            sum(nvl(t.quantity, 0))) qty_91,
                     decode(sign(trunc(sysdate) - trunc(t.date_received) -
                                 nvl(rtl.due_days, 0) - 90),
                            -1,
                            0,
                            0,
                            0,
                            sum(nvl(t.quantity, 0) *
                                nvl(ssl.source_sale_price, 0))) amt_91
                from scm_so_shipment_headers_vir ssh,
                     scm_so_shipment_lines_vir   ssl,
                     scm_so_shipment_details_vir ssd,
                     scm_dm_headers              sdh,
                     scm_dm_types                sdt,
                     hz_cust_accounts            cust,
                     hz_parties                  party,
                     ra_terms_lines              rtl,
                     scm_jd_goods_account2       t
               where t.source_line_id = ssd.shipment_detail_id
                 and ssd.shipment_header_id = ssh.shipment_header_id
                 and ssl.shipment_header_id = ssh.shipment_header_id
                 and ssd.shipment_line_id = ssl.shipment_line_id
                 and ssl.shipment_header_id = ssh.shipment_header_id
                 and ssh.document_header_id = sdh.document_header_id
                 and sdh.document_type_id = sdt.document_type_id
                 and ssh.customer_id = cust.cust_account_id
                 AND cust.party_id = party.party_id
                 AND cust.status = 'A'
                 and sdh.receive_term = rtl.term_id
                 and rtl.sequence_num = 1
                 and cust.account_number >=
                     nvl(p_customer_number_start, cust.account_number)
                 and cust.account_number <=
                     nvl(p_customer_number_end, cust.account_number)
               group by t.item_big_category_name,
                        cust.account_number,
                        party.party_name,
                        ssh.shipment_date,
                        ssh.shipment_number,
                        sdh.document_number,
                        sdt.document_type_name,
                        t.item_segment,
                        t.item_description,
                        t.unit_measure,
                        ssl.source_sale_price,
                        t.material_cost,
                        t.date_received,
                        rtl.due_days*/
							)
			 group by item_big_category_name
							 ,customer_number
							 ,customer_name
							 ,confirm_date
							 ,shipment_number
							 ,document_number
							 ,document_type_name
							 ,item_segment
							 ,item_description
							 ,unit_measure
							 ,source_sale_price
							 ,material_cost;
	
		--非发货确认，非销售订单挑库的客户仓帐龄
		cursor c2(v_sub_type varchar2) is
			select moqd.subinventory_code
						,cust.account_number customer_number
						,party.party_name customer_name
						,trunc(moqd.date_received) date_received
						,mtt.transaction_type_name
						,sib.primary_unit_of_measure uom
						,sum(moqd.primary_transaction_quantity) qty
				from mtl_onhand_quantities_detail moqd
						,mtl_system_items_b           sib
						,mtl_secondary_inventories    msi
						,hz_cust_accounts             cust
						,hz_parties                   party
						,mtl_material_transactions    mmt
						,mtl_transaction_types        mtt
			 where moqd.inventory_item_id = sib.inventory_item_id
				 and moqd.organization_id = sib.organization_id
				 and moqd.subinventory_code = msi.secondary_inventory_name
				 and msi.attribute1 = cust.cust_account_id(+)
				 and cust.party_id = party.party_id
				 and cust.status = 'A'
				 and moqd.create_transaction_id = mmt.transaction_id
				 and mmt.transaction_type_id = mtt.transaction_type_id
				 and sib.segment1 not like '106%'
				 and moqd.subinventory_code like 'K%'
				 and moqd.subinventory_code not like 'KB%'
				 and moqd.subinventory_code not like 'KP%'
				 and mtt.transaction_type_name != '销售订单挑库'
				 and mtt.transaction_type_name not like 'SCM%'
				 and instr(v_sub_type
									,msi.attribute1) <> 0 --03客户外协仓，04客户暂收仓，05客户结算仓
						--参数
				 and moqd.organization_id = p_organization_id
				 and cust.account_number >= nvl(p_customer_number_start
																			 ,cust.account_number)
				 and cust.account_number <= nvl(p_customer_number_end
																			 ,cust.account_number)
			 group by moqd.subinventory_code
							 ,mtt.transaction_type_name
							 ,mmt.trx_source_line_id
							 ,cust.account_number
							 ,party.party_name
							 ,trunc(moqd.date_received)
							 ,sib.primary_unit_of_measure;
	
		v_line_str varchar2(4000);
		v_sep      varchar2(5);
		v_sub_type varchar2(30);
		v_title    varchar2(100);
		v_l_title1 varchar2(100);
		v_l_title2 varchar2(100);
		v_l_title3 varchar2(100);
		-------
		v_qty         number;
		v_amt         number;
		v_amt_cost    number;
		v_qty_not_due number;
		v_amt_not_due number;
		v_qty_0_30    number;
		v_amt_0_30    number;
		v_qty_31_60   number;
		v_amt_31_60   number;
		v_qty_61_90   number;
		v_amt_61_90   number;
		v_qty_91      number;
		v_amt_91      number;
		p_type        varchar2(10);
		v_org_id      number;
	begin
		p_type := '02';
		if (p_type = '02')
		then
			v_sub_type := '03,04'; --目标子库类型是“客户暂收仓”和“客户外协仓”
			v_title    := '客户仓商品帐龄分析表（暂收仓）';
			v_l_title1 := '<BR><BR><B>发货确认的暂收仓帐龄：';
			-- v_l_title2 := '<BR><BR><B>挑库确认的暂收仓帐龄：';
			v_l_title3 := '<BR><BR><B>非发货确认、非挑库确认的暂收仓数量列表：';
		end if;
	
		v_org_id := get_org_id_f(p_organization_id);
		---------------插入临时表-------------------
		insert_temp_new(v_org_id
									 ,p_organization_id
									 ,p_customer_number_start
									 ,p_customer_number_end
									 ,p_big_category_start
									 ,p_big_category_end
									 ,p_request_id
									 ,p_is_temp
									 ,p_type);
	
		v_sep := '####';
		/*    html_report_pkg.v_report_output_mode := 'F';
    
    
    html_report_pkg.html_title(p_program_title => v_title
                              ,p_report_title  => v_title);
    html_report_pkg.output_line('打印时间：' ||
                                to_char(sysdate
                                       ,'yyyy-mm-dd hh24:mi'));
    html_report_pkg.output_line('<BR>客户编号，自：' ||
                                p_customer_number_start || '，至：' ||
                                p_customer_number_end);*/
		html_report_pkg.output_line(v_l_title1);
		html_report_pkg.output_line('<table width=2500 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '物料大类,客户编号,客户名称,发货确认日期,发货单号,委托书编号,委托书类型,物料编码,物料名称,单位,数量,平均成本单价,平均成本金额,销售订单价,销售金额,未到期(数量),未到期(金额),0－30天(数量),0－30天(金额),31－60天(数量),31－60天(金额),61－90天(数量),61－90天(金额),超过90天(数量),超过90天(金额),';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		v_qty         := 0;
		v_amt         := 0;
		v_amt_cost    := 0;
		v_qty_not_due := 0;
		v_amt_not_due := 0;
		v_qty_0_30    := 0;
		v_amt_0_30    := 0;
		v_qty_31_60   := 0;
		v_amt_31_60   := 0;
		v_qty_61_90   := 0;
		v_amt_61_90   := 0;
		v_qty_91      := 0;
		v_amt_91      := 0;
		for r1 in c1(v_sub_type)
		loop
			html_report_pkg.line_title(p_title_string => r1.item_big_category_name || v_sep || r1.customer_number || v_sep ||
																									 r1.customer_name || v_sep ||
																									 to_char(r1.confirm_date
																													,'yyyy-mm-dd') || v_sep || r1.shipment_number || v_sep ||
																									 r1.document_number || v_sep || r1.document_type_name || v_sep ||
																									 r1.item_segment || v_sep || r1.item_description || v_sep ||
																									 r1.unit_measure || v_sep || r1.quantity || v_sep || r1.material_cost ||
																									 v_sep || r1.amount_cost || v_sep || r1.source_sale_price || v_sep ||
																									 r1.amount || v_sep || r1.qty_not_due || v_sep || r1.amt_not_due ||
																									 v_sep || r1.qty_0_30 || v_sep || r1.amt_0_30 || v_sep ||
																									 r1.qty_31_60 || v_sep || r1.amt_31_60 || v_sep || r1.qty_61_90 ||
																									 v_sep || r1.amt_61_90 || v_sep || r1.qty_91 || v_sep || r1.amt_91 ||
																									 v_sep
																,p_delimiter    => v_sep);
		
			v_qty         := nvl(v_qty
													,0) + nvl(r1.quantity
																	 ,0);
			v_amt_cost    := nvl(v_amt_cost
													,0) + nvl(r1.amount_cost
																	 ,0);
			v_amt         := nvl(v_amt
													,0) + nvl(r1.amount
																	 ,0);
			v_qty_not_due := nvl(v_qty_not_due
													,0) + nvl(r1.qty_not_due
																	 ,0);
			v_amt_not_due := nvl(v_amt_not_due
													,0) + nvl(r1.amt_not_due
																	 ,0);
			v_qty_0_30    := nvl(v_qty_0_30
													,0) + nvl(r1.qty_0_30
																	 ,0);
			v_amt_0_30    := nvl(v_amt_0_30
													,0) + nvl(r1.amt_0_30
																	 ,0);
			v_qty_31_60   := nvl(v_qty_31_60
													,0) + nvl(r1.qty_31_60
																	 ,0);
			v_amt_31_60   := nvl(v_amt_31_60
													,0) + nvl(r1.amt_31_60
																	 ,0);
			v_qty_61_90   := nvl(v_qty_61_90
													,0) + nvl(r1.qty_61_90
																	 ,0);
			v_amt_61_90   := nvl(v_amt_61_90
													,0) + nvl(r1.amt_61_90
																	 ,0);
			v_qty_91      := nvl(v_qty_91
													,0) + nvl(r1.qty_91
																	 ,0);
			v_amt_91      := nvl(v_amt_91
													,0) + nvl(r1.amt_91
																	 ,0);
		end loop;
		html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=10' || v_sep || v_qty || v_sep ||
																										'－***align=center' || v_sep || v_amt_cost || v_sep ||
																										'－***align=center' || v_sep || v_amt || v_sep || v_qty_not_due ||
																										v_sep || v_amt_not_due || v_sep || v_qty_0_30 || v_sep ||
																										v_amt_0_30 || v_sep || v_qty_31_60 || v_sep || v_amt_31_60 || v_sep ||
																										v_qty_61_90 || v_sep || v_amt_61_90 || v_sep || v_qty_91 || v_sep ||
																										v_amt_91 || v_sep
															,p_delimiter       => v_sep
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***');
		html_report_pkg.output_line('</tr></table>');
	
		---------------------------------------------
		html_report_pkg.output_line(v_l_title3);
		html_report_pkg.output_line('<table width=1000 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '客户编号,客户名称,子库编号,入库日期,事务处理类型,单位,数量,';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		v_qty := 0;
		v_amt := 0;
		for r1 in c2(v_sub_type)
		loop
			html_report_pkg.line_title(p_title_string => r1.customer_number || v_sep || r1.customer_name || v_sep ||
																									 r1.subinventory_code || v_sep ||
																									 to_char(r1.date_received
																													,'yyyy-mm-dd') || v_sep || r1.transaction_type_name || v_sep ||
																									 r1.uom || v_sep || r1.qty || v_sep
																,p_delimiter    => v_sep);
		
			v_qty := nvl(v_qty
									,0) + nvl(r1.qty
													 ,0);
		end loop;
		html_report_pkg.line_title(p_title_string    => '合计：***align=right colspan=6' || v_sep || v_qty || v_sep
															,p_delimiter       => v_sep
															,p_with_other_attr => 'Y'
															,p_attr_delimiter  => '***');
		html_report_pkg.output_line('</tr></table>');
	
	end jd_goods_account_p2_new;

	--获取货到逾期天数
	function get_overdue_days_f_new(p_shipment_id in number) return number is
		v_confirm_date date; --货到：发货单行程中第一步的确认日期 
		v_pay_days     number; --货到天数
		v_days         number;
	begin
	
		begin
			select sch.confirm_date
						,nvl(sdh.pay_days
								,0)
			
				into v_confirm_date
						,v_pay_days
				from scm_so_confirm_details  scd
						,scm_so_shipment_headers ssh
						,scm_so_shipment_lines   ssl
						,scm_so_confirm_headers  sch
						,scm_so_confirm_lines    scl
						,scm_dm_headers          sdh
			 where scd.confirm_line_id = scl.confirm_line_id
				 and scl.shipment_line_id = ssl.shipment_line_id
				 and scl.confirm_header_id = sch.confirm_header_id
				 and ssl.shipment_header_id = ssh.shipment_header_id
				 and ssh.document_header_id = sdh.document_header_id
				 and sdh.receive_type = 'S'
				 and ssh.shipment_header_id = p_shipment_id
				 and sch.confirm_flag = 'Y'
				 and rownum = 1
			 order by sch.confirm_header_id;
		exception
			when others then
				v_confirm_date := sysdate + 1;
				v_pay_days     := 0;
		end;
		v_days := trunc(sysdate) - trunc(v_confirm_date) - v_pay_days;
	
		return v_days;
	
	end get_overdue_days_f_new;

	--创建临时表数据p_type 01为结算仓，02为暂收仓
	procedure insert_temp_new(p_org_id                in number
													 ,p_organization_id       in number
													 ,p_customer_number_start in varchar2
													 ,p_customer_number_end   in varchar2
													 ,p_big_category_start    in varchar2
													 ,p_big_category_end      in varchar2
													 ,p_request_id            in number
													 ,p_is_temp               in varchar2
													 ,p_type                  in varchar2) is
		v_sub_type varchar2(10);
	begin
		if (p_type = '01')
		then
			v_sub_type := '05';
		elsif (p_type = '02')
		then
			v_sub_type := '03,04';
		end if;
	
		if (p_is_temp = 'Y')
		then
			if p_type = '01'
			then
				insert into scm_jd_goods_account
					(inventory_item_id
					,organization_id
					,item_big_category_name
					,item_segment
					,item_description
					,unit_measure
					,material_cost
					,quantity
					,date_received
					,source_line_id
					,subinventory_code)
					select msib.inventory_item_id
								,msib.organization_id
								,fvt2.description
								,msib.segment1
								,msib.description
								,msib.primary_unit_of_measure
								,cic.material_cost
								,srfd.transaction_quantity
								,srfd.transaction_date
								,srfd.confirm_detail_id
								,scd.destination_sub_code
						from scm_rpt_fcsp_details   srfd
								,scm_so_confirm_details scd
								 ------
								,mtl_system_items_b   msib
								,cst_item_cost_type_v cic
								,mtl_item_categories  mic
								,mtl_categories_b     mcb
								,fnd_flex_value_sets  fvs
								,fnd_flex_values      ffv2
								,fnd_flex_values_tl   fvt2
					 where srfd.confirm_detail_id = scd.confirm_detail_id
						 and srfd.sub_type = p_type --'02' --暂收
						 and srfd.request_id = p_request_id
								
						 and scd.inventory_item_id = msib.inventory_item_id
						 and scd.organization_id = msib.organization_id
						 and msib.inventory_item_id = cic.inventory_item_id(+)
						 and msib.organization_id = cic.organization_id(+)
						 and cic.cost_type_id = 2 --平均成本
						 and msib.inventory_item_id = mic.inventory_item_id
						 and msib.organization_id = mic.organization_id
						 and mic.category_id = mcb.category_id
						 and mic.category_set_id = 1
						 and mcb.segment1 = ffv2.flex_value
						 and fvs.flex_value_set_id = ffv2.flex_value_set_id
						 and ffv2.flex_value_id = fvt2.flex_value_id
						 and fvt2.language = 'ZHS' --userenv('LANG')
						 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
								
								--参数
						 and msib.organization_id = p_organization_id
						 and srfd.org_id = p_org_id
						 and mcb.segment1 >= nvl(p_big_category_start
																		,mcb.segment1)
						 and mcb.segment1 <= nvl(p_big_category_end
																		,mcb.segment1);
			else
				insert into scm_jd_goods_account2
					(inventory_item_id
					,organization_id
					,item_big_category_name
					,item_segment
					,item_description
					,unit_measure
					,material_cost
					,quantity
					,date_received
					,source_line_id
					,subinventory_code)
					select msib.inventory_item_id
								,msib.organization_id
								,fvt2.description
								,msib.segment1
								,msib.description
								,msib.primary_unit_of_measure
								,cic.material_cost
								,srfd.transaction_quantity
								,srfd.transaction_date
								,srfd.confirm_detail_id
								,scd.destination_sub_code
						from scm_rpt_fcsp_details   srfd
								,scm_so_confirm_details scd
								 ------
								,mtl_system_items_b   msib
								,cst_item_cost_type_v cic
								,mtl_item_categories  mic
								,mtl_categories_b     mcb
								,fnd_flex_value_sets  fvs
								,fnd_flex_values      ffv2
								,fnd_flex_values_tl   fvt2
					 where srfd.confirm_detail_id = scd.confirm_detail_id
						 and srfd.sub_type = p_type --'02' --暂收
						 and srfd.request_id = p_request_id
								
						 and scd.inventory_item_id = msib.inventory_item_id
						 and scd.organization_id = msib.organization_id
						 and msib.inventory_item_id = cic.inventory_item_id(+)
						 and msib.organization_id = cic.organization_id(+)
						 and cic.cost_type_id = 2 --平均成本
						 and msib.inventory_item_id = mic.inventory_item_id
						 and msib.organization_id = mic.organization_id
						 and mic.category_id = mcb.category_id
						 and mic.category_set_id = 1
						 and mcb.segment1 = ffv2.flex_value
						 and fvs.flex_value_set_id = ffv2.flex_value_set_id
						 and ffv2.flex_value_id = fvt2.flex_value_id
						 and fvt2.language = 'ZHS' --userenv('LANG')
						 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
								
								--参数
						 and msib.organization_id = p_organization_id
						 and srfd.org_id = p_org_id
						 and mcb.segment1 >= nvl(p_big_category_start
																		,mcb.segment1)
						 and mcb.segment1 <= nvl(p_big_category_end
																		,mcb.segment1);
				--受托发货单             
				insert into scm_jd_goods_account2
					(inventory_item_id
					,organization_id
					,item_big_category_name
					,item_segment
					,item_description
					,unit_measure
					,material_cost
					,quantity
					,date_received
					,source_line_id
					,subinventory_code)
					select msib.inventory_item_id
								,msib.organization_id
								,fvt2.description
								,msib.segment1
								,msib.description
								,msib.primary_unit_of_measure
								,cic.material_cost
								,srfd.transaction_quantity
								,srfd.transaction_date
								,srfd.shipment_detail_id
								,scd.subinventory_code
						from scm_rpt_fcsp_details        srfd
								,scm_so_shipment_details_vir scd
								 ------
								,mtl_system_items_b   msib
								,cst_item_cost_type_v cic
								,mtl_item_categories  mic
								,mtl_categories_b     mcb
								,fnd_flex_value_sets  fvs
								,fnd_flex_values      ffv2
								,fnd_flex_values_tl   fvt2
					 where srfd.shipment_detail_id = scd.shipment_detail_id
						 and srfd.sub_type = '03' --'02' --暂收
						 and srfd.request_id = p_request_id
								
						 and scd.inventory_item_id = msib.inventory_item_id
						 and scd.organization_id = msib.organization_id
						 and msib.inventory_item_id = cic.inventory_item_id(+)
						 and msib.organization_id = cic.organization_id(+)
						 and cic.cost_type_id = 2 --平均成本
						 and msib.inventory_item_id = mic.inventory_item_id
						 and msib.organization_id = mic.organization_id
						 and mic.category_id = mcb.category_id
						 and mic.category_set_id = 1
						 and mcb.segment1 = ffv2.flex_value
						 and fvs.flex_value_set_id = ffv2.flex_value_set_id
						 and ffv2.flex_value_id = fvt2.flex_value_id
						 and fvt2.language = 'ZHS' --userenv('LANG')
						 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
								
								--参数
						 and msib.organization_id = p_organization_id
						 and srfd.org_id = p_org_id
						 and mcb.segment1 >= nvl(p_big_category_start
																		,mcb.segment1)
						 and mcb.segment1 <= nvl(p_big_category_end
																		,mcb.segment1);
			
			end if;
		else
			if p_type = '02'
			then
				insert into scm_jd_goods_account2
					(inventory_item_id
					,organization_id
					,item_big_category_name
					,item_segment
					,item_description
					,unit_measure
					,material_cost
					,quantity
					,date_received
					,source_line_id
					,subinventory_code)
					select moq.inventory_item_id
								,moq.organization_id
								,fvt2.description
								,msib.segment1
								,msib.description
								,msib.primary_unit_of_measure
								,cic.material_cost
								,moq.primary_transaction_quantity
								,moq.date_received
								,mmt.source_line_id
								,mmt.subinventory_code
						from mtl_onhand_quantities_detail moq
								,mtl_material_transactions    mmt
								,mtl_transaction_types        mtt
								,mtl_secondary_inventories    msi
								 
								 ------
								,mtl_system_items_b   msib
								,cst_item_cost_type_v cic
								,mtl_item_categories  mic
								,mtl_categories_b     mcb
								,fnd_flex_value_sets  fvs
								,fnd_flex_values      ffv2
								,fnd_flex_values_tl   fvt2
					 where moq.create_transaction_id = mmt.transaction_id
						 and moq.organization_id = mmt.organization_id
						 and mmt.transaction_type_id = mtt.transaction_type_id
						 and mtt.transaction_type_name like 'SCM%'
						 and moq.subinventory_code = msi.secondary_inventory_name
						 and moq.organization_id = msi.organization_id
						 and instr(v_sub_type
											,msi.attribute1) <> 0 --03客户外协仓，04客户暂收仓，05客户结算仓
								
						 and moq.inventory_item_id = msib.inventory_item_id
						 and moq.organization_id = msib.organization_id
						 and msib.inventory_item_id = cic.inventory_item_id(+)
						 and msib.organization_id = cic.organization_id(+)
						 and cic.cost_type_id = 2 --平均成本
						 and msib.inventory_item_id = mic.inventory_item_id
						 and msib.organization_id = mic.organization_id
						 and mic.category_id = mcb.category_id
						 and mic.category_set_id = 1
						 and mcb.segment1 = ffv2.flex_value
						 and fvs.flex_value_set_id = ffv2.flex_value_set_id
						 and ffv2.flex_value_id = fvt2.flex_value_id
						 and fvt2.language = 'ZHS' --userenv('LANG')
						 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
								
								--参数
						 and moq.organization_id = p_organization_id
						 and mcb.segment1 >= nvl(p_big_category_start
																		,mcb.segment1)
						 and mcb.segment1 <= nvl(p_big_category_end
																		,mcb.segment1);
			else
				insert into scm_jd_goods_account
					(inventory_item_id
					,organization_id
					,item_big_category_name
					,item_segment
					,item_description
					,unit_measure
					,material_cost
					,quantity
					,date_received
					,source_line_id
					,subinventory_code)
					select moq.inventory_item_id
								,moq.organization_id
								,fvt2.description
								,msib.segment1
								,msib.description
								,msib.primary_unit_of_measure
								,cic.material_cost
								,moq.primary_transaction_quantity
								,moq.date_received
								,mmt.source_line_id
								,mmt.subinventory_code
						from mtl_onhand_quantities_detail moq
								,mtl_material_transactions    mmt
								,mtl_transaction_types        mtt
								,mtl_secondary_inventories    msi
								 
								 ------
								,mtl_system_items_b   msib
								,cst_item_cost_type_v cic
								,mtl_item_categories  mic
								,mtl_categories_b     mcb
								,fnd_flex_value_sets  fvs
								,fnd_flex_values      ffv2
								,fnd_flex_values_tl   fvt2
					 where moq.create_transaction_id = mmt.transaction_id
						 and moq.organization_id = mmt.organization_id
						 and mmt.transaction_type_id = mtt.transaction_type_id
						 and mtt.transaction_type_name like 'SCM%'
						 and moq.subinventory_code = msi.secondary_inventory_name
						 and moq.organization_id = msi.organization_id
						 and instr(v_sub_type
											,msi.attribute1) <> 0 --03客户外协仓，04客户暂收仓，05客户结算仓
								
						 and moq.inventory_item_id = msib.inventory_item_id
						 and moq.organization_id = msib.organization_id
						 and msib.inventory_item_id = cic.inventory_item_id(+)
						 and msib.organization_id = cic.organization_id(+)
						 and cic.cost_type_id = 2 --平均成本
						 and msib.inventory_item_id = mic.inventory_item_id
						 and msib.organization_id = mic.organization_id
						 and mic.category_id = mcb.category_id
						 and mic.category_set_id = 1
						 and mcb.segment1 = ffv2.flex_value
						 and fvs.flex_value_set_id = ffv2.flex_value_set_id
						 and ffv2.flex_value_id = fvt2.flex_value_id
						 and fvt2.language = 'ZHS' --userenv('LANG')
						 and fvs.flex_value_set_name = 'MD_ITEM_MAJ'
								
								--参数
						 and moq.organization_id = p_organization_id
						 and mcb.segment1 >= nvl(p_big_category_start
																		,mcb.segment1)
						 and mcb.segment1 <= nvl(p_big_category_end
																		,mcb.segment1);
			end if;
		end if;
	end insert_temp_new;
	--客户对账单
	procedure jd_ar011(p1                in varchar2
										,p2                in varchar2
										,p_book_id         in number
										,p_org_id          in number
										,p_customer_id     in number
										,p_customer_id_end in number
										,p_date_from       in varchar2
										,p_date_to         in varchar2) is
	
		v_qc_inv_amount    number;
		v_qc_rec_amount    number;
		v_qc_exch_loss     number;
		v_qc_remain_amount number;
	
		v_qm_inv_amount    number;
		v_qm_rec_amount    number;
		v_qm_exch_loss     number;
		v_qm_remain_amount number;
	
		v_qj_exch_loss number;
	
		v_line_str varchar2(4000);
		v_sep      varchar2(15);
	
		cursor c_cus is
			select distinct cust.account_number      customer_number
										 ,party.party_name         customer_name
										 ,cust.customer_class_code customer_class_code
										 ,cust.cust_account_id     customer_id
				from hz_cust_accounts       cust
						,hz_parties             party
						,hz_cust_acct_sites_all hz
			 where cust.cust_account_id = hz.cust_account_id
				 and cust.party_id = party.party_id
				 and cust.status = 'A'
				 and hz.status = 'A'
						--and ra.STATUS = 'A'
				 and hz.org_id = p_org_id
				 and cust.cust_account_id between nvl(p_customer_id
																						 ,cust.cust_account_id) and
						 nvl(p_customer_id_end
								,cust.cust_account_id);
	
		cursor c_qj(p_customer_id number) is
			select '发票' record_type
						,rcta.trx_number trx_number
						,rcta.attribute3 zz_trx_num
						,rcta.doc_sequence_value
						,rcta.interface_header_attribute1 hetong_num
						,rcta.comments
						,to_char(rcta.trx_date
										,'yyyy-mm-dd') trx_date
						,to_char(gd.gl_date
										,'yyyy-mm-dd') inv_gl_date
						,rctt.name inv_type
						,get_order_type(decode(nvl(rcta.attribute11
																			,'N/A')
																	,'N/A'
																	,decode(substr(rcta.interface_header_attribute3
																								,1
																								,2)
																				 ,'KP'
																				 ,decode(rcta.interface_header_attribute12
																								,'N/A'
																								,rcta.interface_header_attribute2
																								,null
																								,'空订单类型'
																								,rcta.interface_header_attribute12)
																				 ,decode(rcta.interface_header_attribute2
																								,'0'
																								,'空订单类型'
																								,null
																								,'空订单类型'
																								,rcta.interface_header_attribute2))
																	,rcta.attribute11)) hetong_type --update: wuyujin 2009-12-24
						,rcta.invoice_currency_code curr_code
						,nvl(sum(decode(rctla.line_type
													 ,'LINE'
													 ,rctla.extended_amount
													 ,0))
								,0) price_amount
						,nvl(sum(decode(rctla.line_type
													 ,'TAX'
													 ,rctla.extended_amount
													 ,0))
								,0) tax_amount
						,nvl(round(sum(rctla.extended_amount * nvl(rcta.exchange_rate
																											,1))
											,2)
								,0) sum_amount
						,nvl(rcta.exchange_rate
								,1) exchange_rate
						,0 sum_amount_rmb
				from ra_customer_trx_all          rcta
						,ra_customer_trx_lines_all    rctla
						,ra_cust_trx_line_gl_dist_all gd
						,ra_cust_trx_types_all        rctt
			 where rcta.customer_trx_id = rctla.customer_trx_id
				 and nvl(nvl(rcta.sold_to_customer_id
										,rcta.ship_to_customer_id)
								,rcta.bill_to_customer_id) = p_customer_id
				 and rcta.org_id = p_org_id
				 and rcta.complete_flag = 'Y'
				 and rcta.cust_trx_type_id = rctt.cust_trx_type_id
				 and rcta.customer_trx_id = gd.customer_trx_id
				 and gd.account_class = 'REC'
				 and gd.latest_rec_flag = 'Y'
				 and rctt.post_to_gl <> 'N'
				 and rctt.accounting_affect_flag <> 'N'
				 and (gd.gl_date >= trunc(to_date(p_date_from
																				 ,'yyyy/mm/dd hh24:mi:ss')) or p_date_from is null)
				 and (gd.gl_date <= trunc(to_date(p_date_to
																				 ,'yyyy/mm/dd hh24:mi:ss')) or p_date_to is null)
			 group by rcta.trx_number
							 ,rcta.attribute3
							 ,rcta.doc_sequence_value
							 ,rcta.interface_header_attribute1
							 ,get_order_type(decode(nvl(rcta.attribute11
																				 ,'N/A')
																		 ,'N/A'
																		 ,decode(substr(rcta.interface_header_attribute3
																									 ,1
																									 ,2)
																						,'KP'
																						,decode(rcta.interface_header_attribute12
																									 ,'N/A'
																									 ,rcta.interface_header_attribute2
																									 ,null
																									 ,'空订单类型'
																									 ,rcta.interface_header_attribute12)
																						,decode(rcta.interface_header_attribute2
																									 ,'0'
																									 ,'空订单类型'
																									 ,null
																									 ,'空订单类型'
																									 ,rcta.interface_header_attribute2))
																		 ,rcta.attribute11))
							 ,rcta.comments
							 ,rcta.trx_date
							 ,gd.gl_date
							 ,rctt.name
							 ,rcta.exchange_rate
							 ,rcta.invoice_currency_code
			union all
			select '收款' record_type
						,acra.receipt_number receipt_number
						,null
						,acra.doc_sequence_value
						,null
						,acra.comments
						,to_char(acra.receipt_date
										,'yyyy-mm-dd') receipt_date
						,to_char(acrh.gl_date
										,'yyyy-mm-dd') gl_date
						,null
						,acra.attribute1 receipt_type
						,acra.currency_code
						,0
						,0
						,- (round(sum(nvl(ada.acctd_amount_dr
														,0) - nvl(ada.acctd_amount_cr
																		 ,0))
										,2)) app_amount_rmb
						,decode(acra.currency_code
									 ,'CNY'
									 ,1
									 ,ada.currency_conversion_rate) currency_conversion_rate
						,decode(acra.currency_code
									 ,'CNY'
									 ,0
									 ,- (round(sum(nvl(ada.amount_dr
																	 ,0) - nvl(ada.amount_cr
																						,0))
													 ,2))) app_amount
				from ar_cash_receipts_all        acra
						,ar_cash_receipt_history_all acrh
						,ar_distributions_all        ada
			 where acrh.cash_receipt_id = acra.cash_receipt_id
				 and ada.source_id = acrh.cash_receipt_history_id
				 and ada.source_table = 'CRH'
				 and acra.type = 'CASH'
				 and acra.org_id = p_org_id
				 and (acrh.gl_date >= trunc(to_date(p_date_from
																					 ,'yyyy/mm/dd hh24:mi:ss')) or p_date_from is null)
				 and (acrh.gl_date <= trunc(to_date(p_date_to
																					 ,'yyyy/mm/dd hh24:mi:ss')) or p_date_to is null)
				 and acra.pay_from_customer = p_customer_id
			 group by acra.receipt_number
							 ,acra.attribute1
							 ,acra.receipt_date
								--,acra.exchange_rate
								--,acra.pay_from_customer
							 ,acra.doc_sequence_value
							 ,acrh.gl_date
							 ,acra.currency_code
							 ,acra.comments
							 ,ada.currency_conversion_rate;
	
	begin
	
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '@';
		html_report_pkg.html_title(p_program_title => '客户对帐单'
															,p_report_title  => '客户对帐单');
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		html_report_pkg.output_line('<BR>日期，自：' || substr(p_date_from
																										 ,1
																										 ,10) || ' 至：' || substr(p_date_to
																																						,1
																																						,10));
	
		html_report_pkg.output_line('<table width=2000 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '记录类型,客户类别,客户编码,客户名称,发票/收款编码,增值税发票号,单据号,参考,备注,发票/收款日期,总帐日期,发票类型,订单类型,币种,价款,税额,CNY价税合计(人民币金额),汇率,外币金额,期间汇兑损益,';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		for v_cus in c_cus
		loop
		
			--计算期初金额
			--期初发票
			select nvl(round(sum(rctla.extended_amount * nvl(rcta.exchange_rate
																											,1))
											,2)
								,0) sum_amount
				into v_qc_inv_amount
				from ra_customer_trx_all          rcta
						,ra_customer_trx_lines_all    rctla
						,ra_cust_trx_line_gl_dist_all gd
						,ra_cust_trx_types_all        rctt
			 where rcta.customer_trx_id = rctla.customer_trx_id
				 and nvl(nvl(rcta.sold_to_customer_id
										,rcta.ship_to_customer_id)
								,rcta.bill_to_customer_id) = v_cus.customer_id
				 and rcta.org_id = p_org_id
				 and rcta.complete_flag = 'Y'
				 and rcta.cust_trx_type_id = rctt.cust_trx_type_id
				 and rcta.customer_trx_id = gd.customer_trx_id
				 and gd.account_class = 'REC'
				 and gd.latest_rec_flag = 'Y'
				 and rctt.post_to_gl <> 'N'
				 and rctt.accounting_affect_flag <> 'N'
				 and (gd.gl_date < trunc(to_date(p_date_from
																				,'yyyy/mm/dd hh24:mi:ss')) or p_date_from is null);
		
			--期初收款
			select nvl(sum(app_amount_rmb)
								,0)
				into v_qc_rec_amount
				from (select nvl(round(sum(decode(acra.currency_code
																				 ,'CNY'
																				 ,acrh.amount
																				 ,acrh.amount * acra.exchange_rate))
															,2)
												,0) app_amount_rmb
								from ar_cash_receipts_all        acra
										,ar_cash_receipt_history_all acrh
							 where acrh.cash_receipt_id = acra.cash_receipt_id
								 and acra.type = 'CASH'
								 and acrh.cash_receipt_history_id =
										 (select max(acrh1.cash_receipt_history_id)
												from ar_cash_receipt_history_all acrh1
											 where acrh1.org_id = acra.org_id
												 and acrh1.cash_receipt_id = acra.cash_receipt_id
												 and acrh1.status <> 'REVERSED'
												 and (acrh1.gl_date < trunc(to_date(p_date_from
																													 ,'yyyy/mm/dd hh24:mi:ss')) or p_date_from is null))
								 and acra.org_id = p_org_id
								 and (acrh.gl_date < trunc(to_date(p_date_from
																									,'yyyy/mm/dd hh24:mi:ss')) or p_date_from is null)
								 and acra.pay_from_customer = v_cus.customer_id
							 group by acra.cash_receipt_id
							union all
							select nvl(round(sum(decode(acra.currency_code
																				 ,'CNY'
																				 ,-acrh.amount
																				 ,-acrh.amount * acra.exchange_rate))
															,2)
												,0) app_amount_rmb
								from ar_cash_receipts_all        acra
										,ar_cash_receipt_history_all acrh
							 where acrh.cash_receipt_id = acra.cash_receipt_id
								 and acra.type = 'CASH'
								 and acra.org_id = p_org_id
								 and (acrh.gl_date < trunc(to_date(p_date_from
																									,'yyyy/mm/dd hh24:mi:ss')) or p_date_from is null)
								 and acra.pay_from_customer = v_cus.customer_id
								 and acra.status in ('REV'
																		,'STOP'
																		,'CC_CHARGEBACK_REV')
								 and acrh.status = 'REVERSED'
							 group by acra.cash_receipt_id);
		
			--期初汇兑损益
			select nvl(round(sum(decode(acra.currency_code
																 ,'CNY'
																 ,0
																 ,-araa.acctd_amount_applied_from + araa.acctd_amount_applied_to))
											,2)
								,0) exch_loss
				into v_qc_exch_loss
				from ar_receivable_applications_all araa
						,ar_cash_receipts_all           acra
			 where nvl(araa.status(+)
								,'APP') = 'APP'
				 and araa.application_type(+) = 'CASH'
				 and araa.cash_receipt_id = acra.cash_receipt_id(+)
				 and (araa.gl_date(+) < trunc(nvl(to_date(p_date_from
																								 ,'yyyy/mm/dd hh24:mi:ss')
																				 ,araa.gl_date(+))))
				 and nvl(acra.org_id
								,'89') = p_org_id
				 and acra.pay_from_customer = v_cus.customer_id;
		
			v_qc_remain_amount := v_qc_inv_amount - v_qc_rec_amount - v_qc_exch_loss;
		
			--计算期间汇兑损益
			select nvl(round(sum(decode(acra.currency_code
																 ,'CNY'
																 ,0
																 ,-araa.acctd_amount_applied_from + araa.acctd_amount_applied_to))
											,2)
								,0) exch_loss
				into v_qj_exch_loss
				from ar_receivable_applications_all araa
						,ar_cash_receipts_all           acra
			 where nvl(araa.status(+)
								,'APP') = 'APP'
				 and araa.application_type(+) = 'CASH'
				 and araa.cash_receipt_id = acra.cash_receipt_id(+)
				 and (araa.gl_date(+) >= trunc(nvl(to_date(p_date_from
																									,'yyyy/mm/dd hh24:mi:ss')
																					,araa.gl_date(+))))
				 and (araa.gl_date(+) <= trunc(nvl(to_date(p_date_to
																									,'yyyy/mm/dd hh24:mi:ss')
																					,araa.gl_date(+))))
				 and nvl(acra.org_id
								,'89') = p_org_id
				 and acra.pay_from_customer = v_cus.customer_id;
		
			html_report_pkg.line_title(p_title_string    => '期初金额***bgcolor="#00FFFF"' || v_sep || v_cus.customer_class_code ||
																											v_sep || v_cus.customer_number || v_sep || v_cus.customer_name ||
																											v_sep || '' || v_sep || '' || v_sep || '' || v_sep || '' || v_sep || '' ||
																											v_sep || '' || v_sep || '' || v_sep || '' || v_sep || '' || v_sep || '' ||
																											v_sep || '' || v_sep || '' || v_sep || v_qc_remain_amount ||
																											v_sep || '' || v_sep || '' || v_sep || v_qj_exch_loss || v_sep
																,p_with_other_attr => 'Y'
																,p_attr_delimiter  => '***'
																,p_delimiter       => v_sep);
			------------------------------------------------------------------------------------------------
		
			--期间循环
			for v_qj in c_qj(v_cus.customer_id)
			loop
				html_report_pkg.line_title(p_title_string    => v_qj.record_type || v_sep || v_cus.customer_class_code || v_sep ||
																												v_cus.customer_number || v_sep || v_cus.customer_name || v_sep ||
																												'&nbsp;' || v_qj.trx_number || v_sep || '&nbsp;' ||
																												v_qj.zz_trx_num || v_sep || v_qj.doc_sequence_value || v_sep ||
																												v_qj.hetong_num || v_sep || v_qj.comments || v_sep ||
																												v_qj.trx_date || v_sep || v_qj.inv_gl_date || v_sep ||
																												v_qj.inv_type || v_sep || v_qj.hetong_type || v_sep ||
																												v_qj.curr_code || v_sep || v_qj.price_amount || v_sep ||
																												v_qj.tax_amount || v_sep || v_qj.sum_amount || v_sep ||
																												v_qj.exchange_rate || v_sep || v_qj.sum_amount_rmb || v_sep || '' ||
																												v_sep
																	,p_with_other_attr => 'Y'
																	,p_attr_delimiter  => '***'
																	,p_delimiter       => v_sep);
			
			end loop;
		
			--计算期末余额
			--期末发票
			select nvl(round(sum(rctla.extended_amount * nvl(rcta.exchange_rate
																											,1))
											,2)
								,0) sum_amount
				into v_qm_inv_amount
				from ra_customer_trx_all          rcta
						,ra_customer_trx_lines_all    rctla
						,ra_cust_trx_line_gl_dist_all gd
						,ra_cust_trx_types_all        rctt
			 where rcta.customer_trx_id = rctla.customer_trx_id
				 and nvl(nvl(rcta.sold_to_customer_id
										,rcta.ship_to_customer_id)
								,rcta.bill_to_customer_id) = v_cus.customer_id
				 and rcta.org_id = p_org_id
				 and rcta.complete_flag = 'Y'
				 and rcta.cust_trx_type_id = rctt.cust_trx_type_id
				 and rcta.customer_trx_id = gd.customer_trx_id
				 and gd.account_class = 'REC'
				 and gd.latest_rec_flag = 'Y'
				 and rctt.post_to_gl <> 'N'
				 and rctt.accounting_affect_flag <> 'N'
				 and (gd.gl_date <= trunc(to_date(p_date_to
																				 ,'yyyy/mm/dd hh24:mi:ss')) or p_date_to is null);
		
			--期末收款
			select nvl(sum(app_amount_rmb)
								,0)
				into v_qm_rec_amount
				from (select nvl(round(sum(decode(acra.currency_code
																				 ,'CNY'
																				 ,acrh.amount
																				 ,acrh.amount * acra.exchange_rate))
															,2)
												,0) app_amount_rmb
								from ar_cash_receipts_all        acra
										,ar_cash_receipt_history_all acrh
							 where acrh.cash_receipt_id = acra.cash_receipt_id
								 and acra.type = 'CASH'
								 and acra.status <> 'NSF' --add 2009/07/06
								 and acrh.cash_receipt_history_id =
										 (select max(acrh1.cash_receipt_history_id)
												from ar_cash_receipt_history_all acrh1
											 where acrh1.org_id = acra.org_id
												 and acrh1.cash_receipt_id = acra.cash_receipt_id
												 and acrh1.status <> 'REVERSED'
												 and (acrh1.gl_date <= trunc(to_date(p_date_to
																														,'yyyy/mm/dd hh24:mi:ss')) or p_date_to is null))
								 and acra.org_id = p_org_id
								 and (acrh.gl_date <= trunc(to_date(p_date_to
																									 ,'yyyy/mm/dd hh24:mi:ss')) or p_date_to is null)
								 and acra.pay_from_customer = v_cus.customer_id
							 group by acra.cash_receipt_id
							union all
							select nvl(round(sum(decode(acra.currency_code
																				 ,'CNY'
																				 ,-acrh.amount
																				 ,-acrh.amount * acra.exchange_rate))
															,2)
												,0) app_amount_rmb
								from ar_cash_receipts_all        acra
										,ar_cash_receipt_history_all acrh
							 where acrh.cash_receipt_id = acra.cash_receipt_id
								 and acra.type = 'CASH'
								 and acra.org_id = p_org_id
								 and (acrh.gl_date <= trunc(to_date(p_date_to
																									 ,'yyyy/mm/dd hh24:mi:ss')) or p_date_to is null)
								 and acra.pay_from_customer = v_cus.customer_id
								 and acra.status in ('REV'
																		,'STOP'
																		,'CC_CHARGEBACK_REV')
								 and acrh.status = 'REVERSED'
							 group by acra.cash_receipt_id);
		
			--期末汇兑损益
			select nvl(round(sum(decode(acra.currency_code
																 ,'CNY'
																 ,0
																 ,-araa.acctd_amount_applied_from + araa.acctd_amount_applied_to))
											,2)
								,0) exch_loss
				into v_qm_exch_loss
				from ar_receivable_applications_all araa
						,ar_cash_receipts_all           acra
			 where nvl(araa.status(+)
								,'APP') = 'APP'
				 and araa.application_type(+) = 'CASH'
				 and araa.cash_receipt_id = acra.cash_receipt_id(+)
				 and (araa.gl_date(+) <= trunc(nvl(to_date(p_date_to
																									,'yyyy/mm/dd hh24:mi:ss')
																					,araa.gl_date(+))))
				 and nvl(acra.org_id
								,'89') = p_org_id
				 and acra.pay_from_customer = v_cus.customer_id;
		
			v_qm_remain_amount := v_qm_inv_amount - v_qm_rec_amount - v_qm_exch_loss;
		
			html_report_pkg.line_title(p_title_string    => '期末余额***bgcolor="#00FFFF"' || v_sep || v_cus.customer_class_code ||
																											v_sep || v_cus.customer_number || v_sep || v_cus.customer_name ||
																											v_sep || '' || v_sep || '' || v_sep || '' || v_sep || '' || v_sep || '' ||
																											v_sep || '' || v_sep || '' || v_sep || '' || v_sep || '' || v_sep || '' ||
																											v_sep || '' || v_sep || '' || v_sep || v_qm_remain_amount ||
																											v_sep || '' || v_sep || '' || v_sep || v_qj_exch_loss || v_sep
																,p_with_other_attr => 'Y'
																,p_attr_delimiter  => '***'
																,p_delimiter       => v_sep);
			--------------------------------------------------------------------------------------------------                
		
		end loop;
	
		html_report_pkg.output_line('</tr></table></html>');
	
	end jd_ar011;

	--应收承兑计息报表
	procedure ar_accrual(p1                  out varchar2
											,p2                  out varchar2
											,p_date_b            in varchar2
											,p_date_e            in varchar2
											,p_customer_number_b in varchar2
											,p_customer_number_e in varchar2
											,p_rate              in number
											,p_pay_method        in varchar2
											,p_org_id            in number) is
		cursor c_ar is
			select party.party_name customer_name
						, --by xs 2011-03-02
						 v.attribute1     order_type
						,v.attribute3     doc_type
						,v.comments
						,v.maturity_date
						,v.gl_date
						,v.amount
						 --,(v.gl_date - v.maturity_date ) days
						,(v.maturity_date - v.gl_date) days
						 
						 /*   ,round(v.amount * p_rate / 30 *
              (v.gl_date - v.maturity_date ) / 10000
             ,6) discount_amt*/
						,round(v.amount * p_rate / 30 * (v.maturity_date - v.gl_date) / 10000
									,6) discount_amt
						,v.state_dsp
						,v.payment_method_dsp
				from ar_cash_receipts_v v
						,hz_cust_accounts   cust
						,hz_parties         party
			 where 1 = 1
				 and v.customer_number = cust.account_number
				 and cust.party_id = party.party_id
				 and v.gl_date between to_date(substr(p_date_b
																						 ,1
																						 ,10)
																			,'yyyy/mm/dd') and
						 to_date(substr(p_date_e
													 ,1
													 ,10)
										,'yyyy/mm/dd')
				 and v.state <> 'REVERSED'
				 and v.customer_number >= nvl(p_customer_number_b
																		 ,v.customer_number)
				 and v.customer_number <= nvl(p_customer_number_e
																		 ,v.customer_number)
				 and v.payment_method_dsp = nvl(p_pay_method
																			 ,v.payment_method_dsp)
				 and v.org_id = p_org_id; --by xs 2011-03-02
	
		v_line_str varchar2(4000);
		v_sep      varchar2(10);
	begin
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '@@@';
		html_report_pkg.html_title(p_program_title => '应收承兑计息表'
															,p_report_title  => '应收承兑计息表');
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		html_report_pkg.output_line('<BR>总帐日期，自：' || substr(p_date_b
																											 ,1
																											 ,10) || '至：' ||
																substr(p_date_e
																			,1
																			,10));
		html_report_pkg.output_line('<BR>客户编号，自：' || p_customer_number_b || '，至：' || p_customer_number_e);
		html_report_pkg.output_line('<BR>贴息率：' || p_rate);
		-- html_report_pkg.output_line('付款方法：'||p_pay_method);
		html_report_pkg.output_line('<table width=100% style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '客户名称,订单类型,委托书类型,票据号,票据到期日,收款日,收款额,贴现天数,应计应收贴息,单据状态,付款方式,';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		for c1 in c_ar
		loop
			html_report_pkg.line_title(p_title_string    => c1.customer_name || v_sep || c1.order_type || v_sep ||
																											c1.doc_type || v_sep || c1.comments || v_sep ||
																											to_char(c1.maturity_date
																														 ,'YYYY/MM/DD') || v_sep ||
																											to_char(c1.gl_date
																														 ,'YYYY/MM/DD') || v_sep || c1.amount || '***align=right' ||
																											v_sep || c1.days || '***align=right' || v_sep || c1.discount_amt ||
																											'***align=right' || v_sep || c1.state_dsp || v_sep ||
																											c1.payment_method_dsp || v_sep
																,p_with_other_attr => 'Y'
																,p_attr_delimiter  => '***'
																,p_delimiter       => v_sep);
		end loop;
	
		html_report_pkg.output_line('</tr></table></html>');
	end ar_accrual;

	--销售合同执行情况表
	procedure jd_ar005(p1                   in varchar2
										,p2                   in varchar2
										,p_org_id             in number
										,p_customer_num_from  in varchar2
										,p_customer_num_to    in varchar2
										,p_order_date_from    in varchar2
										,p_order_date_to      in varchar2
										,p_pickslip_date_from in varchar2
										,p_pickslip_date_to   in varchar2
										,p_order_num_from     in varchar2
										,p_order_num_to       in varchar2
										,p_order_status       in varchar2
										,p_order_type_id      in number
										,p_type               in varchar2
										,p_userid             in number
										,p_fcsp_schedule      in varchar2
										,p_yn_flag            varchar2 default 'N' --ADDED BY WHJ IN 20050709 清除发出商品余额
										,p_booked_date_from   in varchar2 default null --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户
										,p_booked_date_to     in varchar2 default null --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户
										,p_invoice_date_from  in varchar2 default null
										,p_invoice_date_to    in varchar2 default null
										,p_pick_date_from     in varchar2 default null
										,p_pick_date_to       in varchar2 default null) is
		cursor c1(c_set_of_books_id number) is
			select distinct oeh.order_number
										 ,oeh.open_flag
										 ,oeh.cancelled_flag
										 ,oeh.header_id
										 ,trl.line_id move_order_line_id
										 ,oel.line_number || '.' || oel.shipment_number line_number
										 ,oel.line_id
										 ,ottl.name order_type_name
										 ,to_char(oeh.ordered_date
														 ,'yyyy-mm-dd') ordered_date
										 ,rc.customer_number
										 ,rc.customer_name
										 ,rc.attribute1 customer_type_1
										 ,jrs.salesrep_number
										 ,jrs.name salesrep_name
										 ,sib.inventory_item_id
										 ,sib.segment1 item_number
										 ,sib.description item_description
										 ,oel.ordered_quantity
										 ,oel.order_quantity_uom
										 ,oel.unit_selling_price
										 ,round(oel.unit_selling_price / (1 + avt.tax_rate / 100)) order_price_no_tax
										 ,oeh.transactional_curr_code
										 ,nvl(oel.ordered_quantity
												 ,0) * nvl(oel.unit_selling_price
																	,0) * nvl(oeh.conversion_rate
																					 ,1) acctd_amount_ordered
										 ,nvl(oel.attribute1
												 ,oel.attribute12) po_num
										 ,oel.attribute4
										 ,oel.attribute5
										 ,oel.attribute9
										 ,oel.attribute2 unit_price_tl
										 ,oel.attribute3 unit_price_gc
										 ,trh.request_number pick_slip_number
										 ,to_char(wpb.creation_date
														 ,'yyyy-mm-dd') pick_slip_date
											-------0520 为了显示退货订单的相关信息 start lm
											-------,/*sum(*/nvl(trl.quantity,0)/*)*/ quantity_pick          
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,r_qty_t.r_qty
														,nvl(trl.quantity
																,0)) quantity_pick
											-------0520 为了显示退货订单的相关信息 end lm
											
										 , /*sum(*/nvl(mmt.primary_quantity
												 ,0) * nvl(oel.unit_selling_price
																	,0) /*)*/ amount_pick_slip
											--,DECODE(SUBSTR(oeh.order_number,1,1),9,d_qty_t.d_qty,NVL(mmt.primary_quantity,0)) * NVL(oel.unit_selling_price,0) amount_pick_slip
										 ,rtt.name     term_name
										 ,rtl.due_days
											--update by zhangzhen@chinasie.com,2005.3.2,改为：按照挑库确认的日期来计算帐龄
										 ,to_char(nvl(to_date(mmt.attribute1
																				 ,'yyyy/mm/dd hh24:mi:ss')
																 ,mmt.transaction_date) + cg_planning_schedule_lns_pkg.get_term(rtt.term_id)
														 ,'yyyy-mm-dd') pick_slip_due_date
											-------0520 为了显示退货订单的相关信息 start lm
											--
											--update by zhangzhen@chinasie.com,2005.3.15,改为：如果发运行状态为S则表示未进行挑库确认，所以没有挑库确认数量
											--,sum(decode(wdd.move_order_line_id,null,0,decode(wdd.Released_Status,'S',0,wdd.requested_quantity))) txn_quantity
											-------,mmt.primary_quantity txn_quantity
											--          
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,d_qty_t.d_qty
														,nvl(mmt.primary_quantity
																,0)) txn_quantity
											-------0520 为了显示退货订单的相关信息 end lm
										 ,trl.uom_code txn_uom_code
										 ,to_char(nvl(to_date(mmt.attribute1
																				 ,'yyyy/mm/dd hh24:mi:ss')
																 ,mmt.transaction_date)
														 ,'yyyy-mm-dd') txn_transaction_date
											--
										 ,wnd.name delivery_name
											--update by zhangzhen@chinasie.com,2005.3.18,修改了发运日期的取数方法，改为从库存事务处理表中获取。
										 ,cg_get_fayun_riqi(oel.ship_from_org_id
																			 ,oel.inventory_item_id
																			 ,wnd.name
																			 ,oel.line_id) delivery_date
											-- ,to_char(wnd.initial_pickup_date,'yyyy-mm-dd') delivery_date
											
											-------0520 为了显示退货订单的相关信息 start lm
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,rcta.trx_number
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,rcta.trx_number
																					,null))) trx_number
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,rcta.attribute3
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,rctl.attribute2
																					,null))) vat_trx_number
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,to_char(dist.gl_date
																		,'yyyy-mm-dd')
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,to_char(decode(nvl(rcta.complete_flag
																											,'N')
																									,'Y'
																									,dist.gl_date
																									,null)
																					 ,'yyyy-mm-dd'))) trx_gl_date
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,rctl.quantity_invoiced
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,rctl.quantity_invoiced
																					,null))) quantity_invoiced
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,nvl(rctl.gross_unit_selling_price
																,rctl.unit_selling_price)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,nvl(rctl.gross_unit_selling_price
																							,rctl.unit_selling_price)
																					,null))) invoice_price
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,nvl(rctl.unit_selling_price
																,0)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,nvl(rctl.unit_selling_price
																							,0)
																					,null))) invoice_price_no_tax
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,rcta.invoice_currency_code
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,rcta.invoice_currency_code
																					,null))) invoice_currency_code
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_rev.amount) + abs(dist_tax.amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_rev.amount
																					,null) + decode(nvl(rcta.complete_flag
																														 ,'N')
																												 ,'Y'
																												 ,dist_tax.amount
																												 ,null))) amount_invoice
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_rev.acctd_amount) + abs(dist_tax.acctd_amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_rev.acctd_amount
																					,null) + decode(nvl(rcta.complete_flag
																														 ,'N')
																												 ,'Y'
																												 ,dist_tax.acctd_amount
																												 ,null))) acctd_amount_invoice
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_rev.amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_rev.amount
																					,null))) amount_revenue
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_rev.acctd_amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_rev.acctd_amount
																					,null))) acctd_amount_revenue
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_tax.amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_tax.amount
																					,null))) amount_tax
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_tax.acctd_amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_tax.acctd_amount
																					,null))) acctd_amount_tax
											
											--
											--ar,根据发票完成标志来判断是否显示
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',rcta.trx_number,null)) trx_number
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',rctl.attribute2,null)) vat_trx_number
											-------,decode(wnd.name,null,null,to_char(decode(nvl(rcta.complete_flag,'N'),'Y',dist.gl_date,null),'yyyy-mm-dd')) trx_gl_date
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',rctl.quantity_invoiced,null)) quantity_invoiced
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',nvl(rctl.gross_unit_selling_price,rctl.unit_selling_price),null)) invoice_price
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',nvl(rctl.unit_selling_price,0),null)) invoice_price_no_tax
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',rcta.invoice_currency_code,null)) invoice_currency_code
											--,decode(nvl(rcta.complete_flag,'N'),'Y',dist.amount,null) amount_invoice
											--,decode(nvl(rcta.complete_flag,'N'),'Y',dist.acctd_amount,null) acctd_amount_invoice
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_rev.amount,null)+decode(nvl(rcta.complete_flag,'N'),'Y',dist_tax.amount,null)) amount_invoice
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_rev.acctd_amount,null)+decode(nvl(rcta.complete_flag,'N'),'Y',dist_tax.acctd_amount,null)) acctd_amount_invoice
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_rev.amount,null)) amount_revenue
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_rev.acctd_amount,null)) acctd_amount_revenue
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_tax.amount,null)) amount_tax
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_tax.acctd_amount,null)) acctd_amount_tax
											-------0520 为了显示退货订单的相关信息 end lm
											
										 ,oeh.cust_po_number
										 ,to_char(oeh.booked_date
														 ,'yyyy-mm-dd') booked_date -- add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户,再inv中追加
											--0518 lm 追加退货订单的接收和入库数量
										 ,r_qty_t.r_qty ruku
										 ,d_qty_t.d_qty jieshou
											--0518 lm 追加退货订单的接收和入库数量
										 ,decode(oeh.flow_status_code
														,'BOOKED'
														,'已登记'
														,'CANCELLED'
														,'已取消'
														,'CLOSED'
														,'已关闭'
														,'ENTERED'
														,'已输入') flow_status_code
											--20080408 追加订单状态
										 ,wpb.attribute1 picking_location
										 ,rsa.name
				from oe_order_headers_all oeh
						,oe_order_lines_all oel
						,ar_vat_tax_all_b avt
						,mtl_txn_request_headers trh
						,mtl_txn_request_lines trl
						,(select mt.move_order_line_id
										,max(trunc(mt.transaction_date)) transaction_date
										,max(mt.attribute1) attribute1
										,sum(mt.primary_quantity) primary_quantity
								from mtl_material_transactions mt
							 where mt.transaction_quantity > 0
								 and mt.transaction_action_id(+) = 28
								 and mt.transaction_type_id(+) = 52
								 and mt.transaction_source_type_id(+) = 2
							 group by mt.move_order_line_id /*,trunc(mt.transaction_date),mt.attribute1*/
							) mmt
						,wsh_picking_batches wpb
						,wsh_delivery_details wdd
						,wsh_delivery_assignments wda
						,wsh_new_deliveries wnd
						,ar_customers rc
						,jtf_rs_salesreps jrs
						,ra_salesreps_all rsa
						,mtl_system_items_b sib
						,oe_transaction_types_tl ottl
						,ra_terms_tl rtt
						 --add by zhangzhen@chinasie.com,2005.3.29
						,ra_terms_lines rtl
						 --
						,ra_customer_trx_lines_all    rctl
						,ra_customer_trx_lines_all    rctl_tax
						,ra_customer_trx_all          rcta
						,ra_cust_trx_line_gl_dist_all dist
						,ra_cust_trx_line_gl_dist_all dist_rev
						,ra_cust_trx_line_gl_dist_all dist_tax
						 --0518 lm 追加退货订单的接收和入库数量
						,(select rt.oe_order_header_id
										,rt.oe_order_line_id
										,sum(decode(rt.transaction_type
															 ,'RECEIVE'
															 ,1
															 ,'RETURN TO CUSTOMER'
															 ,-1) * rt.primary_quantity) r_qty
								from po.rcv_transactions rt
							 where rt.oe_order_header_id is not null
								 and rt.transaction_type in ('RETURN TO CUSTOMER'
																						,'RECEIVE')
							 group by rt.oe_order_header_id
											 ,rt.oe_order_line_id) r_qty_t
						,(select rt.oe_order_header_id
										,rt.oe_order_line_id
										,sum(decode(rt.transaction_type
															 ,'DELIVER'
															 ,1
															 ,'RETURN TO RECEIVING'
															 ,-1) * rt.primary_quantity) d_qty
								from po.rcv_transactions rt
							 where rt.oe_order_header_id is not null
								 and rt.transaction_type in ('RETURN TO RECEIVING'
																						,'DELIVER')
							 group by rt.oe_order_header_id
											 ,rt.oe_order_line_id) d_qty_t
			--0518 lm 追加退货订单的接收和入库数量
			 where oeh.header_id = oel.header_id
				 and nvl(oeh.booked_flag
								,'N') = 'Y'
						--update 2005.1.19
						/*and oel.line_id = trl.txn_source_line_id(+)*/
						--0518 lm 追加退货订单的接收和入库数量
				 and oel.header_id = r_qty_t.oe_order_header_id(+)
				 and oel.line_id = r_qty_t.oe_order_line_id(+)
				 and oel.header_id = d_qty_t.oe_order_header_id(+)
				 and oel.line_id = d_qty_t.oe_order_line_id(+)
						--0518 lm 追加退货订单的接收和入库数量
				 and trl.header_id = trh.header_id(+)
				 and trh.request_number = wpb.batch_id(+)
				 and mmt.move_order_line_id(+) = trl.line_id
				 and oeh.sold_to_org_id = rc.customer_id(+)
				 and oeh.salesrep_id = jrs.salesrep_id(+)
				 and oeh.org_id = jrs.org_id(+)
				 and wpb.attribute2 = rsa.salesrep_id(+)
				 and decode(wpb.organization_id
									 ,91
									 ,89
									 ,95
									 ,94
									 ,100
									 ,98) = rsa.org_id(+)
				 and oel.inventory_item_id = sib.inventory_item_id
				 and oel.ship_from_org_id = sib.organization_id
				 and nvl(oeh.attribute3
								,oeh.payment_term_id) = rtt.term_id(+)
				 and rtt.term_id = rtl.term_id(+)
				 and rtl.sequence_num(+) = 1
				 and oel.tax_code = avt.tax_code(+)
				 and avt.tax_type(+) = 'VAT'
						--update by zhangzhen@chinasie.com,2005.8.29
						--and avt.set_of_books_id(+) = 2
				 and avt.set_of_books_id(+) = c_set_of_books_id
						--update end.
				 and rtt.language(+) = 'ZHS' --userenv('LANG')
						--update 2005.1.19
				 and oel.line_id = wdd.source_line_id(+)
				 and wdd.source_code(+) = 'OE'
				 and wdd.move_order_line_id = trl.line_id(+)
						--and trl.line_id = wdd.move_order_line_id(+)
						--and nvl(wdd.cancelled_quantity(+),0) = 0
				 and wdd.delivery_detail_id = wda.delivery_detail_id(+)
				 and wda.delivery_id = wnd.delivery_id(+)
				 and oeh.order_type_id = ottl.transaction_type_id
				 and ottl.language = 'ZHS' --userenv('LANG')
				 and oel.ordered_quantity > 0
						--ar
						--and rctl.interface_line_attribute3(+) = wnd.name
				 and rctl.interface_line_attribute6(+) = oel.line_id
				 and rctl.interface_line_context(+) = 'ORDER ENTRY'
				 and rctl.customer_trx_id = rcta.customer_trx_id(+)
				 and rcta.customer_trx_id = dist.customer_trx_id(+)
				 and dist.account_class(+) = 'REC'
				 and rctl.customer_trx_line_id = dist_rev.customer_trx_line_id(+)
				 and dist_rev.account_class(+) = 'REV'
				 and rctl_tax.link_to_cust_trx_line_id(+) = rctl.customer_trx_line_id
				 and rctl_tax.customer_trx_line_id = dist_tax.customer_trx_line_id(+)
				 and dist_tax.account_class(+) = 'TAX'
						--参数
				 and sib.organization_id = p_org_id
						---- 20050511 update lm start
						----and oeh.order_type_id = nvl(p_order_type_id,oeh.order_type_id) 
				 and (oeh.order_type_id = nvl(p_order_type_id
																		 ,oeh.order_type_id) or
						 (oeh.order_type_id = '1010' and
						 decode(substr(sib.segment1
														,0
														,4)
										 ,'1001'
										 ,'1002'
										 ,'1002'
										 ,'1003'
										 ,'1003'
										 ,'1004'
										 ,'1007'
										 ,'1005'
										 ,'1004') = nvl(p_order_type_id
																		 ,oeh.order_type_id)))
						----20050511 update lm end
						--add 20050705 lck
				 and oeh.order_type_id in (select b.transaction_type_id
																	 --T.NAME
																		 from oe_transaction_types_tl  t
																				 ,oe_transaction_types_all b
																		where b.transaction_type_id = t.transaction_type_id
																			and t.language = userenv('LANG')
																			and b.transaction_type_code = 'ORDER')
						--end add
						-- And oeh.Order_Type_Id In (1002,1003,1004,1005,1010)
				 and rc.customer_number >= nvl(p_customer_num_from
																			,rc.customer_number)
				 and rc.customer_number <= nvl(p_customer_num_to
																			,rc.customer_number)
				 and oeh.order_number >= nvl(p_order_num_from
																		,oeh.order_number)
				 and oeh.order_number <= nvl(p_order_num_to
																		,oeh.order_number)
						---20050526 lm update start :限定查找订单日期而非登记日期
				 and (p_order_date_from is null or trunc(nvl(oeh.ordered_date
																										,to_date('2999/12/31'
																														,'yyyy/mm/dd'))) >=
						 trunc(to_date(p_order_date_from
																												,'yyyy/mm/dd hh24:mi:ss')))
				 and (p_order_date_to is null or trunc(nvl(oeh.ordered_date
																									,to_date('1000/01/01'
																													,'yyyy/mm/dd'))) <=
						 trunc(to_date(p_order_date_to
																											,'yyyy/mm/dd hh24:mi:ss')))
						/*and (p_order_date_from is null
                 or trunc(oeh.BOOKED_DATE) >= trunc(to_date(p_order_date_from,'yyyy/mm/dd hh24:mi:ss')))
            and (p_order_date_to is null
                 or trunc(oeh.BOOKED_DATE) <= trunc(to_date(p_order_date_to,'yyyy/mm/dd hh24:mi:ss'))) */
						---20050526 lm update end :限定查找订单日期而非登记日期
				 and (p_pickslip_date_from is null or trunc(nvl(to_date(mmt.attribute1
																															 ,'yyyy/mm/dd hh24:mi:ss')
																											 ,mmt.transaction_date)) >=
						 trunc(to_date(p_pickslip_date_from
																													 ,'yyyy/mm/dd hh24:mi:ss')))
				 and (p_pickslip_date_to is null or trunc(nvl(to_date(mmt.attribute1
																														 ,'yyyy/mm/dd hh24:mi:ss')
																										 ,mmt.transaction_date)) <=
						 trunc(to_date(p_pickslip_date_to
																												 ,'yyyy/mm/dd hh24:mi:ss')))
						---- 20050517 update lm start
				 and (p_booked_date_from is null or
						 trunc(oeh.booked_date) >= trunc(to_date(p_booked_date_from
																										 ,'yyyy/mm/dd hh24:mi:ss')))
				 and (p_booked_date_to is null or
						 trunc(oeh.booked_date) <= trunc(to_date(p_booked_date_to
																										 ,'yyyy/mm/dd hh24:mi:ss')))
						--
				 and (p_invoice_date_from is null or
						 trunc(dist.gl_date) >= trunc(to_date(p_invoice_date_from
																									,'yyyy/mm/dd hh24:mi:ss')))
				 and (p_invoice_date_to is null or
						 trunc(dist.gl_date) <= trunc(to_date(p_invoice_date_to
																									,'yyyy/mm/dd hh24:mi:ss')))
						--
				 and (p_pick_date_from is null or
						 trunc(wpb.creation_date) >= trunc(to_date(p_pick_date_from
																											 ,'yyyy/mm/dd hh24:mi:ss')))
				 and (p_pick_date_to is null or
						 trunc(wpb.creation_date) <= trunc(to_date(p_pick_date_to
																											 ,'yyyy/mm/dd hh24:mi:ss')))
						
						---- 20050517 update lm end
						-----20050708 add lck start
				 and ((p_type = 'SALESPERSON' and
						 (exists (select 1
													from fnd_user         fu
															,per_all_people_f per
															,jtf_rs_salesreps jrs
												 where fu.user_id = p_userid
													 and per.last_name = jrs.name
													 and fu.employee_id = per.person_id
													 and jrs.salesrep_id = oeh.salesrep_id
													 and jrs.org_id = (select ood.operating_unit
																							 from org_organization_definitions ood
																							where ood.organization_id = p_org_id))
						 -----20050708 add lck end
						 --  销售人编码取值错误---
						 /*      And ((p_type = 'SALESPERSON' 
             And (Exists
             (Select 1
                From fnd_user fu
                    ,Per_All_People_f per
                    ,Jtf_Rs_Salesreps jrs
               Where fu.User_Id = p_userid
                 And fu.Employee_Id = per.Person_Id
                 And per.Employee_Number = jrs.Salesrep_Number
                 And jrs.Salesrep_Id = oeh.Salesrep_Id
              )*/
						 --  销售人编码取值错误---
						 ----20050519 lm start : to display the informations of '制冷' to all the persons in the steel department 
							or (exists (select 1
																		 from fnd_lookup_values_vl lv
																				 ,fnd_user             fnu
																		where (nvl(''
																							,territory_code) = territory_code or territory_code is null)
																			and (lookup_type like 'SELLERS_KT')
																			and view_application_id = 660
																			and security_group_id = 0
																			and lv.start_date_active <= sysdate
																			and sysdate <= nvl(lv.end_date_active
																												,to_date('2999-12-31'
																																,'yyyy-mm-dd'))
																			and lookup_code = fnu.user_name
																			and fnu.user_id = p_userid) and rc.customer_name like '%制冷%'))
						 ----20050519 lm start : to display the informations of '制冷' to all the persons in the steel department 
						 ) or (p_type = 'INV') or (p_type is null))
						--ORDER_STATUS
				 and ((p_order_status = 'CANCELLED' and oeh.cancelled_flag = 'Y') or
						 (p_order_status = 'CLOSED' and oeh.open_flag = 'N' and oeh.cancelled_flag = 'N') or
						 (p_order_status = 'ENTERED' and oeh.flow_status_code = 'ENTERED') or
						 (p_order_status = 'BOOKED' and oeh.booked_flag = 'Y' and oeh.cancelled_flag = 'N' and oeh.open_flag = 'Y') or
						 p_order_status is null)
			 order by ottl.name
							 ,rc.customer_number
							 ,oeh.order_number
							 ,to_number(oel.line_number || '.' || oel.shipment_number)
							 ,trh.request_number
							 ,wnd.name;
		v_line_str        varchar2(4000);
		v_sep             varchar2(5);
		v_aqv             number;
		v_po_price        number;
		v_ml_price        number;
		v_inv_order_price number;
		v_vat_trx_number  varchar2(500);
		--
		v_sum_quantity_order       number;
		v_sum_quantity_pickslip    number;
		v_sum_quantity_txn         number;
		v_sum_quantity_invoiced    number;
		v_sum_acctd_amount_invoice number;
		v_sum_acctd_amount_revenue number;
		v_sum_acctd_amount_tax     number;
		--
		v_order_quantity     varchar2(100) := '';
		v_acctd_amount_order varchar2(100) := '';
		v_pick_quantity      varchar2(100) := '';
		v_txn_quantity       varchar2(100) := '';
		v_amount_pick_slip   varchar2(100) := '';
	
		v_quantity_invoice     varchar2(100) := '';
		v_amount_revenue       varchar2(100) := '';
		v_acctd_amount_revenue varchar2(100) := '';
		v_amount_receive       varchar2(100) := '';
		v_acctd_amount_receive varchar2(100) := '';
		v_amount_tax           varchar2(100) := '';
		v_acctd_amount_tax     varchar2(100) := '';
	
		v_current_order_number     varchar2(100) := '';
		v_current_line_number      varchar2(20) := '';
		v_move_order_line_id       number;
		v_current_pick_slip_number varchar2(20) := '';
		v_current_quantity_pick    number := '';
		v_current_quantity_txn     number := '';
		v_current_txn_date         date;
		--
		v_current_delivery_name    varchar2(100);
		v_current_quantity_invoice varchar2(100);
	
		v_i     number := 0;
		v_j     number := 0;
		v_count number := 0;
		--
		v_order_type_name varchar2(300);
		--
		v_request_id   number;
		v_request_date date;
		v_req          number;
		--
		v_quantity_delivery      varchar2(100) := '';
		v_current_delivery_name2 varchar2(100) := '';
		v_current_line_id2       varchar2(100) := '';
		v_set_of_books_id        number;
	
		--ADD 2008-3-25
		v_vendor_name varchar2(100);
		v_origin_name varchar2(20);
	begin
		g_org_id := p_org_id;
		--add by zhangzhen@chinasie.com,2005.8.29
		select set_of_books_id
			into v_set_of_books_id
			from jd_set_books_org_v v
		 where v.organization_id = fnd_profile.value('ORG_ID');
		--add end.
		select jd_ar005_temp_s.nextval
					,sysdate
			into v_request_id
					,v_request_date
			from dual;
	
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '####';
		html_report_pkg.html_title(p_program_title => '销售合同执行情况表'
															,p_report_title  => '销售合同执行情况表');
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		html_report_pkg.output_line('<BR>订单日期，自：' || substr(p_order_date_from
																											 ,1
																											 ,10) || '，至：' ||
																substr(p_order_date_to
																			,1
																			,10));
		html_report_pkg.output_line('<BR>挑库确认日期，自：' || substr(p_pickslip_date_from
																												 ,1
																												 ,10) || '，至：' ||
																substr(p_pickslip_date_to
																			,1
																			,10));
		--20050517 lm start
		if p_type = null
		then
			html_report_pkg.output_line('<BR>登记日期，自：' || p_booked_date_from || '，至：' || p_booked_date_to);
		end if;
		--20050517 lm end 
		html_report_pkg.output_line('<BR>客户编号，自：' || p_customer_num_from || '，至：' || p_customer_num_to);
		html_report_pkg.output_line('<BR>订单编号，自：' || p_order_num_from || '，至：' || p_order_num_to);
	
		if p_order_type_id is not null
		then
			begin
				select name
					into v_order_type_name
					from oe_transaction_types_tl ottl
				 where ottl.transaction_type_id = p_order_type_id
					 and ottl.language = userenv('LANG');
				html_report_pkg.output_line('<BR>订单类型：' || v_order_type_name);
			exception
				when others then
					v_order_type_name := null;
			end;
		end if;
	
		if p_type = 'INV'
		then
			html_report_pkg.output_line('<table width=2500 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
		else
			html_report_pkg.output_line('<table width=5000 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
		end if;
	
		if p_type = 'SALESPERSON'
		then
			v_line_str := '订单编号,订单行号,订单类型,订单日期,客户编号,客户名称,销售员,物料代码,物料名称,合同数量,单位,销售单价（含税）,销售单价（不含税）,实际价格（铜铝部）,钢厂价格,币种,合同金额（本位币）,采购订单号,挑库批号,发货经办人,收货地点,' --采购单价（不含税）,单位毛利（不含税）,
										||
										'挑库日期,挑库数量,付款条件,挑库确认金额（本位币）,挑库确认数量,单位,挑库确认日期,到期日期,销货单号,销货日期,销货数量,系统发票号码,增值税发票号码,发票日期,发票价格,发票与订单的价差,开票数量,销售收入（原币）,销售收入（本位币）,增值税（原币）,增值税（本位币）,发票金额（原币）,发票金额（本位币）,客户PO,登记日期,订单状态,';
		elsif p_type = 'INV'
		then
			v_line_str := '订单编号,订单行号,订单类型,订单日期,客户编号,客户名称,销售员,物料代码,物料名称,合同数量,单位,挑库批号,发货经办人,收货地点,' ||
										'挑库日期,挑库数量,挑库确认数量,挑库确认日期,到期日期,销货单号,销货日期,销货数量,发票日期,开票数量,发票金额（本位币）,登记日期,订单状态,';
		else
			v_line_str := '订单编号,订单行号,订单类型,订单日期,客户编号,客户名称,销售员,物料代码,物料名称,合同数量,单位,销售单价（含税）,销售单价（不含税）,实际价格（铜铝部）,钢厂价格,币种,合同金额（本位币）,采购订单号,供应商名称,原产地,采购单价（不含税）,单位毛利（不含税）,挑库批号,发货经办人,收货地点,' ||
										'挑库日期,挑库数量,付款条件,挑库确认金额（本位币）,挑库确认数量,单位,挑库确认日期,到期日期,销货单号,销货日期,销货数量,系统发票号码,增值税发票号码,发票日期,发票价格,发票与订单的价差,开票数量,销售收入（原币）,销售收入（本位币）,增值税（原币）,增值税（本位币）,发票金额（原币）,发票金额（本位币）,客户PO,登记日期,订单状态,';
		end if;
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		for r1 in c1(v_set_of_books_id)
		loop
			select -sum(mmt.primary_quantity)
				into v_quantity_delivery
				from mtl_material_transactions mmt
			 where mmt.transaction_type_id = 33
				 and mmt.source_line_id = r1.line_id
				 and mmt.shipment_number = r1.delivery_name;
			if nvl(v_quantity_delivery
						,0) > nvl(r1.ordered_quantity
										 ,0)
			then
				v_quantity_delivery := r1.ordered_quantity;
			end if;
		
			if (r1.delivery_name = v_current_delivery_name2 and r1.line_id = v_current_line_id2)
			then
				v_quantity_delivery := '同上';
			else
				v_quantity_delivery := v_quantity_delivery;
			end if;
			v_current_delivery_name2 := r1.delivery_name;
			v_current_line_id2       := r1.line_id;
			--   --Modified by whj in 20050720
			/*Select Sum(trl.primary_quantity) 
            --,Sum(trl.primary_quantity*oel.unit_selling_price)
       Into r1.quantity_pick
           --,r1.amount_pick_slip
       From wsh_delivery_details wdd
           ,mtl_txn_request_lines trl
           ,mtl_txn_request_headers trh
           ,oe_order_lines_all oel
      Where wdd.move_order_line_id = trl.line_id
        And trl.header_id = trh.header_id
        And wdd.source_code = 'OE'
        And wdd.source_line_id = oel.line_id
        And wdd.source_line_id = r1.line_id
        And trh.request_number = r1.pick_slip_number;*/
			--add by zhangzhen@chinasie.com,2005.3.14,增加判断，如果挑库数量大于订单行数量，那么挑库数量取挑库确认数量。
		
			--Added by whj in 20050720
			select sum(wdv.requested_quantity) requested_quantity
						,sum(decode(wdv.released_status
											 ,'S'
											 ,0
											 ,wdv.picked_quantity)) picked_quantity
						,round(sum(decode(wdv.released_status
														 ,'S'
														 ,0
														 ,wdv.picked_quantity)) * r1.unit_selling_price
									,2) amount_pick_slip
				into r1.quantity_pick
						,r1.txn_quantity
						,r1.amount_pick_slip
				from wsh_deliverables_v wdv
			 where wdv.source_header_id = r1.header_id
				 and wdv.source_line_id = r1.line_id
				 and wdv.move_order_line_id = r1.move_order_line_id
				 and wdv.source_code = 'OE'
				 and wdv.released_status in ('C'
																		,'Y'
																		,'S'); -- 发运 C;分批发运/确认挑库 Y;已发放至仓库 S
			/*Select Sum(trl.primary_quantity) --Modified by whj in 20050720
            --,Sum(trl.primary_quantity*oel.unit_selling_price)
       Into r1.quantity_pick
           --,r1.amount_pick_slip
       From mtl_txn_request_lines trl
           ,mtl_txn_request_headers trh
      Where trl.line_id=r1.move_order_line_id 
        And trl.header_id = trh.header_id
        And trh.request_number = r1.pick_slip_number;*/
			--add by whj in 20050720
			if r1.quantity_pick > r1.ordered_quantity
			then
				r1.quantity_pick := r1.ordered_quantity;
			end if;
			--   
			/*select sum(mt.Primary_Quantity) Primary_Quantity
       into r1.txn_quantity
       from mtl_material_transactions mt
      where mt.transaction_quantity > 0
        and mt.transaction_action_id(+) = 28
        and mt.transaction_type_id(+) = 52
        and mt.transaction_source_type_id(+) = 2
        and mt.move_order_line_id=r1.move_order_line_id
        and mt.trx_source_line_id=r1.line_id
      Group By mt.trx_source_line_id,
               mt.move_order_line_id;*/
		
			--add by whj@chinasie.com,2005.6.20,增加判断，如果挑库确认数量大于订单行数量，那么挑库确认数量取订单数量。
			if r1.txn_quantity > r1.ordered_quantity
			then
				r1.txn_quantity     := r1.ordered_quantity;
				r1.amount_pick_slip := round(r1.txn_quantity * r1.unit_selling_price
																		,2);
			end if;
			--r1.amount_pick_slip := round(r1.txn_quantity*r1.unit_selling_price,2);
			--Modified by whj at 20050620 (对于不同订单行对应相同挑库单号，多条挑库确认记录对应产生多条记录的问题处理)
			--
			if nvl(r1.attribute4
						,'YES') = 'YES'
			then
				begin
					select round(sum(pla.quantity * decode(nvl(pla.list_price_per_unit
																										,0)
																								,0
																								,pla.unit_price
																								,pla.list_price_per_unit)) / sum(pla.quantity)
											,6)
						into v_po_price
						from po_headers_all pha
								,po_lines_all   pla
					 where pha.po_header_id = pla.po_header_id
						 and pha.segment1 = r1.po_num
						 and pla.item_id = r1.inventory_item_id;
				
					--add 2008-3-25  
					select pov.vendor_name
						into v_vendor_name
						from po_headers_all               poh
								,po_vendors                   pov
								,org_organization_definitions ood
					 where poh.vendor_id = pov.vendor_id
						 and poh.org_id = ood.operating_unit
						 and ood.organization_id = p_org_id
						 and poh.segment1 = r1.po_num;
				
				exception
					when others then
						v_po_price    := 0;
						v_vendor_name := null;
				end;
			
				begin
					select ft.territory_short_name
						into v_origin_name
						from po_headers_all        poh
								,po_line_locations_all plla
								,fnd_territories_vl    ft
					 where poh.po_header_id = plla.po_header_id
						 and plla.country_of_origin_code = ft.territory_code
						 and poh.segment1 = r1.po_num
						 and rownum = 1;
				exception
					when others then
						v_origin_name := null;
				end;
			
			else
				v_po_price    := r1.attribute5;
				v_vendor_name := null;
				v_origin_name := null;
			end if;
		
			if nvl(r1.quantity_pick
						,0) = 0
			then
				v_ml_price := to_number(null);
			else
				if (nvl(r1.attribute4
							 ,'YES') = 'YES' and r1.po_num is null) or
					 (nvl(r1.attribute4
							 ,'YES') = 'NO' and r1.attribute5 is null)
				then
					v_ml_price := to_number(null);
				else
					v_ml_price := nvl(r1.invoice_price_no_tax
													 ,r1.order_price_no_tax) - nvl(v_po_price
																												,0);
				end if;
			end if;
		
			--发票与订单价差是含税的
			if nvl(r1.invoice_price
						,0) = 0
			then
				v_inv_order_price := null;
			else
				v_inv_order_price := nvl(r1.invoice_price
																,0) - nvl(r1.unit_selling_price
																				 ,0);
			end if;
		
			if r1.vat_trx_number = '0.00'
			then
				v_vat_trx_number := null;
			else
				v_vat_trx_number := r1.vat_trx_number;
			end if;
		
			--add 2005.2.22 for duplicate record
			if (r1.order_number = v_current_order_number and r1.line_number = v_current_line_number)
			then
				v_order_quantity       := '同上';
				v_current_order_number := '';
				v_current_line_number  := '';
				if (r1.pick_slip_number = v_current_pick_slip_number and r1.quantity_pick = v_current_quantity_pick and
					 r1.move_order_line_id = v_move_order_line_id)
				then
					v_pick_quantity    := '同上';
					v_txn_quantity     := '同上'; --Added by whj@chinasie.com,2005.6.20,
					v_amount_pick_slip := '同上'; --Added by whj@chinasie.com,2005.6.20,
				
					v_current_pick_slip_number := '';
					v_current_quantity_pick    := to_number(null);
					--Modified by whj@chinasie.com,2005.6.20,
					/*If (r1.txn_quantity = v_current_quantity_txn And r1.txn_transaction_date = v_current_txn_date ) Then
            v_txn_quantity := '同上';
            v_current_quantity_txn := to_number(Null);
            v_current_txn_date := to_date(Null);
          Else
            v_txn_quantity := r1.txn_quantity;
          End If;*/
					--Modified by whj@chinasie.com,2005.6.20,
				
				else
					v_pick_quantity := r1.quantity_pick;
				
					if nvl(p_yn_flag
								,'N') = 'Y' and
						 r1.open_flag = 'N' and
						 r1.cancelled_flag = 'N'
					then
						v_amount_pick_slip := 0;
						v_txn_quantity     := 0; --Added by whj@chinasie.com,2005.7.8,
					else
						v_txn_quantity     := r1.txn_quantity; --Added by whj@chinasie.com,2005.6.20,
						v_amount_pick_slip := r1.amount_pick_slip; --Added by whj@chinasie.com,2005.6.20,
					end if;
				end if;
				if (r1.delivery_name = v_current_delivery_name and r1.quantity_invoiced = v_current_quantity_invoice)
				then
					v_quantity_invoice     := '同上';
					v_amount_revenue       := '同上';
					v_acctd_amount_revenue := '同上';
					v_amount_receive       := '同上';
					v_acctd_amount_receive := '同上';
					v_amount_tax           := '同上';
					v_acctd_amount_tax     := '同上';
				
					v_current_delivery_name    := '';
					v_current_quantity_invoice := '';
				else
					v_quantity_invoice     := r1.quantity_invoiced;
					v_amount_revenue       := r1.amount_revenue;
					v_acctd_amount_revenue := r1.acctd_amount_revenue;
					v_amount_receive       := r1.amount_invoice;
					v_acctd_amount_receive := r1.acctd_amount_invoice;
					v_amount_tax           := r1.amount_tax;
					v_acctd_amount_tax     := r1.acctd_amount_tax;
				end if;
			else
				v_order_quantity := r1.ordered_quantity;
			
				v_pick_quantity := r1.quantity_pick;
			
				if nvl(p_yn_flag
							,'N') = 'Y' and
					 r1.open_flag = 'N' and
					 r1.cancelled_flag = 'N'
				then
					v_amount_pick_slip := 0;
					v_txn_quantity     := 0;
				else
					v_txn_quantity     := r1.txn_quantity;
					v_amount_pick_slip := r1.amount_pick_slip; --Added by whj@chinasie.com,2005.6.20,
				end if;
			
				v_quantity_invoice     := r1.quantity_invoiced;
				v_amount_revenue       := r1.amount_revenue;
				v_acctd_amount_revenue := r1.acctd_amount_revenue;
				v_amount_receive       := r1.amount_invoice;
				v_acctd_amount_receive := r1.acctd_amount_invoice;
				v_amount_tax           := r1.amount_tax;
				v_acctd_amount_tax     := r1.acctd_amount_tax;
			end if;
			--
			--Added by whj at 20050620
			/*If (r1.pick_slip_number = v_current_pick_slip_number And r1.quantity_pick = v_current_quantity_pick) Then
          v_pick_quantity := '同上';
          --v_current_pick_slip_number  := '';
          v_current_quantity_pick := to_number(Null);
          If (r1.txn_quantity = v_current_quantity_txn And r1.txn_transaction_date = v_current_txn_date ) Then
            v_txn_quantity := '同上';
            v_current_quantity_txn := to_number(Null);
            v_current_txn_date := to_date(Null);
          Else
            v_txn_quantity := r1.txn_quantity;
          End If;
      Else
          v_pick_quantity := r1.quantity_pick;
          v_txn_quantity := r1.txn_quantity;
      End If;*/
			--Added by whj at 20050620
			v_current_order_number := r1.order_number;
			v_current_line_number  := r1.line_number;
		
			v_current_pick_slip_number := r1.pick_slip_number;
			v_current_quantity_pick    := r1.quantity_pick;
			v_move_order_line_id       := r1.move_order_line_id;
		
			v_current_delivery_name    := r1.delivery_name;
			v_current_quantity_invoice := r1.quantity_invoiced;
		
			v_i := v_i + 1;
			if v_order_quantity = '同上'
			then
				v_acctd_amount_order := '同上';
			else
				v_acctd_amount_order := r1.acctd_amount_ordered;
			end if;
		
			----050518 lm  追加退货订单的接收和入库数量
			/*      If r1.order_number Like '9%' Then 
         v_pick_quantity := r1.ruku;
         v_txn_quantity := r1.jieshou;
      End If;*/
			----050518 lm  追加退货订单的接收和入库数量
		
			if p_type = 'SALESPERSON'
			then
				html_report_pkg.line_title(p_title_string => r1.order_number || v_sep || r1.line_number || v_sep ||
																										 r1.order_type_name || v_sep || r1.ordered_date || v_sep ||
																										 r1.customer_number || v_sep || r1.customer_name || v_sep ||
																										 r1.salesrep_name || v_sep || r1.item_number || v_sep ||
																										 r1.item_description || v_sep || v_order_quantity --r1.ordered_quantity
																										 || v_sep || r1.order_quantity_uom || v_sep ||
																										 r1.unit_selling_price || v_sep || r1.order_price_no_tax || v_sep ||
																										 r1.unit_price_tl || v_sep || r1.unit_price_gc || v_sep ||
																										 r1.transactional_curr_code || v_sep || v_acctd_amount_order --r1.acctd_amount_ordered
																										 || v_sep || r1.po_num /*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                


                                                                                                                                                            
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ||v_sep||v_po_price
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                


                                                                                                                                                            
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ||v_sep||v_ml_price*/
																										 || v_sep || r1.pick_slip_number || v_sep || r1.picking_location ||
																										 v_sep || r1.name || v_sep || r1.pick_slip_date || v_sep ||
																										 v_pick_quantity --r1.quantity_pick
																										 || v_sep || r1.term_name || v_sep || v_amount_pick_slip --r1.amount_pick_slip
																										--                                          
																										 || v_sep || v_txn_quantity --r1.txn_quantity
																										 || v_sep || r1.txn_uom_code || v_sep || r1.txn_transaction_date ||
																										 v_sep || r1.pick_slip_due_date
																										--
																										 || v_sep || r1.delivery_name || v_sep || r1.delivery_date || v_sep ||
																										 v_quantity_delivery || v_sep || r1.trx_number || v_sep ||
																										 r1.vat_trx_number || v_sep || r1.trx_gl_date || v_sep ||
																										 r1.invoice_price || v_sep || v_inv_order_price || v_sep ||
																										 v_quantity_invoice --r1.quantity_invoiced
																										 || v_sep || v_amount_revenue --r1.amount_revenue
																										 || v_sep || v_acctd_amount_revenue --r1.acctd_amount_revenue
																										 || v_sep || v_amount_tax --r1.amount_tax
																										 || v_sep || v_acctd_amount_tax --r1.acctd_amount_tax
																										 || v_sep || v_amount_receive --r1.amount_invoice
																										 || v_sep || v_acctd_amount_receive --r1.acctd_amount_invoice
																										 || v_sep || r1.cust_po_number || v_sep || r1.booked_date --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户,再inv中追加
																										 || v_sep || r1.flow_status_code || v_sep
																	,p_delimiter    => v_sep);
			elsif p_type = 'INV'
			then
				html_report_pkg.line_title(p_title_string => r1.order_number || v_sep || r1.line_number || v_sep ||
																										 r1.order_type_name || v_sep || r1.ordered_date || v_sep ||
																										 r1.customer_number || v_sep || r1.customer_name || v_sep ||
																										 r1.salesrep_name || v_sep || r1.item_number || v_sep ||
																										 r1.item_description || v_sep || v_order_quantity --r1.ordered_quantity
																										 || v_sep || r1.order_quantity_uom || v_sep || r1.pick_slip_number ||
																										 v_sep || r1.picking_location || v_sep || r1.name || v_sep ||
																										 r1.pick_slip_date || v_sep || v_pick_quantity --r1.quantity_pick
																										--                                          
																										 || v_sep || v_txn_quantity --r1.txn_quantity
																										 || v_sep || r1.txn_transaction_date || v_sep ||
																										 r1.pick_slip_due_date
																										--
																										 || v_sep || r1.delivery_name || v_sep || r1.delivery_date || v_sep ||
																										 v_quantity_delivery || v_sep || r1.trx_gl_date || v_sep ||
																										 v_quantity_invoice --r1.quantity_invoiced
																										 || v_sep || v_acctd_amount_receive --r1.acctd_amount_invoice
																										 || v_sep || r1.booked_date --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户,再inv中追加
																										 || v_sep || r1.flow_status_code || v_sep
																	,p_delimiter    => v_sep);
			else
				html_report_pkg.line_title(p_title_string => r1.order_number || v_sep || r1.line_number || v_sep ||
																										 r1.order_type_name || v_sep || r1.ordered_date || v_sep ||
																										 r1.customer_number || v_sep || r1.customer_name || v_sep ||
																										 r1.salesrep_name || v_sep || r1.item_number || v_sep ||
																										 r1.item_description || v_sep || v_order_quantity --r1.ordered_quantity
																										 || v_sep || r1.order_quantity_uom || v_sep ||
																										 r1.unit_selling_price || v_sep || r1.order_price_no_tax || v_sep ||
																										 r1.unit_price_tl || v_sep || r1.unit_price_gc || v_sep ||
																										 r1.transactional_curr_code || v_sep || v_acctd_amount_order --r1.acctd_amount_ordered
																										 || v_sep || r1.po_num || v_sep || v_vendor_name || v_sep ||
																										 v_origin_name || v_sep || v_po_price || v_sep || v_ml_price ||
																										 v_sep || r1.pick_slip_number || v_sep || r1.picking_location ||
																										 v_sep || r1.name || v_sep || r1.pick_slip_date || v_sep ||
																										 v_pick_quantity --r1.quantity_pick
																										 || v_sep || r1.term_name || v_sep || v_amount_pick_slip --r1.amount_pick_slip
																										--                                          
																										 || v_sep || v_txn_quantity --r1.txn_quantity
																										 || v_sep || r1.txn_uom_code || v_sep || r1.txn_transaction_date ||
																										 v_sep || r1.pick_slip_due_date
																										--
																										 || v_sep || r1.delivery_name || v_sep || r1.delivery_date || v_sep ||
																										 v_quantity_delivery || v_sep || r1.trx_number || v_sep ||
																										 r1.vat_trx_number || v_sep || r1.trx_gl_date || v_sep ||
																										 r1.invoice_price || v_sep || v_inv_order_price || v_sep ||
																										 v_quantity_invoice --r1.quantity_invoiced
																										 || v_sep || v_amount_revenue --r1.amount_revenue
																										 || v_sep || v_acctd_amount_revenue --r1.acctd_amount_revenue
																										 || v_sep || v_amount_tax --r1.amount_tax
																										 || v_sep || v_acctd_amount_tax --r1.acctd_amount_tax
																										 || v_sep || v_amount_receive --r1.amount_invoice
																										 || v_sep || v_acctd_amount_receive --r1.acctd_amount_invoice
																										 || v_sep || r1.cust_po_number || v_sep || r1.booked_date --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户,再inv中追加
																										 || v_sep || r1.flow_status_code || v_sep
																	,p_delimiter    => v_sep);
			end if;
			--
		
			---update 20050602 lm :退货订单不写入该表
			----If p_fcsp_schedule = 'Y'  Then
			if p_fcsp_schedule = 'Y' and
				 to_char(r1.order_number) not like '9%'
			then
				--ADD BY SSC 'TO_CHAR' 2005/06/12
				---update 20050602 lm :退货订单不写入该表
			
				insert into jd_ar005_temp
					(request_id
					,request_date
					,order_number
					,move_order_line_id
					,line_number
					,line_id
					,order_type_name
					,ordered_date
					,customer_number
					,customer_name
					,salesrep_number
					,salesrep_name
					,inventory_item_id
					,item_number
					,item_description
					,ordered_quantity
					,order_quantity_uom
					,unit_selling_price
					,order_price_no_tax
					,transactional_curr_code
					,acctd_amount_ordered
					,po_num
					,attribute4
					,attribute5
					,unit_price_tl
					,unit_price_gc
					,pick_slip_number
					,pick_slip_date
					,quantity_pick
					,amount_pick_slip
					,term_name
					,pick_slip_due_date
					,txn_quantity
					,txn_uom_code
					,txn_transaction_date
					,delivery_name
					,delivery_date
					,trx_number
					,vat_trx_number
					,trx_gl_date
					,quantity_invoiced
					,invoice_price
					,invoice_price_no_tax
					,invoice_currency_code
					,amount_invoice
					,acctd_amount_invoice
					,amount_revenue
					,acctd_amount_revenue
					,amount_tax
					,acctd_amount_tax
					,cust_po_number
					,due_days
					,quantity_delivery
					,set_book_id
					,attribute9
					,customer_type_1)
				values
					(v_request_id
					,v_request_date
					,r1.order_number
					,r1.move_order_line_id
					,r1.line_number
					,r1.line_id
					,r1.order_type_name
					,r1.ordered_date
					,r1.customer_number
					,r1.customer_name
					,r1.salesrep_number
					,r1.salesrep_name
					,r1.inventory_item_id
					,r1.item_number
					,r1.item_description
					,v_order_quantity --r1.ORDERED_QUANTITY       
					,r1.order_quantity_uom
					,r1.unit_selling_price
					,r1.order_price_no_tax
					,r1.transactional_curr_code
					,v_acctd_amount_order --r1.ACCTD_AMOUNT_ORDERED   
					,r1.po_num
					,v_po_price --r1.ATTRIBUTE4             
					,v_ml_price --r1.ATTRIBUTE5             
					,r1.unit_price_tl
					,r1.unit_price_gc
					,r1.pick_slip_number
					,r1.pick_slip_date
					,v_pick_quantity --r1.QUANTITY_PICK          
					,decode(nvl(p_yn_flag
										 ,'N')
								 ,'Y'
								 ,decode(r1.open_flag
												,'N'
												,decode(r1.cancelled_flag
															 ,'N'
															 ,0
															 ,r1.amount_pick_slip)
												,r1.amount_pick_slip)
								 ,r1.amount_pick_slip) --UPDATED BY WHJ IN 20050708
					 --,r1.AMOUNT_PICK_SLIP
					,r1.term_name
					,r1.pick_slip_due_date
					,v_txn_quantity --r1.TXN_QUANTITY           
					,r1.txn_uom_code
					,r1.txn_transaction_date
					,r1.delivery_name
					,r1.delivery_date
					,r1.trx_number
					,r1.vat_trx_number
					,r1.trx_gl_date
					,v_quantity_invoice --r1.QUANTITY_INVOICED      
					,r1.invoice_price
					,v_inv_order_price --r1.INVOICE_PRICE_NO_TAX   
					,r1.invoice_currency_code
					,v_amount_receive --r1.AMOUNT_INVOICE         
					,v_acctd_amount_receive --r1.ACCTD_AMOUNT_INVOICE   
					,v_amount_revenue --r1.AMOUNT_REVENUE         
					,v_acctd_amount_revenue --r1.ACCTD_AMOUNT_REVENUE   
					,v_amount_tax --r1.AMOUNT_TAX             
					,v_acctd_amount_tax --r1.ACCTD_AMOUNT_TAX       
					,r1.cust_po_number
					,r1.due_days
					,v_quantity_delivery
					,v_set_of_books_id
					,r1.attribute9
					,r1.customer_type_1);
				v_count := v_count + 1;
				if v_count = 500
				then
					v_count := 0;
					commit;
				end if;
			end if;
		end loop;
		commit;
		if p_fcsp_schedule = 'Y'
		then
			--进行数据加工处理
			fcsp_jiagong(v_request_id
									,p_org_id);
			--提交生成发出商品帐龄汇总的报表
			v_req := fnd_request.submit_request(application => 'AR'
																				 ,program     => 'JD_AR010_HTML2'
																				 ,description => 'JD.客户仓商品帐龄分析表(汇总)_排程使用2'
																				 ,sub_request => false
																				 ,argument1   => v_request_id);
			--提交生成发出商品帐龄明细的报表
			v_req := fnd_request.submit_request(application => 'AR'
																				 ,program     => 'JD_AR004_HTML2'
																				 ,description => 'JD.客户仓商品帐龄分析表_排程使用2'
																				 ,sub_request => false
																				 ,argument1   => v_request_id);
		
			--提交生成应收帐款帐龄分析总表
			v_req := fnd_request.submit_request(application => 'AR'
																				 ,program     => 'JD_AR010_008'
																				 ,description => 'JD.应收帐款帐龄分析总表'
																				 ,sub_request => false
																				 ,argument1   => to_char(v_request_date
																																,'yyyy/mm/dd')
																				 ,argument2   => v_set_of_books_id
																				 ,argument3   => p_order_type_id
																				 ,argument4   => p_customer_num_from
																				 ,argument5   => p_customer_num_to);
		end if;
		html_report_pkg.output_line('</tr></table></html>');
	
	end jd_ar005;

	--销售合同执行情况表(供应链管理)
	procedure jd_ar005_gy(p1                   in varchar2
											 ,p2                   in varchar2
											 ,p_org_id             in number
											 ,p_customer_num_from  in varchar2
											 ,p_customer_num_to    in varchar2
											 ,p_order_date_from    in varchar2
											 ,p_order_date_to      in varchar2
											 ,p_pickslip_date_from in varchar2
											 ,p_pickslip_date_to   in varchar2
											 ,p_order_num_from     in varchar2
											 ,p_order_num_to       in varchar2
											 ,p_order_status       in varchar2
											 ,p_order_type_id      in number
											 ,p_type               in varchar2
											 ,p_userid             in number
											 ,p_fcsp_schedule      in varchar2
											 ,p_yn_flag            varchar2 default 'N' --ADDED BY WHJ IN 20050709 清除发出商品余额
											 ,p_booked_date_from   in varchar2 default null --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户
											 ,p_booked_date_to     in varchar2 default null --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户
											 ,p_invoice_date_from  in varchar2 default null
											 ,p_invoice_date_to    in varchar2 default null) is
		cursor c1(c_set_of_books_id number) is
			select distinct oeh.order_number
										 ,oeh.open_flag
										 ,oeh.cancelled_flag
										 ,oeh.header_id
										 ,trl.line_id move_order_line_id
										 ,oel.line_number || '.' || oel.shipment_number line_number
										 ,oel.line_id
										 ,ottl.name order_type_name
										 ,to_char(oeh.ordered_date
														 ,'yyyy-mm-dd') ordered_date
										 ,rc.customer_number
										 ,rc.customer_name
										 ,jrs.salesrep_number
										 ,jrs.name salesrep_name
										 ,sib.inventory_item_id
										 ,sib.segment1 item_number
										 ,sib.description item_description
										 ,oel.ordered_quantity
										 ,oel.order_quantity_uom
										 ,oel.unit_selling_price
										 ,round(oel.unit_selling_price / (1 + avt.tax_rate / 100)) order_price_no_tax
										 ,oeh.transactional_curr_code
										 ,nvl(oel.ordered_quantity
												 ,0) * nvl(oel.unit_selling_price
																	,0) * nvl(oeh.conversion_rate
																					 ,1) acctd_amount_ordered
										 ,oel.attribute1 po_num
										 ,oel.attribute4
										 ,oel.attribute5
										 ,oel.attribute2 unit_price_tl
										 ,oel.attribute3 unit_price_gc
										 ,trh.request_number pick_slip_number
										 ,to_char(wpb.creation_date
														 ,'yyyy-mm-dd') pick_slip_date
											-------0520 为了显示退货订单的相关信息 start lm
											-------,/*sum(*/nvl(trl.quantity,0)/*)*/ quantity_pick          
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,r_qty_t.r_qty
														,nvl(trl.quantity
																,0)) quantity_pick
											-------0520 为了显示退货订单的相关信息 end lm
											
										 , /*sum(*/nvl(mmt.primary_quantity
												 ,0) * nvl(oel.unit_selling_price
																	,0) /*)*/ amount_pick_slip
										 ,rtt.name term_name
										 ,rtl.due_days
											--update by zhangzhen@chinasie.com,2005.3.2,改为：按照挑库确认的日期来计算帐龄
										 ,to_char(nvl(to_date(mmt.attribute1
																				 ,'yyyy/mm/dd hh24:mi:ss')
																 ,mmt.transaction_date) + cg_planning_schedule_lns_pkg.get_term(rtt.term_id)
														 ,'yyyy-mm-dd') pick_slip_due_date
											-------0520 为了显示退货订单的相关信息 start lm
											--
											--update by zhangzhen@chinasie.com,2005.3.15,改为：如果发运行状态为S则表示未进行挑库确认，所以没有挑库确认数量
											--,sum(decode(wdd.move_order_line_id,null,0,decode(wdd.Released_Status,'S',0,wdd.requested_quantity))) txn_quantity
											-------,mmt.primary_quantity txn_quantity
											--          
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,d_qty_t.d_qty
														,nvl(mmt.primary_quantity
																,0)) txn_quantity
											-------0520 为了显示退货订单的相关信息 end lm
										 ,trl.uom_code txn_uom_code
										 ,to_char(nvl(to_date(mmt.attribute1
																				 ,'yyyy/mm/dd hh24:mi:ss')
																 ,mmt.transaction_date)
														 ,'yyyy-mm-dd') txn_transaction_date
											--
										 ,wnd.name delivery_name
											--update by zhangzhen@chinasie.com,2005.3.18,修改了发运日期的取数方法，改为从库存事务处理表中获取。
										 ,cg_get_fayun_riqi(oel.ship_from_org_id
																			 ,oel.inventory_item_id
																			 ,wnd.name
																			 ,oel.line_id) delivery_date
											-- ,to_char(wnd.initial_pickup_date,'yyyy-mm-dd') delivery_date
											
											-------0520 为了显示退货订单的相关信息 start lm
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,rcta.trx_number
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,rcta.trx_number
																					,null))) trx_number
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,rcta.attribute3
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,rctl.attribute2
																					,null))) vat_trx_number
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,to_char(dist.gl_date
																		,'yyyy-mm-dd')
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,to_char(decode(nvl(rcta.complete_flag
																											,'N')
																									,'Y'
																									,dist.gl_date
																									,null)
																					 ,'yyyy-mm-dd'))) trx_gl_date
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,rctl.quantity_invoiced
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,rctl.quantity_invoiced
																					,null))) quantity_invoiced
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,nvl(rctl.gross_unit_selling_price
																,rctl.unit_selling_price)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,nvl(rctl.gross_unit_selling_price
																							,rctl.unit_selling_price)
																					,null))) invoice_price
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,nvl(rctl.unit_selling_price
																,0)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,nvl(rctl.unit_selling_price
																							,0)
																					,null))) invoice_price_no_tax
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,rcta.invoice_currency_code
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,rcta.invoice_currency_code
																					,null))) invoice_currency_code
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_rev.amount) + abs(dist_tax.amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_rev.amount
																					,null) + decode(nvl(rcta.complete_flag
																														 ,'N')
																												 ,'Y'
																												 ,dist_tax.amount
																												 ,null))) amount_invoice
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_rev.acctd_amount) + abs(dist_tax.acctd_amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_rev.acctd_amount
																					,null) + decode(nvl(rcta.complete_flag
																														 ,'N')
																												 ,'Y'
																												 ,dist_tax.acctd_amount
																												 ,null))) acctd_amount_invoice
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_rev.amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_rev.amount
																					,null))) amount_revenue
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_rev.acctd_amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_rev.acctd_amount
																					,null))) acctd_amount_revenue
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_tax.amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_tax.amount
																					,null))) amount_tax
										 ,decode(substr(oeh.order_number
																	 ,1
																	 ,1)
														,9
														,abs(dist_tax.acctd_amount)
														,decode(wnd.name
																	 ,null
																	 ,null
																	 ,decode(nvl(rcta.complete_flag
																							,'N')
																					,'Y'
																					,dist_tax.acctd_amount
																					,null))) acctd_amount_tax
											
											--
											--ar,根据发票完成标志来判断是否显示
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',rcta.trx_number,null)) trx_number
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',rctl.attribute2,null)) vat_trx_number
											-------,decode(wnd.name,null,null,to_char(decode(nvl(rcta.complete_flag,'N'),'Y',dist.gl_date,null),'yyyy-mm-dd')) trx_gl_date
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',rctl.quantity_invoiced,null)) quantity_invoiced
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',nvl(rctl.gross_unit_selling_price,rctl.unit_selling_price),null)) invoice_price
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',nvl(rctl.unit_selling_price,0),null)) invoice_price_no_tax
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',rcta.invoice_currency_code,null)) invoice_currency_code
											--,decode(nvl(rcta.complete_flag,'N'),'Y',dist.amount,null) amount_invoice
											--,decode(nvl(rcta.complete_flag,'N'),'Y',dist.acctd_amount,null) acctd_amount_invoice
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_rev.amount,null)+decode(nvl(rcta.complete_flag,'N'),'Y',dist_tax.amount,null)) amount_invoice
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_rev.acctd_amount,null)+decode(nvl(rcta.complete_flag,'N'),'Y',dist_tax.acctd_amount,null)) acctd_amount_invoice
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_rev.amount,null)) amount_revenue
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_rev.acctd_amount,null)) acctd_amount_revenue
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_tax.amount,null)) amount_tax
											-------,decode(wnd.name,null,null,decode(nvl(rcta.complete_flag,'N'),'Y',dist_tax.acctd_amount,null)) acctd_amount_tax
											-------0520 为了显示退货订单的相关信息 end lm
											
										 ,oeh.cust_po_number
										 ,to_char(oeh.booked_date
														 ,'yyyy-mm-dd') booked_date -- add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户,再inv中追加
											--0518 lm 追加退货订单的接收和入库数量
										 ,r_qty_t.r_qty ruku
										 ,d_qty_t.d_qty jieshou
			--0518 lm 追加退货订单的接收和入库数量
				from oe_order_headers_all oeh
						,oe_order_lines_all oel
						,ar_vat_tax_all_b avt
						,mtl_txn_request_headers trh
						,mtl_txn_request_lines trl
						,(select mt.move_order_line_id
										,max(trunc(mt.transaction_date)) transaction_date
										,max(mt.attribute1) attribute1
										,sum(mt.primary_quantity) primary_quantity
								from mtl_material_transactions mt
							 where mt.transaction_quantity > 0
								 and mt.transaction_action_id(+) = 28
								 and mt.transaction_type_id(+) = 52
								 and mt.transaction_source_type_id(+) = 2
							 group by mt.move_order_line_id /*,trunc(mt.transaction_date),mt.attribute1*/
							) mmt
						,wsh_picking_batches wpb
						,wsh_delivery_details wdd
						,wsh_delivery_assignments wda
						,wsh_new_deliveries wnd
						,ar_customers rc
						,jtf_rs_salesreps jrs
						,mtl_system_items_b sib
						,oe_transaction_types_tl ottl
						,ra_terms_tl rtt
						 --add by zhangzhen@chinasie.com,2005.3.29
						,ra_terms_lines rtl
						 --
						,ra_customer_trx_lines_all    rctl
						,ra_customer_trx_lines_all    rctl_tax
						,ra_customer_trx_all          rcta
						,ra_cust_trx_line_gl_dist_all dist
						,ra_cust_trx_line_gl_dist_all dist_rev
						,ra_cust_trx_line_gl_dist_all dist_tax
						 --0518 lm 追加退货订单的接收和入库数量
						,(select rt.oe_order_header_id
										,rt.oe_order_line_id
										,sum(decode(rt.transaction_type
															 ,'RECEIVE'
															 ,1
															 ,'RETURN TO CUSTOMER'
															 ,-1) * rt.primary_quantity) r_qty
								from po.rcv_transactions rt
							 where rt.oe_order_header_id is not null
								 and rt.transaction_type in ('RETURN TO CUSTOMER'
																						,'RECEIVE')
							 group by rt.oe_order_header_id
											 ,rt.oe_order_line_id) r_qty_t
						,(select rt.oe_order_header_id
										,rt.oe_order_line_id
										,sum(decode(rt.transaction_type
															 ,'DELIVER'
															 ,1
															 ,'RETURN TO RECEIVING'
															 ,-1) * rt.primary_quantity) d_qty
								from po.rcv_transactions rt
							 where rt.oe_order_header_id is not null
								 and rt.transaction_type in ('RETURN TO RECEIVING'
																						,'DELIVER')
							 group by rt.oe_order_header_id
											 ,rt.oe_order_line_id) d_qty_t
			--0518 lm 追加退货订单的接收和入库数量
			 where oeh.header_id = oel.header_id
				 and nvl(oeh.booked_flag
								,'N') = 'Y'
						--update 2005.1.19
						/*and oel.line_id = trl.txn_source_line_id(+)*/
						--0518 lm 追加退货订单的接收和入库数量
				 and oel.header_id = r_qty_t.oe_order_header_id(+)
				 and oel.line_id = r_qty_t.oe_order_line_id(+)
				 and oel.header_id = d_qty_t.oe_order_header_id(+)
				 and oel.line_id = d_qty_t.oe_order_line_id(+)
						--0518 lm 追加退货订单的接收和入库数量
				 and trl.header_id = trh.header_id(+)
				 and trh.request_number = wpb.batch_id(+)
				 and mmt.move_order_line_id(+) = trl.line_id
				 and oeh.sold_to_org_id = rc.customer_id(+)
				 and oeh.salesrep_id = jrs.salesrep_id(+)
				 and oeh.org_id = jrs.org_id(+)
				 and oel.inventory_item_id = sib.inventory_item_id
				 and oel.ship_from_org_id = sib.organization_id
				 and nvl(oeh.attribute3
								,oeh.payment_term_id) = rtt.term_id(+)
				 and rtt.term_id = rtl.term_id(+)
				 and rtl.sequence_num(+) = 1
				 and oel.tax_code = avt.tax_code(+)
				 and avt.tax_type(+) = 'VAT'
						--update by zhangzhen@chinasie.com,2005.8.29
						--and avt.set_of_books_id(+) = 2
				 and avt.set_of_books_id(+) = c_set_of_books_id
						--update end.
				 and rtt.language(+) = 'ZHS' --userenv('LANG')
						--update 2005.1.19
				 and oel.line_id = wdd.source_line_id(+)
				 and wdd.source_code(+) = 'OE'
				 and wdd.move_order_line_id = trl.line_id(+)
						--and trl.line_id = wdd.move_order_line_id(+)
						--and nvl(wdd.cancelled_quantity(+),0) = 0
				 and wdd.delivery_detail_id = wda.delivery_detail_id(+)
				 and wda.delivery_id = wnd.delivery_id(+)
				 and oeh.order_type_id = ottl.transaction_type_id
				 and ottl.language = 'ZHS' --userenv('LANG')
				 and oel.ordered_quantity > 0
						--ar
						--and rctl.interface_line_attribute3(+) = wnd.name
				 and rctl.interface_line_attribute6(+) = oel.line_id
				 and rctl.interface_line_context(+) = 'ORDER ENTRY'
				 and rctl.customer_trx_id = rcta.customer_trx_id(+)
				 and rcta.customer_trx_id = dist.customer_trx_id(+)
				 and dist.account_class(+) = 'REC'
				 and rctl.customer_trx_line_id = dist_rev.customer_trx_line_id(+)
				 and dist_rev.account_class(+) = 'REV'
				 and rctl_tax.link_to_cust_trx_line_id(+) = rctl.customer_trx_line_id
				 and rctl_tax.customer_trx_line_id = dist_tax.customer_trx_line_id(+)
				 and dist_tax.account_class(+) = 'TAX'
						--参数
				 and sib.organization_id = p_org_id
						---- 20050511 update lm start
						----and oeh.order_type_id = nvl(p_order_type_id,oeh.order_type_id) 
						/*AND (oeh.order_type_id=NVL(p_order_type_id,oeh.order_type_id)
            OR (oeh.order_type_id='1010'
               AND DECODE(SUBSTR(sib.segment1,0,4),'1001','1002','1002','1003','1003','1004','1007','1005','1004')=NVL(p_order_type_id,oeh.order_type_id)
            ))*/
						----20050511 update lm end
						--add 20050705 lck
				 and oeh.order_type_id in (select b.transaction_type_id
																	 --T.NAME
																		 from oe_transaction_types_tl  t
																				 ,oe_transaction_types_all b
																		where b.transaction_type_id = t.transaction_type_id
																			and t.language = userenv('LANG')
																			and b.transaction_type_code = 'ORDER'
																			and (t.name like '%供应%' or t.name like '%市场营销%' or t.name like 'KY%')
																			and b.warehouse_id = p_org_id)
						--end add
						-- And oeh.Order_Type_Id In (1002,1003,1004,1005,1010)
				 and rc.customer_number >= nvl(p_customer_num_from
																			,rc.customer_number)
				 and rc.customer_number <= nvl(p_customer_num_to
																			,rc.customer_number)
				 and oeh.order_number >= nvl(p_order_num_from
																		,oeh.order_number)
				 and oeh.order_number <= nvl(p_order_num_to
																		,oeh.order_number)
						---20050526 lm update start :限定查找订单日期而非登记日期
				 and (p_order_date_from is null or trunc(nvl(oeh.ordered_date
																										,to_date('2999/12/31'
																														,'yyyy/mm/dd'))) >=
						 trunc(to_date(p_order_date_from
																												,'yyyy/mm/dd hh24:mi:ss')))
				 and (p_order_date_to is null or trunc(nvl(oeh.ordered_date
																									,to_date('1000/01/01'
																													,'yyyy/mm/dd'))) <=
						 trunc(to_date(p_order_date_to
																											,'yyyy/mm/dd hh24:mi:ss')))
						/*and (p_order_date_from is null
                 or trunc(oeh.BOOKED_DATE) >= trunc(to_date(p_order_date_from,'yyyy/mm/dd hh24:mi:ss')))
            and (p_order_date_to is null
                 or trunc(oeh.BOOKED_DATE) <= trunc(to_date(p_order_date_to,'yyyy/mm/dd hh24:mi:ss'))) */
						---20050526 lm update end :限定查找订单日期而非登记日期
				 and (p_pickslip_date_from is null or trunc(nvl(to_date(mmt.attribute1
																															 ,'yyyy/mm/dd hh24:mi:ss')
																											 ,mmt.transaction_date)) >=
						 trunc(to_date(p_pickslip_date_from
																													 ,'yyyy/mm/dd hh24:mi:ss')))
				 and (p_pickslip_date_to is null or trunc(nvl(to_date(mmt.attribute1
																														 ,'yyyy/mm/dd hh24:mi:ss')
																										 ,mmt.transaction_date)) <=
						 trunc(to_date(p_pickslip_date_to
																												 ,'yyyy/mm/dd hh24:mi:ss')))
						---- 20050517 update lm start
				 and (p_booked_date_from is null or
						 trunc(oeh.booked_date) >= trunc(to_date(p_booked_date_from
																										 ,'yyyy/mm/dd hh24:mi:ss')))
				 and (p_booked_date_to is null or
						 trunc(oeh.booked_date) <= trunc(to_date(p_booked_date_to
																										 ,'yyyy/mm/dd hh24:mi:ss')))
						--
				 and (p_invoice_date_from is null or
						 trunc(dist.gl_date) >= trunc(to_date(p_invoice_date_from
																									,'yyyy/mm/dd hh24:mi:ss')))
				 and (p_invoice_date_to is null or
						 trunc(dist.gl_date) <= trunc(to_date(p_invoice_date_to
																									,'yyyy/mm/dd hh24:mi:ss')))
						---- 20050517 update lm end
						-----20050708 add lck start
				 and ((p_type = 'SALESPERSON' and
						 (exists (select 1
													from fnd_user         fu
															,per_all_people_f per
															,jtf_rs_salesreps jrs
												 where fu.user_id = p_userid
													 and per.last_name = jrs.name
													 and fu.employee_id = per.person_id
													 and jrs.salesrep_id = oeh.salesrep_id
													 and jrs.org_id = (select ood.operating_unit
																							 from org_organization_definitions ood
																							where ood.organization_id = p_org_id))
						 -----20050708 add lck end
						 --  销售人编码取值错误---
						 /*      And ((p_type = 'SALESPERSON' 
             And (Exists
             (Select 1
                From fnd_user fu
                    ,Per_All_People_f per
                    ,Jtf_Rs_Salesreps jrs
               Where fu.User_Id = p_userid
                 And fu.Employee_Id = per.Person_Id
                 And per.Employee_Number = jrs.Salesrep_Number
                 And jrs.Salesrep_Id = oeh.Salesrep_Id
              )*/
						 --  销售人编码取值错误---
						 ----20050519 lm start : to display the informations of '制冷' to all the persons in the steel department 
							or (exists (select 1
																		 from fnd_lookup_values_vl lv
																				 ,fnd_user             fnu
																		where (nvl(''
																							,territory_code) = territory_code or territory_code is null)
																			and (lookup_type like 'SELLERS_KT')
																			and view_application_id = 660
																			and security_group_id = 0
																			and lv.start_date_active <= sysdate
																			and sysdate <= nvl(lv.end_date_active
																												,to_date('2999-12-31'
																																,'yyyy-mm-dd'))
																			and lookup_code = fnu.user_name
																			and fnu.user_id = p_userid) and rc.customer_name like '%制冷%'))
						 ----20050519 lm start : to display the informations of '制冷' to all the persons in the steel department 
						 ) or (p_type = 'INV') or (p_type is null))
						--ORDER_STATUS
				 and ((p_order_status = 'CANCELLED' and oeh.cancelled_flag = 'Y') or
						 (p_order_status = 'CLOSED' and oeh.open_flag = 'N' and oeh.cancelled_flag = 'N') or
						 (p_order_status = 'ENTERED' and oeh.flow_status_code = 'ENTERED') or
						 (p_order_status = 'BOOKED' and oeh.booked_flag = 'Y' and oeh.cancelled_flag = 'N' and oeh.open_flag = 'Y') or
						 p_order_status is null)
			 order by ottl.name
							 ,rc.customer_number
							 ,oeh.order_number
							 ,to_number(oel.line_number || '.' || oel.shipment_number)
							 ,trh.request_number
							 ,wnd.name;
		v_line_str        varchar2(4000);
		v_sep             varchar2(5);
		v_aqv             number;
		v_po_price        number;
		v_ml_price        number;
		v_inv_order_price number;
		v_vat_trx_number  varchar2(500);
		--
		v_sum_quantity_order       number;
		v_sum_quantity_pickslip    number;
		v_sum_quantity_txn         number;
		v_sum_quantity_invoiced    number;
		v_sum_acctd_amount_invoice number;
		v_sum_acctd_amount_revenue number;
		v_sum_acctd_amount_tax     number;
		--
		v_order_quantity     varchar2(100) := '';
		v_acctd_amount_order varchar2(100) := '';
		v_pick_quantity      varchar2(100) := '';
		v_txn_quantity       varchar2(100) := '';
		v_amount_pick_slip   varchar2(100) := '';
	
		v_quantity_invoice     varchar2(100) := '';
		v_amount_revenue       varchar2(100) := '';
		v_acctd_amount_revenue varchar2(100) := '';
		v_amount_receive       varchar2(100) := '';
		v_acctd_amount_receive varchar2(100) := '';
		v_amount_tax           varchar2(100) := '';
		v_acctd_amount_tax     varchar2(100) := '';
	
		v_current_order_number     varchar2(100) := '';
		v_current_line_number      varchar2(20) := '';
		v_move_order_line_id       number;
		v_current_pick_slip_number varchar2(20) := '';
		v_current_quantity_pick    number := '';
		v_current_quantity_txn     number := '';
		v_current_txn_date         date;
		--
		v_current_delivery_name    varchar2(100);
		v_current_quantity_invoice varchar2(100);
	
		v_i     number := 0;
		v_j     number := 0;
		v_count number := 0;
		--
		v_order_type_name varchar2(300);
		--
		v_request_id   number;
		v_request_date date;
		v_req          number;
		--
		v_quantity_delivery      varchar2(100) := '';
		v_current_delivery_name2 varchar2(100) := '';
		v_current_line_id2       varchar2(100) := '';
		v_set_of_books_id        number;
	begin
		g_org_id := p_org_id;
		--add by zhangzhen@chinasie.com,2005.8.29
		select set_of_books_id
			into v_set_of_books_id
			from jd_set_books_org_v v
		 where v.organization_id = fnd_profile.value('ORG_ID');
		--add end.
		select jd_ar005_temp_s.nextval
					,sysdate
			into v_request_id
					,v_request_date
			from dual;
	
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '####';
		html_report_pkg.html_title(p_program_title => '销售合同执行情况表'
															,p_report_title  => '销售合同执行情况表');
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		html_report_pkg.output_line('<BR>订单日期，自：' || substr(p_order_date_from
																											 ,1
																											 ,10) || '，至：' ||
																substr(p_order_date_to
																			,1
																			,10));
		html_report_pkg.output_line('<BR>挑库确认日期，自：' || substr(p_pickslip_date_from
																												 ,1
																												 ,10) || '，至：' ||
																substr(p_pickslip_date_to
																			,1
																			,10));
		--20050517 lm start
		if p_type = null
		then
			html_report_pkg.output_line('<BR>登记日期，自：' || p_booked_date_from || '，至：' || p_booked_date_to);
		end if;
		--20050517 lm end 
		html_report_pkg.output_line('<BR>客户编号，自：' || p_customer_num_from || '，至：' || p_customer_num_to);
		html_report_pkg.output_line('<BR>订单编号，自：' || p_order_num_from || '，至：' || p_order_num_to);
	
		if p_order_type_id is not null
		then
			begin
				select name
					into v_order_type_name
					from oe_transaction_types_tl ottl
				 where ottl.transaction_type_id = p_order_type_id
					 and ottl.language = userenv('LANG');
				html_report_pkg.output_line('<BR>订单类型：' || v_order_type_name);
			exception
				when others then
					v_order_type_name := null;
			end;
		end if;
	
		if p_type = 'INV'
		then
			html_report_pkg.output_line('<table width=2000 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
		else
			html_report_pkg.output_line('<table width=3800 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
		end if;
	
		if p_type = 'SALESPERSON'
		then
			v_line_str := '订单编号,订单行号,订单类型,订单日期,客户编号,客户名称,销售员,物料代码,物料名称,合同数量,单位,销售单价（含税）,销售单价（不含税）,实际价格（铜铝部）,钢厂价格,币种,合同金额（本位币）,采购订单号,挑库批号,' --采购单价（不含税）,单位毛利（不含税）,
										||
										'挑库日期,挑库数量,付款条件,挑库确认金额（本位币）,挑库确认数量,单位,挑库确认日期,到期日期,销货单号,销货日期,销货数量,系统发票号码,增值税发票号码,发票日期,发票价格,发票与订单的价差,开票数量,销售收入（原币）,销售收入（本位币）,增值税（原币）,增值税（本位币）,发票金额（原币）,发票金额（本位币）,客户PO,登记日期,';
		elsif p_type = 'INV'
		then
			v_line_str := '订单编号,订单行号,订单类型,订单日期,客户编号,客户名称,销售员,物料代码,物料名称,合同数量,单位,挑库批号,' ||
										'挑库日期,挑库数量,挑库确认数量,挑库确认日期,到期日期,销货单号,销货日期,销货数量,发票日期,开票数量,发票金额（本位币）,登记日期,';
		else
			v_line_str := '订单编号,订单行号,订单类型,订单日期,客户编号,客户名称,销售员,物料代码,物料名称,合同数量,单位,销售单价（含税）,销售单价（不含税）,实际价格（铜铝部）,钢厂价格,币种,合同金额（本位币）,采购订单号,采购单价（不含税）,单位毛利（不含税）,挑库批号,' ||
										'挑库日期,挑库数量,付款条件,挑库确认金额（本位币）,挑库确认数量,单位,挑库确认日期,到期日期,销货单号,销货日期,销货数量,系统发票号码,增值税发票号码,发票日期,发票价格,发票与订单的价差,开票数量,销售收入（原币）,销售收入（本位币）,增值税（原币）,增值税（本位币）,发票金额（原币）,发票金额（本位币）,客户PO,登记日期,';
		end if;
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		for r1 in c1(v_set_of_books_id)
		loop
			select -sum(mmt.primary_quantity)
				into v_quantity_delivery
				from mtl_material_transactions mmt
			 where mmt.transaction_type_id = 33
				 and mmt.source_line_id = r1.line_id
				 and mmt.shipment_number = r1.delivery_name;
			if nvl(v_quantity_delivery
						,0) > nvl(r1.ordered_quantity
										 ,0)
			then
				v_quantity_delivery := r1.ordered_quantity;
			end if;
		
			if (r1.delivery_name = v_current_delivery_name2 and r1.line_id = v_current_line_id2)
			then
				v_quantity_delivery := '同上';
			else
				v_quantity_delivery := v_quantity_delivery;
			end if;
			v_current_delivery_name2 := r1.delivery_name;
			v_current_line_id2       := r1.line_id;
			--   --Modified by whj in 20050720
			/*Select Sum(trl.primary_quantity) 
            --,Sum(trl.primary_quantity*oel.unit_selling_price)
       Into r1.quantity_pick
           --,r1.amount_pick_slip
       From wsh_delivery_details wdd
           ,mtl_txn_request_lines trl
           ,mtl_txn_request_headers trh
           ,oe_order_lines_all oel
      Where wdd.move_order_line_id = trl.line_id
        And trl.header_id = trh.header_id
        And wdd.source_code = 'OE'
        And wdd.source_line_id = oel.line_id
        And wdd.source_line_id = r1.line_id
        And trh.request_number = r1.pick_slip_number;*/
			--add by zhangzhen@chinasie.com,2005.3.14,增加判断，如果挑库数量大于订单行数量，那么挑库数量取挑库确认数量。
		
			--Added by whj in 20050720
			select sum(wdv.requested_quantity) requested_quantity
						,sum(decode(wdv.released_status
											 ,'S'
											 ,0
											 ,wdv.picked_quantity)) picked_quantity
				into r1.quantity_pick
						,r1.txn_quantity
				from wsh_deliverables_v wdv
			 where wdv.source_header_id = r1.header_id
				 and wdv.source_line_id = r1.line_id
				 and wdv.move_order_line_id = r1.move_order_line_id
				 and wdv.source_code = 'OE'
				 and wdv.released_status in ('C'
																		,'Y'
																		,'S'); -- 发运 C;分批发运/确认挑库 Y;已发放至仓库 S
			/*Select Sum(trl.primary_quantity) --Modified by whj in 20050720
            --,Sum(trl.primary_quantity*oel.unit_selling_price)
       Into r1.quantity_pick
           --,r1.amount_pick_slip
       From mtl_txn_request_lines trl
           ,mtl_txn_request_headers trh
      Where trl.line_id=r1.move_order_line_id 
        And trl.header_id = trh.header_id
        And trh.request_number = r1.pick_slip_number;*/
			--add by whj in 20050720
			if r1.quantity_pick > r1.ordered_quantity
			then
				r1.quantity_pick := r1.ordered_quantity;
			end if;
			--   
			/*select sum(mt.Primary_Quantity) Primary_Quantity
       into r1.txn_quantity
       from mtl_material_transactions mt
      where mt.transaction_quantity > 0
        and mt.transaction_action_id(+) = 28
        and mt.transaction_type_id(+) = 52
        and mt.transaction_source_type_id(+) = 2
        and mt.move_order_line_id=r1.move_order_line_id
        and mt.trx_source_line_id=r1.line_id
      Group By mt.trx_source_line_id,
               mt.move_order_line_id;*/
		
			--add by whj@chinasie.com,2005.6.20,增加判断，如果挑库确认数量大于订单行数量，那么挑库确认数量取订单数量。
			if r1.txn_quantity > r1.ordered_quantity
			then
				r1.txn_quantity     := r1.ordered_quantity;
				r1.amount_pick_slip := round(r1.txn_quantity * r1.unit_selling_price
																		,2);
			end if;
			--r1.amount_pick_slip := round(r1.txn_quantity*r1.unit_selling_price,2);
			--Modified by whj at 20050620 (对于不同订单行对应相同挑库单号，多条挑库确认记录对应产生多条记录的问题处理)
			--
			if nvl(r1.attribute4
						,'YES') = 'YES'
			then
				begin
					select round(sum(pla.quantity * decode(nvl(pla.list_price_per_unit
																										,0)
																								,0
																								,pla.unit_price
																								,pla.list_price_per_unit)) / sum(pla.quantity)
											,6)
						into v_po_price
						from po_headers_all pha
								,po_lines_all   pla
					 where pha.po_header_id = pla.po_header_id
						 and pha.segment1 = r1.po_num
						 and pla.item_id = r1.inventory_item_id;
				exception
					when others then
						v_po_price := 0;
				end;
			else
				v_po_price := r1.attribute5;
			end if;
		
			if nvl(r1.quantity_pick
						,0) = 0
			then
				v_ml_price := to_number(null);
			else
				if (nvl(r1.attribute4
							 ,'YES') = 'YES' and r1.po_num is null) or
					 (nvl(r1.attribute4
							 ,'YES') = 'NO' and r1.attribute5 is null)
				then
					v_ml_price := to_number(null);
				else
					v_ml_price := nvl(r1.invoice_price_no_tax
													 ,r1.order_price_no_tax) - nvl(v_po_price
																												,0);
				end if;
			end if;
		
			--发票与订单价差是含税的
			if nvl(r1.invoice_price
						,0) = 0
			then
				v_inv_order_price := null;
			else
				v_inv_order_price := nvl(r1.invoice_price
																,0) - nvl(r1.unit_selling_price
																				 ,0);
			end if;
		
			if r1.vat_trx_number = '0.00'
			then
				v_vat_trx_number := null;
			else
				v_vat_trx_number := r1.vat_trx_number;
			end if;
		
			--add 2005.2.22 for duplicate record
			if (r1.order_number = v_current_order_number and r1.line_number = v_current_line_number)
			then
				v_order_quantity       := '同上';
				v_current_order_number := '';
				v_current_line_number  := '';
				if (r1.pick_slip_number = v_current_pick_slip_number and r1.quantity_pick = v_current_quantity_pick and
					 r1.move_order_line_id = v_move_order_line_id)
				then
					v_pick_quantity    := '同上';
					v_txn_quantity     := '同上'; --Added by whj@chinasie.com,2005.6.20,
					v_amount_pick_slip := '同上'; --Added by whj@chinasie.com,2005.6.20,
				
					v_current_pick_slip_number := '';
					v_current_quantity_pick    := to_number(null);
					--Modified by whj@chinasie.com,2005.6.20,
					/*If (r1.txn_quantity = v_current_quantity_txn And r1.txn_transaction_date = v_current_txn_date ) Then
            v_txn_quantity := '同上';
            v_current_quantity_txn := to_number(Null);
            v_current_txn_date := to_date(Null);
          Else
            v_txn_quantity := r1.txn_quantity;
          End If;*/
					--Modified by whj@chinasie.com,2005.6.20,
				
				else
					v_pick_quantity := r1.quantity_pick;
				
					if nvl(p_yn_flag
								,'N') = 'Y' and
						 r1.open_flag = 'N' and
						 r1.cancelled_flag = 'N'
					then
						v_amount_pick_slip := 0;
						v_txn_quantity     := 0; --Added by whj@chinasie.com,2005.7.8,
					else
						v_txn_quantity     := r1.txn_quantity; --Added by whj@chinasie.com,2005.6.20,
						v_amount_pick_slip := r1.amount_pick_slip; --Added by whj@chinasie.com,2005.6.20,
					end if;
				end if;
				if (r1.delivery_name = v_current_delivery_name and r1.quantity_invoiced = v_current_quantity_invoice)
				then
					v_quantity_invoice     := '同上';
					v_amount_revenue       := '同上';
					v_acctd_amount_revenue := '同上';
					v_amount_receive       := '同上';
					v_acctd_amount_receive := '同上';
					v_amount_tax           := '同上';
					v_acctd_amount_tax     := '同上';
				
					v_current_delivery_name    := '';
					v_current_quantity_invoice := '';
				else
					v_quantity_invoice     := r1.quantity_invoiced;
					v_amount_revenue       := r1.amount_revenue;
					v_acctd_amount_revenue := r1.acctd_amount_revenue;
					v_amount_receive       := r1.amount_invoice;
					v_acctd_amount_receive := r1.acctd_amount_invoice;
					v_amount_tax           := r1.amount_tax;
					v_acctd_amount_tax     := r1.acctd_amount_tax;
				end if;
			else
				v_order_quantity := r1.ordered_quantity;
			
				v_pick_quantity := r1.quantity_pick;
			
				if nvl(p_yn_flag
							,'N') = 'Y' and
					 r1.open_flag = 'N' and
					 r1.cancelled_flag = 'N'
				then
					v_amount_pick_slip := 0;
					v_txn_quantity     := 0;
				else
					v_txn_quantity     := r1.txn_quantity;
					v_amount_pick_slip := r1.amount_pick_slip; --Added by whj@chinasie.com,2005.6.20,
				end if;
			
				v_quantity_invoice     := r1.quantity_invoiced;
				v_amount_revenue       := r1.amount_revenue;
				v_acctd_amount_revenue := r1.acctd_amount_revenue;
				v_amount_receive       := r1.amount_invoice;
				v_acctd_amount_receive := r1.acctd_amount_invoice;
				v_amount_tax           := r1.amount_tax;
				v_acctd_amount_tax     := r1.acctd_amount_tax;
			end if;
			--
			--Added by whj at 20050620
			/*If (r1.pick_slip_number = v_current_pick_slip_number And r1.quantity_pick = v_current_quantity_pick) Then
          v_pick_quantity := '同上';
          --v_current_pick_slip_number  := '';
          v_current_quantity_pick := to_number(Null);
          If (r1.txn_quantity = v_current_quantity_txn And r1.txn_transaction_date = v_current_txn_date ) Then
            v_txn_quantity := '同上';
            v_current_quantity_txn := to_number(Null);
            v_current_txn_date := to_date(Null);
          Else
            v_txn_quantity := r1.txn_quantity;
          End If;
      Else
          v_pick_quantity := r1.quantity_pick;
          v_txn_quantity := r1.txn_quantity;
      End If;*/
			--Added by whj at 20050620
			v_current_order_number := r1.order_number;
			v_current_line_number  := r1.line_number;
		
			v_current_pick_slip_number := r1.pick_slip_number;
			v_current_quantity_pick    := r1.quantity_pick;
			v_move_order_line_id       := r1.move_order_line_id;
		
			v_current_delivery_name    := r1.delivery_name;
			v_current_quantity_invoice := r1.quantity_invoiced;
		
			v_i := v_i + 1;
			if v_order_quantity = '同上'
			then
				v_acctd_amount_order := '同上';
			else
				v_acctd_amount_order := r1.acctd_amount_ordered;
			end if;
		
			----050518 lm  追加退货订单的接收和入库数量
			/*      If r1.order_number Like '9%' Then 
         v_pick_quantity := r1.ruku;
         v_txn_quantity := r1.jieshou;
      End If;*/
			----050518 lm  追加退货订单的接收和入库数量
		
			if p_type = 'SALESPERSON'
			then
				html_report_pkg.line_title(p_title_string => r1.order_number || v_sep || r1.line_number || v_sep ||
																										 r1.order_type_name || v_sep || r1.ordered_date || v_sep ||
																										 r1.customer_number || v_sep || r1.customer_name || v_sep ||
																										 r1.salesrep_name || v_sep || r1.item_number || v_sep ||
																										 r1.item_description || v_sep || v_order_quantity --r1.ordered_quantity
																										 || v_sep || r1.order_quantity_uom || v_sep ||
																										 r1.unit_selling_price || v_sep || r1.order_price_no_tax || v_sep ||
																										 r1.unit_price_tl || v_sep || r1.unit_price_gc || v_sep ||
																										 r1.transactional_curr_code || v_sep || v_acctd_amount_order --r1.acctd_amount_ordered
																										 || v_sep || r1.po_num /*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                


                                                                                                                                                            
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ||v_sep||v_po_price
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                


                                                                                                                                                            
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ||v_sep||v_ml_price*/
																										 || v_sep || r1.pick_slip_number || v_sep || r1.pick_slip_date ||
																										 v_sep || v_pick_quantity --r1.quantity_pick
																										 || v_sep || r1.term_name || v_sep || v_amount_pick_slip --r1.amount_pick_slip
																										--                                          
																										 || v_sep || v_txn_quantity --r1.txn_quantity
																										 || v_sep || r1.txn_uom_code || v_sep || r1.txn_transaction_date ||
																										 v_sep || r1.pick_slip_due_date
																										--
																										 || v_sep || r1.delivery_name || v_sep || r1.delivery_date || v_sep ||
																										 v_quantity_delivery || v_sep || r1.trx_number || v_sep ||
																										 r1.vat_trx_number || v_sep || r1.trx_gl_date || v_sep ||
																										 r1.invoice_price || v_sep || v_inv_order_price || v_sep ||
																										 v_quantity_invoice --r1.quantity_invoiced
																										 || v_sep || v_amount_revenue --r1.amount_revenue
																										 || v_sep || v_acctd_amount_revenue --r1.acctd_amount_revenue
																										 || v_sep || v_amount_tax --r1.amount_tax
																										 || v_sep || v_acctd_amount_tax --r1.acctd_amount_tax
																										 || v_sep || v_amount_receive --r1.amount_invoice
																										 || v_sep || v_acctd_amount_receive --r1.acctd_amount_invoice
																										 || v_sep || r1.cust_po_number || v_sep || r1.booked_date --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户,再inv中追加
																										 || v_sep
																	,p_delimiter    => v_sep);
			elsif p_type = 'INV'
			then
				html_report_pkg.line_title(p_title_string => r1.order_number || v_sep || r1.line_number || v_sep ||
																										 r1.order_type_name || v_sep || r1.ordered_date || v_sep ||
																										 r1.customer_number || v_sep || r1.customer_name || v_sep ||
																										 r1.salesrep_name || v_sep || r1.item_number || v_sep ||
																										 r1.item_description || v_sep || v_order_quantity --r1.ordered_quantity
																										 || v_sep || r1.order_quantity_uom || v_sep || r1.pick_slip_number ||
																										 v_sep || r1.pick_slip_date || v_sep || v_pick_quantity --r1.quantity_pick
																										--                                          
																										 || v_sep || v_txn_quantity --r1.txn_quantity
																										 || v_sep || r1.txn_transaction_date || v_sep ||
																										 r1.pick_slip_due_date
																										--
																										 || v_sep || r1.delivery_name || v_sep || r1.delivery_date || v_sep ||
																										 v_quantity_delivery || v_sep || r1.trx_gl_date || v_sep ||
																										 v_quantity_invoice --r1.quantity_invoiced
																										 || v_sep || v_acctd_amount_receive --r1.acctd_amount_invoice
																										 || v_sep || r1.booked_date --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户,再inv中追加
																										 || v_sep
																	,p_delimiter    => v_sep);
			else
				html_report_pkg.line_title(p_title_string => r1.order_number || v_sep || r1.line_number || v_sep ||
																										 r1.order_type_name || v_sep || r1.ordered_date || v_sep ||
																										 r1.customer_number || v_sep || r1.customer_name || v_sep ||
																										 r1.salesrep_name || v_sep || r1.item_number || v_sep ||
																										 r1.item_description || v_sep || v_order_quantity --r1.ordered_quantity
																										 || v_sep || r1.order_quantity_uom || v_sep ||
																										 r1.unit_selling_price || v_sep || r1.order_price_no_tax || v_sep ||
																										 r1.unit_price_tl || v_sep || r1.unit_price_gc || v_sep ||
																										 r1.transactional_curr_code || v_sep || v_acctd_amount_order --r1.acctd_amount_ordered
																										 || v_sep || r1.po_num || v_sep || v_po_price || v_sep ||
																										 v_ml_price || v_sep || r1.pick_slip_number || v_sep ||
																										 r1.pick_slip_date || v_sep || v_pick_quantity --r1.quantity_pick
																										 || v_sep || r1.term_name || v_sep || v_amount_pick_slip --r1.amount_pick_slip
																										--                                          
																										 || v_sep || v_txn_quantity --r1.txn_quantity
																										 || v_sep || r1.txn_uom_code || v_sep || r1.txn_transaction_date ||
																										 v_sep || r1.pick_slip_due_date
																										--
																										 || v_sep || r1.delivery_name || v_sep || r1.delivery_date || v_sep ||
																										 v_quantity_delivery || v_sep || r1.trx_number || v_sep ||
																										 r1.vat_trx_number || v_sep || r1.trx_gl_date || v_sep ||
																										 r1.invoice_price || v_sep || v_inv_order_price || v_sep ||
																										 v_quantity_invoice --r1.quantity_invoiced
																										 || v_sep || v_amount_revenue --r1.amount_revenue
																										 || v_sep || v_acctd_amount_revenue --r1.acctd_amount_revenue
																										 || v_sep || v_amount_tax --r1.amount_tax
																										 || v_sep || v_acctd_amount_tax --r1.acctd_amount_tax
																										 || v_sep || v_amount_receive --r1.amount_invoice
																										 || v_sep || v_acctd_amount_receive --r1.acctd_amount_invoice
																										 || v_sep || r1.cust_po_number || v_sep || r1.booked_date --add lm 20050517 : 追加“登记日期”信息字段给inv全面查询用户,再inv中追加
																										 || v_sep
																	,p_delimiter    => v_sep);
			end if;
			--
		
			---update 20050602 lm :退货订单不写入该表
			----If p_fcsp_schedule = 'Y'  Then
			if p_fcsp_schedule = 'Y' and
				 to_char(r1.order_number) not like '9%'
			then
				--ADD BY SSC 'TO_CHAR' 2005/06/12
				---update 20050602 lm :退货订单不写入该表
			
				insert into jd_ar005_temp
					(request_id
					,request_date
					,order_number
					,move_order_line_id
					,line_number
					,line_id
					,order_type_name
					,ordered_date
					,customer_number
					,customer_name
					,salesrep_number
					,salesrep_name
					,inventory_item_id
					,item_number
					,item_description
					,ordered_quantity
					,order_quantity_uom
					,unit_selling_price
					,order_price_no_tax
					,transactional_curr_code
					,acctd_amount_ordered
					,po_num
					,attribute4
					,attribute5
					,unit_price_tl
					,unit_price_gc
					,pick_slip_number
					,pick_slip_date
					,quantity_pick
					,amount_pick_slip
					,term_name
					,pick_slip_due_date
					,txn_quantity
					,txn_uom_code
					,txn_transaction_date
					,delivery_name
					,delivery_date
					,trx_number
					,vat_trx_number
					,trx_gl_date
					,quantity_invoiced
					,invoice_price
					,invoice_price_no_tax
					,invoice_currency_code
					,amount_invoice
					,acctd_amount_invoice
					,amount_revenue
					,acctd_amount_revenue
					,amount_tax
					,acctd_amount_tax
					,cust_po_number
					,due_days
					,quantity_delivery)
				values
					(v_request_id
					,v_request_date
					,r1.order_number
					,r1.move_order_line_id
					,r1.line_number
					,r1.line_id
					,r1.order_type_name
					,r1.ordered_date
					,r1.customer_number
					,r1.customer_name
					,r1.salesrep_number
					,r1.salesrep_name
					,r1.inventory_item_id
					,r1.item_number
					,r1.item_description
					,v_order_quantity --r1.ORDERED_QUANTITY       
					,r1.order_quantity_uom
					,r1.unit_selling_price
					,r1.order_price_no_tax
					,r1.transactional_curr_code
					,v_acctd_amount_order --r1.ACCTD_AMOUNT_ORDERED   
					,r1.po_num
					,v_po_price --r1.ATTRIBUTE4             
					,v_ml_price --r1.ATTRIBUTE5             
					,r1.unit_price_tl
					,r1.unit_price_gc
					,r1.pick_slip_number
					,r1.pick_slip_date
					,v_pick_quantity --r1.QUANTITY_PICK          
					,decode(nvl(p_yn_flag
										 ,'N')
								 ,'Y'
								 ,decode(r1.open_flag
												,'N'
												,decode(r1.cancelled_flag
															 ,'N'
															 ,0
															 ,r1.amount_pick_slip)
												,r1.amount_pick_slip)
								 ,r1.amount_pick_slip) --UPDATED BY WHJ IN 20050708
					 --,r1.AMOUNT_PICK_SLIP
					,r1.term_name
					,r1.pick_slip_due_date
					,v_txn_quantity --r1.TXN_QUANTITY           
					,r1.txn_uom_code
					,r1.txn_transaction_date
					,r1.delivery_name
					,r1.delivery_date
					,r1.trx_number
					,r1.vat_trx_number
					,r1.trx_gl_date
					,v_quantity_invoice --r1.QUANTITY_INVOICED      
					,r1.invoice_price
					,v_inv_order_price --r1.INVOICE_PRICE_NO_TAX   
					,r1.invoice_currency_code
					,v_amount_receive --r1.AMOUNT_INVOICE         
					,v_acctd_amount_receive --r1.ACCTD_AMOUNT_INVOICE   
					,v_amount_revenue --r1.AMOUNT_REVENUE         
					,v_acctd_amount_revenue --r1.ACCTD_AMOUNT_REVENUE   
					,v_amount_tax --r1.AMOUNT_TAX             
					,v_acctd_amount_tax --r1.ACCTD_AMOUNT_TAX       
					,r1.cust_po_number
					,r1.due_days
					,v_quantity_delivery);
				v_count := v_count + 1;
				if v_count = 500
				then
					v_count := 0;
					commit;
				end if;
			end if;
		end loop;
		commit;
		if p_fcsp_schedule = 'Y'
		then
			--进行数据加工处理
			fcsp_jiagong(v_request_id
									,p_org_id);
			--提交生成发出商品帐龄汇总的报表
			v_req := fnd_request.submit_request(application => 'AR'
																				 ,program     => 'JD_AR010_HTML2'
																				 ,description => 'JD.客户仓商品帐龄分析表(汇总)_排程使用2'
																				 ,sub_request => false
																				 ,argument1   => v_request_id);
			--提交生成发出商品帐龄明细的报表
			v_req := fnd_request.submit_request(application => 'AR'
																				 ,program     => 'JD_AR004_HTML2'
																				 ,description => 'JD.客户仓商品帐龄分析表_排程使用2'
																				 ,sub_request => false
																				 ,argument1   => v_request_id);
		end if;
		html_report_pkg.output_line('</tr></table></html>');
	
	end jd_ar005_gy;

	procedure fcsp_jiagong(p_request_id in number
												,p_org_id     in number) is
	begin
		--第一步数据加工，将临时表jd_ar005_temp的数据加工汇总后，写入到jd_ar005_temp2表
		insert into jd_ar005_temp2
			(request_id
			,item_big_category_name
			,customer_number
			,customer_name
			,order_type_name
			,order_quantity_uom
			,txn_transaction_date
			,line_id
			,quantity_cust
			,amount_cust
			,due_days
			 --
			,pick_slip_number
			,order_number
			,item_number
			,item_description
			,unit_selling_price
			 --,unit_cost
			 --,amount_cost
			,term_name
			,due_date
			,set_book_id
			,attribute9
			,customer_type_1)
			select p_request_id
						,item_big_category_name
						,customer_number
						,customer_name
						,order_type_name
						,order_quantity_uom
						,txn_transaction_date
						,line_id
						,sum(nvl(quantity_txn
										,0)) quantity_cust
						,sum(nvl(amount_txn
										,0)) amount_cust
						,due_days
						 --
						,pick_slip_number
						,order_number
						,item_number
						,item_description
						,unit_selling_price
						 --,unit_cost
						 --,sum(nvl(amount_cost,0)) amount_cost
						,term_name
						,pick_slip_due_date
						,set_book_id
						,attribute9
						,customer_type_1
				from (select fvt2.description item_big_category_name
										,jat5.customer_number
										,jat5.customer_name
										,jat5.order_type_name
										,jat5.order_quantity_uom
										,jat5.txn_transaction_date
										,jat5.line_id
										,sum(round(to_number(jat5.txn_quantity)
															,5)) quantity_txn
										,sum(round(to_number(jat5.txn_quantity)
															,5) * jat5.unit_selling_price) amount_txn
										,jat5.due_days
										 --
										,pick_slip_number
										,order_number
										,item_number
										,item_description
										,unit_selling_price
										 --,unit_cost
										 --,sum(to_number(jat5.txn_quantity)*jat5.unit_selling_price) amount_cost
										,jat5.term_name
										,jat5.pick_slip_due_date
										,jat5.set_book_id
										,jat5.attribute9
										,jat5.customer_type_1
								from jd_ar005_temp jat5
										 --
										,mtl_system_items_b  sib
										,mtl_item_categories mic
										,mtl_categories_b    mcb
										,fnd_flex_value_sets fvs
										,fnd_flex_values     ffv2
										,fnd_flex_values_tl  fvt2
							--
							 where jat5.request_id = p_request_id
								 and jat5.txn_quantity is not null
								 and jat5.txn_quantity != '同上'
										--
								 and jat5.inventory_item_id = sib.inventory_item_id
										--update by zhangzhen@chinasie.com
										--And 91 = sib.organization_id
								 and sib.organization_id = p_org_id --fnd_profile.Value('MFG_ORGANIZATION_ID')
										--update end.
								 and mic.category_id = mcb.category_id
								 and mic.category_set_id = 1
								 and mcb.segment1 = ffv2.flex_value
								 and fvs.flex_value_set_id = ffv2.flex_value_set_id
								 and ffv2.flex_value_id = fvt2.flex_value_id
								 and fvt2.language = 'ZHS' --userenv('LANG')
								 and fvs.flex_value_set_name = 'JD_项目大类'
								 and sib.inventory_item_id = mic.inventory_item_id
								 and sib.organization_id = mic.organization_id
							--
							 group by fvt2.description
											 ,jat5.customer_number
											 ,jat5.customer_name
											 ,jat5.order_type_name
											 ,jat5.order_quantity_uom
											 ,jat5.txn_transaction_date
											 ,jat5.line_id
											 ,jat5.due_days
												--
											 ,pick_slip_number
											 ,order_number
											 ,item_number
											 ,item_description
											 ,unit_selling_price
												--,unit_cost
												--,amount_cost
											 ,jat5.term_name
											 ,jat5.pick_slip_due_date
											 ,jat5.set_book_id
											 ,jat5.attribute9
											 ,jat5.customer_type_1
							union all
							select fvt2.description item_big_category_name
										,jat.customer_number
										,jat.customer_name
										,jat.order_type_name
										,jat.order_quantity_uom
										,jat.txn_transaction_date
										,jat.line_id
										,-sum(round(to_number(jat.quantity_delivery)
															 ,5)) quantity_txn
										,-sum(round(to_number(jat.quantity_delivery)
															 ,5) * jat.unit_selling_price) amount_txn
										,jat.due_days
										 --
										,pick_slip_number
										,order_number
										,item_number
										,item_description
										,unit_selling_price
										 --,unit_cost
										 --,amount_cost
										,jat.term_name
										,jat.pick_slip_due_date
										,jat.set_book_id
										,jat.attribute9
										,jat.customer_type_1
								from jd_ar005_temp jat
										 --
										,mtl_system_items_b  sib
										,mtl_item_categories mic
										,mtl_categories_b    mcb
										,fnd_flex_value_sets fvs
										,fnd_flex_values     ffv2
										,fnd_flex_values_tl  fvt2
							--
							 where jat.request_id = p_request_id
								 and jat.quantity_delivery is not null
										--And jat.quantity_invoiced != '同上'
								 and jat.quantity_delivery != '同上'
										--
								 and jat.inventory_item_id = sib.inventory_item_id
										--update by zhangzhen@chinasie.com
										--And 91 = sib.organization_id
								 and sib.organization_id = p_org_id --fnd_profile.Value('MFG_ORGANIZATION_ID')
										--update end.
										
								 and mic.category_id = mcb.category_id
								 and mic.category_set_id = 1
								 and mcb.segment1 = ffv2.flex_value
								 and fvs.flex_value_set_id = ffv2.flex_value_set_id
								 and ffv2.flex_value_id = fvt2.flex_value_id
								 and fvt2.language = 'ZHS' --userenv('LANG')
								 and fvs.flex_value_set_name = 'JD_项目大类'
								 and sib.inventory_item_id = mic.inventory_item_id
								 and sib.organization_id = mic.organization_id
							--
							 group by fvt2.description
											 ,jat.customer_number
											 ,jat.customer_name
											 ,jat.order_type_name
											 ,jat.order_quantity_uom
											 ,jat.txn_transaction_date
											 ,jat.line_id
											 ,jat.due_days
												--
											 ,pick_slip_number
											 ,order_number
											 ,item_number
											 ,item_description
											 ,unit_selling_price
												--,unit_cost
												--,amount_cost
											 ,jat.term_name
											 ,jat.pick_slip_due_date
											 ,jat.set_book_id
											 ,jat.attribute9
											 ,jat.customer_type_1)
			 group by item_big_category_name
							 ,customer_number
							 ,customer_name
							 ,order_type_name
							 ,order_quantity_uom
							 ,txn_transaction_date
							 ,line_id
							 ,due_days
								--
							 ,pick_slip_number
							 ,order_number
							 ,item_number
							 ,item_description
							 ,unit_selling_price
								--,unit_cost
								--,amount_cost
							 ,term_name
							 ,pick_slip_due_date
							 ,set_book_id
							 ,attribute9
							 ,customer_type_1
			having sum(nvl(quantity_txn, 0)) <> 0;
		commit;
		--第二步数据加工，将jd_ar005_temp2中的发出商品数量为负数的进行加工，将其分别核销到其所对应的订单行的其他挑库确认中。
		declare
			cursor c1 is
				select *
					from jd_ar005_temp2 jt2
				 where jt2.quantity_cust < 0
					 and jt2.request_id = p_request_id;
			--
			cursor c2(c_line_id in number) is
				select jat2.rowid
							,jat2.*
					from jd_ar005_temp2 jat2
				 where jat2.line_id = c_line_id
					 and jat2.quantity_cust > 0
					 and jat2.request_id = p_request_id
				 order by jat2.txn_transaction_date;
			--
			v_quantity number;
			v_amount   number;
		
			v_quantity_remain number;
			v_amount_remain   number;
		begin
			for r1 in c1
			loop
				v_quantity_remain := r1.quantity_cust;
				v_amount_remain   := r1.amount_cust;
				for r2 in c2(r1.line_id)
				loop
					v_quantity_remain := v_quantity_remain + r2.quantity_cust;
					v_amount_remain   := v_amount_remain + r2.amount_cust;
					--
					update jd_ar005_temp2 jat2
						 set jat2.actual_quantity_cust = decode(sign(v_quantity_remain)
																									 ,1
																									 ,v_quantity_remain
																									 ,0)
								,jat2.actual_amount_cust   = decode(sign(v_amount_remain)
																									 ,1
																									 ,v_amount_remain
																									 ,0)
					 where jat2.rowid = r2.rowid;
					if v_amount_remain >= 0
					then
						exit;
					end if;
				end loop;
			end loop;
		end;
		commit;
		--
	end;

	--应收发票清单
	procedure jd_ar002(p1                         in varchar2
										,p2                         in varchar2
										,p_org_id                   in number
										,p_start_date               in varchar2
										,p_end_date                 in varchar2
										,p_customer_number_start    in varchar2
										,p_customer_number_end      in varchar2
										,p_doc_sequence_value_start in varchar2
										,p_doc_sequence_value_end   in varchar2
										,p_cust_trx_type            in varchar2) is
		cursor c1 is
			select trx.trx_number
						,trx.attribute3 vat_trx_number
						,cust.cust_account_id customer_id
						,party.party_name customer_name
						,cust.account_number customer_number
						,trx.doc_sequence_value
						,types.name description
						,trx.trx_date
						,apsa.gl_date
						,sum(extended_amount) total_amount
						,trx.customer_trx_id
						,
						 --nvl(lines.tax_rate, 0) tax_rate,
						 sum(decode(line_type
											 ,'TAX'
											 ,extended_amount
											 ,0)) total_tax_amount
						,trx.invoice_currency_code
						,trx.exchange_rate
						,trx.attribute11
						,trx.interface_header_attribute1
						,sum(nvl(extended_amount
										,0) * nvl(trx.exchange_rate
														 ,1)) nation_total_amount
				from ra_customer_trx_lines_all lines
						,ar_payment_schedules_all  apsa
						,ra_cust_trx_types_all     types
						,ra_customer_trx_all       trx
						,hz_cust_accounts          cust
						,hz_parties                party
			 where trx.complete_flag = 'Y'
				 and trx.customer_trx_id = lines.customer_trx_id
				 and trx.cust_trx_type_id = types.cust_trx_type_id
				 and apsa.customer_trx_id = trx.customer_trx_id
				 and apsa.org_id = trx.org_id
				 and trx.bill_to_customer_id = cust.cust_account_id(+)
				 and cust.party_id = party.party_id
				 and cust.status = 'A'
				 and
						--参数
						 trx.org_id = p_org_id
				 and cust.account_number >= nvl(p_customer_number_start
																			 ,cust.account_number)
				 and cust.account_number <= nvl(p_customer_number_end
																			 ,cust.account_number)
				 and (apsa.gl_date >= to_date(p_start_date
																		 ,'yyyy/mm/dd hh24:mi:ss') or p_start_date is null)
				 and (apsa.gl_date <= to_date(p_end_date
																		 ,'yyyy/mm/dd hh24:mi:ss') or p_end_date is null)
				 and (trx.doc_sequence_value >= p_doc_sequence_value_start or p_doc_sequence_value_start is null)
				 and (trx.doc_sequence_value <= p_doc_sequence_value_end or p_doc_sequence_value_end is null)
				 and (types.name = p_cust_trx_type or p_cust_trx_type is null)
			 group by types.name
							 ,types.cust_trx_type_id
							 ,trx.doc_sequence_value
							 ,trx.trx_number
							 ,trx.attribute3
							 ,cust.cust_account_id
							 ,party.party_name
							 ,cust.account_number
							 ,trx.customer_trx_id
							 ,trx.trx_date
							 ,apsa.gl_date
							 ,trx.customer_trx_id
							 ,
								--nvl(lines.tax_rate, 0),
								trx.invoice_currency_code
							 ,trx.exchange_rate
							 ,trx.attribute11
							 ,trx.interface_header_attribute1;
		v_line_str        varchar2(4000);
		v_sep             varchar2(5);
		v_aqv             number;
		v_po_price        number;
		v_ml_price        number;
		v_inv_order_price number;
		v_vat_trx_number  varchar2(500);
		--
		v_customer_name varchar2(200);
		v_tax_rate      number;
	
		v_order_type_name varchar2(200);
	
		v_amount_jk number;
		v_amount_ye number;
	begin
		/*
    Begin
      Select customer_name
        Into v_customer_name
        From ar_CUSTOMERS rc
       Where rc.customer_number = p_customer_number_;
    Exception When Others Then
      v_customer_name := Null;
    End;*/
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '####';
		html_report_pkg.html_title(p_program_title => '应收发票清单'
															,p_report_title  => '应收发票清单');
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		html_report_pkg.output_line('发票的总帐日期，自：' || substr(p_start_date
																											,1
																											,10) || '，至：' ||
																substr(p_end_date
																			,1
																			,10));
		html_report_pkg.output_line('<BR>客户编号，自：' || p_customer_number_start || '，至：' || p_customer_number_end);
		html_report_pkg.output_line('<BR>单据编号，自：' || p_doc_sequence_value_start || '，至：' || p_doc_sequence_value_end);
		html_report_pkg.output_line('<BR>发票类型：' || p_cust_trx_type);
		html_report_pkg.output_line('<table width=2000 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '发票编号,客户名称,单据编号,发票类型,订单类型,发票日期,总帐日期,发票金额,税率,税额,币种,汇率,本位币金额,价款,未核销余额,参考,增值税发票号,';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		for r1 in c1
		loop
			begin
				select tax_rate
					into v_tax_rate
					from ra_customer_trx_lines_all
				 where customer_trx_id = r1.customer_trx_id
					 and line_type = 'TAX'
					 and rownum = 1;
			exception
				when no_data_found then
					v_tax_rate := 0;
			end;
		
			if r1.attribute11 is not null
			then
				v_order_type_name := r1.attribute11;
			else
				begin
					select ottl.name
						into v_order_type_name
						from oe_order_headers_all    oeh
								,oe_transaction_types_tl ottl
					 where oeh.order_type_id = ottl.transaction_type_id
						 and ottl.language = 'ZHS'
						 and oeh.org_id = p_org_id
						 and oeh.order_number = r1.interface_header_attribute1;
				exception
					when others then
						begin
							select document_type_name
								into v_order_type_name
								from scm_dm_headers_v
							 where document_number = r1.interface_header_attribute1;
						exception
							when others then
								v_order_type_name := null;
						end;
				end;
			end if;
		
			select get_order_type(v_order_type_name) into v_order_type_name from dual;
		
			--add 2008-10-10
			select r1.nation_total_amount - nvl(sum(amount_applied)
																				 ,0)
				into v_amount_ye
				from ar_receivable_applications_all
			 where applied_customer_trx_id = r1.customer_trx_id;
		
			--add 2013-10-08 解决红冲AR发票核销金额不对问题
			select v_amount_ye + nvl(sum(amount_applied)
															,0)
				into v_amount_ye
				from ar_receivable_applications_all
			 where customer_trx_id = r1.customer_trx_id;
		
			--
		
			v_amount_jk := r1.nation_total_amount - r1.total_tax_amount;
		
			html_report_pkg.line_title(p_title_string => r1.trx_number || v_sep || r1.customer_name || v_sep ||
																									 r1.doc_sequence_value || v_sep || r1.description || v_sep ||
																									 v_order_type_name || v_sep ||
																									 to_char(r1.trx_date
																													,'yyyy-mm-dd') || v_sep ||
																									 to_char(r1.gl_date
																													,'yyyy-mm-dd') || v_sep || r1.total_amount || v_sep ||
																									 v_tax_rate || v_sep || r1.total_tax_amount || v_sep ||
																									 r1.invoice_currency_code || v_sep || r1.exchange_rate || v_sep ||
																									 r1.nation_total_amount || v_sep || v_amount_jk || v_sep ||
																									 v_amount_ye || v_sep || r1.interface_header_attribute1 || v_sep ||
																									 r1.vat_trx_number || v_sep
																,p_delimiter    => v_sep);
		end loop;
		html_report_pkg.output_line('</tr></table></html>');
	
	end jd_ar002;

	--计算发出商品的数据，存入临时表
	-----------------------------------------------------------------------
	procedure cal_fcsp_scm(p1         out varchar2
												,p2         out varchar2
												,p_end_date varchar2
												,p_org_id   number) is
		v_end_date date;
		cursor c is
		--发货部分
			select mmt.transaction_id
						,mmt.transaction_quantity
						,mmt.transaction_uom
						,mmt.transaction_date
						 
						,scd.confirm_detail_id
						,scl.confirm_line_id
						 
						,ssd.shipment_detail_id
						,ssl.shipment_line_id
						,ssl.sale_price
						 
						,ssh.shipment_header_id
						,ssh.customer_id
						,ssh.customer_site_id
						 
						,dh.document_header_id
						,dh.document_type_id
						,dh.receive_type
						,dh.pay_days
			
				from mtl_material_transactions mmt
						,scm_so_confirm_details    scd
						,scm_so_confirm_lines      scl
						,scm_so_shipment_details   ssd
						,scm_so_shipment_lines     ssl
						,scm_so_shipment_headers   ssh
						,scm_dm_headers            dh
			 where mmt.transaction_type_id in
						 (select mtt.transaction_type_id from mtl_transaction_types mtt where mtt.transaction_type_name like 'SCM%')
				 and mmt.transaction_action_id = 2 --只取子库转移的，即只取发货到客户结算仓的数据，排除开票产生的账户别名发放的数据
				 and mmt.organization_id in
						 (select ood.organization_id from org_organization_definitions ood where ood.operating_unit = p_org_id)
				 and mmt.transaction_date <= v_end_date
				 and mmt.subinventory_code in
						 (select msi.secondary_inventory_name
								from mtl_secondary_inventories msi
							 where msi.attribute3 = '05'  --结算仓
								 and msi.organization_id in (select ood.organization_id
																							 from org_organization_definitions ood
																							where ood.operating_unit = p_org_id))
						
				 and mmt.source_line_id = scd.confirm_detail_id
				 and scd.confirm_line_id = scl.confirm_line_id
				 and scd.shipment_detail_id = ssd.shipment_detail_id
				 and ssd.shipment_line_id = ssl.shipment_line_id
				 and ssl.shipment_header_id = ssh.shipment_header_id
				 and ssh.document_header_id = dh.document_header_id
						
						--排出已开票的部分
				 and not exists (select 1
								from scm_ra_bill_lines_detail rbd
										,scm_ra_bill_lines        rbl
										,scm_ra_bill_headers      rbh
							 where rbd.shipment_detail_id = ssd.shipment_detail_id
								 and rbd.line_id = rbl.line_id
								 and rbl.header_id = rbh.header_id
								 and rbh.gl_date <= v_end_date
								 and rbh.status = 'Close');
		v_request_id number;
	begin
		select cgscm.scm_rpt_fcsp_request_s.nextval into v_request_id from dual;
		v_end_date := to_date(p_end_date
												 ,'YYYY/MM/DD hh24:mi:ss');
		fnd_file.put_line(fnd_file.log
										 ,'v_End_Date:' || v_end_date);
		--1.发出商品数据：取库存事物类型已SCM开头（即发货时子库转移，不包含开票时的账户别名发放），仓库为结算仓的库存事物。
		delete from scm_rpt_fcsp_details
		 where org_id = p_org_id
			 and end_date = v_end_date;
		for r in c
		loop
			insert into scm_rpt_fcsp_details
				(request_id
				,end_date
				,org_id
				,customer_id
				,customer_site_id
				 
				,transaction_id
				,confirm_detail_id
				,confirm_line_id
				,shipment_detail_id
				,shipment_line_id
				,shipment_header_id
				,document_header_id
				 
				,transaction_quantity
				,transaction_uom
				,transaction_date
				,sale_price
				,receive_type
				,due_days
				,document_type_id
				 
				,created_by
				,creation_date
				,last_updated_by
				,last_update_date)
				select v_request_id
							,v_end_date
							,p_org_id
							,r.customer_id
							,r.customer_site_id
							 
							,r.transaction_id
							,r.confirm_detail_id
							,r.confirm_line_id
							,r.shipment_detail_id
							,r.shipment_line_id
							,r.shipment_header_id
							,r.document_header_id
							 
							,r.transaction_quantity
							,r.transaction_uom
							,r.transaction_date
							,r.sale_price
							,r.receive_type
							,nvl(r.pay_days
									,0)
							,r.document_type_id
							 
							,0
							,sysdate
							,0
							,sysdate
					from dual;
		
		end loop;
		fnd_file.put_line(fnd_file.log
										 ,'detail complieted');
		--根据销售结算方式，取不同的计算到期日期：货到，转移到结算子库的事物日期；票到、预付款，无逾期
		update scm_rpt_fcsp_details
			 set due_days = 999999999 --设为最大数，代表不逾期
		 where receive_type in ('B'
													 ,'P')
			 and request_id = v_request_id
			 and org_id = p_org_id;
		fnd_file.put_line(fnd_file.log
										 ,'begin sum');
	
		delete from scm_rpt_fcsp_sum
		 where org_id = p_org_id
			 and end_date = v_end_date;
	
		insert into scm_rpt_fcsp_sum
			(request_id
			,end_date
			,org_id
			,customer_number
			,customer_name
			,order_type_name
			,txn_transaction_date
			,due_days
			,quantity_cust
			,actual_quantity_cust
			,amount_cust
			,actual_amount_cust)
			select rfd.request_id
						,rfd.end_date
						,p_org_id
						,ra.customer_number
						,ra.customer_name
						,dt.document_type_name order_type_name
						,transaction_date txn_transaction_date
						,due_days
						,nvl(sum(round(transaction_quantity
													,5))
								,0) quantity_cust
						,nvl(sum(round(transaction_quantity
													,5))
								,0) actual_quantity_cust
						,nvl(sum(round(transaction_quantity
													,5) * sale_price)
								,0) amount_cust
						,nvl(sum(round(transaction_quantity
													,5) * sale_price)
								,0) actual_amount_cust
				from scm_rpt_fcsp_details rfd
						,scm_dm_types         dt
						,ar_customers         ra
			 where rfd.document_type_id = dt.document_type_id
				 and rfd.customer_id = ra.customer_id
				 and rfd.request_id = v_request_id
				 and rfd.org_id = p_org_id
			 group by rfd.request_id
							 ,rfd.end_date
							 ,ra.customer_number
							 ,ra.customer_name
							 ,dt.document_type_name
							 ,transaction_date
							 ,due_days;
		fnd_file.put_line(fnd_file.log
										 ,'end sum');
		--2.客户结算仓库存其他来源数据
		delete from scm_rpt_account_oinv_details
		 where end_date = v_end_date
			 and org_id = p_org_id;
		insert into scm_rpt_account_oinv_details
			(request_id
			,end_date
			,org_id
			,subinventory_code
			,customer_number
			,customer_name
			,date_received
			,transaction_type_name
			,uom
			,qty)
			select v_request_id
						,v_end_date
						,p_org_id
						,moqd.subinventory_code
						,rc.customer_number
						,rc.customer_name
						,trunc(moqd.date_received) date_received
						,mtt.transaction_type_name
						,sib.primary_unit_of_measure uom
						,sum(moqd.primary_transaction_quantity) qty
				from mtl_onhand_quantities_detail moqd
						,mtl_system_items_b           sib
						,mtl_secondary_inventories    msi
						,mtl_material_transactions    mmt
						,mtl_transaction_types        mtt
						,ar_customers                 rc
			 where moqd.inventory_item_id = sib.inventory_item_id
				 and moqd.organization_id = sib.organization_id
				 and moqd.subinventory_code = msi.secondary_inventory_name
				 and moqd.create_transaction_id = mmt.transaction_id
				 and mmt.transaction_type_id = mtt.transaction_type_id
				 and sib.segment1 not like '106%'
						--And Moqd.Subinventory_Code Like 'K%'
						--And Moqd.Subinventory_Code Not Like 'KB%'
						--And Moqd.Subinventory_Code Not Like 'KP%'
				 and moqd.subinventory_code in
						 (select msi.secondary_inventory_name
								from mtl_secondary_inventories msi
							 where msi.attribute3 = '05'
								 and msi.organization_id in (select ood.organization_id
																							 from org_organization_definitions ood
																							where ood.operating_unit = p_org_id))
				 and mtt.transaction_type_name not like 'SCM%'
				 and mtt.transaction_type_name != '销售订单挑库' --排出历史销售订单挑库数据
						
				 and msi.attribute1 = rc.customer_id(+) --?此弹性域是否尚使用
						--参数
				 and moqd.organization_id in
						 (select ood.organization_id from org_organization_definitions ood where ood.operating_unit = p_org_id)
			--And Rc.Customer_Number >= Nvl(p_Customer_Number_Start
			--                             ,Rc.Customer_Number)
			--And Rc.Customer_Number <= Nvl(p_Customer_Number_End
			--                             ,Rc.Customer_Number)
			 group by moqd.subinventory_code
							 ,mtt.transaction_type_name
							 ,rc.customer_number
							 ,rc.customer_name
							 ,trunc(moqd.date_received)
							 ,sib.primary_unit_of_measure;
	end;

	--应收账款计息报表
	procedure receivables_accrual(p_1              out varchar2
															 ,p_2              out varchar2
															 ,p_end_date       in varchar2
															 ,p_org_id         in number
															 ,p_request_id     in number
															 ,p_order_type     in varchar2
															 ,p_order_type_n   in varchar2 default null
															 ,p_cust_num_start in varchar2
															 ,p_cust_num_end   in varchar2
															 ,p_rate1          in number
															 ,p_rate2          in number
															 ,p_rate3          in number
															 ,p_rate4          in number
															 ,p_rate5          in number) is
	
		v_request_id     number;
		v_request_id_old number;
		cursor c_ar(c_request_id     in number
							 ,v_request_id_old in number) is
			select customer_id
						,customer_number
						,customer_name
						,customer_class_code
						,customer_type_1
						,order_type_name ---/////
						,round(sum(amt_pre_receive)
									,2) amt_pre_receive
						,round(sum(amt_receive)
									,2) amt_receive
						,round(sum(amt_fcsp)
									,2) amt_fcsp
						,round(sum(amt_fcsp1)
									,2) amt_fcsp1
						,round(sum(amt_receive_not_due)
									,2) amt_receive_not_due
						,round(sum(amt_fcsp_not_due)
									,2) amt_fcsp_not_due
						,round(sum(amt_fcsp_not_due1)
									,2) amt_fcsp_not_due1
						,round(sum(amt_receive_0_30)
									,2) amt_receive_0_30
						,round(sum(amt_fcsp_0_30)
									,2) amt_fcsp_0_30
						,round(sum(amt_fcsp_0_301)
									,2) amt_fcsp_0_301
						,round(sum(amt_receive_31_90)
									,2) amt_receive_31_90
						,round(sum(amt_fcsp_31_90)
									,2) amt_fcsp_31_90
						,round(sum(amt_fcsp_31_901)
									,2) amt_fcsp_31_901
						,round(sum(amt_receive_91_180)
									,2) amt_receive_91_180
						,round(sum(amt_fcsp_91_180)
									,2) amt_fcsp_91_180
						,round(sum(amt_fcsp_91_1801)
									,2) amt_fcsp_91_1801
						,round(sum(amt_receive_181_360)
									,2) amt_receive_181_360
						,round(sum(amt_fcsp_181_360)
									,2) amt_fcsp_181_360
						,round(sum(amt_fcsp_181_3601)
									,2) amt_fcsp_181_3601
						,round(sum(amt_receive_361)
									,2) amt_receive_361
						,round(sum(amt_fcsp_361)
									,2) amt_fcsp_361
						,round(sum(amt_fcsp_3611)
									,2) amt_fcsp_3611
				from (
							--发出商品
							select customer_id
										 ,customer_number
										 ,customer_name
										 ,customer_class_code
										 ,customer_type_1
										 ,order_type_name
										 ,sum(0) amt_pre_receive
										 ,0 amt_receive
										 ,sum(nvl(amt
														 ,0)) amt_fcsp
										 ,sum(nvl(amt1
														 ,0)) amt_fcsp1
										 ,0 amt_receive_not_due
										 ,sum(nvl(amt_not_due
														 ,0)) amt_fcsp_not_due
										 ,sum(nvl(amt_not_due1
														 ,0)) amt_fcsp_not_due1
										 ,0 amt_receive_0_30
										 ,sum(nvl(amt_0_30
														 ,0)) amt_fcsp_0_30
										 ,sum(nvl(amt_0_301
														 ,0)) amt_fcsp_0_301
										 ,0 amt_receive_31_90
										 ,sum(nvl(amt_31_90
														 ,0)) amt_fcsp_31_90
										 ,sum(nvl(amt_31_901
														 ,0)) amt_fcsp_31_901
										 ,0 amt_receive_91_180
										 ,sum(nvl(amt_91_180
														 ,0)) amt_fcsp_91_180
										 ,sum(nvl(amt_91_1801
														 ,0)) amt_fcsp_91_1801
										 ,0 amt_receive_181_360
										 ,sum(nvl(amt_181_360
														 ,0)) amt_fcsp_181_360
										 ,sum(nvl(amt_181_3601
														 ,0)) amt_fcsp_181_3601
										 ,0 amt_receive_361
										 ,sum(nvl(amt_361
														 ,0)) amt_fcsp_361
										 ,sum(nvl(amt_3611
														 ,0)) amt_fcsp_3611
								from (select rc.customer_id
														 ,jat2.customer_number
														 ,jat2.customer_name
														 ,rc.customer_class_code
														 ,rc.attribute1 customer_type_1
														 ,scm_ar_report_pkg.get_order_type(jat2.order_type_name) order_type_name
														 ,sum(nvl(jat2.actual_quantity_cust
																		 ,jat2.quantity_cust)) qty
														 ,sum(nvl(jat2.actual_amount_cust
																		 ,jat2.amount_cust)) amt
														 ,0 amt1
															--
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date))
																		,-1
																		,sum(nvl(nvl(actual_quantity_cust
																								,quantity_cust)
																						,0))
																		,0) qty_not_due
														 ,0 qty_not_due1 --<0
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date))
																		,-1
																		,sum(nvl(actual_amount_cust
																						,amount_cust))
																		,0) amt_not_due
														 ,0 amt_not_due1 --<0
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date))
																		,-1
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 30)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_0_30
														 ,0 qty_0_301 -->=0 and <=30
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date))
																		,-1
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 30)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_0_30
														 ,0 amt_0_301 -->=0 and <=30
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 30)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 90)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_31_90
														 ,0 qty_31_901 -->30 and <=90
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 30)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 90)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_31_90
														 ,0 amt_31_901 -->30 and <=90                                                                                                      -->60 and <=90
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 90)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 180)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_91_180
														 ,0 qty_91_1801 -->90 and <=180
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 90)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 180)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_91_180
														 ,0 amt_91_1801 -->90 and <=180
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 180)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 360)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_181_360
														 ,0 qty_181_3601 -->180 and <=360
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 180)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 360)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_181_360
														 ,0 amt_181_3601 -->180 and <=360
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 360)
																		,-1
																		,0
																		,0
																		,0
																		,sum(nvl(nvl(actual_quantity_cust
																								,quantity_cust)
																						,0))) qty_361
														 ,0 qty_3611 -->360
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 360)
																		,-1
																		,0
																		,0
																		,0
																		,sum(nvl(actual_amount_cust
																						,amount_cust))) amt_361
														 ,0 amt_3611 -->360
												 from scm_rpt_fcsp_sum jat2
														 ,ar_customers     rc
												where jat2.quantity_cust > 0
													and jat2.customer_number = rc.customer_number
													and jat2.sub_type = '01'
														 --                             --另外需要获取最大的request_id
													and jat2.request_id = v_request_id
													and jat2.customer_number between nvl(p_cust_num_start
																															,jat2.customer_number) and
															nvl(p_cust_num_end
																 ,jat2.customer_number)
													and jat2.order_type_name = nvl(p_order_type_n
																												,jat2.order_type_name)
												group by rc.customer_id
																,jat2.customer_number
																,jat2.customer_name
																,rc.customer_class_code
																,rc.attribute1
																,scm_ar_report_pkg.get_order_type(jat2.order_type_name)
																,jat2.transaction_date
											 -- ,jat2.due_days
											 union all
											 select rc.customer_id
														 ,jat2.customer_number
														 ,jat2.customer_name
														 ,rc.customer_class_code
														 ,rc.attribute1 customer_type_1
														 ,scm_ar_report_pkg.get_order_type(jat2.order_type_name)
														 ,sum(nvl(jat2.actual_quantity_cust
																		 ,jat2.quantity_cust)) qty
														 ,0 amt
														 ,sum(nvl(jat2.actual_amount_cust
																		 ,jat2.amount_cust)) amt1
															--
														 ,0 qty_not_due
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date))
																		,-1
																		,sum(nvl(nvl(actual_quantity_cust
																								,quantity_cust)
																						,0))
																		,0) qty_not_due1
														 ,0 amt_not_due1 --<0
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date))
																		,-1
																		,sum(nvl(actual_amount_cust
																						,amount_cust))
																		,0) amt_not_due1
														 ,0 qty_0_30 --<0
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date))
																		,-1
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 30)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_0_301
														 ,0 amt_0_30 -->=0 and <=30
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date))
																		,-1
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 30)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_0_301
														 ,0 qty_31_60 -->=0 and <=30
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 30)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 90)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_31_901
														 ,0 amt_31_90 -->30 and <=90
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 30)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 90)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_31_901
														 ,0 qty_91_180
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 90)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 180)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_91_1801
														 ,0 amt_91_180 -->90 and <=180
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 90)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 180)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_91_1801
														 ,0 qty_181_360 -->90 and <=180
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 180)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 360)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_181_3601
														 ,0 amt_181_360 -->180 and <=360
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 180)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(transaction_date) - 360)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_181_3601
														 ,0 qty_361
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 360)
																		,-1
																		,0
																		,0
																		,0
																		,sum(nvl(nvl(actual_quantity_cust
																								,quantity_cust)
																						,0))) qty_3611
														 ,0 amt_361 -->360
														 ,decode(sign(trunc(sysdate) - trunc(transaction_date) - 360)
																		,-1
																		,0
																		,0
																		,0
																		,sum(nvl(actual_amount_cust
																						,amount_cust))) amt_3611 -->360
												 from scm_rpt_fcsp_sum jat2
														 ,ar_customers     rc
												where jat2.quantity_cust > 0
													and jat2.customer_number = rc.customer_number
													and jat2.sub_type = '02'
														 --                             --另外需要获取最大的request_id
													and jat2.request_id = v_request_id
													and jat2.customer_number between nvl(p_cust_num_start
																															,jat2.customer_number) and
															nvl(p_cust_num_end
																 ,jat2.customer_number)
													and jat2.order_type_name = nvl(p_order_type_n
																												,jat2.order_type_name)
												group by rc.customer_id
																,jat2.customer_number
																,jat2.customer_name
																,rc.customer_class_code
																,rc.attribute1
																,scm_ar_report_pkg.get_order_type(jat2.order_type_name)
																,jat2.transaction_date
											 -- ,jat2.due_days
											 union all
											 select rc.customer_id
														 ,jat2.customer_number
														 ,jat2.customer_name
														 ,rc.customer_class_code
														 ,rc.attribute1 customer_type_1
														 ,scm_ar_report_pkg.get_order_type(jat2.order_type_name) order_type_name
														 ,sum(nvl(jat2.actual_quantity_cust
																		 ,jat2.quantity_cust)) qty
														 ,sum(nvl(jat2.actual_amount_cust
																		 ,jat2.amount_cust)) amt
														 ,0
															--
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')))
																		,-1
																		,sum(nvl(nvl(actual_quantity_cust
																								,quantity_cust)
																						,0))
																		,0) qty_not_due --<0
														 ,0
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')))
																		,-1
																		,sum(nvl(actual_amount_cust
																						,amount_cust))
																		,0) amt_not_due --<0
														 ,0
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')))
																		,-1
																		,0
																		,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																							 ,'yyyy-mm-dd')) - 30)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_0_30 -->=0 and <=30
														 ,0
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')))
																		,-1
																		,0
																		,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																							 ,'yyyy-mm-dd')) - 30)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_0_30
														 ,0 -->=0 and <=30
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')) - 30)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																							 ,'yyyy-mm-dd')) - 90)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_31_90
														 ,0 -->30 and <=90
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')) - 30)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																							 ,'yyyy-mm-dd')) - 90)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_31_90
														 ,0 -->30 and <=60
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')) - 90)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																							 ,'yyyy-mm-dd')) - 180)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_91_180 -->90 and <=180
														 ,0
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')) - 90)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																							 ,'yyyy-mm-dd')) - 180)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_91_180 -->90 and <=180
														 ,0
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')) - 180)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																							 ,'yyyy-mm-dd')) - 360)
																					 ,1
																					 ,0
																					 ,sum(nvl(nvl(actual_quantity_cust
																											 ,quantity_cust)
																									 ,0)))) qty_181_360 -->180 and <=360
														 ,0
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')) - 180)
																		,-1
																		,0
																		,0
																		,0
																		,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																							 ,'yyyy-mm-dd')) - 360)
																					 ,1
																					 ,0
																					 ,sum(nvl(actual_amount_cust
																									 ,amount_cust)))) amt_181_360 -->180 and <=360
														 ,0
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')) - 360)
																		,-1
																		,0
																		,0
																		,0
																		,sum(nvl(nvl(actual_quantity_cust
																								,quantity_cust)
																						,0))) qty_361 -->360
														 ,0
														 ,decode(sign(trunc(sysdate) - trunc(to_date(txn_transaction_date
																																				,'yyyy-mm-dd')) - 360)
																		,-1
																		,0
																		,0
																		,0
																		,sum(nvl(actual_amount_cust
																						,amount_cust))) amt_361 -->360
														 ,0
												 from jd_ar005_temp2 jat2
														 ,ar_customers   rc
												where jat2.quantity_cust > 0
													and jat2.customer_number = rc.customer_number
														 --另外需要获取最大的request_id
													and jat2.request_id = v_request_id_old
													and jat2.customer_number between nvl(p_cust_num_start
																															,jat2.customer_number) and
															nvl(p_cust_num_end
																 ,jat2.customer_number)
													and jat2.order_type_name = nvl(p_order_type
																												,jat2.order_type_name)
												group by rc.customer_id
																,jat2.customer_number
																,jat2.customer_name
																,rc.customer_class_code
																,rc.attribute1
																,scm_ar_report_pkg.get_order_type(jat2.order_type_name)
																,jat2.txn_transaction_date
											 --,jat2.due_days
											 )
							 group by customer_id
												,customer_number
												,customer_name
												,customer_class_code
												,customer_type_1
												,order_type_name
							--应收帐款
							union all
							select t.customer_id
										 ,hca.account_number
										 ,hp.party_name
										 ,hca.customer_class_code cust_class
										 ,hca.attribute1 customer_type_1
										 ,t.order_type
										 ,scm_ar_report_pkg.get_prepay(p_org_id
																									,p_end_date
																									,t.customer_id
																									,t.order_type) amt_pre_receive
										 ,sum(ar_amount) amt_receive
										 ,0 amt_fcsp
										 ,0 amt_fcsp1
										 ,sum(ar_00) amt_receive_not_due
										 ,0 amt_fcsp_not_due
										 ,0
										 ,sum(ar_30) amt_receive_0_30
										 ,0 amt_fcsp_0_30
										 ,0
										 ,sum(ar_90) amt_receive_31_90
										 ,0 amt_fcsp_31_90
										 ,0
										 ,sum(ar_180) amt_receive_91_180
										 ,0 amt_fcsp_91_180
										 ,0
										 ,sum(ar_360) amt_receive_181_360
										 ,0 amt_fcsp_181_360
										 ,0
										 ,sum(ar_361) amt_receive_361
										 ,0 amt_fcsp_361
										 ,0
								from (select a.customer_id
														 ,c.name
														 ,a.order_type
														 ,(a.sum_amount - nvl(b.app_amount
																								 ,0)) * nvl(c.rate
																													 ,1) ar_amount
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date)
																		,1
																		,0
																		,(a.sum_amount - nvl(b.app_amount
																												,0)) * nvl(c.rate
																																	,1)) ar_00
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date)
																		,1
																		,decode(sign(to_date(substr(p_end_date
																															 ,1
																															 ,10)
																												,'yyyy/mm/dd') - a.trx_date - 30)
																					 ,1
																					 ,0
																					 ,a.sum_amount - nvl(b.app_amount
																															,0)) * nvl(c.rate
																																				,1)) ar_30
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - 30)
																		,1
																		,decode(sign(to_date(substr(p_end_date
																															 ,1
																															 ,10)
																												,'yyyy/mm/dd') - a.trx_date - 90)
																					 ,1
																					 ,0
																					 ,a.sum_amount - nvl(b.app_amount
																															,0)) * nvl(c.rate
																																				,1)) ar_90
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - 90)
																		,1
																		,decode(sign(to_date(substr(p_end_date
																															 ,1
																															 ,10)
																												,'yyyy/mm/dd') - a.trx_date - 180)
																					 ,1
																					 ,0
																					 ,sum_amount - nvl(b.app_amount
																														,0)) * nvl(c.rate
																																			,1)) ar_180
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - 180)
																		,1
																		,decode(sign(to_date(substr(p_end_date
																															 ,1
																															 ,10)
																												,'yyyy/mm/dd') - a.trx_date - 360)
																					 ,1
																					 ,0
																					 ,sum_amount - nvl(b.app_amount
																														,0)) * nvl(c.rate
																																			,1)) ar_360
														 ,decode(sign(to_date(substr(p_end_date
																												,1
																												,10)
																								 ,'yyyy/mm/dd') - a.trx_date - 360)
																		,1
																		,a.sum_amount - nvl(b.app_amount
																											 ,0)) * nvl(c.rate
																																 ,1) ar_361
											 
												 from (select rcta.trx_number
																		 ,rcta.customer_trx_id
																		 ,rcta.bill_to_customer_id customer_id
																		 ,nvl(get_pre_date(rcta.customer_trx_id)
																				 ,trunc(rctlgd.gl_date)) trx_date
																		 ,rctt.name inv_type
																		 ,nvl(scm_ar_report_pkg.get_term(rcta.customer_trx_id)
																				 ,rcta.term_id) term_id
																		 ,scm_ar_report_pkg.get_order_type(decode(nvl(rcta.attribute11
																																								 ,'N/A')
																																						 ,'N/A'
																																						 ,decode(substr(interface_header_attribute3
																																													 ,1
																																													 ,2)
																																										,'KP'
																																										,decode(rcta.interface_header_attribute12
																																													 ,'N/A'
																																													 ,interface_header_attribute2
																																													 ,null
																																													 ,'空订单类型'
																																													 ,rcta.interface_header_attribute12)
																																										,decode(rcta.interface_header_attribute2
																																													 ,'0'
																																													 ,'空订单类型'
																																													 ,null
																																													 ,'空订单类型'
																																													 ,rcta.interface_header_attribute2))
																																						 ,rcta.attribute11)) order_type --
																		 ,rcta.invoice_currency_code curr_code
																		 ,sum(rctlgd.amount * nvl(rcta.exchange_rate
																														 ,1)) sum_amount
																 from ra_customer_trx_all          rcta
																		 ,ra_customer_trx_lines_all    rctla
																		 ,ra_cust_trx_types_all        rctt
																		 ,ra_cust_trx_line_gl_dist_all rctlgd
																where rcta.customer_trx_id = rctla.customer_trx_id
																	and rcta.org_id = p_org_id
																	and rcta.complete_flag = 'Y'
																	and rcta.cust_trx_type_id = rctt.cust_trx_type_id
																	and rctla.customer_trx_line_id = rctlgd.customer_trx_line_id
																	and rctt.post_to_gl = 'Y'
																	and rctt.accounting_affect_flag = 'Y' --过滤发票
																		 --单据类型
																	and (scm_ar_report_pkg.get_order_type(decode(nvl(rcta.attribute11
																																									,'N/A')
																																							,'N/A'
																																							,decode(rcta.interface_header_attribute2
																																										 ,'0'
																																										 ,'空订单类型'
																																										 ,null
																																										 ,'空订单类型'
																																										 ,rcta.interface_header_attribute2)
																																							,rcta.attribute11)) in
																			(p_order_type
																			 ,p_order_type_n) or (p_order_type is null and p_order_type_n is null))
																		 
																	and rctlgd.gl_date <= to_date(substr(p_end_date
																																			,1
																																			,10)
																															 ,'yyyy/mm/dd') + 1439 / 1440
																group by rcta.trx_number
																				,rcta.customer_trx_id
																				,rcta.bill_to_customer_id
																				,rctlgd.gl_date
																				,rctt.name
																				,rcta.invoice_currency_code
																				,scm_ar_report_pkg.get_order_type(decode(nvl(rcta.attribute11
																																										,'N/A')
																																								,'N/A'
																																								,decode(substr(interface_header_attribute3
																																															,1
																																															,2)
																																											 ,'KP'
																																											 ,decode(rcta.interface_header_attribute12
																																															,'N/A'
																																															,interface_header_attribute2
																																															,null
																																															,'空订单类型'
																																															,rcta.interface_header_attribute12)
																																											 ,decode(rcta.interface_header_attribute2
																																															,'0'
																																															,'空订单类型'
																																															,null
																																															,'空订单类型'
																																															,rcta.interface_header_attribute2))
																																								,rcta.attribute11))
																				,rcta.term_id) a
														 ,(select araa.applied_customer_trx_id
																		 ,sum(araa.amount_applied * nvl(ps.exchange_rate
																																	 ,1)) app_amount
																 from ar_receivable_applications_all araa
																		 ,ar_cash_receipts_all           acra
																		 ,ar_payment_schedules_all       ps
																where araa.cash_receipt_id = acra.cash_receipt_id
																	and ps.payment_schedule_id = araa.applied_payment_schedule_id
																	and nvl(araa.status
																				 ,'APP') = 'APP'
																	and araa.gl_date <= to_date(substr(p_end_date
																																		,1
																																		,10)
																														 ,'yyyy/mm/dd') + 1439 / 1440
																	and acra.org_id = p_org_id
																		 
																	and (scm_ar_report_pkg.get_order_type(nvl(acra.attribute1
																																					 ,'空订单类型')) in
																			(p_order_type
																			 ,p_order_type_n) or (p_order_type is null and p_order_type_n is null))
															 
																group by araa.applied_customer_trx_id
															 having sum(araa.amount_applied) <> 0) b
														 ,(select rtb.term_id
																		 ,rtl.relative_amount / rtb.base_amount rate
																		 ,rtl.due_days
																		 ,rtt.name
																 from ra_terms_b     rtb
																		 ,ra_terms_lines rtl
																		 ,ra_terms_tl    rtt
																where rtb.term_id = rtl.term_id
																	and rtb.term_id = rtt.term_id
																	and rtt.language = userenv('LANG')) c
												where b.applied_customer_trx_id(+) = a.customer_trx_id
													and a.term_id = c.term_id(+)) t
										 ,hz_cust_accounts hca
										 ,hz_parties hp
							 where t.customer_id = hca.cust_account_id
								 and hca.party_id = hp.party_id
								 and hca.account_number between nvl(p_cust_num_start
																									 ,hca.account_number) and
										 nvl(p_cust_num_end
												,hca.account_number)
							 group by hca.customer_class_code
												,hca.attribute1
												,hp.party_name
												,t.order_type
												,t.customer_id
												,hca.account_number
							--预收款，不能获取帐龄，只反应总金额
							union all
							select acra.pay_from_customer customer_id_1
										 ,hca.account_number account_number_1
										 ,hp.party_name party_name_1
										 ,hca.customer_class_code cust_class_1
										 ,hca.attribute1 customer_type_1
										 ,scm_ar_report_pkg.get_order_type(nvl(acra.attribute1
																													,'空订单类型')) order_type_1
										 ,sum(araa.amount_applied * nvl(acra.exchange_rate
																									 ,1)) amt_pre_receive
										 ,0 amt_receive
										 ,0 amt_fcsp
										 ,0 amt_fcsp1
										 ,0 amt_receive_not_due
										 ,0 amt_fcsp_not_due
										 ,0
										 ,0 amt_receive_0_30
										 ,0 amt_fcsp_0_30
										 ,0
										 ,0 amt_receive_31_90
										 ,0 amt_fcsp_31_90
										 ,0
										 ,0 amt_receive_91_180
										 ,0 amt_fcsp_91_180
										 ,0
										 ,0 amt_receive_181_360
										 ,0 amt_fcsp_181_360
										 ,0
										 ,0 amt_receive_361
										 ,0 amt_fcsp_361
										 ,0
								from ar_cash_receipts_all           acra
										 ,ar_receivable_applications_all araa
										 ,hz_cust_accounts               hca
										 ,hz_parties                     hp
							 where acra.cash_receipt_id = araa.cash_receipt_id
								 and acra.org_id = p_org_id
								 and hca.account_number between nvl(p_cust_num_start
																									 ,hca.account_number) and
										 nvl(p_cust_num_end
												,hca.account_number)
								 and araa.gl_date <= to_date(substr(p_end_date
																									 ,1
																									 ,10)
																						,'yyyy/mm/dd')
								 and acra.pay_from_customer = hca.cust_account_id
								 and hca.party_id = hp.party_id
										
								 and (scm_ar_report_pkg.get_order_type(nvl(acra.attribute1
																													,'空订单类型')) in
										 (p_order_type
											,p_order_type_n) or (p_order_type is null and p_order_type_n is null))
										
								 and araa.status = 'UNAPP'
								 and not exists (select 1
												from ra_customer_trx_all          rcta
														,ra_customer_trx_lines_all    rctla
														,ra_cust_trx_types_all        rctt
														,ra_cust_trx_line_gl_dist_all rctlgd
											 where rcta.customer_trx_id = rctla.customer_trx_id
												 and rcta.org_id = p_org_id
												 and rcta.complete_flag = 'Y'
												 and rcta.customer_trx_id = rctlgd.customer_trx_id
												 and rctla.customer_trx_line_id = rctlgd.customer_trx_line_id
												 and rcta.cust_trx_type_id = rctt.cust_trx_type_id
												 and rctt.post_to_gl = 'Y'
												 and rctt.accounting_affect_flag = 'Y' --过滤发票
												 and rcta.bill_to_customer_id = acra.pay_from_customer
												 and scm_ar_report_pkg.get_order_type(decode(nvl(rcta.attribute11
																																				,'N/A')
																																		,'N/A'
																																		,decode(substr(interface_header_attribute3
																																									,1
																																									,2)
																																					 ,'KP'
																																					 ,decode(rcta.interface_header_attribute12
																																									,'N/A'
																																									,interface_header_attribute2
																																									,null
																																									,'空订单类型'
																																									,rcta.interface_header_attribute12)
																																					 ,decode(rcta.interface_header_attribute2
																																									,'0'
																																									,'空订单类型'
																																									,null
																																									,'空订单类型'
																																									,rcta.interface_header_attribute2))
																																		,rcta.attribute11)) =
														 scm_ar_report_pkg.get_order_type(nvl(acra.attribute1
																																 ,'空订单类型'))
												 and rctlgd.gl_date <= to_date(substr(p_end_date
																														 ,1
																														 ,10)
																											,'yyyy/mm/dd') + 1439 / 1440)
							 group by hca.customer_class_code
												,hca.attribute1
												,acra.pay_from_customer
												,hca.account_number
												,hp.party_name
												,scm_ar_report_pkg.get_order_type(nvl(acra.attribute1
																														 ,'空订单类型'))
							having sum(araa.amount_applied * nvl(acra.exchange_rate, 1)) != 0)
			 group by customer_class_code
							 ,customer_type_1
							 ,customer_number
							 ,customer_id
							 ,customer_name
							 ,order_type_name;
	
		v_line_str varchar2(4000);
		v_sep      varchar2(5);
	
		--
		v_qty                number := 0;
		v_amt                number := 0;
		v_amt_actual_receive number; --实际应收余额
		v_amt_pre_receive    number; --预收余额
		v_amt_receive_total  number; --应收总计
		v_amt_0_30           number; --1个月内
		v_amt_31_90          number; -- 2-3个月
		v_amt_91_180         number; -- 4-6个月
		v_amt_181_360        number; -- 7-12个月
		v_amt_361            number; -- 一年以上
		v_amt_discount       number; --应计利息
		v_org_id             number;
		v_organization_id    number;
		v_amt_due            number;
	begin
		-------------应收帐款帐龄分析总表原数据-------------------
		/*select t.organization_id
      into v_org_id
      from hr_organization_information_v t
     where t.org_information_context = 'Operating Unit Information'
       and t.org_information3 = p_set_of_books_id
       and rownum = 1;
    select max(request_id)
      into v_request_id
      from scm_rpt_fcsp_sum
     where end_date = trunc(to_date(p_end_date
                                   ,'YYYY/MM/DD hh24:mi:ss'))
       and org_id = v_org_id;
    if (v_request_id is null)
    then
      cal_fcsp(p_1
               ,p_2
               ,p_end_date
               ,v_org_id);
      commit;
    
      select max(request_id)
        into v_request_id
        from scm_rpt_fcsp_sum
       where end_date = trunc(to_date(p_end_date
                                     ,'YYYY/MM/DD hh24:mi:ss'))
         and org_id = v_org_id;
    end if;
    fnd_file.put_line(fnd_file.log
                     ,'v_Request_Id' || v_request_id);
    --取旧报表的数据
    select max(jat.request_id)
      into v_request_id_old
      from jd_ar005_temp        jat
          ,oe_order_headers_all oeh
          ,oe_order_lines_all   oel
          ,jd_set_books_org_v   sob
     where to_char(jat.request_date
                  ,'yyyy/mm/dd') = substr(p_end_date
                                         ,1
                                         ,10)
       and oeh.header_id = oel.header_id
       and oel.line_id = jat.line_id
       and oeh.org_id = sob.organization_id
       and sob.set_of_books_id = p_set_of_books_id
       and jat.set_book_id = p_set_of_books_id;
    --如果没有运行旧的报表则运行旧的报表
    select decode(v_org_id
                 ,89
                 ,91
                 ,94
                 ,95
                 ,98
                 ,100
                 ,0)
      into v_organization_id
      from dual;
    if (v_request_id_old is null)
    then
      jd_ar_report_new_new_pkg.jd_ar005(p1                   => p_1
                                       ,p2                   => p_2
                                       ,p_org_id             => v_organization_id
                                       ,p_customer_num_from  => p_cust_num_start
                                       ,p_customer_num_to    => p_cust_num_end
                                       ,p_order_date_from    => null
                                       ,p_order_date_to      => null
                                       ,p_pickslip_date_from => null
                                       ,p_pickslip_date_to   => p_end_date
                                       ,p_order_num_from     => null
                                       ,p_order_num_to       => null
                                       ,p_order_status       => null
                                       ,p_order_type_id      => null
                                       ,p_type               => null
                                       ,p_userid             => null
                                       ,p_fcsp_schedule      => 'Y');
      select max(jat.request_id)
        into v_request_id_old
        from jd_ar005_temp        jat
            ,oe_order_headers_all oeh
            ,oe_order_lines_all   oel
            ,jd_set_books_org_v   sob
       where to_char(jat.request_date
                    ,'yyyy/mm/dd') = substr(p_end_date
                                           ,1
                                           ,10)
         and oeh.header_id = oel.header_id
         and oel.line_id = jat.line_id
         and oeh.org_id = sob.organization_id
         and sob.set_of_books_id = p_set_of_books_id
         and jat.set_book_id = p_set_of_books_id;
    end if;*/
	
		select distinct old_request_id
									 ,request_id
			into v_request_id_old
					,v_request_id
			from scm_yszl_temp
		 where request_id = p_request_id;
	
		-------------报表输出---------------------------------
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '####';
		html_report_pkg.html_title(p_program_title => '应收账款计息表'
															,p_report_title  => '应收账款计息表');
		html_report_pkg.output_line('打印时间：' || to_char(sysdate
																									,'yyyy-mm-dd hh24:mi'));
		html_report_pkg.output_line('<BR>截止日期：' || substr(p_end_date
																										 ,1
																										 ,10));
		if p_cust_num_start is not null or
			 p_cust_num_end is not null
		then
			html_report_pkg.output_line('<BR>客户编号，自：' || p_cust_num_start || '，至：' || p_cust_num_end);
		end if;
	
		if p_order_type is not null
		then
			html_report_pkg.output_line('<BR>订单类型：' || p_order_type);
		end if;
	
		html_report_pkg.output_line('<table width=2000 style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '客户编号,客户名称,订单类型,实际应收余额,预收余额,应收总计,1个月内,2-3个月,4-6个月,7-12个月,一年以上,应计利息(万元),';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		for c1 in c_ar(v_request_id
									,v_request_id_old)
		loop
		
			v_amt_pre_receive := 0;
			--加上未发货部分的
			v_amt_pre_receive    := nvl(c1.amt_pre_receive
																 ,0) + nvl(v_amt_pre_receive
																					,0);
			v_amt_actual_receive := nvl(c1.amt_receive
																 ,0) + nvl(c1.amt_fcsp
																					,0) + nvl(c1.amt_fcsp1
																									 ,0) - nvl(v_amt_pre_receive
																														,0); --实际应收余额=应收总计-预收余额
		
			v_amt_due  := nvl(c1.amt_receive_not_due
											 ,0) + nvl(c1.amt_fcsp_not_due
																,0) + nvl(c1.amt_fcsp_not_due1
																				 ,0);
			v_amt_0_30 := nvl(c1.amt_receive_0_30
											 ,0) + nvl(c1.amt_fcsp_0_30
																,0) + nvl(c1.amt_fcsp_0_301
																				 ,0) + v_amt_due;
			/*+nvl(c1.amt_receive_not_due
      ,0) + nvl(c1.amt_fcsp_not_due
               ,0) + nvl(c1.amt_fcsp_not_due1
                        ,0);*/
			v_amt_31_90   := nvl(c1.amt_receive_31_90
													,0) + nvl(c1.amt_fcsp_31_90
																	 ,0) + nvl(c1.amt_fcsp_31_901
																						,0);
			v_amt_91_180  := nvl(c1.amt_receive_91_180
													,0) + nvl(c1.amt_fcsp_91_180
																	 ,0) + nvl(c1.amt_fcsp_91_1801
																						,0);
			v_amt_181_360 := nvl(c1.amt_receive_181_360
													,0) + nvl(c1.amt_fcsp_181_360
																	 ,0) + nvl(c1.amt_fcsp_181_3601
																						,0);
			v_amt_361     := nvl(c1.amt_receive_361
													,0) + nvl(c1.amt_fcsp_361
																	 ,0) + nvl(c1.amt_fcsp_3611
																						,0);
			-------------报表数据加工---------------------------------                                  
			--若实际应收余额大于0且，预收余额大于0，则预收余额为0.
			if (v_amt_actual_receive > 0 and v_amt_pre_receive > 0)
			then
				--一年以上
				if (v_amt_pre_receive - v_amt_361 > 0)
				then
					v_amt_pre_receive := v_amt_pre_receive - v_amt_361;
					v_amt_361         := 0;
					-- 7-12个月
					if (v_amt_pre_receive - v_amt_181_360 > 0)
					then
						v_amt_pre_receive := v_amt_pre_receive - v_amt_181_360;
						v_amt_181_360     := 0;
						-- 4-6个月
						if (v_amt_pre_receive - v_amt_91_180 > 0)
						then
							v_amt_pre_receive := v_amt_pre_receive - v_amt_91_180;
							v_amt_91_180      := 0;
							-- 2-3个月
							if (v_amt_pre_receive - v_amt_31_90 > 0)
							then
								v_amt_pre_receive := v_amt_pre_receive - v_amt_31_90;
								v_amt_31_90       := 0;
								--1个月内
								if (v_amt_pre_receive - v_amt_0_30 > 0)
								then
									v_amt_pre_receive := v_amt_pre_receive - v_amt_0_30;
									v_amt_0_30        := 0;
								else
									v_amt_0_30        := v_amt_0_30 - v_amt_pre_receive;
									v_amt_pre_receive := 0;
								end if;
							else
								v_amt_31_90       := v_amt_31_90 - v_amt_pre_receive;
								v_amt_pre_receive := 0;
							end if;
						else
							v_amt_91_180      := v_amt_91_180 - v_amt_pre_receive;
							v_amt_pre_receive := 0;
						end if;
					else
						v_amt_181_360     := v_amt_181_360 - v_amt_pre_receive;
						v_amt_pre_receive := 0;
					end if;
				else
					v_amt_361         := v_amt_361 - v_amt_pre_receive;
					v_amt_pre_receive := 0;
				end if;
			
				--若“实际应收余额”<0，则“实际应收余额”= -“预收余额”
			elsif (v_amt_actual_receive < 0 and v_amt_pre_receive > 0)
			then
				v_amt_pre_receive := v_amt_pre_receive - v_amt_0_30 - v_amt_31_90 - v_amt_91_180 - v_amt_181_360 - v_amt_361;
				--v_amt_actual_receive := 0 - v_amt_pre_receive;
				v_amt_0_30    := 0;
				v_amt_31_90   := 0;
				v_amt_91_180  := 0;
				v_amt_181_360 := 0;
				v_amt_361     := 0;
				--若“实际应收余额”=0 则 预收余额=0
			elsif (v_amt_actual_receive = 0 and v_amt_pre_receive > 0)
			then
				v_amt_pre_receive := 0;
				v_amt_0_30        := 0;
				v_amt_31_90       := 0;
				v_amt_91_180      := 0;
				v_amt_181_360     := 0;
				v_amt_361         := 0;
			end if;
		
			v_amt_receive_total := v_amt_actual_receive + nvl(v_amt_pre_receive
																											 ,0); --应收总计
			--应计利息
			v_amt_discount := round((v_amt_0_30 * p_rate1 + v_amt_31_90 * p_rate2 + v_amt_91_180 * p_rate3 +
															v_amt_181_360 * p_rate4 + v_amt_361 * p_rate5 - v_amt_pre_receive * p_rate1) / 10000
														 ,6);
			html_report_pkg.line_title(p_title_string    => c1.customer_number || v_sep || c1.customer_name || v_sep ||
																											c1.order_type_name || v_sep || v_amt_actual_receive ||
																											'***align=right' || v_sep || v_amt_pre_receive ||
																											'***align=right' || v_sep || v_amt_receive_total ||
																											'***align=right' || v_sep || v_amt_0_30 || '***align=right' ||
																											v_sep || v_amt_31_90 || '***align=right' || v_sep || v_amt_91_180 ||
																											'***align=right' || v_sep || v_amt_181_360 || '***align=right' ||
																											v_sep || v_amt_361 || '***align=right' || v_sep || v_amt_discount ||
																											'***align=right' || v_sep
																,p_with_other_attr => 'Y'
																,p_attr_delimiter  => '***'
																,p_delimiter       => v_sep);
		end loop;
	
		html_report_pkg.output_line('</tr></table></html>');
	end receivables_accrual;

	--现有量非子库存转移报表
	procedure onhand_notranfer_p(p_1        out varchar2
															,p_2        out varchar2
															,p_end_date in varchar2
															,p_org_id   in number) is
		cursor c_data is
			select o.organization_name
						,msib.segment1 item_code
						,msib.description item_des
						,decode(m.attribute1
									 ,'03'
									 ,'暂收仓'
									 ,'04'
									 ,'暂收仓'
									 ,'05'
									 ,'结算仓') sub_type
						,m.secondary_inventory_name sub_code
						,m.description sub_des
						,mil.segment1 l_code
						,mil.description l_des
						,moq.transaction_quantity onhan_qty
						,mmt.transaction_quantity
						,mmt.transaction_date
						,mtt.transaction_type_name
				from apps.mtl_onhand_quantities        moq
						,apps.mtl_secondary_inventories    m
						,apps.mtl_item_locations           mil
						,apps.mtl_material_transactions    mmt
						,apps.org_organization_definitions o
						,apps.mtl_system_items_b           msib
						,apps.mtl_transaction_types        mtt
			 where moq.organization_id = m.organization_id
				 and moq.subinventory_code = m.secondary_inventory_name
				 and moq.organization_id = o.organization_id
				 and moq.inventory_item_id = msib.inventory_item_id
				 and moq.organization_id = msib.organization_id
				 and moq.locator_id = mil.inventory_location_id
				 and moq.organization_id = mil.organization_id
				 and moq.create_transaction_id = mmt.transaction_id
				 and mmt.transaction_type_id = mtt.transaction_type_id
				 and mmt.transaction_quantity > 0
				 and mmt.transaction_action_id <> 2 --非子库存转移
				 and m.attribute1 in ('03'
														 ,'04'
														 ,'05')
						
						--参数
				 and trunc(moq.creation_date) <= to_date(substr(p_end_date
																											 ,1
																											 ,10)
																								,'yyyy/mm/dd')
				 and moq.organization_id in
						 (select ood.organization_id from org_organization_definitions ood where ood.operating_unit = p_org_id);
	
		v_line_str varchar2(4000);
		v_sep      varchar2(5);
	begin
		html_report_pkg.v_report_output_mode := 'F';
	
		v_sep := '####';
		html_report_pkg.html_title(p_program_title => '现有量非子库存转移报表'
															,p_report_title  => '现有量非子库存转移报表');
		html_report_pkg.output_line('截止时间：' || p_end_date);
	
		html_report_pkg.output_line('<table width=100% style="border-collapse:collapse; border:none; font-family: 宋体; font-size: 10pt" border=1 bordercolor=#000000 cellspacing="0">');
	
		v_line_str := '库存组织,物料编码,物料描述,类别,仓库代码,仓库说明,货位代码,货位说明,现有量数量,事务处理日期,事务处理类型,';
		html_report_pkg.line_title(p_title_string => v_line_str);
	
		for c1 in c_data
		loop
			html_report_pkg.line_title(p_title_string    => c1.organization_name || v_sep || c1.item_code || v_sep ||
																											c1.item_des || v_sep || c1.sub_type || v_sep || c1.sub_code ||
																											v_sep || c1.sub_des || v_sep || c1.l_code || v_sep || c1.l_des ||
																											v_sep || c1.onhan_qty || v_sep || c1.transaction_date || v_sep ||
																											c1.transaction_type_name || v_sep
																,p_delimiter       => v_sep
																,p_with_other_attr => 'Y'
																,p_attr_delimiter  => '***');
		
		end loop;
	
		html_report_pkg.output_line('</tr></table>');
		html_report_pkg.output_line('</html>');
	end onhand_notranfer_p;
end scm_ar_report_pkg;


  CREATE OR REPLACE PACKAGE "APPS"."CUX_SUPPLIER_BALANCE_PKG" is

  -- Author  : ADMINISTRATOR
  -- Created : 2007-10-09 14:31:27
  -- Purpose : JD2.供应商应计负债余额明细表

  -- Public function and procedure declarations

  --从临时表cux_supplier_balance取同一供应商同一接接收号同一物料的匹配余量
  function get_supplier_balance_qty(p_vendor_code      varchar2,
                                    p_vendor_site_code varchar2,
                                    p_receipt_num      varchar2,
                                    p_po_num           varchar2,
                                    p_item_code        varchar2,
                                    p_qty_flag         varchar2)
    return varchar2;

  --从临时表cux_supplier_balance取同一供应商同一接接收号同一物料的匹配余额
  function get_supplier_balance_amount(p_vendor_code      varchar2,
                                       p_vendor_site_code varchar2,
                                       p_receipt_num      varchar2,
                                       p_po_num           varchar2,
                                       p_item_code        varchar2,
                                       p_amount_flag      varchar2)
    return varchar2;

  procedure supplier_balance_report(p1                in varchar2,
                                    p2                in varchar2,
                                    p_vendor_from     in varchar2,
                                    p_vendor_to       in varchar2,
                                    p_po_num_from     in varchar2,
                                    p_po_num_to       in varchar2,
                                    p_item_from       in varchar2,
                                    p_item_to         in varchar2,
                                    p_date_from       in varchar2,
                                    p_date_to         in varchar2,
                                    P_qty_zero        in out varchar2,
                                    P_amount_zero     in out varchar2,
                                    p_organization_id in number);
end cux_supplier_balance_pkg;

CREATE OR REPLACE PACKAGE BODY "APPS"."CUX_SUPPLIER_BALANCE_PKG" is

  --p_qty_flag=Y时,取出所有数据,不论余额是否为0,p_qty_flag=N时,只取余额不等于0的.
  --其返回值与p_qty_flag对应
  function get_supplier_balance_qty(p_vendor_code      varchar2,
                                    p_vendor_site_code varchar2,
                                    p_receipt_num      varchar2,
                                    p_po_num           varchar2,
                                    p_item_code        varchar2,
                                    p_qty_flag         varchar2)
    return varchar2 is

    v_sum_qty number := 0;
    v_sum_qty1 number := 0;
    v_result  varchar2(5) := 'Y';
  begin
    if p_qty_flag = 'Y' then
      v_result := 'Y';
    else
      --期初数量
      select sum(csb.init_qty) qty
        into v_sum_qty
        from cux_supplier_balance2 csb
       where csb.vendor_code = p_vendor_code
         and csb.vendor_site_code = p_vendor_site_code
         and csb.receipt_num = p_receipt_num
         and csb.po_num = p_po_num
         and csb.item_code = p_item_code;
     --期间数量+匹配数量
     select sum(nvl(csb.period_qty,0) + nvl(match_qty,0)) qty
        into v_sum_qty1
        from cux_supplier_balance2 csb
       where csb.vendor_code = p_vendor_code
         and csb.vendor_site_code = p_vendor_site_code
         and csb.receipt_num = p_receipt_num
         and csb.po_num = p_po_num
         and csb.item_code = p_item_code;
      if nvl(v_sum_qty, 0) + nvl(v_sum_qty1, 0) = 0 then
        v_result := 'N';
      end if;
    end if;

    return v_result;
  exception
    when others then
      return v_result;
  end get_supplier_balance_qty;

  --p_amount_flag=Y时,取出所有数据,不论余额是否为0,p_amount_flag=N时,只取余额不等于0的.
  --其返回值与p_qty_flag对应
  function get_supplier_balance_amount(p_vendor_code      varchar2,
                                       p_vendor_site_code varchar2,
                                       p_receipt_num      varchar2,
                                       p_po_num           varchar2,
                                       p_item_code        varchar2,
                                       p_amount_flag      varchar2)
    return varchar2 is

    v_sum_amount number := 0;
    v_sum_amount1 number := 0;
    v_result     varchar2(5) := 'Y';
  begin
    if p_amount_flag = 'Y' then
      v_result := 'Y';
    else
      --期初金额
      select sum(csb.init_amount) qty
        into v_sum_amount
        from cux_supplier_balance2 csb
       where csb.vendor_code = p_vendor_code
         and csb.vendor_site_code = p_vendor_site_code
         and csb.receipt_num = p_receipt_num
         and csb.po_num = p_po_num
         and csb.item_code = p_item_code;
     --期初金额+匹配金额
     select sum(nvl(csb.period_amount,0) + nvl(match_amount,0)) qty
        into v_sum_amount1
        from cux_supplier_balance2 csb
       where csb.vendor_code = p_vendor_code
         and csb.vendor_site_code = p_vendor_site_code
         and csb.receipt_num = p_receipt_num
         and csb.po_num = p_po_num
         and csb.item_code = p_item_code;
      if nvl(v_sum_amount, 0) + nvl(v_sum_amount1, 0) = 0 then
        v_result := 'N';
      end if;
    end if;

    return v_result;

  exception
    when others then
      return v_result;
  end get_supplier_balance_amount;
--JD.供应商应计负债余额明细表-New
  procedure supplier_balance_report(p1                in varchar2,
                                    p2                in varchar2,
                                    p_vendor_from     in varchar2,
                                    p_vendor_to       in varchar2,
                                    p_po_num_from     in varchar2,
                                    p_po_num_to       in varchar2,
                                    p_item_from       in varchar2,
                                    p_item_to         in varchar2,
                                    p_date_from       in varchar2,
                                    p_date_to         in varchar2,
                                    P_qty_zero        in out varchar2,
                                    P_amount_zero     in out varchar2,
                                    p_organization_id in number) is
    v_date_to date;
    cursor c1 is
      select a4.segment1 vendor_code,
             a4.vendor_name,
             a5.vendor_site_code,
             a1.transaction_type trans_type,
             a1.transaction_date trans_date,
             a2.receipt_num,
             a8.segment1 po_num,
             a7.segment1 item_code,
             a7.description item_description,
             a1.unit_of_measure,
             a1.po_unit_price * nvl(a1.currency_conversion_rate, 1) unit_price,
             a1.quantity * decode(a1.transaction_type,
                                  'RECEIVE',
                                  -1,
                                  'RETURN TO VENDOR',
                                  1,
                                  0) quantity,
             0 amount_invoiced,
             (select vn.receive_no from vsreceive_no_v vn
             where vn.erp_receive_no=a2.RECEIPT_NUM
             AND  vn.organization_id=A2.ship_to_org_id ) ESCM_RECEIPT_NUM---add by chenlk 20161125 增加ESCM接收单号
        from po.rcv_transactions     a1,
             po.rcv_shipment_headers a2,
             po_vendors           a4,
             po_vendor_sites_all  a5,
             po.po_lines_all         a6,
             inv.mtl_system_items_b  a7,
             po.po_headers_all       a8
       where a1.shipment_header_id = a2.shipment_header_id
         and a1.vendor_id = a4.vendor_id
         and a1.vendor_site_id = a5.vendor_site_id
         and a6.po_line_id = a1.po_line_id
         and a8.po_header_id = a1.po_header_id
         and a6.item_id = a7.inventory_item_id
         and a1.transaction_type in ('RECEIVE', 'RETURN TO VENDOR')
         and a1.organization_id = p_organization_id
         and a7.organization_id = p_organization_id
         and a1.transaction_date < v_date_to
         AND a4.vendor_name BETWEEN nvl(p_vendor_from, a4.vendor_name) AND
             nvl(p_vendor_to, a4.vendor_name)
         and a7.inventory_item_id between
             nvl(p_item_from, a7.inventory_item_id) and
             nvl(p_item_to, a7.inventory_item_id)
         and a8.segment1 between nvl(p_po_num_from, a8.segment1) and
             nvl(p_po_num_to, a8.segment1)
      union all
      select b2.segment1 vendor_code,
             b2.Vendor_Name vendor_name,
             b3.vendor_site_code,
             'AP接收匹配' trans_type,
             b1.accounting_date trans_date,
             b5.receipt_num,
             b8.segment1 po_num,
             b7.segment1 item_code,
             b7.description item_description,
             b4.unit_of_measure,
             b1.unit_price,
             b1.quantity_invoiced quantity,
             nvl(b1.base_amount, b1.amount) -
             nvl(b1.base_invoice_price_variance, 0) -
             nvl(b1.exchange_rate_variance, 0) amount_invoiced,
              (select vn.receive_no from vsreceive_no_v vn
             where vn.erp_receive_no=b5.RECEIPT_NUM
             AND  vn.organization_id=B5.ship_to_org_id ) ESCM_RECEIPT_NUM---add by chenlk 20161125 增加ESCM接收单号
        from ap_invoice_distributions_all b1,
             po_vendors                   b2,
             po_vendor_sites_all          b3,
             po.rcv_transactions             b4,
             po.rcv_shipment_headers         b5,
             po.po_lines_all                 b6,
             inv.mtl_system_items_b          b7,
             po.po_headers_all               b8
       where b1.rcv_transaction_id = b4.transaction_id
         and b4.vendor_id = b2.vendor_id
         and b4.vendor_site_id = b3.vendor_site_id
         and b4.shipment_header_id = b5.shipment_header_id
         and b4.po_line_id = b6.po_line_id
         and b6.item_id = b7.inventory_item_id
         and b8.po_header_id = b4.po_header_id
         and b1.po_distribution_id is not null
         and b4.transaction_type in ('RECEIVE', 'RETURN TO VENDOR')
         And b1.line_type_lookup_code<>'IPV'  --2011/12/27增加
         and b4.organization_id = p_organization_id
         and b7.organization_id = p_organization_id
         and b1.accounting_date < v_date_to
         and b2.vendor_name BETWEEN nvl(p_vendor_from, b2.vendor_name) AND
             nvl(p_vendor_to, b2.vendor_name)
         and b7.inventory_item_id between
             nvl(p_item_from, b7.inventory_item_id) and
             nvl(p_item_to, b7.inventory_item_id)
         and b8.segment1 between nvl(p_po_num_from, b8.segment1) and
             nvl(p_po_num_to, b8.segment1);

    v_date_from date;
    cursor c2 is
      select csb.*
      from cux_supplier_balance2 csb
      where get_supplier_balance_qty(csb.vendor_code,
                                      csb.vendor_site_code,
                                      csb.receipt_num,
                                      csb.po_num,
                                      csb.item_code,
                                      P_qty_zero) = 'Y'
        and get_supplier_balance_amount(csb.vendor_code,
                                         csb.vendor_site_code,
                                         csb.receipt_num,
                                         csb.po_num,
                                         csb.item_code,
                                         P_amount_zero) = 'Y';

    cursor c3 is(
      select csb.vendor_code,
             csb.vendor_name,
             csb.vendor_site_code,
             decode(csb.trans_type,
                    'RECEIVE',
                    '接收',
                    'RETURN TO VENDOR',
                    '向供应商退货',
                    csb.trans_type) trans_type,
             csb.trans_date,
             csb.receipt_num,
             csb.escm_receipt_num,--add by chenlk 20161125 增加ESCM接收单号
             csb.po_num,
             csb.item_code,
             csb.item_description,
             csb.unit_of_measure,
             csb.unit_price,
             decode(sign(csb.trans_date - v_date_from),
                    -1,
                    round(sum(csb.quantity),4),--2007.11.8 保留小数4位
                    0) init_qty,
             decode(sign(csb.trans_date - v_date_from),
                    -1,
                    decode(csb.trans_type,
                           'AP接收匹配',
                           round(sum(csb.amount_invoiced),2),
                           round(sum(csb.unit_price * csb.quantity),2)),--2007.11.8 保留小数2位
                    0) init_amount,
             decode(csb.trans_type,
                    'AP接收匹配',
                    0,
                    decode(sign(csb.trans_date - v_date_from),
                           -1,
                           0,
                           round(sum(csb.quantity),4))) period_qty,--2007.11.8 保留小数4位
             decode(csb.trans_type,
                    'AP接收匹配',
                    0,
                    decode(sign(csb.trans_date - v_date_from),
                           -1,
                           0,
                           round(sum(csb.quantity * csb.unit_price),2))) period_amount,--2007.11.8 保留小数2位
             decode(csb.trans_type,
                    'AP接收匹配',
                    decode(sign(csb.trans_date - v_date_from),
                           -1,
                           0,
                           round(sum(csb.quantity),4)),--2007.11.8 保留小数4位
                    0) match_qty,
             decode(csb.trans_type,
                    'AP接收匹配',
                    decode(sign(csb.trans_date - v_date_from),
                           -1,
                           0,
                           round(sum(csb.amount_invoiced),2)),--2007.11.8 保留小数2位
                    0) match_amount
        from cux_supplier_balance csb

       group by csb.vendor_code,
                csb.vendor_name,
                csb.vendor_site_code,
                csb.trans_type,
                csb.trans_date,
                csb.receipt_num,
                csb.escm_receipt_num,--add by chenlk 20161125 增加ESCM接收单号
                csb.po_num,
                csb.item_code,
                csb.item_description,
                csb.unit_of_measure,
                csb.unit_price

      )
       order by vendor_name,
                vendor_site_code,
                po_num,
                receipt_num,
                item_code,
                trans_date;
    v_user_id number;
    v_company varchar2(100);

    v_sep     varchar2(10);
    v_Line_Str varchar2(500);

    v_final_qty number := 0;
    v_final_amt number := 0;
    v_sum_init_qty  number := 0;
    v_sum_init_amt  number := 0;
    v_sum_period_qty  number := 0;
    v_sum_period_amt  number := 0;
    v_sum_match_qty  number := 0;
    v_sum_match_amt  number := 0;
    v_sum_final_qty  number := 0;
    v_sum_final_amt  number := 0;
    v_0_30           number :=0;
    v_31_60          number :=0;
    v_61_90          number :=0;
    v_91             number :=0;
    v_sum_0_30       number :=0;
    v_sum_31_60      number :=0;
    v_sum_61_90      number :=0;
    v_sum_91         number :=0;    
    v_days           number;
  begin
    v_user_id := fnd_global.USER_ID;

    if P_qty_zero is null then
      P_qty_zero := 'Y';
    end if;

    if P_amount_zero is null then
      P_amount_zero := 'Y';
    end if;

    if p_date_from is not null then
      v_date_from := to_date(p_date_from,'yyyy-mm-dd hh24:mi:ss');
    else
      v_date_from := to_date('1990-01-01 00:00:00','yyyy-mm-dd hh24:mi:ss');
    end if;

    if p_date_to is null then
      v_date_to := sysdate;
    else
      v_date_to := to_date(p_date_to,'yyyy-mm-dd hh24:mi:ss') + 1;
    end if;

    begin
      for r1 in c1 loop
        insert into cux_supplier_balance
          (vendor_code,
           vendor_name,
           vendor_site_code,
           trans_type,
           trans_date,
           receipt_num,
           escm_receipt_num,--add by chenlk 20161125 增加ESCM接收单号
           po_num,
           item_code,
           item_description,
           unit_of_measure,
           unit_price,
           quantity,
           amount_invoiced,
           created_by,
           creation_date)
        values
          (r1.vendor_code,
           r1.vendor_name,
           r1.vendor_site_code,
           r1.trans_type,
           r1.trans_date,
           r1.receipt_num,
           r1.ESCM_RECEIPT_NUM,--add by chenlk 20161125 增加ESCM接收单号
           r1.po_num,
           r1.item_code,
           r1.item_description,
           r1.unit_of_measure,
           r1.unit_price,
           r1.quantity,
           r1.amount_invoiced,
           v_user_id,
           sysdate);
      end loop;
    exception
      when others then
        Html_Report_Pkg.Output_Line('数据提取程序出错,请与系统管理员联系!');
    end;

    --表示以文件形式进行输出，在开发HTML报表时，固定即可，不需修改
    Html_Report_Pkg.v_Report_Output_Mode := 'F';

    --为输出字符串的分隔符号赋值，分隔符号的值，在输出字段的值中不能包含，否则，会造成分隔错误。
    v_Sep := '^';

    --输出标题
    Html_Report_Pkg.Html_Title(p_Program_Title => 'JD2.供应商应计负债余额明细表',
                               p_Report_Title  => 'JD2.供应商应计负债余额明细表');

    select hou.name
      into v_company
      from org_organization_definitions ood, hr_operating_units hou
     where ood.OPERATING_UNIT = hou.organization_id
       and ood.ORGANIZATION_ID = p_organization_id;

    --输出报表参数
    Html_Report_Pkg.Output_Line('经营单位:' || v_company);

    Html_Report_Pkg.Output_Line('<BR>' || '供应商从:' || p_vendor_from);
    Html_Report_Pkg.Output_Line('<BR>' || '至:' || p_vendor_to );
    Html_Report_Pkg.Output_Line('<BR>' || 'PO编号从:' || p_po_num_From);
    Html_Report_Pkg.Output_Line('<BR>' || '至:' || p_po_num_To);
    Html_Report_Pkg.Output_Line('<BR>' || '物料从:' || p_Item_From);
    Html_Report_Pkg.Output_Line('<BR>' || '至:' || p_Item_To);
    Html_Report_Pkg.Output_Line('<BR>' || '日期从:' || p_date_From);
    Html_Report_Pkg.Output_Line('<BR>' || '至:' || p_date_To);
    Html_Report_Pkg.Output_Line('<BR>' || '数量余额是否为零:' || p_qty_zero);
    Html_Report_Pkg.Output_Line('<BR>' || '金额余额是否为零:' || p_amount_zero);
    --Html_Report_Pkg.Output_Line('<BR>' || '是否显示帮助:' || p_Show_Help);
    Html_Report_Pkg.Output_Line('<BR>' || '报表运行时间:' ||
                                To_Char(Sysdate, 'yyyy-mm-dd hh24:mi:ss'));

            --开始进行内容的输出，下行的width=2000，用于进行输出表格的宽度设置
        Html_Report_Pkg.Output_Line('<br/><table width=200% style="border-collapse:collapse;    border:none; font-family: 宋体; font-size: 10pt" border=1    bordercolor=#000000 cellspacing="0">');

            --将表格标题，用逗号分隔后，连接成一个字符串，注意：最后一个字段之后，也要有个逗号。
            v_Line_Str := '供应商名称,地点,类型,日期,入库单号,ESCM接收单号,PO 编号,项目,说明,单位,单价,期初数量,期初金额,期间数量,期间金额,匹配数量,匹配金额,期末数量,期末金额,0-30天,31-60天,61-90天,90天以上,';

            --输出表格标题
            Html_Report_Pkg.Line_Title(p_Title_String => v_Line_Str);
    --输入临时表 2007.11.8 add
    for r3 in c3 loop
        insert into cux_supplier_balance2
          (vendor_code,
           vendor_name,
           vendor_site_code,
           trans_type,
           trans_date,
           receipt_num,
           escm_receipt_num,--add by chenlk 20161125 增加ESCM接收单号
           po_num,
           item_code,
           item_description,
           unit_of_measure,
           unit_price,
           init_qty,
           init_amount,
           period_qty,
           period_amount,
           match_qty,
           match_amount)
        values
          (r3.vendor_code,
           r3.vendor_name,
           r3.vendor_site_code,
           r3.trans_type,
           r3.trans_date,
           r3.receipt_num,
           r3.escm_receipt_num, --add by chenlk 20161125 增加ESCM接收单号
           r3.po_num,
           r3.item_code,
           r3.item_description,
           r3.unit_of_measure,
           r3.unit_price,
           r3.init_qty,
           r3.init_amount,
           r3.period_qty,
           r3.period_amount,
           r3.match_qty,
           r3.match_amount);
    end loop;

    for r2 in c2 loop
      v_final_qty := nvl(r2.init_qty,0) + nvl(r2.period_qty,0) + nvl(r2.match_qty,0);
      v_final_amt := nvl(r2.init_amount,0) + nvl(r2.period_amount,0) + nvl(r2.match_amount,0);
      
      --add wuyujin 2010-11-5  增加帐龄
      v_days := trunc(sysdate)-trunc(r2.trans_date);
      if(v_days>0 and v_days<31) then
        v_0_30   :=v_final_amt;
        v_31_60  :=0;
        v_61_90  :=0;
        v_91     :=0;      
      elsif(v_days>30 and v_days<61) then
        v_0_30   :=0;
        v_31_60  :=v_final_amt;
        v_61_90  :=0;
        v_91     :=0;            
      elsif(v_days>60 and v_days<91) then
        v_0_30   :=0;
        v_31_60  :=0;
        v_61_90  :=v_final_amt;
        v_91     :=0;            
      elsif(v_days>90) then
        v_0_30   :=0;
        v_31_60  :=0;
        v_61_90  :=0;
        v_91     :=v_final_amt;            
      end if;
      v_sum_0_30  :=v_sum_0_30 +v_0_30 ;
      v_sum_31_60 :=v_sum_31_60+v_31_60;
      v_sum_61_90 :=v_sum_61_90+v_61_90;
      v_sum_91    :=v_sum_91+v_91;        
            --output
            Html_Report_Pkg.Line_Title(p_Title_String => r2.vendor_name || v_Sep ||
                                                   r2.vendor_site_code || v_sep ||
                                                   r2.trans_type || v_sep ||
                                                   to_char(r2.trans_date,'yyyy-mm-dd') || v_sep ||
                                                   r2.receipt_num || v_sep  ||
                                                   r2.escm_receipt_num|| v_sep  ||--add by chenlk 20161125 增加显示escm接收单号
                                                   r2.po_num || v_sep ||
                                                   r2.item_code || v_sep ||
                                                   Substr(r2.Item_description,1,40) || v_Sep ||
                                                   r2.unit_of_measure || v_sep ||
                                                   --2007.11.8 将unit_price由第2位精确到第4位
                                                   to_char(round(r2.unit_price,4),'FM999999990.0000') || '*** align=Right' || v_sep ||
                                                   to_char(round(r2.init_qty,4)) || '*** align=Right' || v_sep ||
                                                   to_char(round(r2.init_amount,2),'FM999999990.00') || '*** align=Right' || v_sep ||
                                                   to_char(round(r2.period_qty,4)) || '*** align=Right' || v_sep ||
                                                   to_char(round(r2.period_amount,2),'FM999999990.00') || '*** align=Right' || v_sep ||
                                                   to_char(round(r2.match_qty,4)) || '*** align=Right' || v_sep ||
                                                   to_char(round(r2.match_amount,2),'FM999999990.00') || '*** align=Right' || v_sep ||
                                                   to_char(round(v_final_qty,4)) || '*** align=Right' || v_sep ||
                                                   to_char(round(v_final_amt,2),'FM999999990.00') || '*** align=Right' || v_sep ||
                                                   to_char(round(v_0_30,2),'FM999999990.00') || '*** align=Right' || v_sep ||
                                                   to_char(round(v_31_60,2),'FM999999990.00') || '*** align=Right' || v_sep ||
                                                   to_char(round(v_61_90,2),'FM999999990.00') || '*** align=Right' || v_sep ||
                                                   to_char(round(v_91,2),'FM999999990.00') || '*** align=Right' || v_sep 
                                                                    ,p_With_Other_Attr => 'Y'
                                                                    ,p_Attr_Delimiter  => '***'
                                                                    ,p_Delimiter       => v_Sep);

      v_sum_init_qty    := v_sum_init_qty + r2.init_qty;
      v_sum_init_amt    := v_sum_init_amt + r2.init_amount;
      v_sum_period_qty  := v_sum_period_qty + r2.period_qty;
      v_sum_period_amt  := v_sum_period_amt + r2.period_amount;
      v_sum_match_qty   := v_sum_match_qty + r2.match_qty;
      v_sum_match_amt   := v_sum_match_amt + r2.match_amount;
      v_sum_final_qty   := v_sum_final_qty + v_final_qty;
      v_sum_final_amt   := v_sum_final_amt + v_final_amt;
    end loop;

      --输出汇总行
        Html_Report_Pkg.Line_Title(p_Title_String    => '报表合计:' || v_Sep || v_Sep || v_Sep || v_Sep ||
                                                      v_Sep ||v_Sep || v_Sep || v_Sep || v_Sep || v_Sep ||
                                                                                                            to_char(round(v_sum_init_qty,4)) || '*** align=Right' || v_Sep ||
                                                                                                            to_char(round(v_sum_init_amt,2),'FM999999990.00') || '*** align=Right' || v_Sep ||
                                                                                                            to_char(round(v_sum_period_qty,4)) || '*** align=Right' || v_Sep ||
                                                                                                            to_char(round(v_sum_period_amt,2),'FM999999990.00') || '*** align=Right' || v_Sep ||
                                                                                                            to_char(round(v_sum_match_qty,4)) || '*** align=Right' || v_Sep ||
                                                                                                            to_char(round(v_sum_match_amt,2),'FM999999990.00') || '*** align=Right' || v_Sep ||
                                                                                                            to_char(round(v_sum_final_qty,4)) || '*** align=Right' || v_Sep ||
                                                                                                            to_char(round(v_sum_final_amt,2),'FM999999990.00') || '*** align=Right' || v_Sep ||
                                                      to_char(round(v_sum_0_30,2),'FM999999990.00') || '*** align=Right' || v_sep ||
                                                      to_char(round(v_sum_31_60,2),'FM999999990.00') || '*** align=Right' || v_sep ||
                                                      to_char(round(v_sum_61_90,2),'FM999999990.00') || '*** align=Right' || v_sep ||
                                                      to_char(round(v_sum_91,2),'FM999999990.00') || '*** align=Right' || v_sep 
                                                                ,p_With_Other_Attr => 'Y'
                                                                ,p_Attr_Delimiter  => '***'
                                                                ,p_Delimiter       => v_Sep);

      --输出网页结束时的标签符
      Html_Report_Pkg.Output_Line('</html>');
    --清除数据
    delete from cux_supplier_balance;
    delete from cux_supplier_balance2;
    commit;
  end supplier_balance_report;

end cux_supplier_balance_pkg; 
 
 
